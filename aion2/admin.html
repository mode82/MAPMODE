<!-- aion2/index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>MAPMODE · INDEX</title>
  <style>
    :root{
      color-scheme: dark;
      --bg:#070b12;
      --panel:#0b1220cc;
      --card:#0e1626cc;
      --stroke:#1f2a3a;
      --stroke2:#27344a;
      --text:#e7eef8;
      --muted:#9fb0c6;
      --accent:#7cc4ff;
      --danger:#ff5d5d;
      --ok:#39d98a;
      --warn:#ffd60a;

      --r12:12px;
      --r14:14px;
      --r16:16px;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --shadow2: 0 8px 24px rgba(0,0,0,.35);
      --blur: 14px;

      --topH: 58px;
      --sideW: 310px;
      --sideW2: 330px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 20% 0%, rgba(124,196,255,.10), transparent 65%),
                  radial-gradient(900px 500px at 90% 30%, rgba(57,217,138,.08), transparent 60%),
                  var(--bg);
      color:var(--text);
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, "Noto Sans KR", sans-serif;
      overflow:hidden;
      -webkit-tap-highlight-color: transparent;
    }
    .app{
      position:fixed; inset:0;
      display:grid;
      grid-template-rows: var(--topH) 1fr;
      grid-template-columns: var(--sideW) 1fr var(--sideW2);
      grid-template-areas:
        "top top top"
        "left center right";
    }
    .top{
      grid-area:top;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      background: linear-gradient(180deg, rgba(11,18,32,.88), rgba(11,18,32,.55));
      border-bottom:1px solid rgba(39,52,74,.8);
      backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow2);
      z-index:10;
    }
    .left{
      grid-area:left;
      padding:12px;
      border-right:1px solid rgba(39,52,74,.8);
      background: linear-gradient(180deg, rgba(11,18,32,.66), rgba(11,18,32,.42));
      backdrop-filter: blur(var(--blur));
      overflow:auto;
    }
    .right{
      grid-area:right;
      padding:12px;
      border-left:1px solid rgba(39,52,74,.8);
      background: linear-gradient(180deg, rgba(11,18,32,.66), rgba(11,18,32,.42));
      backdrop-filter: blur(var(--blur));
      overflow:auto;
    }
    .center{
      grid-area:center;
      position:relative;
      overflow:hidden;
      background:
        radial-gradient(900px 500px at 30% 20%, rgba(124,196,255,.06), transparent 60%),
        radial-gradient(900px 500px at 70% 80%, rgba(255,214,10,.05), transparent 60%),
        #050813;
    }
    .canvasWrap{ position:absolute; inset:0; touch-action:none; }
    canvas{ position:absolute; inset:0; width:100%; height:100%; display:block; }

    .brand{
      display:flex; align-items:center; gap:10px;
      min-width:220px;
    }
    .logo{
      width:38px; height:38px;
      border-radius:12px;
      border:1px solid rgba(39,52,74,.9);
      background: rgba(14,22,38,.6);
      box-shadow: var(--shadow2);
      display:grid; place-items:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .logo img{ width:100%; height:100%; object-fit:contain; }
    .brandTitle{
      display:flex; flex-direction:column; gap:2px; min-width:0;
    }
    .brandTitle b{ font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .brandTitle span{ color:var(--muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .btn{
      height:34px;
      border-radius:12px;
      border:1px solid rgba(39,52,74,.95);
      background: rgba(14,22,38,.65);
      color:var(--text);
      padding:0 12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      box-shadow: var(--shadow2);
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{ border-color: rgba(124,196,255,.7); }
    .btn.small{ height:30px; border-radius:10px; padding:0 10px; font-size:13px; }
    .card{
      background: rgba(14,22,38,.55);
      border:1px solid rgba(39,52,74,.85);
      border-radius:16px;
      box-shadow: var(--shadow2);
      padding:12px;
      margin-bottom:12px;
    }
    .card h3{
      margin:0 0 10px 0;
      font-size:13px;
      color: var(--muted);
      font-weight:600;
      letter-spacing:.2px;
    }
    .row{ display:flex; gap:8px; align-items:center; }
    .col{ display:flex; flex-direction:column; gap:8px; }
    .grow{ flex:1; min-width:0; }
    .list{ display:flex; flex-direction:column; gap:8px; }
    .item{
      display:flex;
      gap:8px;
      align-items:center;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(39,52,74,.75);
      background: rgba(7,11,18,.35);
    }
    .item.active{
      border-color: rgba(124,196,255,.8);
      box-shadow: 0 0 0 3px rgba(124,196,255,.10);
    }
    .pill{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.85);
      color: var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .hint{ color: var(--muted); font-size:12px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .swatch{ width:18px; height:18px; border-radius:8px; border:1px solid rgba(255,255,255,.12); }

    a.link{
      color: var(--accent);
      text-decoration:none;
    }
    a.link:hover{ text-decoration:underline; }

    @media (max-width: 980px){
      :root{ --sideW: 280px; --sideW2: 300px; }
    }
    @media (max-width: 860px){
      :root{ --sideW: 250px; --sideW2: 280px; }
      .brand{ min-width: 180px; }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="top">
    <div class="brand">
      <div class="logo"><img id="logoImg" alt="logo" /></div>
      <div class="brandTitle">
        <b class="mono">MAPMODE · INDEX</b>
        <span id="locLabel">Loading…</span>
      </div>
    </div>
    <div class="row">
      <button class="btn" id="btnFit">Fit View</button>
      <button class="btn" id="btnReload">Reload</button>
    </div>
  </div>

  <aside class="left">
    <div class="card">
      <h3>Pages</h3>
      <div class="hint">Select a page to view its map and markers.</div>
      <div style="height:10px"></div>
      <div class="list" id="pageList"></div>
    </div>
    <div class="card">
      <h3>How to Use</h3>
      <div class="col">
        <div class="row"><span class="pill">Drag</span><span class="hint">pan</span></div>
        <div class="row"><span class="pill">Wheel</span><span class="hint">zoom</span></div>
        <div class="row"><span class="pill">Click marker</span><span class="hint">toggle 30% opacity</span></div>
      </div>
    </div>
  </aside>

  <main class="center">
    <div class="canvasWrap" id="canvasWrap">
      <canvas id="c"></canvas>
    </div>
  </main>

  <aside class="right">
    <div class="card">
      <h3>Marker Categories</h3>
      <div class="list" id="markerCatList"></div>
      <div style="height:10px"></div>
      <div class="hint">Toggles are view-only. Admin controls are disabled.</div>
    </div>

    <div class="card">
      <h3>Selected Marker</h3>
      <div class="item">
        <div class="grow">
          <div class="hint">Name</div>
          <div id="selName" class="mono" style="margin-top:2px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">(none)</div>
        </div>
      </div>
      <div class="col" style="margin-top:10px;">
        <div class="hint">YouTube</div>
        <div id="ytBlock" class="item" style="align-items:flex-start; display:none;">
          <div class="grow">
            <div id="ytTitle" class="mono" style="font-size:13px;"></div>
            <div id="ytDesc" class="hint" style="margin-top:6px; white-space:pre-wrap;"></div>
            <div style="height:8px"></div>
            <a id="ytLink" class="link" href="#" target="_blank" rel="noopener">Open link</a>
          </div>
        </div>
        <div class="hint" id="ytNone">Select a marker to see its link panel.</div>
      </div>
    </div>
  </aside>
</div>

<script>
(() => {
  "use strict";

  // Fixed shared remote URL
  const REMOTE_STATE_URL = new URL("./data/state.json", location.href);

  const $ = (sel, el=document) => el.querySelector(sel);
  const clamp = (v,a,b) => Math.max(a, Math.min(b, v));
  const safeParse = (json,fallback)=>{ try{ return JSON.parse(json);}catch{ return fallback; } };

  let state = null;

  const canvas = $("#c");
  const wrap = $("#canvasWrap");
  const ctx = canvas.getContext("2d");

  const img = new Image();
  img.crossOrigin = "anonymous";
  let imgReady = false;

  const view = { scale:1, ox:0, oy:0, minScale:0.1, maxScale:10 };

  function resize(){
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
    const r = wrap.getBoundingClientRect();
    canvas.width = Math.round(r.width * dpr);
    canvas.height = Math.round(r.height * dpr);
    canvas.style.width = r.width + "px";
    canvas.style.height = r.height + "px";
    ctx.setTransform(dpr,0,0,dpr,0,0);
    requestDraw();
  }
  window.addEventListener("resize", resize, {passive:true});

  function worldToScreen(wx, wy){
    return { x: wx * view.scale + view.ox, y: wy * view.scale + view.oy };
  }
  function screenToWorld(sx, sy){
    return { x: (sx - view.ox) / view.scale, y: (sy - view.oy) / view.scale };
  }

  function fitView(){
    if(!imgReady) return;
    const r = wrap.getBoundingClientRect();
    const w = img.naturalWidth || 1;
    const h = img.naturalHeight || 1;
    const pad = 20;
    const sx = (r.width - pad*2) / w;
    const sy = (r.height - pad*2) / h;
    view.scale = clamp(Math.min(sx, sy), view.minScale, view.maxScale);
    view.ox = (r.width - w * view.scale) * 0.5;
    view.oy = (r.height - h * view.scale) * 0.5;
    requestDraw();
  }

  const getActivePage = () => state.pages.find(p => p.id === state.activePageId) || state.pages[0] || null;
  const getMarkersForPage = (pid) => state.markers.filter(m => m.pageId === pid);
  const getLinksForPage = (pid) => state.links.filter(l => l.pageId === pid);
  const getMarkerCat = (id) => state.markerCategories.find(c => c.id === id) || state.markerCategories[0];

  function isMarkerVisible(m){
    const cat = getMarkerCat(m.mcatId);
    return !!(cat && cat.enabled);
  }

  let drawReq = 0;
  function requestDraw(){
    if(drawReq) return;
    drawReq = requestAnimationFrame(()=>{ drawReq=0; draw(); });
  }

  function draw(){
    if(!state) return;
    const r = wrap.getBoundingClientRect();
    const w = r.width, h = r.height;
    ctx.clearRect(0,0,w,h);

    // image
    if(imgReady){
      ctx.save();
      ctx.setTransform(view.scale,0,0,view.scale,view.ox,view.oy);
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = "high";
      ctx.drawImage(img, 0, 0);
      ctx.restore();
    }

    const page = getActivePage();
    if(!page) return;

    // lines
    if(state.view?.showLines !== false){
      for(const l of getLinksForPage(page.id)){
        const a = state.markers.find(m=>m.id===l.from);
        const b = state.markers.find(m=>m.id===l.to);
        if(!a || !b) continue;
        if(!isMarkerVisible(a) || !isMarkerVisible(b)) continue;
        drawLink(a,b,l.ctrl);
      }
    }

    // markers
    const markers = getMarkersForPage(page.id).slice().sort((a,b)=>(a.num||0)-(b.num||0));
    for(const m of markers){
      if(!isMarkerVisible(m)) continue;
      drawMarker(m);
    }
  }

  function roundRect(ctx,x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  function drawMarker(m){
    const cat = getMarkerCat(m.mcatId);
    const fill = cat?.color || "#4da3ff";
    const hideNum = !!cat?.hideNumbers;

    const s = worldToScreen(m.x, m.y);
    const baseR = m.size * 0.5 * view.scale;

    ctx.save();
    ctx.globalAlpha = m.selected ? 0.3 : 1;

    ctx.beginPath();
    ctx.arc(s.x, s.y, baseR, 0, Math.PI*2);
    ctx.fillStyle = fill;
    ctx.fill();

    ctx.globalAlpha = m.selected ? 0.35 : 0.9;
    ctx.lineWidth = Math.max(1, 2 * view.scale);
    ctx.strokeStyle = "rgba(231,238,248,.85)";
    ctx.stroke();

    if(!hideNum){
      ctx.globalAlpha = m.selected ? 0.7 : 1;
      const textSize = Math.max(8, (m.size * 0.45 * (m.textScale||1)) * view.scale);
      ctx.fillStyle = m.textColor || "#fff";
      ctx.font = `${m.textWeight||700} ${textSize}px system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, "Noto Sans KR", sans-serif`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(String(m.num||""), s.x, s.y);
    }

    const labelSize = Math.max(10, (m.size * 0.38 * (m.textScale||1)) * view.scale);
    ctx.globalAlpha = m.selected ? 0.7 : 0.95;
    ctx.font = `${m.textWeight||600} ${labelSize}px system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, "Noto Sans KR", sans-serif`;
    ctx.fillStyle = m.textColor || "#ffffff";
    ctx.textAlign = "left";
    ctx.textBaseline = "middle";
    const pad = Math.max(8, 10 * view.scale);
    const name = (m.name || "").trim();
    if(name){
      const tx = s.x + baseR + pad;
      const ty = s.y;
      const metrics = ctx.measureText(name);
      const bw = metrics.width + 10 * view.scale;
      const bh = labelSize + 8 * view.scale;

      ctx.save();
      ctx.globalAlpha = m.selected ? 0.25 : 0.22;
      ctx.fillStyle = "rgba(7,11,18,.85)";
      roundRect(ctx, tx - 6*view.scale, ty - bh/2, bw, bh, 10*view.scale);
      ctx.fill();
      ctx.restore();

      ctx.fillText(name, tx, ty);
    }

    ctx.restore();
  }

  function quadAt(A,C,B,t){
    const u=1-t;
    return { x:u*u*A.x+2*u*t*C.x+t*t*B.x, y:u*u*A.y+2*u*t*C.y+t*t*B.y };
  }
  function quadDeriv(A,C,B,t){
    return { x:2*(1-t)*(C.x-A.x)+2*t*(B.x-C.x), y:2*(1-t)*(C.y-A.y)+2*t*(B.y-C.y) };
  }
  function drawArrow(x,y,ang,color){
    const len = Math.max(10, 14 * view.scale);
    const w = Math.max(6, 9 * view.scale);
    ctx.save();
    ctx.translate(x,y);
    ctx.rotate(ang);
    ctx.fillStyle = color;
    ctx.globalAlpha = 0.95;
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.lineTo(-len, -w/2);
    ctx.lineTo(-len,  w/2);
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }
  function drawLink(a,b,ctrl){
    const catA = getMarkerCat(a.mcatId);
    const col = catA?.color || "#4da3ff";

    const A = worldToScreen(a.x,a.y);
    const B = worldToScreen(b.x,b.y);
    const Cw = ctrl || {x:(a.x+b.x)/2, y:(a.y+b.y)/2};
    const C = worldToScreen(Cw.x, Cw.y);

    ctx.save();
    ctx.globalAlpha = 0.85;
    ctx.strokeStyle = col;
    ctx.lineWidth = Math.max(1.5, 2.2 * view.scale);
    ctx.beginPath();
    ctx.moveTo(A.x,A.y);
    ctx.quadraticCurveTo(C.x,C.y,B.x,B.y);
    ctx.stroke();

    const t = 0.82;
    const p = quadAt(A,C,B,t);
    const d = quadDeriv(A,C,B,t);
    drawArrow(p.x,p.y,Math.atan2(d.y,d.x),col);
    ctx.restore();
  }

  // ===== Interaction (view-only) =====
  let pointerDown=false;
  let dragMode=null;
  let dragStart={x:0,y:0};
  let dragViewStart={ox:0,oy:0,scale:1};
  let selectedMarkerId=null;

  function hitTestMarker(sx,sy){
    const page = getActivePage();
    if(!page) return null;
    const w = screenToWorld(sx,sy);
    const list = getMarkersForPage(page.id).filter(isMarkerVisible).slice().reverse();
    for(const m of list){
      const dx = w.x - m.x, dy = w.y - m.y;
      const r = (m.size*0.5);
      if(dx*dx+dy*dy <= r*r) return m;
    }
    return null;
  }

  function setSelectedMarker(id){
    selectedMarkerId = id;
    const m = state.markers.find(x=>x.id===id) || null;
    $("#selName").textContent = m ? `${m.name || "(unnamed)"}  ·  #${m.num || "?"}` : "(none)";

    if(m && (m.ytUrl || m.ytTitle || m.ytDesc)){
      $("#ytNone").style.display = "none";
      $("#ytBlock").style.display = "flex";
      $("#ytTitle").textContent = (m.ytTitle || m.name || "");
      $("#ytDesc").textContent = m.ytDesc || "";
      const link = $("#ytLink");
      link.href = m.ytUrl || "#";
      link.style.pointerEvents = m.ytUrl ? "auto" : "none";
      link.style.opacity = m.ytUrl ? "1" : "0.5";
    }else{
      $("#ytBlock").style.display = "none";
      $("#ytNone").style.display = "";
    }
    requestDraw();
  }

  function toggleMarkerSelected(m){
    if(!m) return;
    m.selected = !m.selected;
    setSelectedMarker(m.id);
    requestDraw();
  }

  wrap.addEventListener("contextmenu",(e)=>e.preventDefault());

  wrap.addEventListener("pointerdown",(e)=>{
    if(e.button !== 0) return;
    pointerDown = true;

    const r = wrap.getBoundingClientRect();
    const sx = e.clientX - r.left;
    const sy = e.clientY - r.top;

    const m = hitTestMarker(sx,sy);
    if(m){
      toggleMarkerSelected(m);
      dragMode = null;
    }else{
      dragMode="pan";
      dragStart={x:sx,y:sy};
      dragViewStart={ox:view.ox, oy:view.oy, scale:view.scale};
    }
  }, {passive:false});

  wrap.addEventListener("pointermove",(e)=>{
    if(!pointerDown) return;
    if(dragMode!=="pan") return;
    const r = wrap.getBoundingClientRect();
    const sx = e.clientX - r.left;
    const sy = e.clientY - r.top;
    view.ox = dragViewStart.ox + (sx - dragStart.x);
    view.oy = dragViewStart.oy + (sy - dragStart.y);
    requestDraw();
  }, {passive:false});

  wrap.addEventListener("pointerup",()=>{
    pointerDown=false;
    dragMode=null;
  }, {passive:true});

  wrap.addEventListener("wheel",(e)=>{
    e.preventDefault();
    const r = wrap.getBoundingClientRect();
    const sx = e.clientX - r.left;
    const sy = e.clientY - r.top;

    const before = screenToWorld(sx,sy);
    const delta = -e.deltaY;
    const zoomFactor = Math.exp(delta * 0.0012);
    const newScale = clamp(view.scale * zoomFactor, view.minScale, view.maxScale);
    view.scale = newScale;

    const after = screenToWorld(sx,sy);
    view.ox += (after.x - before.x) * view.scale;
    view.oy += (after.y - before.y) * view.scale;
    requestDraw();
  }, {passive:false});

  // ===== UI rendering =====
  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function renderPages(){
    const list = $("#pageList");
    list.innerHTML = "";
    for(const p of state.pages){
      const cat = state.categories.find(c=>c.id===p.categoryId);
      const g = cat?.games?.find(x=>x.id===p.gameId);

      const it = document.createElement("div");
      it.className = "item" + (p.id===state.activePageId ? " active" : "");
      it.style.cursor="pointer";
      it.innerHTML = `
        <div class="grow">
          <div class="row" style="gap:6px;">
            <span class="pill mono">${escapeHtml(g?.name || "Game")}</span>
            <span class="pill">${escapeHtml(cat?.name || "Category")}</span>
          </div>
          <div class="mono" style="margin-top:6px; font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(p.name)}</div>
          <div class="hint mono" style="margin-top:2px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(p.url || "")}</div>
        </div>
        <button class="btn small">Open</button>
      `;
      it.addEventListener("click", ()=>{
        state.activePageId = p.id;
        updateActivePage();
        renderPages();
      });
      list.appendChild(it);
    }
  }

  function renderMarkerCats(){
    const list = $("#markerCatList");
    list.innerHTML = "";
    for(const c of state.markerCategories){
      const it = document.createElement("div");
      it.className = "item";
      it.innerHTML = `
        <div class="swatch" style="background:${c.color};"></div>
        <div class="grow">
          <div class="mono">${escapeHtml(c.name)}</div>
          <div class="hint">Enabled: ${c.enabled ? "YES":"NO"} · Hide numbers: ${c.hideNumbers ? "YES":"NO"}</div>
        </div>
      `;
      list.appendChild(it);
    }
  }

  function getGamePathLabel(p){
    const cat = state.categories.find(c => c.id === p.categoryId);
    const g = cat?.games?.find(x => x.id === p.gameId);
    return `${g?.name || "Game"} / ${p.name || "Page"}`;
  }

  function applyLogo(){
    $("#logoImg").src = (state.logoUrl || "/assets/logo/MAPMODELOGO2.png");
  }

  function updateActivePage(){
    const p = getActivePage();
    $("#locLabel").textContent = p ? getGamePathLabel(p) : "No page selected";
    loadPageImage();
  }

  function loadPageImage(){
    const p = getActivePage();
    if(!p || !p.url){
      imgReady=false;
      requestDraw();
      return;
    }
    imgReady=false;
    img.onload = () => { imgReady=true; fitView(); requestDraw(); };
    img.onerror = () => { imgReady=false; requestDraw(); alert("Failed to load image URL:\n"+p.url); };
    img.src = p.url + (p.url.includes("?") ? "&" : "?") + "t=" + Date.now();
  }

  // ===== Load state.json =====
  async function loadState(){
    const res = await fetch(REMOTE_STATE_URL.toString(), {cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const data = await res.json();
    // minimal normalize
    data.view = data.view || {showLines:true};
    data.markerCategories = Array.isArray(data.markerCategories) ? data.markerCategories : [];
    data.pages = Array.isArray(data.pages) ? data.pages : [];
    data.categories = Array.isArray(data.categories) ? data.categories : [];
    data.markers = Array.isArray(data.markers) ? data.markers : [];
    data.links = Array.isArray(data.links) ? data.links : [];
    if(!data.activePageId && data.pages[0]) data.activePageId = data.pages[0].id;
    return data;
  }

  async function boot(){
    resize();
    try{
      state = await loadState();
    }catch(e){
      // If state.json missing, show minimal empty state
      state = safeParse(localStorage.getItem("mapmode_state_v99") || "null", null) || {
        version:1, logoUrl:"/assets/logo/MAPMODELOGO2.png",
        categories:[], pages:[], activePageId:null,
        markerCategories:[{id:"mcat-1", name:"Default", color:"#4da3ff", enabled:true, hideNumbers:false}],
        view:{showLines:true},
        markers:[], links:[]
      };
      alert("Could not load remote state.json.\nIndex will show local fallback if available.");
    }
    applyLogo();
    renderPages();
    renderMarkerCats();
    updateActivePage();

    $("#btnFit").addEventListener("click", fitView);
    $("#btnReload").addEventListener("click", async ()=>{
      state = await loadState();
      applyLogo();
      renderPages();
      renderMarkerCats();
      updateActivePage();
      requestDraw();
    });

    requestDraw();
  }

  boot();
})();
</script>
</body>
</html>
