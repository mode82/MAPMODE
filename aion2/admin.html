<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MAPMODE Â· ADMIN99</title>

  <style>
    :root{
      color-scheme: dark;

      --bg:#070b12;
      --panel:#0b1220cc;
      --card:#0e1626cc;

      --stroke:#1f2a3a;
      --stroke2:#27344a;

      --text:#e7eef8;
      --muted:#9fb0c6;

      --accent:#7cc4ff;
      --danger:#ff5d5d;
      --ok:#39d98a;
      --warn:#ffd60a;

      --r14:14px;
      --r16:16px;
      --r18:18px;

      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --shadow2: 0 8px 24px rgba(0,0,0,.35);
      --blur: 14px;

      --topH:58px;
      --sideW:320px;
      --sideW2:360px;

      /* âœ… [ADD] ìƒë‹¨ ìŠ¬ë¡¯ í­ */
      --topSlotW:170px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      overflow:hidden;
      background:
        radial-gradient(1200px 700px at 50% -10%, rgba(124,196,255,.18), transparent 55%),
        radial-gradient(900px 650px at 88% 10%, rgba(57,217,138,.12), transparent 55%),
        radial-gradient(900px 650px at 12% 10%, rgba(255,214,10,.08), transparent 55%),
        linear-gradient(180deg, #0a0f18 0%, var(--bg) 100%);
      color:var(--text);

      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", Arial, sans-serif;
      font-weight: 800;
      letter-spacing: .1px;
    }

    /* ========== TOPBAR ========== */
    .topbar{
      position:fixed; inset:0 0 auto 0;
      height:var(--topH);
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 14px;
      z-index:90;
      background: linear-gradient(180deg, rgba(9,14,23,.88), rgba(9,14,23,.58));
      backdrop-filter: blur(var(--blur));
      border-bottom:1px solid rgba(39,52,74,.65);
    }
    .top-left, .top-right{ display:flex; align-items:center; gap:10px; min-width:0; }

    .slot{
      height:38px;
      display:flex; align-items:center;
      padding:0 10px;
      border-radius:999px;
      background: rgba(14,22,38,.55);
      border:1px solid rgba(39,52,74,.65);
      box-shadow: var(--shadow2);
      gap:8px;
      white-space:nowrap;
    }
    .slot.fixed{ width:var(--topSlotW); justify-content:center; }

    .slot.logo{
      justify-content:flex-start;
      border:none;
      background: transparent;
      box-shadow:none;
      padding:0;
      width:var(--topSlotW);
    }
    .logoBox{
      width:var(--topSlotW); height:38px;
      border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      background: transparent;
      border:none;
      cursor:pointer;
      user-select:none;
    }
    .logoBox img{ height:26px; width:auto; display:block; opacity:.98; }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.5px; }
    .brand .word{ font-size:20px; line-height:1; display:flex; align-items:center; }
    .brand .word .o{
      display:inline-block;
      width:12px; height:12px; border-radius:999px;
      margin:0 2px;
      background:#fff;
      box-shadow: 0 0 0 2px rgba(255,255,255,.12);
      transform: translateY(1px);
    }

    .pill{
      height:34px;
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px;
      padding:0 12px;
      border-radius:999px;
      background: rgba(14,22,38,.55);
      border:1px solid rgba(39,52,74,.65);
      color:var(--text);
      box-shadow: var(--shadow2);
      cursor:pointer;
      user-select:none;
      text-decoration:none;
      font-weight:900;
    }
    .pill:hover{ border-color: rgba(124,196,255,.55); }
    .pill:active{ transform: translateY(1px); }
    .pill.small{ height:32px; padding:0 10px; font-size:13px; font-weight:900; }
    .pill.ghost{ background: rgba(14,22,38,.25); }
    .pill.danger{ border-color: rgba(255,93,93,.55); }
    .pill.ok{ border-color: rgba(57,217,138,.55); }

    /* âœ… ê²Œì„ ìŠ¬ë¡¯(ë‹¨ì¼) */
    .gameSlot{
      width:100%;
      height:38px;
      display:flex; align-items:center; justify-content:center;
      gap:8px;
      border-radius:999px;
      background: rgba(14,22,38,.35);
      border:1px solid rgba(39,52,74,.65);
      box-shadow: var(--shadow2);
      cursor:pointer;
      user-select:none;
      font-weight:900;
      font-size:14px;
      padding:0 12px;
    }
    .gameSlot:hover{ border-color: rgba(124,196,255,.55); }
    .gameSlot.active{
      /* âœ… (1) ë…¹ìƒ‰ ê°•ì¡° ì œê±°: ê¸°ì¡´ UI í†¤(ë¸”ë£¨ ê³„ì—´)ë¡œ ì•½í•˜ê²Œ ê°•ì¡° */
      border-color: rgba(124,196,255,.55);
      background: rgba(124,196,255,.08);
      box-shadow: var(--shadow2);
    }
    .gameSlot.static{
      cursor:default;
      opacity:.78;
      pointer-events:none;
    }

    /* âœ… (7) ìƒë‹¨ 4ìŠ¬ë¡¯: í™œì„±/ë¹„í™œì„± ì²´í¬ ë²„íŠ¼ */
    .gameSlot.gameItem{
      justify-content:space-between;
      padding:0 10px;
      gap:10px;
      min-width:0;
    }
    .gameSlot.gameItem .gNm{
      flex:1 1 auto;
      min-width:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-weight:900;
    }
    /* âœ… FIX: ì¹´í…Œê³ ë¦¬1(ì•„ì´ì˜¨2) í…ìŠ¤íŠ¸ëŠ” ... ê¸ˆì§€(ìë™ í°íŠ¸ ë§ì¶¤) */
    #gSlot1 .gNm{ text-overflow:clip; } /* âœ… FIX */

    .gEnBtn{
      flex:0 0 auto;
      width:34px;
      height:34px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color: rgba(231,238,248,.92);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-weight:900;
      font-size:14px;
      padding:0;
      user-select:none;
    }
    .gEnBtn.off{
      opacity:.75;
      border-color: rgba(255,93,93,.45);
    }
    .gameSlot.gameItem.off{
      opacity:.62;
    }

    /* âœ… ê²Œì„ ë“œë¡­ë‹¤ìš´ */
    .gameDropWrap{
      position:fixed;
      left:14px;
      top:calc(var(--topH) + 8px);
      width:calc(var(--topSlotW) + 20px);
      z-index:120;
      display:none;
    }
    .gameDropWrap.show{ display:block; }
    .gameDrop{
      width:100%;
      background: linear-gradient(180deg, rgba(14,22,38,.96), rgba(10,15,24,.92));
      border:1px solid rgba(39,52,74,.75);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(var(--blur));
    }
    .gameDropHead{
      padding:12px 12px 10px;
      border-bottom:1px solid rgba(39,52,74,.55);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .gameDropHead .t{ font-weight:900; font-size:13px; color:rgba(231,238,248,.92); }
    .gameDropList{ padding:10px; display:flex; flex-direction:column; gap:8px; }
    .gRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 10px;
      border-radius:16px;
      border:1px solid rgba(39,52,74,.6);
      background: rgba(14,22,38,.35);
      cursor:pointer;
      min-width:0;
    }
    .gRow.active{
      /* âœ… ë…¹ìƒ‰ ê³„ì—´ ì œê±° */
      outline:2px solid rgba(124,196,255,.25);
      border-color: rgba(124,196,255,.45);
      background: rgba(14,22,38,.55);
    }
    .gRow.off{
      opacity:.65;
    }
    .gRow .nm{
      font-weight:900;
      font-size:14px;
      flex:1 1 auto;
      min-width:0;
      white-space:nowrap;            /* âœ… FIX: í•œ ì¤„ ê³ ì • */
      overflow:visible;              /* âœ… FIX: ... ê¸ˆì§€(ì „ì²´ í…ìŠ¤íŠ¸ ë…¸ì¶œ) */
      text-overflow:clip;            /* âœ… FIX */
    }
    .gRow .acts{ display:flex; gap:8px; flex:0 0 auto; }
    .miniBtn{
      height:34px;
      padding:0 12px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color: rgba(231,238,248,.92);
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      display:flex; align-items:center; justify-content:center;
    }
    .miniBtn.icon{
      width:34px;
      padding:0;
    }
    .miniBtn.url{ border-color: rgba(57,217,138,.55); }
    .miniBtn.edit{ border-color: rgba(124,196,255,.55); }
    .miniBtn.del{ border-color: rgba(255,93,93,.55); }
    .miniBtn.en{ border-color: rgba(255,214,10,.55); }

    .top-right{ flex-wrap:wrap; justify-content:flex-end; }
    .top-right .pill{ flex: 0 0 auto; }

    /* ========== LAYOUT ========== */
    .layout{
      position:fixed;
      inset:var(--topH) 0 0 0;
      display:grid;
      grid-template-columns: var(--sideW) 1fr var(--sideW2);
      height:calc(100% - var(--topH));
      min-height: 0;
    }
    .side{
      overflow:hidden;
      border-right:1px solid rgba(39,52,74,.55);
      background: rgba(8,12,20,.35);
      backdrop-filter: blur(var(--blur));
      min-height:0;
    }
    .side.right{ border-right:none; border-left:1px solid rgba(39,52,74,.55); }

    .sideInner{
      height:100%;
      padding:12px;
      overflow:auto;
    }

    .card{
      background: rgba(14,22,38,.50);
      border:1px solid rgba(39,52,74,.6);
      border-radius: var(--r16);
      padding:12px;
      box-shadow: var(--shadow2);
    }
    .card + .card{ margin-top:12px; }

    .sectionTitle{
      font-size:12px;
      color: rgba(231,238,248,.9);
      margin:4px 0 10px 0;
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
    }
    .sectionTitle b{ font-weight:900; }
    .subtle{
      color: rgba(159,176,198,.92);
      font-size:12px;
      line-height:1.45;
      font-weight:800;
    }

    /* ========== LEFT: Pages ========== */
    .btnAddPage{
      width:100%;
      height:52px;
      border-radius:18px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(14,22,38,.35);
      color: rgba(231,238,248,.95);
      font-weight:900;
      cursor:pointer;
      box-shadow: var(--shadow2);
    }
    .btnAddPage:hover{ border-color: rgba(124,196,255,.55); }

    .pageList{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .pageItem{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 10px;
      border-radius: var(--r16);
      border:1px solid rgba(39,52,74,.6);
      background: rgba(14,22,38,.35);
      cursor:pointer;
    }
    .pageItem.active{
      outline:2px solid rgba(57,217,138,.35);
      border-color: rgba(57,217,138,.55);
      background: rgba(14,22,38,.55);
    }
    .pageName{ font-weight:900; font-size:16px; }
    .pageActions{ display:flex; align-items:center; gap:8px; flex:0 0 auto; }

    /* ========== CENTER: Canvas ========== */
    .center{
      position:relative;
      overflow:hidden;
      background:
        radial-gradient(900px 700px at 50% 15%, rgba(124,196,255,.08), transparent 60%),
        radial-gradient(900px 700px at 50% 80%, rgba(57,217,138,.05), transparent 60%);
      min-height:0;
    }
    .canvasWrap{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:16px;
    }
    canvas{ background: transparent; touch-action:none; }

    .hintToast{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      top:14px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.6);
      background: rgba(14,22,38,.55);
      color: rgba(231,238,248,.9);
      box-shadow: var(--shadow2);
      font-size:12px;
      display:none;
      z-index:40;
    }
    .hintToast.show{ display:block; }

    /* ========== RIGHT: Tools ========== */
    .chipRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .chip{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.6);
      background: rgba(10,15,24,.35);
      cursor:pointer;
      font-size:13px;
      user-select:none;
      font-weight:900;
    }
    .chip.on{ border-color: rgba(124,196,255,.6); background: rgba(124,196,255,.10); }
    .dotc{ width:10px; height:10px; border-radius:999px; box-shadow:0 0 0 2px rgba(255,255,255,.06); }

    .hr{ height:1px; background: rgba(39,52,74,.55); margin:12px 0; }

    .btnFull{
      width:100%;
      height:52px;
      border-radius:18px;
      font-weight:900;
      font-size:15px;
      justify-content:center;
    }

    .palette{
      display:flex; gap:12px; align-items:flex-start;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .sw{
      width:42px; height:42px;
      border-radius:14px;
      border:1px solid rgba(39,52,74,.65);
      box-shadow: var(--shadow2);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      position:relative;
      overflow:hidden;
      background: rgba(10,15,24,.35);
    }
    .sw::after{
      content:"";
      position:absolute; inset:6px;
      border-radius:10px;
      background: var(--c);
    }
    .swLabel{
      margin-top:6px;
      font-size:12px;
      text-align:center;
      color: rgba(231,238,248,.85);
      font-weight:900;
    }
    .swWrap{ display:flex; flex-direction:column; align-items:center; }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }

    .field{
      width:100%;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color: rgba(231,238,248,.95);
      outline:none;
      font-weight:900;
      font-size:14px;
    }
    textarea.field{ min-height:90px; resize:vertical; }

    .selectedBox .label{
      font-size:14px; font-weight:900; margin-bottom:8px;
    }
    .selectedBox .sub{
      font-size:12px; color: rgba(159,176,198,.92); font-weight:900;
      margin-top:10px;
    }

    /* ========== MODAL ========== */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:stretch;
      justify-content:stretch;
      z-index:200;
    }
    .modalBack.show{ display:flex; }
    .modal{
      margin:auto;
      width:min(1050px, calc(100vw - 28px));
      height:min(860px, calc(100vh - 28px));
      background: linear-gradient(180deg, rgba(14,22,38,.96), rgba(10,15,24,.92));
      border:1px solid rgba(39,52,74,.75);
      border-radius:22px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex; flex-direction:column;
    }
    .modalHead{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(39,52,74,.55);
    }
    .modalHead .title{ font-size:18px; font-weight:900; }
    .modalBody{
      padding:16px;
      overflow:auto;
      flex:1 1 auto;
    }
    .modalClose{
      height:40px;
      padding:0 14px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color: rgba(231,238,248,.92);
      cursor:pointer;
      font-weight:900;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    .labelRow{ color: rgba(159,176,198,.92); font-size:13px; font-weight:900; margin:10px 0 8px; }
    .checkRow{ display:flex; align-items:center; gap:10px; justify-content:flex-end; }
    .checkRow input{ width:18px; height:18px; accent-color:#a86bff; }
    .colorChip{
      width:46px; height:46px;
      border-radius:16px;
      border:1px solid rgba(39,52,74,.65);
      box-shadow: var(--shadow2);
      background: rgba(10,15,24,.35);
      position:relative;
      overflow:hidden;
    }
    .colorChip::after{ content:""; position:absolute; inset:7px; border-radius:12px; background: var(--c); }

    .styleGrid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      margin-top:14px;
    }
    .styleCard{
      border-radius:18px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      padding:14px;
      min-height:160px;
    }
    .styleCard h4{ margin:0 0 10px; font-size:18px; font-weight:900; }
    .rangeRow{ display:flex; align-items:center; gap:12px; }
    .rangeRow input[type="range"]{ width:100%; }
    .numBox{
      width:68px;
      text-align:center;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      padding:8px 10px;
      font-weight:900;
    }
    .fwSelect{ width:100%; }

    .quickTextColors{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .tSw{
      width:34px; height:34px;
      border-radius:12px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      box-shadow: var(--shadow2);
      cursor:pointer;
      position:relative;
      overflow:hidden;
    }
    .tSw::after{ content:""; position:absolute; inset:7px; border-radius:9px; background: var(--c); }

    .modalFoot{
      padding:14px 16px;
      border-top:1px solid rgba(39,52,74,.55);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .btnBig{
      height:46px;
      padding:0 16px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color: rgba(231,238,248,.95);
      font-weight:900;
      cursor:pointer;
    }
    .btnBig.danger{ border-color: rgba(255,93,93,.65); }
    .btnBig.ok{ border-color: rgba(57,217,138,.65); }

    /* ë§ˆì»¤ í°íŠ¸ */
    .markerFont{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-weight: 900;
      letter-spacing: 0;
    }

    /* ========== LOGIN OVERLAY ========== */
    .lock{
      position:fixed; inset:0;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center; justify-content:center;
      z-index:300;
    }
    .lock.show{ display:flex; }
    .lockBox{
      width:min(420px, calc(100vw - 28px));
      background: linear-gradient(180deg, rgba(14,22,38,.96), rgba(10,15,24,.92));
      border:1px solid rgba(39,52,74,.75);
      border-radius:22px;
      box-shadow: var(--shadow);
      padding:18px;
    }
    .lockBox h3{ margin:0 0 10px; font-size:18px; font-weight:900; }
    .lockBox p{ margin:0 0 14px; color:rgba(159,176,198,.92); font-size:13px; font-weight:900; }
    .lockRow{ display:flex; gap:10px; }
    .lockRow input{
      flex:1;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color: rgba(231,238,248,.95);
      outline:none;
      font-weight:900;
      font-size:14px;
    }

    /* ========== POPUP (prompt/confirm ëŒ€ì²´) ========== */
    .popLayer{
      position:fixed; inset:0;
      z-index:260;
      display:none;
    }
    .popLayer.show{ display:block; }
    .pop{
      position:absolute;
      width:min(380px, calc(100vw - 28px));
      background: linear-gradient(180deg, rgba(14,22,38,.96), rgba(10,15,24,.92));
      border:1px solid rgba(39,52,74,.75);
      border-radius:18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(var(--blur));
    }
    .popHead{
      padding:12px 12px 10px;
      border-bottom:1px solid rgba(39,52,74,.55);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .popHead .title{ font-size:13px; font-weight:900; color:rgba(231,238,248,.92); }
    .popBody{ padding:12px; }
    .popBody .msg{ color: rgba(159,176,198,.92); font-size:12px; line-height:1.45; font-weight:800; margin:0 0 10px; }
    .popFoot{
      padding:12px;
      border-top:1px solid rgba(39,52,74,.55);
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }
    .popFoot .btnBig{ height:40px; }

    /* ========== responsive ========== */
    @media (max-width: 1200px){
      body{ overflow:auto; }
      .layout{
        width: calc(var(--sideW) + 1000px + var(--sideW2));
        min-width: calc(var(--sideW) + 1000px + var(--sideW2));
      }
      .center{ min-width: 1000px; }
    }
    @media (max-width: 560px){
      :root{ --topSlotW:160px; }
      .slot.fixed{ width:var(--topSlotW); }
      .slot.logo{ width:var(--topSlotW); }
      .logoBox{ width:var(--topSlotW); }
      .gameSlot{ font-size:13px; }
      .gameDropWrap{ width:calc(var(--topSlotW) + 20px); }
    }
  </style>
</head>

<body>

  <!-- LOGIN LOCK -->
  <div class="lock" id="lock">
    <div class="lockBox">
      <h3>ê´€ë¦¬ì ì¸ì¦</h3>
      <p>ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë©´ <b>24ì‹œê°„</b> ì¸ì¦ì´ ìœ ì§€ë©ë‹ˆë‹¤.</p>
      <div class="lockRow">
        <input id="pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" />
        <button class="pill ok" id="btnLogin">ë¡œê·¸ì¸</button>
      </div>
      <div class="subtle" id="lockMsg" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- âœ… popup layer -->
  <div class="popLayer" id="popLayer" aria-hidden="true">
    <div class="pop" id="pop" role="dialog" aria-modal="true">
      <div class="popHead">
        <div class="title" id="popTitle">ì…ë ¥</div>
        <button class="modalClose" id="popClose" type="button">ë‹«ê¸°</button>
      </div>
      <div class="popBody" id="popBody">
        <p class="msg" id="popMsg" style="display:none;"></p>
        <input class="field" id="popInput" placeholder="" />
      </div>
      <div class="popFoot" id="popFoot">
        <button class="btnBig" id="popCancel" type="button">ì·¨ì†Œ</button>
        <button class="btnBig ok" id="popOk" type="button">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- TOPBAR -->
  <div class="topbar" id="topbar">
    <div class="top-left">
      <!-- Logo -->
      <div class="slot fixed logo">
        <div class="logoBox" id="logoBox" title="ë¡œê³  í´ë¦­ â†’ URL ì…ë ¥">
          <div class="brand"><div class="word">MAPM<span class="o"></span>DE</div></div>
        </div>
      </div>

      <!-- âœ… (2) ìƒë‹¨ ê²Œì„ ìŠ¬ë¡¯ 4ì¹¸ í‘œì‹œ -->
      <div class="slot fixed" style="padding:0; border:none; background:transparent; box-shadow:none;">
        <div class="gameSlot gameItem active" id="gSlot1" title="ê²Œì„ ì„ íƒ / í´ë¦­í•˜ì—¬ ê´€ë¦¬">ì•„ì´ì˜¨2</div>
      </div>

      <div class="slot fixed" style="padding:0; border:none; background:transparent; box-shadow:none;">
        <div class="gameSlot gameItem" id="gSlot2" title="ê²Œì„ ì„ íƒ / í´ë¦­í•˜ì—¬ ê´€ë¦¬">íŒ¨ìŠ¤ì˜¤ë¸Œì—‘ìì¼</div>
      </div>

      <div class="slot fixed" style="padding:0; border:none; background:transparent; box-shadow:none;">
        <div class="gameSlot gameItem" id="gSlot3" title="ê²Œì„ ì„ íƒ / í´ë¦­í•˜ì—¬ ê´€ë¦¬">ì¶”ê°€</div>
      </div>

      <div class="slot fixed" style="padding:0; border:none; background:transparent; box-shadow:none;">
        <div class="gameSlot gameItem" id="gSlot4" title="ê²Œì„ ì„ íƒ / í´ë¦­í•˜ì—¬ ê´€ë¦¬">ì¶”ê°€</div>
      </div>

      <!-- Admin label -->
      <div class="slot fixed">
        <div style="font-weight:900; color:rgba(57,217,138,.95);">ADMIN</div>
      </div>

      <!-- âœ… (3) ì§€ë„ ì—…ë¡œë“œ / state ë‚´ë³´ë‚´ê¸° / ì „ì²´ ì´ˆê¸°í™”: ê²Œì„ ìŠ¬ë¡¯ ë’¤ë¡œ ì´ë™ -->
      <div class="slot fixed" style="padding:0; border:none; background:transparent; box-shadow:none;">
        <label class="gameSlot" style="cursor:pointer;">
          ì§€ë„ ì—…ë¡œë“œ
          <input id="fileMap" type="file" accept="image/*" style="display:none;" />
        </label>
      </div>

      <div class="slot fixed" style="padding:0; border:none; background:transparent; box-shadow:none;">
        <div class="gameSlot" id="btnExport">state ë‚´ë³´ë‚´ê¸°</div>
      </div>

      <div class="slot fixed" style="padding:0; border:none; background:transparent; box-shadow:none;">
        <div class="gameSlot" id="btnResetAll" style="border-color:rgba(255,93,93,.55);">ì „ì²´ ì´ˆê¸°í™”</div>
      </div>
    </div>

    <div class="top-right">
      <span class="pill small ghost" title="í˜„ì¬ í˜ì´ì§€">
        ê´€ë¦¬ì
        <span style="opacity:.7;">/</span>
        <span id="pathGameTop">ì•„ì´ì˜¨2</span>
      </span>
    </div>
  </div>

  <!-- âœ… ê²Œì„ ë“œë¡­ë‹¤ìš´ -->
  <div class="gameDropWrap" id="gameDropWrap">
    <div class="gameDrop" id="gameDrop">
      <div class="gameDropHead">
        <div class="t">ê²Œì„ ëª©ë¡</div>
        <button class="pill small ghost" id="btnAddGameDrop" type="button">+ ì¶”ê°€</button>
      </div>
      <div class="gameDropList" id="gameDropList"></div>
    </div>
  </div>

  <div class="layout">
    <!-- LEFT -->
    <aside class="side left">
      <div class="sideInner">
        <div class="card">
          <div class="sectionTitle">
            <span>í˜ì´ì§€</span>
            <span class="subtle"><b id="pathGame">ì•„ì´ì˜¨2</b> / <b id="pathPage">ì „ì²´ì§€ë„</b></span>
          </div>

          <button class="btnAddPage" id="btnAddPage">+ í˜ì´ì§€ ì¶”ê°€</button>

          <div class="subtle" style="margin-top:10px;">
            â€¢ í˜ì´ì§€ ë²„íŠ¼ í´ë¦­ â†’ ê°™ì€ ê²Œì„ ì•ˆì—ì„œ ì§€ë„ í˜ì´ì§€ ì´ë™<br/>
            â€¢ í°/ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œë„ ì§€ë„ ë³´ì´ê²Œ í•˜ë ¤ë©´: ê´€ë¦¬ìì—ì„œ URL ë²„íŠ¼ìœ¼ë¡œ ì§€ë„ ì´ë¯¸ì§€ URL ì„¤ì •
          </div>

          <div class="pageList" id="pageList"></div>
        </div>
      </div>
    </aside>

    <!-- CENTER -->
    <main class="center">
      <div class="hintToast" id="toast"></div>
      <div class="canvasWrap">
        <canvas id="cv" width="1200" height="900"></canvas>
      </div>
    </main>

    <!-- RIGHT -->
    <aside class="side right">
      <div class="sideInner">

        <!-- ì¹´í…Œê³ ë¦¬ -->
        <div class="card">
          <div class="sectionTitle">
            <span>ì¹´í…Œê³ ë¦¬</span>
            <span class="subtle">í•„í„°</span>
          </div>

          <div class="chipRow" id="catChips"></div>

          <div class="subtle" id="kpi" style="margin-top:10px;">í‘œì‹œ ì¤‘ ë§ˆì»¤: 0 / í˜ì´ì§€ ì „ì²´: 0</div>

          <button class="pill btnFull ghost" id="btnEditCats" style="margin-top:10px;">ì¹´í…Œê³ ë¦¬/ìƒ‰ìƒ í¸ì§‘</button>
        </div>

        <!-- ê´€ë¦¬ì íˆ´ -->
        <div class="card">
          <div class="sectionTitle">
            <span>ê´€ë¦¬ì íˆ´</span>
            <span class="subtle">â€¢ ìƒ‰ìƒ íŒ”ë ˆíŠ¸(ì¹´í…Œê³ ë¦¬ 1ë²ˆ ê¸°ì¤€ ì „íŒŒ)<br/>â€¢ ì„ ì€ ê°™ì€ í˜ì´ì§€ ë§ˆì»¤(ë²ˆí˜¸ ìˆœ)ë¡œ ìë™ í‘œì‹œ</span>
          </div>

          <div class="subtle" style="margin-top:8px;">ë¹ ë¥¸ ìƒ‰ìƒ (ì› ìƒ‰ìƒ ì˜¤ë²„ë¼ì´ë“œ)</div>
          <div class="palette" id="palette"></div>

          <div class="row2">
            <button class="pill btnFull ghost" id="btnApplyQuick" disabled>ì„ íƒ ë§ˆì»¤ì— ì ìš©</button>
            <button class="pill btnFull ghost" id="btnUseCatColor" disabled>ì„ íƒ ë§ˆì»¤ ìƒ‰ìƒ(ì¹´í…Œê³ ë¦¬ë¡œ)</button>
          </div>

          <div class="hr"></div>

          <div class="row2">
            <button class="pill btnFull danger" id="btnClearLines">ì„  ìˆ¨ê¹€</button>
            <button class="pill btnFull ghost" id="btnRechain">ì„  ë‹¤ì‹œ í‘œì‹œ</button>
          </div>

          <div class="hr"></div>

          <button class="pill btnFull danger" id="btnResetMarkers" style="border-color:rgba(255,93,93,.65);">ë§ˆì»¤ ì´ˆê¸°í™”</button>

          <div class="hr"></div>

          <div class="selectedBox" style="margin-top:6px;">
            <div class="label">ì„ íƒí•œ ë§ˆì»¤: <span id="selName">(ì´ë¦„ ì—†ìŒ)</span></div>
            <div class="sub">ìœ íŠœë¸Œ ë§í¬</div>
            <input class="field" id="selLink" placeholder="ìœ íŠœë¸Œ" />
            <div class="sub">ìœ íŠœë¸Œ í‘œì‹œëª…</div>
            <input class="field" id="selYtTitle" placeholder="ìœ íŠœë¸Œ í‘œì‹œëª…" />
            <div style="margin-top:10px;">
              <button class="pill btnFull ghost" id="btnOpenMarkerEdit" disabled>ë§ˆì»¤ í¸ì§‘ ì—´ê¸°</button>
            </div>
          </div>
        </div>

      </div>
    </aside>
  </div>

  <!-- MARKER EDIT MODAL -->
  <div class="modalBack" id="mMarker">
    <div class="modal">
      <div class="modalHead">
        <div>
          <div class="title">ë§ˆì»¤ í¸ì§‘</div>
          <div class="subtle" style="margin-top:6px;">ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ í¸ì§‘/ì‚­ì œ ê°€ëŠ¥í•©ë‹ˆë‹¤. (Enter = ì €ì¥)</div>
        </div>
        <button class="modalClose" id="btnCloseMarker">ë‹«ê¸°</button>
      </div>

      <div class="modalBody">
        <div class="grid2">
          <div>
            <div class="labelRow">ì´ë¦„(ë§ˆì»¤ ì´ë¦„)</div>
            <input class="field" id="mfName" placeholder="ì˜ˆ: ê¸°í…” ìœ„ì¹˜" />
          </div>
          <div>
            <div class="labelRow">ì¹´í…Œê³ ë¦¬</div>
            <select class="field" id="mfCat"></select>
          </div>
        </div>

        <div class="labelRow" style="margin-top:12px;">ë§ˆì»¤ ì› ìƒ‰ìƒ</div>
        <div style="display:flex; align-items:center; gap:12px; justify-content:space-between;">
          <input class="field" id="mfColor" placeholder="ê°œë³„ ì˜¤ë²„ë¼ì´ë“œ ìƒ‰ìƒ (ì˜ˆ: #ff0000)" />
          <div style="display:flex; align-items:center; gap:10px;">
            <div class="colorChip" id="mfColorChip" style="--c:#2b8cff;"></div>
            <div class="checkRow">
              <input type="checkbox" id="mfUseCatColor" />
              <label for="mfUseCatColor" class="subtle" style="cursor:pointer;">ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì‚¬ìš©</label>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="grid2">
          <div>
            <div class="labelRow">ìœ íŠœë¸Œ ë§í¬(URL)</div>
            <input class="field" id="mfYt" placeholder="https://www.youtube.com/..." />
          </div>
          <div>
            <div class="labelRow">ìœ íŠœë¸Œ í‘œì‹œëª…(ìœ ì €ëª¨ë“œ ì œëª©)</div>
            <input class="field" id="mfYtTitle" placeholder="ì˜ˆ: ê¸°í…” 1ë²ˆìœ„ì¹˜" />
          </div>
        </div>

        <div class="labelRow" style="margin-top:12px;">ë©”ëª¨ (ê´€ë¦¬ì ë“±ë¡)</div>
        <textarea class="field" id="mfMemo" placeholder="ê´€ë¦¬ì ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ìœ ì € ëª¨ë“œì—ì„œëŠ” ì½ê¸° ì „ìš©ì…ë‹ˆë‹¤."></textarea>

        <div class="hr"></div>

        <div class="labelRow">ë§ˆì»¤ ìŠ¤íƒ€ì¼</div>
        <div class="styleGrid">
          <div class="styleCard">
            <h4>ì› í¬ê¸° <span class="subtle" style="float:right;">px</span></h4>
            <div class="rangeRow">
              <!-- âœ… (2) mfR ìµœì†Œê°’ ë²”ìœ„ í™•ì¥: ê¸°ì¡´ ìµœì†Œ(4) ëŒ€ë¹„ 50% ë” ì‘ê²Œ(2) -->
              <input type="range" id="mfR" min="2" max="40" step="1" />
              <div class="numBox" id="mfRVal">10</div>
            </div>
            <div class="subtle" style="margin-top:10px;">* ì› í¬ê¸° ë³€ê²½ ì‹œ ê¸€ì”¨ í¬ê¸°ê°€ ê°™ì€ ë¹„ìœ¨ë¡œ ìë™ ë³€ê²½ë©ë‹ˆë‹¤.</div>
          </div>

          <div class="styleCard">
            <h4>ê¸€ì”¨ í¬ê¸° <span class="subtle" style="float:right;">ë¼ë²¨</span></h4>
            <div class="rangeRow">
              <!-- âœ… (6) mfFs ë²”ìœ„: ìµœì†Œ=ê¸°ì¡´ì˜ ì ˆë°˜(8â†’4), ìµœëŒ€=ê¸°ì¡´ì˜ 2ë°°(40â†’80) -->
              <input type="range" id="mfFs" min="4" max="80" step="1" />
              <div class="numBox" id="mfFsVal">15</div>
            </div>
            <div class="subtle" style="margin-top:10px;">* í˜„ì¬ëŠ” ìë™ ë™ê¸°í™” ìš°ì„ </div>
          </div>

          <div class="styleCard">
            <h4>êµµê¸°/ìƒ‰ìƒ <span class="subtle" style="float:right;">ë¼ë²¨</span></h4>
            <select class="field fwSelect" id="mfFw">
              <option value="900">900 (Black)</option>
              <option value="800">800 (ExtraBold)</option>
              <option value="700">700 (Bold)</option>
              <option value="600">600 (SemiBold)</option>
            </select>

            <div class="labelRow" style="margin-top:10px;">ê¸€ì”¨ ìƒ‰ìƒ (ë¼ë²¨)</div>
            <div style="display:flex; gap:10px; align-items:center;">
              <input class="field" style="flex:1;" id="mfLabelColor" placeholder="#e7eef8" />
              <button class="btnBig" id="mfLabelDefault" type="button">ê¸°ë³¸ê°’</button>
            </div>

            <div class="labelRow" style="margin-top:10px;">ë¹ ë¥¸ ê¸€ì”¨ìƒ‰</div>
            <div class="quickTextColors" id="textColors"></div>
          </div>
        </div>

        <div class="subtle" id="mfPos" style="margin-top:12px;">ì¢Œí‘œ(ë¹„ìœ¨): -</div>
      </div>

      <div class="modalFoot">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btnBig" id="btnNewChain">ìƒˆë¡œìš´ ë²ˆí˜¸ë¡œ ì‹œì‘</button>
          <button class="btnBig" id="btnInsertAfter">í•´ë‹¹ ë§ˆì»¤ë¥¼ ì´ì–´ì„œ ì‹œì‘</button>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-left:auto;">
          <button class="btnBig danger" id="btnDeleteMarker">ì‚­ì œ</button>
          <button class="btnBig ok" id="btnSaveMarker">ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CATEGORY EDIT MODAL -->
  <div class="modalBack" id="mCats">
    <div class="modal">
      <div class="modalHead">
        <div class="title">ì¹´í…Œê³ ë¦¬/ìƒ‰ìƒ í¸ì§‘</div>
        <button class="modalClose" id="btnCloseCats">ë‹«ê¸°</button>
      </div>

      <div class="modalBody">
        <div class="subtle">ì €ì¥í•˜ë©´ í˜„ì¬ ê²Œì„ì˜ ì¹´í…Œê³ ë¦¬ ëª©ë¡ì´ ì™„ì „íˆ êµì²´ë©ë‹ˆë‹¤.</div>

        <div class="hr"></div>

        <div class="sectionTitle" style="margin-top:0;">
          <span>ì¹´í…Œê³ ë¦¬ ì˜µì…˜</span>
          <span class="subtle">í‘œì‹œ/í•„í„°</span>
        </div>

        <div class="chipRow" style="gap:10px;">
          <div class="chip" id="tgShowChainSameCat">
            <div class="dotc" style="background:#fff;"></div>
            <div>ê°™ì€ ì¹´í…Œê³ ë¦¬ í•„í„° ì‹œ ì„ ë„ ê°™ì´ í‘œì‹œ/ìˆ¨ê¹€</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="labelRow" style="margin-top:14px;">ë¹ ë¥¸ ìƒ‰ìƒ (ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ í–‰ì— ì ìš©)</div>
        <div class="palette" id="catQuickPalette" style="margin-top:10px;"></div>
        <div class="subtle" style="margin-top:8px;">ì¹´í…Œê³ ë¦¬ í–‰ì„ ë¨¼ì € í´ë¦­í•´ì„œ ì„ íƒí•˜ì„¸ìš”.</div>

        <div class="hr"></div>

        <div class="row2">
          <button class="pill btnFull ghost" id="btnAddCat">+ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</button>
          <button class="pill btnFull ghost" id="btnCatsDefault">ê¸°ë³¸ê°’ìœ¼ë¡œ</button>
        </div>

        <div class="hr"></div>

        <div id="catRows"></div>
      </div>

      <div class="modalFoot" style="justify-content:flex-end;">
        <button class="btnBig ok" id="btnSaveCats">ì €ì¥</button>
      </div>
    </div>
  </div>

<script>
(() => {
  /************************************************************
   * ADMIN99 ì €ì¥ ê·œì¹™
   ************************************************************/
  const LS_AUTH_KEY = "mapmode_admin_auth_v99";
  const LS_KEY = "mapmode_state_v99";
  const REMOTE_STATE_URL = new URL("./data/state.json", location.href).toString();
  const PASSWORD = "0000000001";
  const AUTH_MS = 24 * 60 * 60 * 1000;

  const defaultCats = [
    { id:"ì „ì²´", name:"ì „ì²´", color:"#7cc4ff", on:true },
    { id:"ë³´ìŠ¤", name:"ë³´ìŠ¤", color:"#ff5d5d", on:true },
    { id:"ê¸°í…”", name:"ê¸°í…”", color:"#ffd60a", on:true },
    { id:"íë¸Œ", name:"íë¸Œ", color:"#2b8cff", on:true },
  ];

  const defaultState = {
    version:99,
    game:"ì•„ì´ì˜¨2",
    logoUrl:"",
    games:["ì•„ì´ì˜¨2"],
    pages: [
      { id:"p_all", name:"ì „ì²´ì§€ë„", url:"" },
      { id:"p_2", name:"2ë²ˆë§ˆì„", url:"" },
      { id:"p_3", name:"3ë²ˆë§ˆì„", url:"" },
      { id:"p_4", name:"4ë²ˆë§ˆì„", url:"" },
      { id:"p_5", name:"5ë²ˆë§ˆì„", url:"" },
      { id:"p_6", name:"6ë²ˆë§ˆì„", url:"" },
      { id:"p_7", name:"7ë²ˆë§ˆì„", url:"" },
    ],
    currentPageId:"p_all",
    categories: structuredClone(defaultCats),
    showLinesWithCatFilter:true,
    map:{ imgDataUrl:"", naturalW:1, naturalH:1, scale:0, tx:0, ty:0 },
    markers:[],
    chains:[]
  };

  const $ = (id)=>document.getElementById(id);
  const cv = $("cv");
  const ctx = cv.getContext("2d");

  const toastEl = $("toast");
  const lock = $("lock");
  const pw = $("pw");
  const btnLogin = $("btnLogin");
  const lockMsg = $("lockMsg");

  const pageList = $("pageList");
  const catChips = $("catChips");
  const palette = $("palette");
  const textColors = $("textColors");
  const mMarker = $("mMarker");
  const mCats = $("mCats");

  // game dropdown
  const gSlot1 = $("gSlot1");
  const gSlot2 = $("gSlot2");
  const gSlot3 = $("gSlot3");
  const gSlot4 = $("gSlot4");
  const gameDropWrap = $("gameDropWrap");
  const gameDropList = $("gameDropList");
  const btnAddGameDrop = $("btnAddGameDrop");

  // popup
  const popLayer = $("popLayer");
  const pop = $("pop");
  const popTitle = $("popTitle");
  const popMsg = $("popMsg");
  const popInput = $("popInput");
  const popBody = $("popBody");
  const popOk = $("popOk");
  const popCancel = $("popCancel");
  const popClose = $("popClose");
  const popFoot = $("popFoot");

  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const safeParse = (json, fallback) => { try{ return JSON.parse(json); }catch(e){ return fallback; } };
  const uid = () => Math.random().toString(36).slice(2,10);

  function toast(msg, ms=1200){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>toastEl.classList.remove("show"), ms);
  }

  function isAuthed(){
    const t = Number(localStorage.getItem(LS_AUTH_KEY) || "0");
    return (Date.now() - t) < AUTH_MS;
  }
  function setAuthed(){
    localStorage.setItem(LS_AUTH_KEY, String(Date.now()));
  }

  function requireAuth(){
    if(isAuthed()){
      lock.classList.remove("show");
      return;
    }
    lock.classList.add("show");
    pw.value = "";
    lockMsg.textContent = "";
    setTimeout(()=>pw.focus(), 0);
  }

  btnLogin.addEventListener("click", ()=>{
    if(pw.value === PASSWORD){
      setAuthed();
      lock.classList.remove("show");
      toast("ì¸ì¦ ì™„ë£Œ");
    }else{
      lockMsg.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      toast("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
    }
  });
  pw.addEventListener("keydown", (e)=>{
    if(e.key==="Enter") btnLogin.click();
  });

  // ---------- popup helpers (prompt/confirm ëŒ€ì²´) ----------
  let _popResolve = null;
  let _popMode = "input"; // input | confirm
  function popCloseAll(){
    popLayer.classList.remove("show");
    popLayer.setAttribute("aria-hidden","true");
    if(_popResolve){
      const r = _popResolve;
      _popResolve = null;
      r(null);
    }
  }
  function popPlaceNear(anchorEl){
    const pad = 10;
    const r = anchorEl ? anchorEl.getBoundingClientRect() : {left: (window.innerWidth/2), top:(window.innerHeight/2), width:0, height:0, right:(window.innerWidth/2), bottom:(window.innerHeight/2)};
    const popW = Math.min(380, window.innerWidth - 28);
    pop.style.width = popW + "px";

    // estimate height
    const estH = (_popMode==="confirm") ? 170 : 210;
    let x = r.left;
    let y = r.bottom + 10;

    // prefer below, else above
    if(y + estH > window.innerHeight - pad){
      y = Math.max(pad, r.top - estH - 10);
    }
    // align left but clamp
    x = clamp(x, pad, window.innerWidth - popW - pad);
    pop.style.left = x + "px";
    pop.style.top = y + "px";
  }

  function openPopInput({anchor, title="ì…ë ¥", message="", placeholder="", value="", okText="ì €ì¥", cancelText="ì·¨ì†Œ"}){
    requireAuth(); if(!isAuthed()) return Promise.resolve(null);

    _popMode = "input";
    popTitle.textContent = title;
    popMsg.style.display = message ? "block" : "none";
    popMsg.textContent = message || "";
    popInput.style.display = "block";
    popInput.placeholder = placeholder || "";
    popInput.value = value ?? "";
    popOk.textContent = okText;
    popCancel.textContent = cancelText;
    popOk.classList.remove("danger");
    popOk.classList.add("ok");
    popFoot.style.display = "flex";

    popLayer.classList.add("show");
    popLayer.setAttribute("aria-hidden","false");
    popPlaceNear(anchor);
    setTimeout(()=>popInput.focus(), 0);

    return new Promise((res)=>{
      _popResolve = res;
    });
  }

  function openPopConfirm({anchor, title="í™•ì¸", message="ì •ë§ ì§„í–‰í• ê¹Œìš”?", okText="í™•ì¸", cancelText="ì·¨ì†Œ", danger=false}){
    requireAuth(); if(!isAuthed()) return Promise.resolve(false);

    _popMode = "confirm";
    popTitle.textContent = title;
    popMsg.style.display = "block";
    popMsg.textContent = message || "";
    popInput.style.display = "none";
    popOk.textContent = okText;
    popCancel.textContent = cancelText;
    popFoot.style.display = "flex";

    if(danger){
      popOk.classList.remove("ok");
      popOk.classList.add("danger");
    }else{
      popOk.classList.remove("danger");
      popOk.classList.add("ok");
    }

    popLayer.classList.add("show");
    popLayer.setAttribute("aria-hidden","false");
    popPlaceNear(anchor);

    return new Promise((res)=>{
      _popResolve = (v)=>res(!!v);
    });
  }

  function popCommit(val){
    if(!_popResolve) return;
    const r = _popResolve;
    _popResolve = null;
    popLayer.classList.remove("show");
    popLayer.setAttribute("aria-hidden","true");
    r(val);
  }

  popClose.addEventListener("click", ()=>popCommit(null));
  popCancel.addEventListener("click", ()=>popCommit(null));
  popOk.addEventListener("click", ()=>{
    if(_popMode==="confirm"){ popCommit(true); return; }
    popCommit(popInput.value);
  });

  popLayer.addEventListener("mousedown", (e)=>{
    if(e.target === popLayer) popCommit(null);
  });

  window.addEventListener("keydown", (e)=>{
    if(!popLayer.classList.contains("show")) return;
    if(e.key==="Escape"){ e.preventDefault(); popCommit(null); }
    if(e.key==="Enter"){
      if(_popMode==="confirm"){ e.preventDefault(); popCommit(true); }
      else{
        if(document.activeElement === popInput){ e.preventDefault(); popCommit(popInput.value); }
      }
    }
  });

  // ---------- state ----------
  let S = structuredClone(defaultState);
  let mapImg = new Image();
  mapImg.crossOrigin = "anonymous";

  // âœ… (7) í˜„ì¬ í˜ì´ì§€ì—ì„œ ìš°í´ë¦­ ì¶”ê°€ ì‹œ ì´ì–´ì§ˆ "í˜„ì¬ ì²´ì¸" (chainId ì‚¬ìš©)
  const currentChainByPage = Object.create(null);

  function mergeState(st){
    const merged = structuredClone(defaultState);
    if(st && typeof st === "object") Object.assign(merged, st);
    merged.pages = Array.isArray(st?.pages) && st.pages.length ? st.pages : structuredClone(defaultState.pages);
    merged.categories = Array.isArray(st?.categories) && st.categories.length ? st.categories : structuredClone(defaultCats);
    merged.markers = Array.isArray(st?.markers) ? st.markers : [];
    merged.chains = Array.isArray(st?.chains) ? st.chains : [];
    merged.map = Object.assign(structuredClone(defaultState.map), st?.map||{});
    merged.games = Array.isArray(st?.games) && st.games.length ? st.games : ["ì•„ì´ì˜¨2"];
    if(!merged.pages.find(p=>p.id===merged.currentPageId)) merged.currentPageId = merged.pages[0].id;
    if(!merged.games.includes(merged.game)) merged.game = merged.games[0];

    // v99+: marker order/dim
    for(const m of merged.markers){
      if(typeof m.order !== "number") m.order = (typeof m.chainIndex==="number" ? m.chainIndex : null);
      if(typeof m.dim !== "boolean") m.dim = false;
      if(m.order == null) m.order = 0;

      // âœ… chainId (ê¸°ì¡´ í•„ë“œ í™œìš©): ì—†ìœ¼ë©´ null ìœ ì§€
      if(typeof m.chainId === "undefined") m.chainId = null;
    }
    return merged;
  }

  function saveLocal(){
    localStorage.setItem(LS_KEY, JSON.stringify(S));
  }

  async function loadStateRemoteFirst(){
    try{
      const r = await fetch(REMOTE_STATE_URL, { cache:"no-store" });
      if(r.ok){
        const st = await r.json();
        localStorage.setItem(LS_KEY, JSON.stringify(st));
        return st;
      }
    }catch(e){}
    const raw = localStorage.getItem(LS_KEY);
    return raw ? safeParse(raw, structuredClone(defaultState)) : structuredClone(defaultState);
  }

  // ---------- logo ----------
  const logoBox = $("logoBox");
  function renderLogo(){
    logoBox.innerHTML = "";
    if(S.logoUrl){
      const img = document.createElement("img");
      img.src = S.logoUrl;
      img.alt = "logo";
      img.onerror = () => {
        logoBox.innerHTML = `<div class="brand"><div class="word">MAPM<span class="o"></span>DE</div></div>`;
      };
      logoBox.appendChild(img);
    }else{
      logoBox.innerHTML = `<div class="brand"><div class="word">MAPM<span class="o"></span>DE</div></div>`;
    }
  }
  logoBox.addEventListener("click", async (e)=>{
    requireAuth();
    if(!isAuthed()) return;

    const cur = S.logoUrl || "";
    const next = await openPopInput({
      anchor: logoBox,
      title: "ë¡œê³  URL ì„¤ì •",
      message: "ë¡œê³  ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”. ë¹„ìš°ë©´ ê¸°ë³¸ ë¡œê³ ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.",
      placeholder: "https://... (ë¹„ìš°ë©´ ê¸°ë³¸)",
      value: cur,
      okText: "ì €ì¥",
      cancelText: "ì·¨ì†Œ"
    });
    if(next === null) return;
    S.logoUrl = (next || "").trim();
    saveLocal();
    renderLogo();
    toast("ë¡œê³  ì„¤ì • ì €ì¥");
  });

  // ---------- games helpers (enabled flag via string suffix) ----------
  function parseGameRaw(raw){
    const s = String(raw ?? "");
    const m = s.match(/^(.*)\|([01])$/);
    if(m){
      return { raw:s, name:m[1], enabled: m[2] === "1" };
    }
    return { raw:s, name:s, enabled:true };
  }
  function buildGameRaw(name, enabled){
    const nm = String(name ?? "").trim();
    if(!nm) return "";
    return enabled ? nm : (nm + "|0");
  }
  function setGameRawAtIndex(i, newRaw){
    if(i < 0 || i >= (S.games||[]).length) return;
    const prevRaw = S.games[i];
    S.games[i] = newRaw;
    if(S.game === prevRaw) S.game = newRaw;
  }
  function escapeHtml(s){
    return String(s ?? "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#39;");
  }

  // âœ… FIX: ì¹´í…Œê³ ë¦¬1(ì•„ì´ì˜¨2) í°íŠ¸ ìë™ ë§ì¶¤(í•œ ì¤„/ì˜ë¦¼/â€¦ ê¸ˆì§€)
  function fitSlot1Text(){ // âœ… FIX
    const slot = gSlot1; // âœ… FIX
    if(!slot) return; // âœ… FIX
    const nm = slot.querySelector(".gNm"); // âœ… FIX
    if(!nm) return; // âœ… FIX
    const btn = slot.querySelector(".gEnBtn"); // âœ… FIX
    const pad = 18; // âœ… FIX
    const avail = Math.max(10, slot.clientWidth - (btn ? btn.offsetWidth : 0) - pad); // âœ… FIX

    nm.style.whiteSpace = "nowrap"; // âœ… FIX
    nm.style.overflow = "hidden"; // âœ… FIX
    nm.style.textOverflow = "clip"; // âœ… FIX

    const minFs = 10; // âœ… FIX
    const maxFs = 18; // âœ… FIX
    let lo = minFs, hi = maxFs, best = minFs; // âœ… FIX

    for(let i=0;i<12;i++){ // âœ… FIX
      const mid = (lo + hi) / 2; // âœ… FIX
      nm.style.fontSize = mid + "px"; // âœ… FIX
      if(nm.scrollWidth <= avail){ // âœ… FIX
        best = mid; lo = mid; // âœ… FIX
      }else{
        hi = mid; // âœ… FIX
      }
    }
    nm.style.fontSize = Math.floor(best) + "px"; // âœ… FIX
  }

  // ---------- games dropdown ----------
  function setGameActive(raw){
    S.game = raw;
    $("pathGameTop").textContent = parseGameRaw(S.game).name || "ì•„ì´ì˜¨2";
    $("pathGame").textContent = parseGameRaw(S.game).name || "ì•„ì´ì˜¨2";
    saveLocal();
    renderGamesTop();
    toast("ê²Œì„ ë³€ê²½");
  }

  function renderGamesTop(){
    const slots = [gSlot1,gSlot2,gSlot3,gSlot4];
    for(let i=0;i<slots.length;i++){
      const el = slots[i];
      const raw = (S.games && S.games[i]) ? S.games[i] : "";
      if(raw){
        const info = parseGameRaw(raw);
        el.classList.toggle("active", raw === S.game);
        el.classList.toggle("off", !info.enabled);
        el.innerHTML = `
          <span class="gNm" title="${escapeHtml(info.name)}">${escapeHtml(info.name)}</span>
          <button class="gEnBtn${info.enabled ? "" : " off"}" type="button" title="í™œì„±/ë¹„í™œì„±">${info.enabled ? "âœ“" : "â€“"}</button>
        `;
      }else{
        el.classList.remove("active");
        el.classList.add("off");
        el.innerHTML = `
          <span class="gNm" style="opacity:.7;">ì¶”ê°€</span>
          <button class="gEnBtn off" type="button" title="ë¹„í™œì„±" disabled>â€“</button>
        `;
      }
    }
    $("pathGameTop").textContent = parseGameRaw(S.game).name || "ì•„ì´ì˜¨2";
    $("pathGame").textContent = parseGameRaw(S.game).name || "ì•„ì´ì˜¨2";
    fitSlot1Text(); // âœ… FIX
  }

  function toggleGameEnabledByRaw(raw){
    const idx = (S.games||[]).indexOf(raw);
    if(idx < 0) return;
    const info = parseGameRaw(raw);
    const nextRaw = buildGameRaw(info.name, !info.enabled);
    setGameRawAtIndex(idx, nextRaw);
    saveLocal();
    renderGamesTop();
    renderGameDropList();
    toast(!info.enabled ? "í™œì„±í™”" : "ë¹„í™œì„±í™”");
  }

  function renderGameDropList(){
    gameDropList.innerHTML = "";
    for(const g of (S.games||[])){
      const info = parseGameRaw(g);
      const row = document.createElement("div");
      row.className = "gRow" + (g===S.game ? " active" : "") + (!info.enabled ? " off" : "");
      row.innerHTML = `
        <div class="nm" title="${String(info.name).replace(/"/g,'&quot;')}">${escapeHtml(info.name)}</div>
        <div class="acts">
          <!-- âœ… FIX: ë“œë¡­ë‹¤ìš´ ëª©ë¡ ë‚´ë¶€ í™œì„±/ë¹„í™œì„± í† ê¸€ ì œê±° -->
          <button class="miniBtn icon edit" type="button" title="ì´ë¦„ í¸ì§‘">âœ</button>
          <button class="miniBtn icon del" type="button" title="ì‚­ì œ">ğŸ—‘</button>
        </div>
      `;

      row.addEventListener("click", (e)=>{
        const btn = e.target.closest("button");
        if(btn) return;
        setGameActive(g);
        closeGameDrop();
        renderPages();
        renderCats();
        renderKpi();
        draw();
      });

      const bEdit = row.querySelector(".edit");
      const bDel = row.querySelector(".del");

      bEdit.addEventListener("click", async (e)=>{
        e.stopPropagation();
        const nn = await openPopInput({
          anchor: bEdit,
          title: "ê²Œì„ ì´ë¦„ í¸ì§‘",
          message: "ê²Œì„ ì´ë¦„ì„ ìˆ˜ì •í•˜ì„¸ìš”.",
          placeholder: "ì˜ˆ: ì•„ì´ì˜¨2",
          value: info.name,
          okText: "ì €ì¥",
          cancelText: "ì·¨ì†Œ"
        });
        if(nn === null) return;
        const name = (nn||"").trim();
        if(!name) return;

        const exists = (S.games||[]).some(x=>{
          if(x === g) return false;
          return parseGameRaw(x).name === name;
        });
        if(exists){
          toast("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²Œì„");
          return;
        }

        const idx = (S.games||[]).indexOf(g);
        if(idx>=0){
          const nextRaw = buildGameRaw(name, info.enabled);
          setGameRawAtIndex(idx, nextRaw);
        }
        saveLocal();
        renderGamesTop();
        renderGameDropList();
        toast("ê²Œì„ ì´ë¦„ ìˆ˜ì •");
      });

      bDel.addEventListener("click", async (e)=>{
        e.stopPropagation();
        if((S.games||[]).length <= 1){
          toast("ìµœì†Œ 1ê°œ ê²Œì„ì€ í•„ìš”í•©ë‹ˆë‹¤");
          return;
        }
        const ok = await openPopConfirm({
          anchor: bDel,
          title: "ê²Œì„ ì‚­ì œ",
          message: `"${info.name}" ê²Œì„ì„ ì‚­ì œí• ê¹Œìš”?\n(ê²Œì„ ëª©ë¡ì—ì„œë§Œ ì œê±°ë©ë‹ˆë‹¤)`,
          okText: "ì‚­ì œ",
          cancelText: "ì·¨ì†Œ",
          danger: true
        });
        if(!ok) return;

        S.games = (S.games||[]).filter(x=>x!==g);
        if(S.game === g) S.game = S.games[0] || "ì•„ì´ì˜¨2";
        saveLocal();
        renderGamesTop();
        renderGameDropList();
        toast("ê²Œì„ ì‚­ì œ");
      });

      gameDropList.appendChild(row);
    }
  }

  let _gameDropAnchorEl = null;

  // âœ… FIX: ë“œë¡­ë‹¤ìš´ ë„ˆë¹„ë¥¼ "í…ìŠ¤íŠ¸ ì „ì²´ ë…¸ì¶œ" ìš°ì„ ìœ¼ë¡œ ê³„ì‚°
  function computeGameDropNeedWidth(){ // âœ… FIX
    let maxNeed = 0; // âœ… FIX
    const rows = gameDropList.querySelectorAll(".gRow"); // âœ… FIX
    for(const r of rows){ // âœ… FIX
      const nm = r.querySelector(".nm"); // âœ… FIX
      if(!nm) continue; // âœ… FIX
      const acts = r.querySelector(".acts"); // âœ… FIX
      const need = (nm.scrollWidth || 0) + (acts ? acts.offsetWidth : 0) + 40; // âœ… FIX
      maxNeed = Math.max(maxNeed, need); // âœ… FIX
    }
    return maxNeed || 0; // âœ… FIX
  }

  function placeGameDropUnderSlot(anchor, desiredW){ // âœ… FIX
    const anchorEl = anchor || gSlot1;
    const r = anchorEl.getBoundingClientRect();
    const baseW = Math.min((anchorEl.offsetWidth || r.width) + 20, window.innerWidth - 28);
    const w = Math.min(Math.max((desiredW || baseW), 220), window.innerWidth - 28); // âœ… FIX
    gameDropWrap.style.width = w + "px";
    const left = clamp(r.left, 14, window.innerWidth - w - 14);
    const top = r.bottom + 8;
    gameDropWrap.style.left = left + "px";
    gameDropWrap.style.top = top + "px";
  }

  function openGameDrop(anchor){
    requireAuth(); if(!isAuthed()) return;
    _gameDropAnchorEl = anchor || gSlot1;
    renderGameDropList();
    placeGameDropUnderSlot(_gameDropAnchorEl);
    gameDropWrap.classList.add("show");
    requestAnimationFrame(()=>{ // âœ… FIX
      const need = computeGameDropNeedWidth(); // âœ… FIX
      if(need) placeGameDropUnderSlot(_gameDropAnchorEl, need); // âœ… FIX
    });
  }
  function closeGameDrop(){
    gameDropWrap.classList.remove("show");
  }
  function toggleGameDrop(anchor){
    if(gameDropWrap.classList.contains("show")) closeGameDrop();
    else openGameDrop(anchor);
  }

  function onTopSlotClickFactory(slotEl, slotIndex){
    slotEl.addEventListener("click", (e)=>{
      requireAuth(); if(!isAuthed()) return;
      const btn = e.target.closest(".gEnBtn");
      const raw = (S.games && S.games[slotIndex]) ? S.games[slotIndex] : "";
      if(btn){
        e.stopPropagation();
        if(!raw) return;
        toggleGameEnabledByRaw(raw);
        return;
      }
      toggleGameDrop(slotEl);
    });
  }
  onTopSlotClickFactory(gSlot1, 0);
  onTopSlotClickFactory(gSlot2, 1);
  onTopSlotClickFactory(gSlot3, 2);
  onTopSlotClickFactory(gSlot4, 3);

  window.addEventListener("resize", ()=>{
    if(gameDropWrap.classList.contains("show")) placeGameDropUnderSlot(_gameDropAnchorEl || gSlot1, computeGameDropNeedWidth() || undefined); // âœ… FIX
    fitSlot1Text(); // âœ… FIX
  });

  // ë°”ê¹¥ í´ë¦­ / ESC ë‹«ê¸°
  document.addEventListener("mousedown", (e)=>{
    if(!gameDropWrap.classList.contains("show")) return;
    if(e.target.closest("#gameDropWrap")) return;
    if(e.target.closest("#gSlot1") || e.target.closest("#gSlot2") || e.target.closest("#gSlot3") || e.target.closest("#gSlot4")) return;
    closeGameDrop();
  });
  window.addEventListener("keydown", (e)=>{
    if(e.key==="Escape" && gameDropWrap.classList.contains("show")) closeGameDrop();
  });

  btnAddGameDrop.addEventListener("click", async (e)=>{
    requireAuth(); if(!isAuthed()) return;
    const nn = await openPopInput({
      anchor: btnAddGameDrop,
      title: "ê²Œì„ ì¶”ê°€",
      message: "ì¶”ê°€í•  ê²Œì„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.",
      placeholder: "ì˜ˆ: íŒ¨ìŠ¤ì˜¤ë¸Œì—‘ìì¼",
      value: "",
      okText: "ì¶”ê°€",
      cancelText: "ì·¨ì†Œ"
    });
    if(nn === null) return;
    const name = (nn||"").trim();
    if(!name) return;

    const exists = (S.games||[]).some(x=>parseGameRaw(x).name === name);
    if(exists){
      toast("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²Œì„");
      return;
    }

    const raw = buildGameRaw(name, true);
    S.games.push(raw);
    S.game = raw;
    saveLocal();
    renderGamesTop();
    renderGameDropList();
    toast("ê²Œì„ ì¶”ê°€");
  });

  // ---------- pages ----------
  function renderPages(){
    pageList.innerHTML = "";
    const cur = S.pages.find(p=>p.id===S.currentPageId) || S.pages[0];
    $("pathPage").textContent = cur ? cur.name : "ì „ì²´ì§€ë„";

    for(const p of S.pages){
      const item = document.createElement("div");
      item.className = "pageItem" + (p.id===S.currentPageId ? " active" : "");
      item.innerHTML = `
        <div class="pageName">${p.name}</div>
        <div class="pageActions">
          <button class="miniBtn url" type="button" title="ì§€ë„ ì´ë¯¸ì§€ URL ì„¤ì •">URL</button>
          <button class="miniBtn icon edit" type="button" title="ì´ë¦„ í¸ì§‘">âœ</button>
          <button class="miniBtn icon del" type="button" title="ì‚­ì œ">ğŸ—‘</button>
        </div>
      `;
      item.addEventListener("click", (e)=>{
        const btn = e.target.closest("button");
        if(btn) return;
        S.currentPageId = p.id;
        saveLocal();
        renderPages();
        renderKpi();
        loadMap();

        applyAllCatStylesOnPage(S.currentPageId); // âœ… FIX
        applyAllChainStylesOnPage(S.currentPageId); // âœ… FIX
        saveLocal(); // âœ… FIX

        draw();
      });

      const bUrl = item.querySelector(".url");
      const bEdit = item.querySelector(".edit");
      const bDel = item.querySelector(".del");

      bUrl.addEventListener("click", async (e)=>{
        e.stopPropagation();
        requireAuth();
        if(!isAuthed()) return;
        const next = await openPopInput({
          anchor: bUrl,
          title: "í˜ì´ì§€ ì§€ë„ URL",
          message: "ì´ í˜ì´ì§€ ì§€ë„ ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”. (Raw/GitHub Pages URL ê°€ëŠ¥)",
          placeholder: "https://.../map.png",
          value: p.url || "",
          okText: "ì €ì¥",
          cancelText: "ì·¨ì†Œ"
        });
        if(next === null) return;
        p.url = (next || "").trim();
        saveLocal();
        toast("í˜ì´ì§€ URL ì €ì¥");
        if(p.id === S.currentPageId) loadMap();
      });

      bEdit.addEventListener("click", async (e)=>{
        e.stopPropagation();
        requireAuth();
        if(!isAuthed()) return;
        const next = await openPopInput({
          anchor: bEdit,
          title: "í˜ì´ì§€ ì´ë¦„ í¸ì§‘",
          message: "í˜ì´ì§€ ì´ë¦„ì„ ìˆ˜ì •í•˜ì„¸ìš”.",
          placeholder: "ì˜ˆ: 8ë²ˆë§ˆì„",
          value: p.name,
          okText: "ì €ì¥",
          cancelText: "ì·¨ì†Œ"
        });
        if(next === null) return;
        const name = (next||"").trim();
        if(!name) return;
        p.name = name;
        saveLocal();
        renderPages();
        toast("í˜ì´ì§€ ì´ë¦„ ìˆ˜ì •");
      });

      bDel.addEventListener("click", async (e)=>{
        e.stopPropagation();
        requireAuth();
        if(!isAuthed()) return;
        if(S.pages.length <= 1){ toast("ìµœì†Œ 1ê°œ í˜ì´ì§€ëŠ” í•„ìš”í•©ë‹ˆë‹¤"); return; }
        const ok = await openPopConfirm({
          anchor: bDel,
          title: "í˜ì´ì§€ ì‚­ì œ",
          message: `"${p.name}" í˜ì´ì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?\n(í•´ë‹¹ í˜ì´ì§€ ë§ˆì»¤ë„ ê°™ì´ ì‚­ì œë©ë‹ˆë‹¤)`,
          okText: "ì‚­ì œ",
          cancelText: "ì·¨ì†Œ",
          danger: true
        });
        if(!ok) return;

        const pid = p.id;
        S.markers = S.markers.filter(m=>m.pageId !== pid);
        S.pages = S.pages.filter(x=>x.id !== pid);
        if(S.currentPageId === pid) S.currentPageId = S.pages[0].id;

        saveLocal();
        renderPages();
        renderKpi();
        loadMap();
        draw();
        toast("í˜ì´ì§€ ì‚­ì œ");
      });

      pageList.appendChild(item);
    }
  }

  $("btnAddPage").addEventListener("click", async (e)=>{
    requireAuth();
    if(!isAuthed()) return;
    const name = await openPopInput({
      anchor: $("btnAddPage"),
      title: "í˜ì´ì§€ ì¶”ê°€",
      message: "ì¶”ê°€í•  í˜ì´ì§€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: 8ë²ˆë§ˆì„)",
      placeholder: "ì˜ˆ: 8ë²ˆë§ˆì„",
      value: "",
      okText: "ì¶”ê°€",
      cancelText: "ì·¨ì†Œ"
    });
    if(name === null) return;
    const n = (name||"").trim();
    if(!n) return;

    const p = { id:"p_"+uid(), name:n, url:"" };
    S.pages.push(p);
    S.currentPageId = p.id;
    saveLocal();
    renderPages();
    renderKpi();
    loadMap();
    draw();
    toast("í˜ì´ì§€ ì¶”ê°€");
  });

  // ---------- categories ----------
  function getCat(id){ return S.categories.find(c=>c.id===id); }
  function markerColor(m){
    if(!m) return "#7cc4ff";
    if(m.useCatColor){
      const c = getCat(m.cat);
      return (c && c.color) ? c.color : "#7cc4ff";
    }
    if(m.colorOverride && m.colorOverride.trim()) return m.colorOverride.trim();
    const c = getCat(m.cat);
    return (c && c.color) ? c.color : "#7cc4ff";
  }

  function renderCats(){
    catChips.innerHTML = "";
    for(const c of S.categories){
      const chip = document.createElement("div");
      chip.className = "chip" + (c.on ? " on" : "");
      chip.innerHTML = `<div class="dotc" style="background:${c.color};"></div><div>${c.name}</div>`;
      chip.addEventListener("click", ()=>{
        requireAuth();
        if(!isAuthed()) return;

        if(c.id === "ì „ì²´"){ // âœ… FIX: "ì „ì²´"ëŠ” ì „ì²´ ë§ˆì»¤ í‘œì‹œ/ìˆ¨ê¹€ í† ê¸€(ë§ˆìŠ¤í„°)
          const nextOn = !c.on; // âœ… FIX
          c.on = nextOn; // âœ… FIX
          if(nextOn){
            for(const cc of S.categories){ if(cc.id!=="ì „ì²´") cc.on = true; } // âœ… FIX: ì¼°ì„ ë•Œ ì „ë¶€ ë‹¤ì‹œ ë³´ì´ê²Œ
          }
        }else{
          c.on = !c.on;
        }

        if(!S.categories.some(x=>x.on)){
          c.on = true;
          toast("ìµœì†Œ 1ê°œ ì¹´í…Œê³ ë¦¬ëŠ” ì¼œì ¸ì•¼ í•©ë‹ˆë‹¤");
        }
        saveLocal();
        renderCats();
        renderKpi();
        draw();
      });
      catChips.appendChild(chip);
    }
  }

  function setChipToggle(el, on){
    el.classList.toggle("on", !!on);
    el.dataset.on = on ? "1" : "0";
  }

  const tgShowLinesWithCatFilter = $("tgShowChainSameCat");
  tgShowLinesWithCatFilter.addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    S.showLinesWithCatFilter = !S.showLinesWithCatFilter;
    setChipToggle(tgShowLinesWithCatFilter, S.showLinesWithCatFilter);
    saveLocal();
    draw();
  });

  function ensureCat(name, color){
    if(S.categories.some(c=>c.id===name)) return;
    S.categories.push({ id:name, name, color:color||"#ffffff", on:true });
    renderCats();
  }

  // ---------- map upload ----------
  $("fileMap").addEventListener("change", async (e)=>{
    requireAuth();
    if(!isAuthed()) return;
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const dataUrl = await fileToDataURL(f);
    S.map.imgDataUrl = dataUrl;
    saveLocal();
    loadMap();
    toast("ì§€ë„ ì—…ë¡œë“œ ì™„ë£Œ");
    e.target.value = "";
  });

  function fileToDataURL(file){
    return new Promise((res, rej)=>{
      const fr = new FileReader();
      fr.onload = ()=>res(fr.result);
      fr.onerror = rej;
      fr.readAsDataURL(file);
    });
  }

  function loadMap(){
    const curPage = S.pages.find(p => p.id === S.currentPageId);
    const pageUrl = (curPage?.url || "").trim();

    if(pageUrl){
      mapImg = new Image();
      mapImg.crossOrigin = "anonymous";
      mapImg.onload = ()=>{
        S.map.naturalW = mapImg.naturalWidth || 1;
        S.map.naturalH = mapImg.naturalHeight || 1;
        fitToScreen();
        saveLocal();
        draw();
        renderKpi();
      };
      mapImg.onerror = ()=>{
        toast("ì§€ë„ URL ë¡œë“œ ì‹¤íŒ¨");
        draw();
      };
      mapImg.src = pageUrl;
      return;
    }

    if(S.map.imgDataUrl){
      mapImg = new Image();
      mapImg.crossOrigin = "anonymous";
      mapImg.onload = ()=>{
        S.map.naturalW = mapImg.naturalWidth || 1;
        S.map.naturalH = mapImg.naturalHeight || 1;
        if(!S.map.scale || S.map.scale<=0) fitToScreen();
        draw();
      };
      mapImg.src = S.map.imgDataUrl;
      return;
    }

    mapImg = new Image();
    mapImg.onload = ()=>draw();
    mapImg.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(
      `<svg xmlns="http://www.w3.org/2000/svg" width="1400" height="1000">
        <defs>
          <radialGradient id="g" cx="50%" cy="40%" r="70%">
            <stop offset="0%" stop-color="#ffffff"/>
            <stop offset="100%" stop-color="#e8edf7"/>
          </radialGradient>
        </defs>
        <rect width="100%" height="100%" fill="url(#g)"/>
        <text x="50%" y="50%" text-anchor="middle" font-family="Arial" font-size="28" fill="#7a889e">í˜ì´ì§€ URL ë˜ëŠ” ì§€ë„ ì—…ë¡œë“œê°€ í•„ìš”</text>
      </svg>`
    );
  }

  // ---------- export ----------
  $("btnExport").addEventListener("click", ()=>{
    requireAuth();
    if(!isAuthed()) return;

    const blob = new Blob([JSON.stringify(S, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "state.json";
    a.click();
    URL.revokeObjectURL(a.href);
    toast("state.json ë‹¤ìš´ë¡œë“œ");
  });

  $("btnResetAll").addEventListener("click", async (e)=>{
    requireAuth();
    if(!isAuthed()) return;
    const ok = await openPopConfirm({
      anchor: $("btnResetAll"),
      title: "ì „ì²´ ì´ˆê¸°í™”",
      message: "ì „ì²´ ì´ˆê¸°í™”í• ê¹Œìš”?\n(í˜ì´ì§€/ë§ˆì»¤/ì§€ë„ í¬í•¨)",
      okText: "ì´ˆê¸°í™”",
      cancelText: "ì·¨ì†Œ",
      danger: true
    });
    if(!ok) return;

    S = structuredClone(defaultState);
    saveLocal();
    renderAll();
    loadMap();
    toast("ì „ì²´ ì´ˆê¸°í™” ì™„ë£Œ");
  });

  // ---------- canvas sizing ----------
  function resizeCanvas(){
    const wrap = cv.parentElement;
    const w = wrap.clientWidth - 32;
    const h = wrap.clientHeight - 32;
    cv.width = Math.max(900, Math.floor(w));
    cv.height = Math.max(650, Math.floor(h));
  }
  window.addEventListener("resize", ()=>{ resizeCanvas(); draw(); });

  function fitToScreen(){
    const pad = 40;
    const iw = S.map.naturalW || (mapImg.naturalWidth||1);
    const ih = S.map.naturalH || (mapImg.naturalHeight||1);
    const cw = cv.width, ch = cv.height;
    const scale = Math.min((cw - pad)/iw, (ch - pad)/ih);
    S.map.scale = clamp(scale, 0.05, 10);
    S.map.tx = (cw - iw*S.map.scale)/2;
    S.map.ty = (ch - ih*S.map.scale)/2;
  }

  // ---------- marker data ----------
  function renumberPage(pageId){
    const ms = (S.markers||[]).filter(m=>m.pageId===pageId);
    ms.sort((a,b)=>(a.order||0)-(b.order||0) || (a.id>b.id?1:-1));
    for(let i=0;i<ms.length;i++){
      ms[i].order = i+1;
    }
  }

  function getVisibleMarkers(){
    const curPage = S.currentPageId;
    const allCat = getCat("ì „ì²´"); // âœ… FIX
    if(allCat && allCat.on === false) return []; // âœ… FIX: "ì „ì²´" OFFë©´ ì „ë¶€ ìˆ¨ê¹€

    const onCats = new Set(S.categories.filter(c=>c.on).map(c=>c.id));
    const allOn = onCats.has("ì „ì²´");
    return (S.markers||[]).filter(m=>{
      if(m.pageId !== curPage) return false;

      // âœ… (6) "ì „ì²´"ê°€ ONì´ì–´ë„ ê°œë³„ ì¹´í…Œê³ ë¦¬ OFFê°€ í•­ìƒ ìš°ì„ 
      if(allOn){
        const c = getCat(m.cat);
        if(c && c.on === false) return false;
        return true;
      }
      return onCats.has(m.cat);
    }).sort((a,b)=>(a.order||0)-(b.order||0));
  }

  function renderKpi(){
    const curPage = S.currentPageId;
    const total = (S.markers||[]).filter(m=>m.pageId===curPage).length;
    const shown = getVisibleMarkers().length;
    $("kpi").textContent = `í‘œì‹œ ì¤‘ ë§ˆì»¤: ${shown} / í˜ì´ì§€ ì „ì²´: ${total}`;
  }

  // ---------- chain helpers (ë²ˆí˜¸/ì„  ë¶„ë¦¬) ----------
  function ensureMarkerChain(m){
    if(!m.chainId) m.chainId = "c0";
    return m.chainId;
  }
  function getPageMarkersSorted(pageId){
    return (S.markers||[]).filter(m=>m.pageId===pageId).slice().sort((a,b)=>(a.order||0)-(b.order||0) || (a.id>b.id?1:-1));
  }
  function getChainMarkersOnPage(pageId, chainId){
    const ms = getPageMarkersSorted(pageId).filter(m=>ensureMarkerChain(m)===chainId);
    return ms;
  }
  function recomputeChainIndices(pageId){
    const ms = getPageMarkersSorted(pageId);
    const byChain = new Map();
    for(const m of ms){
      const cid = ensureMarkerChain(m);
      if(!byChain.has(cid)) byChain.set(cid, []);
      byChain.get(cid).push(m);
    }
    for(const [cid, arr] of byChain){
      for(let i=0;i<arr.length;i++){
        arr[i].chainIndex = i+1;
      }
    }
  }
  function getActiveChainIdForPage(pageId){
    const v = currentChainByPage[pageId];
    if(v) return v;
    const ms = getPageMarkersSorted(pageId);
    const last = ms[ms.length-1];
    const cid = last ? ensureMarkerChain(last) : "c0";
    currentChainByPage[pageId] = cid;
    return cid;
  }
  function setActiveChainIdForPage(pageId, cid){
    currentChainByPage[pageId] = cid;
  }

  // ---------- style propagation (ì¹´í…Œê³ ë¦¬ 1ë²ˆ ê¸°ì¤€ ì „íŒŒ) ----------
  function leaderOfCat(pageId, catId){
    const ms = (S.markers||[]).filter(m=>m.pageId===pageId && m.cat===catId);
    if(!ms.length) return null;
    ms.sort((a,b)=>(a.order||0)-(b.order||0));
    return ms[0];
  }

  function applyCatLeaderStyle(pageId, catId){
    const leader = leaderOfCat(pageId, catId);
    if(!leader) return;
    const ms = (S.markers||[]).filter(m=>m.pageId===pageId && m.cat===catId);
    for(const m of ms){
      if(m.id===leader.id) continue;
      m.r = leader.r;
      m.fs = leader.fs;
      m.fw = leader.fw;
      m.labelColor = leader.labelColor;
      m.useCatColor = leader.useCatColor;
      m.colorOverride = leader.colorOverride || "";
    }
  }

  function applyAllCatStylesOnPage(pageId){
    const cats = new Set((S.markers||[]).filter(m=>m.pageId===pageId).map(m=>m.cat));
    for(const catId of cats) applyCatLeaderStyle(pageId, catId);
  }

  // âœ… FIX: ì²´ì¸(ì„ ìœ¼ë¡œ ì´ì–´ì§„ ê·¸ë£¹) ìŠ¤íƒ€ì¼ì€ í•­ìƒ 1ë²ˆ ë§ˆì»¤(ì²´ì¸ ë¦¬ë”)ì™€ ë™ì¼
  function leaderOfChain(pageId, chainId){ // âœ… FIX
    const ms = getChainMarkersOnPage(pageId, chainId).slice(); // âœ… FIX
    if(!ms.length) return null; // âœ… FIX
    ms.sort((a,b)=>(a.order||0)-(b.order||0) || (a.id>b.id?1:-1)); // âœ… FIX
    return ms[0]; // âœ… FIX
  }
  function applyChainLeaderStyle(pageId, chainId){ // âœ… FIX
    const ms = getChainMarkersOnPage(pageId, chainId).slice(); // âœ… FIX
    if(ms.length < 2) return; // âœ… FIX
    ms.sort((a,b)=>(a.order||0)-(b.order||0) || (a.id>b.id?1:-1)); // âœ… FIX
    const leader = ms[0]; // âœ… FIX
    const leaderCol = markerColor(leader); // âœ… FIX
    for(let i=1;i<ms.length;i++){ // âœ… FIX
      const m = ms[i]; // âœ… FIX
      m.r = leader.r; // âœ… FIX
      m.fs = leader.fs; // âœ… FIX
      m.fw = leader.fw; // âœ… FIX
      m.labelColor = leader.labelColor; // âœ… FIX
      // âœ… FIX: ìƒ‰ìƒë„ ë¦¬ë”ì™€ ë™ì¼(ì²´ì¸ ë‚´ ê°œë³„ ìƒ‰ìƒ ê¸ˆì§€)
      m.useCatColor = false; // âœ… FIX
      m.colorOverride = leaderCol; // âœ… FIX
    }
  }
  function applyAllChainStylesOnPage(pageId){ // âœ… FIX
    const ms = getPageMarkersSorted(pageId); // âœ… FIX
    const chainIds = new Set(); // âœ… FIX
    for(const m of ms) chainIds.add(ensureMarkerChain(m)); // âœ… FIX
    for(const cid of chainIds) applyChainLeaderStyle(pageId, cid); // âœ… FIX
  }

  // ---------- auto label (ì²´ì¸ 1ë²ˆ í…ìŠ¤íŠ¸ ê¸°ë°˜) ----------
  function splitBaseAndNumber(name){
    const s = (name||"").trim();

    // âœ… (5) "1ë²ˆ ê¹ƒí„¸" / "12ë²ˆ ã…‡ã…‡" íŒ¨í„´: ë§¨ ì• ìˆ«ì + (ê³µë°±) + ë²ˆ + ë‚˜ë¨¸ì§€
    const mFront = s.match(/^(\s*)(\d+)(\s*)ë²ˆ(.*)$/);
    if(mFront){
      const num = parseInt(mFront[2], 10);
      if(Number.isFinite(num)) return { kind:"front_bun", pre:mFront[1]||"", num, mid:mFront[3]||"", rest:mFront[4]||"" };
    }

    // âœ… (5) ë ìˆ«ì íŒ¨í„´: "ê¹ƒí„¸1", "ê¹ƒí„¸ 1"
    const mTail = s.match(/^(.*?)(\d+)(\s*)$/);
    if(mTail){
      const num = parseInt(mTail[2], 10);
      if(Number.isFinite(num)) return { kind:"tail", base:(mTail[1]||""), num, tailSpace:(mTail[3]||"") };
    }

    return { kind:"none", raw:s };
  }
  function makeAutoNameFromLeader(leaderName, idx){
    const info = splitBaseAndNumber(leaderName);
    const leaderIdx = 1;
    const delta = Math.max(0, (idx||1) - leaderIdx);

    if(info.kind === "front_bun"){
      const nextNum = info.num + delta;
      return `${info.pre}${nextNum}${info.mid}ë²ˆ${info.rest}`;
    }
    if(info.kind === "tail"){
      const nextNum = info.num + delta;
      return `${info.base}${nextNum}${info.tailSpace}`;
    }

    return `${(leaderName||"").trim()}${idx}`;
  }
  function applyAutoNamesForChainOnPage(pageId, chainId){
    const ms = getChainMarkersOnPage(pageId, chainId);
    if(!ms.length) return;
    const leader = ms[0];
    const leaderName = (leader.name||"").trim();
    if(!leaderName) return;
    for(let i=1;i<ms.length;i++){
      const m = ms[i];
      if((m.name||"").trim()) continue; // âœ… ìˆ˜ë™ìœ¼ë¡œ ì´ë¦„ì´ ìˆìœ¼ë©´ ë®ì–´ì“°ê¸° ê¸ˆì§€
      const idx = (m.chainIndex || (i+1));
      m.name = makeAutoNameFromLeader(leaderName, idx);
    }
  }

  // ---------- drawing ----------
  function worldFromNorm(nx, ny){
    const iw = S.map.naturalW || (mapImg.naturalWidth||1);
    const ih = S.map.naturalH || (mapImg.naturalHeight||1);
    return { x:nx*iw, y:ny*ih };
  }
  function screenFromWorld(wx, wy){
    return { sx: wx*S.map.scale + S.map.tx, sy: wy*S.map.scale + S.map.ty };
  }

  let circleHitboxes = []; // {id,sx,sy,rPx}
  function drawArrowheadWorld(x1,y1,x2,y2, sizeWorld){
    const dx = x2-x1, dy = y2-y1;
    const len = Math.hypot(dx,dy);
    if(len < 1e-6) return;
    const ux = dx/len, uy = dy/len;
    const px = -uy, py = ux;

    const tipX = x2, tipY = y2;
    const backX = x2 - ux*sizeWorld;
    const backY = y2 - uy*sizeWorld;
    const wing = sizeWorld*0.55;

    ctx.beginPath();
    ctx.moveTo(tipX, tipY);
    ctx.lineTo(backX + px*wing, backY + py*wing);
    ctx.lineTo(backX - px*wing, backY - py*wing);
    ctx.closePath();
    ctx.fill();
  }

  function draw(){
    ctx.clearRect(0,0,cv.width,cv.height);
    circleHitboxes = [];

    ctx.save();
    ctx.fillStyle = "rgba(0,0,0,.22)";
    ctx.fillRect(0,0,cv.width,cv.height);
    ctx.restore();

    ctx.save();
    ctx.translate(S.map.tx, S.map.ty);
    ctx.scale(S.map.scale, S.map.scale);

    if(mapImg && mapImg.complete){
      const iw = S.map.naturalW || (mapImg.naturalWidth||1);
      const ih = S.map.naturalH || (mapImg.naturalHeight||1);
      ctx.drawImage(mapImg, 0,0, iw, ih);
    }

    const visible = getVisibleMarkers();
    const onCats = new Set(S.categories.filter(c=>c.on).map(c=>c.id));
    const allOn = onCats.has("ì „ì²´");

    // âœ… chainIndex ìµœì‹ í™”
    recomputeChainIndices(S.currentPageId);

    // âœ… (7) ì„ ì€ ì²´ì¸ë³„ë¡œë§Œ í‘œì‹œ(ìƒˆë¡œìš´ ë²ˆí˜¸ë¡œ ì‹œì‘ ì‹œ ì—°ê²° ê¸ˆì§€)
    if(S.showLinesWithCatFilter){
      const byChain = new Map();
      for(const m of visible){
        const cid = ensureMarkerChain(m);
        if(!byChain.has(cid)) byChain.set(cid, []);
        byChain.get(cid).push(m);
      }

      for(const [cid, ms] of byChain){
        ms.sort((a,b)=>(a.order||0)-(b.order||0));
        if(ms.length < 2) continue;

        // âœ… FIX: í™”ì‚´í‘œ/ì„  êµµê¸°/í™”ì‚´ì´‰ í¬ê¸°/ê°„ê²©ì´ ë§ˆì»¤ ë¹„ìœ¨ + ì¤Œì— ê°™ì´ ì¤„ì–´ë“¤ë„ë¡(world ê¸°ì¤€)
        const baseR = ms.reduce((acc,m)=>acc + (m.r ?? 10), 0) / Math.max(1, ms.length); // âœ… FIX
        const lineW = clamp(baseR * 0.18, 0.9, 2.4); // âœ… FIX (world)
        const arrowSize = clamp(baseR * 0.95, 4.5, 18); // âœ… FIX (world)

        ctx.save();
        ctx.globalAlpha = 0.92;

        ctx.lineWidth = lineW; // âœ… FIX
        ctx.strokeStyle = "rgba(255,255,255,.78)";
        ctx.fillStyle = "rgba(255,255,255,.78)";
        ctx.beginPath();
        for(let i=0;i<ms.length;i++){
          const p = worldFromNorm(ms[i].x, ms[i].y);
          if(i===0) ctx.moveTo(p.x, p.y);
          else ctx.lineTo(p.x, p.y);
        }
        ctx.stroke();

        for(let i=0;i<ms.length-1;i++){
          const a = worldFromNorm(ms[i].x, ms[i].y);
          const b = worldFromNorm(ms[i+1].x, ms[i+1].y);
          const ar = (ms[i].r ?? 10);
          const br = (ms[i+1].r ?? 10);

          const dx = b.x-a.x, dy = b.y-a.y;
          const len = Math.hypot(dx,dy);
          if(len < 1e-6) continue;
          const ux = dx/len, uy = dy/len;

          // âœ… (3) í™”ì‚´í‘œ ëì´ ë‹¤ìŒ ë§ˆì»¤ ì› í…Œë‘ë¦¬ì— ì •í™•íˆ ë‹¿ë„ë¡ (stroke ë°˜ì˜, +3 ì œê±°)
          const halfStroke = (lineW * 0.5); // âœ… FIX
          const endX = b.x - ux*(br + halfStroke);
          const endY = b.y - uy*(br + halfStroke);
          const startX = a.x + ux*(ar + halfStroke);
          const startY = a.y + uy*(ar + halfStroke);

          if(Math.hypot(endX-startX, endY-startY) < 10) continue;
          drawArrowheadWorld(startX, startY, endX, endY, arrowSize); // âœ… FIX
        }
        ctx.restore();
      }
    }

    // markers
    for(const m of visible){
      const p = worldFromNorm(m.x, m.y);
      const r = (m.r ?? 10);
      const col = markerColor(m);

      ctx.save();
      ctx.globalAlpha = m.dim ? 0.30 : 1;
      ctx.beginPath();
      ctx.arc(p.x, p.y, r, 0, Math.PI*2);
      ctx.fillStyle = col;
      ctx.fill();
      ctx.lineWidth = 2 / S.map.scale;
      ctx.strokeStyle = "rgba(0,0,0,.35)";
      ctx.stroke();
      ctx.restore();

      // âœ… (1) ìˆ«ì(fontSize)ëŠ” ì›(r)ê³¼ ë™ì¼ ìŠ¤ì¼€ì¼ ë¹„ìœ¨ë¡œ í•­ìƒ ë™ê¸°í™” + ì¤‘ì•™ ìœ ì§€ (ì¶•ì†Œ ì‹œ íŠ€ì–´ë‚˜ì˜´ ë°©ì§€)
      const num = (typeof m.chainIndex === "number" && m.chainIndex > 0) ? String(m.chainIndex) : "";
      if(num){
        const digits = num.length;
        const ratio = (digits===1) ? 1.20 : (digits===2 ? 1.00 : 0.86);
        const numFs = Math.max(1, Math.round(r * ratio));

        ctx.save();
        ctx.globalAlpha = 0.98;
        ctx.fillStyle = "rgba(0,0,0,.75)";
        ctx.font = `${m.fw ?? 900} ${numFs}px ui-sans-serif`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(num, p.x, p.y);
        ctx.restore();
      }

      if(m.name){
        ctx.save();
        ctx.globalAlpha = 1;
        ctx.fillStyle = m.labelColor || "#e7eef8";
        ctx.font = `${m.fw ?? 900} ${m.fs ?? 15}px ui-sans-serif`;
        ctx.textAlign = "left";
        ctx.textBaseline = "middle";
        const off = r + 8;
        ctx.fillText(m.name, p.x + off, p.y);
        ctx.restore();
      }

      const sp = screenFromWorld(p.x, p.y);
      circleHitboxes.push({ id:m.id, sx:sp.sx, sy:sp.sy, rPx: r*S.map.scale });
    }

    ctx.restore();
  }

  function pickCircleAt(sx, sy){
    let best=null, bestD=Infinity;
    for(const c of circleHitboxes){
      const d = Math.hypot(c.sx - sx, c.sy - sy);
      if(d <= c.rPx*1.25 && d < bestD){
        best = c;
        bestD = d;
      }
    }
    return best;
  }

  // ---------- pan/zoom + marker drag ----------
  let isPanning=false, lastX=0,lastY=0;
  let draggingMarkerId = null;
  let dragStartSX=0, dragStartSY=0;
  let dragMoved = false;
  let dragPointerId = null;

  function screenToWorld(sx, sy){
    const wx = (sx - S.map.tx) / S.map.scale;
    const wy = (sy - S.map.ty) / S.map.scale;
    return { wx, wy };
  }
  function worldToNorm(wx, wy){
    const iw = S.map.naturalW || (mapImg.naturalWidth||1);
    const ih = S.map.naturalH || (mapImg.naturalHeight||1);
    return { nx: clamp(wx / iw, 0, 1), ny: clamp(wy / ih, 0, 1) };
  }

  cv.addEventListener("pointerdown", (e)=>{
    requireAuth(); if(!isAuthed()) return;

    cv.setPointerCapture(e.pointerId);
    dragPointerId = e.pointerId;

    const rect = cv.getBoundingClientRect();
    const sx = e.clientX - rect.left;
    const sy = e.clientY - rect.top;

    lastX=e.clientX; lastY=e.clientY;

    const hit = pickCircleAt(sx, sy);
    if(hit){
      draggingMarkerId = hit.id;
      dragStartSX = sx;
      dragStartSY = sy;
      dragMoved = false;
      isPanning = false;
      return;
    }

    draggingMarkerId = null;
    isPanning = true;
  });

  cv.addEventListener("pointermove", (e)=>{
    if(dragPointerId !== e.pointerId) return;

    const rect = cv.getBoundingClientRect();
    const sx = e.clientX - rect.left;
    const sy = e.clientY - rect.top;

    if(draggingMarkerId){
      const dist = Math.hypot(sx - dragStartSX, sy - dragStartSY);
      if(dist > 3) dragMoved = true;

      const m = S.markers.find(x=>x.id===draggingMarkerId);
      if(!m) return;

      const { wx, wy } = screenToWorld(sx, sy);
      const { nx, ny } = worldToNorm(wx, wy);
      m.x = nx; m.y = ny;

      draw();
      return;
    }

    if(!isPanning) return;
    const dx=e.clientX-lastX, dy=e.clientY-lastY;
    lastX=e.clientX; lastY=e.clientY;
    S.map.tx += dx;
    S.map.ty += dy;
    draw();
  });

  cv.addEventListener("pointerup", ()=>{
    if(draggingMarkerId){
      const m = S.markers.find(x=>x.id===draggingMarkerId);
      if(m){
        if(!dragMoved){
          m.dim = !m.dim;
          selectedMarker = m;
          syncSelectedPanel();
          toast(m.dim ? "ë¶ˆíˆ¬ëª…í™”" : "ë¶ˆíˆ¬ëª… í•´ì œ");
        }else{
          toast("ë§ˆì»¤ ì´ë™ ì™„ë£Œ");
        }
        saveLocal();
      }
      draggingMarkerId = null;
      dragPointerId = null;
      dragMoved = false;
      draw();
      return;
    }

    isPanning=false;
    dragPointerId = null;
  });

  cv.addEventListener("pointercancel", ()=>{
    draggingMarkerId = null;
    isPanning=false;
    dragPointerId = null;
  });

  cv.addEventListener("wheel", (e)=>{
    e.preventDefault();
    const rect = cv.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;

    const old = S.map.scale || 1;
    const zoom = Math.exp(-e.deltaY * 0.0012);
    const next = clamp(old * zoom, 0.05, 10);

    const wx = (mx - S.map.tx) / old;
    const wy = (my - S.map.ty) / old;

    S.map.scale = next;
    S.map.tx = mx - wx * next;
    S.map.ty = my - wy * next;

    draw();
  }, {passive:false});

  // ---------- marker create / select ----------
  let selectedMarker = null;
  let insertAfterMarkerId = null;

  function nextOrderForPage(pageId){
    const ms = (S.markers||[]).filter(m=>m.pageId===pageId);
    const max = ms.reduce((acc,m)=>Math.max(acc, (m.order||0)), 0);
    return max + 1;
  }

  function newMarkerAt(normX, normY){
    const pageId = S.currentPageId;

    const m = {
      id:"m_"+uid(),
      pageId:pageId,
      x:normX, y:normY,
      name:"",
      cat: (S.categories.find(c=>c.on && c.id!=="ì „ì²´")?.id) || "ê¸°í…”",
      colorOverride:"",
      useCatColor:true,
      yt:"",
      ytTitle:"",
      memo:"",
      r:10,
      fs:15,
      fw:900,
      labelColor:"#e7eef8",
      order: nextOrderForPage(pageId),
      dim:false,
      chainId:null,
      chainIndex:null,
    };

    // âœ… ì²´ì¸ ê²°ì •: ì¤‘ê°„ ì‚½ì…ì´ë©´ ê¸°ì¤€ ë§ˆì»¤ ì²´ì¸, ì•„ë‹ˆë©´ í˜„ì¬ í™œì„± ì²´ì¸
    if(insertAfterMarkerId){
      const base = S.markers.find(x=>x.id===insertAfterMarkerId);
      if(base && base.pageId===m.pageId){
        m.chainId = ensureMarkerChain(base);
        const insertAt = (base.order||0) + 1;
        for(const mm of S.markers){
          if(mm.pageId===m.pageId && (mm.order||0) >= insertAt){
            mm.order = (mm.order||0) + 1;
          }
        }
        m.order = insertAt;
        renumberPage(m.pageId);
      }
    }else{
      m.chainId = getActiveChainIdForPage(pageId);
    }
    ensureMarkerChain(m);

    S.markers.push(m);

    // ì¹´í…Œê³ ë¦¬ 1ë²ˆ ìŠ¤íƒ€ì¼ ì „íŒŒ: ìƒˆ ë§ˆì»¤ëŠ” leader ìŠ¤íƒ€ì¼ì„ ë”°ë¼ê°
    const leader = leaderOfCat(m.pageId, m.cat);
    if(leader && leader.id !== m.id){
      m.r = leader.r; m.fs = leader.fs; m.fw = leader.fw; m.labelColor = leader.labelColor;
      m.useCatColor = leader.useCatColor; m.colorOverride = leader.colorOverride || "";
    }

    renumberPage(pageId);
    recomputeChainIndices(pageId);

    // âœ… (9) ì²´ì¸ 1ë²ˆ í…ìŠ¤íŠ¸ ê¸°ë°˜ ìë™ ì´ì–´ì“°ê¸° (ìš°í´ë¦­ ì¶”ê°€ ì‹œ)
    applyAutoNamesForChainOnPage(pageId, ensureMarkerChain(m));

    applyAllCatStylesOnPage(pageId); // âœ… FIX
    applyAllChainStylesOnPage(pageId); // âœ… FIX: ì²´ì¸ ìŠ¤íƒ€ì¼(1ë²ˆ ê¸°ì¤€) ë™ê¸°í™”

    saveLocal();
    selectMarker(m.id);
    renderKpi();
    draw();
  }

  function selectMarker(id){
    selectedMarker = S.markers.find(m=>m.id===id) || null;
    syncSelectedPanel();
  }

  function syncSelectedPanel(){
    $("selName").textContent = selectedMarker ? (selectedMarker.name || "(ì´ë¦„ ì—†ìŒ)") : "(ì´ë¦„ ì—†ìŒ)";
    $("selLink").value = selectedMarker ? (selectedMarker.yt || "") : "";
    $("selYtTitle").value = selectedMarker ? (selectedMarker.ytTitle || "") : "";
    $("btnOpenMarkerEdit").disabled = !selectedMarker;
    $("btnApplyQuick").disabled = !selectedMarker;
    $("btnUseCatColor").disabled = !selectedMarker;
  }

  cv.addEventListener("click", (e)=>{
    requireAuth(); if(!isAuthed()) return;
    if(dragMoved) return;

    const rect = cv.getBoundingClientRect();
    const sx = e.clientX - rect.left;
    const sy = e.clientY - rect.top;
    const hit = pickCircleAt(sx, sy);
    if(hit){
      selectMarker(hit.id);
      return;
    }
    selectedMarker = null;
    insertAfterMarkerId = null;
    syncSelectedPanel();
  });

  // right-click add marker
  cv.addEventListener("contextmenu", (e)=>{
    e.preventDefault();
    requireAuth(); if(!isAuthed()) return;

    const rect = cv.getBoundingClientRect();
    const sx = e.clientX - rect.left;
    const sy = e.clientY - rect.top;

    const { wx, wy } = screenToWorld(sx, sy);

    const iw = S.map.naturalW || (mapImg.naturalWidth||1);
    const ih = S.map.naturalH || (mapImg.naturalHeight||1);

    const nx = clamp(wx / iw, 0, 1);
    const ny = clamp(wy / ih, 0, 1);

    newMarkerAt(nx, ny);
    toast("ë§ˆì»¤ ì¶”ê°€");
  });

  $("selLink").addEventListener("input", ()=>{
    if(!selectedMarker) return;
    selectedMarker.yt = $("selLink").value.trim();
    saveLocal();
  });
  $("selYtTitle").addEventListener("input", ()=>{
    if(!selectedMarker) return;
    selectedMarker.ytTitle = $("selYtTitle").value;
    saveLocal();
  });

  $("btnOpenMarkerEdit").addEventListener("click", ()=>{
    if(!selectedMarker) return;
    openMarkerModal(selectedMarker.id);
  });

  // ---------- quick palette ----------
  const QUICK = [
    {name:"ë¹¨", c:"#ff3b30"},
    {name:"ì£¼", c:"#ff9500"},
    {name:"ë…¸", c:"#ffd60a"},
    {name:"ì´ˆ", c:"#34c759"},
    {name:"íŒŒ", c:"#0a84ff"},
    {name:"í°", c:"#ffffff"},
    {name:"ê²€", c:"#0b0b0f"},
  ];
  let pickedQuick = null;

  function renderPalette(){
    palette.innerHTML = "";
    for(const q of QUICK){
      const wrap = document.createElement("div");
      wrap.className = "swWrap";
      wrap.innerHTML = `
        <div class="sw" style="--c:${q.c}" title="${q.name}"></div>
        <div class="swLabel">${q.name}</div>
      `;
      wrap.querySelector(".sw").addEventListener("click", ()=>{
        pickedQuick = q.c;
        toast("ìƒ‰ìƒ ì„ íƒ");
      });
      palette.appendChild(wrap);
    }
  }

  $("btnApplyQuick").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    if(!selectedMarker){ toast("ë§ˆì»¤ë¥¼ ì„ íƒí•˜ì„¸ìš”"); return; }
    if(!pickedQuick){ toast("ë¹ ë¥¸ ìƒ‰ìƒì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”"); return; }

    // âœ… FIX: ì²´ì¸ ìŠ¤íƒ€ì¼ì€ 1ë²ˆ ë§ˆì»¤ê°€ ê¸°ì¤€ â†’ ì„ íƒ ë§ˆì»¤ê°€ 1ë²ˆì´ ì•„ë‹ˆë©´ ë¦¬ë”ì— ì ìš©
    const cid = ensureMarkerChain(selectedMarker); // âœ… FIX
    const leader = leaderOfChain(S.currentPageId, cid); // âœ… FIX
    const target = leader || selectedMarker; // âœ… FIX
    target.colorOverride = pickedQuick; // âœ… FIX
    target.useCatColor = false; // âœ… FIX

    applyAllCatStylesOnPage(S.currentPageId);
    applyAllChainStylesOnPage(S.currentPageId); // âœ… FIX

    saveLocal();
    draw();
    toast("ìƒ‰ìƒ ì ìš©");
  });

  $("btnUseCatColor").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    if(!selectedMarker){ toast("ë§ˆì»¤ë¥¼ ì„ íƒí•˜ì„¸ìš”"); return; }

    // âœ… FIX: ì²´ì¸ ìŠ¤íƒ€ì¼ì€ 1ë²ˆ ë§ˆì»¤ê°€ ê¸°ì¤€ â†’ ì„ íƒ ë§ˆì»¤ê°€ 1ë²ˆì´ ì•„ë‹ˆë©´ ë¦¬ë”ì— ì ìš©
    const cid = ensureMarkerChain(selectedMarker); // âœ… FIX
    const leader = leaderOfChain(S.currentPageId, cid); // âœ… FIX
    const target = leader || selectedMarker; // âœ… FIX
    target.colorOverride = ""; // âœ… FIX
    target.useCatColor = true; // âœ… FIX

    applyAllCatStylesOnPage(S.currentPageId);
    applyAllChainStylesOnPage(S.currentPageId); // âœ… FIX

    saveLocal();
    draw();
    toast("ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì ìš©");
  });

  $("btnClearLines").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    S.showLinesWithCatFilter = false;
    setChipToggle($("tgShowChainSameCat"), false);
    saveLocal();
    draw();
    toast("ì„  ìˆ¨ê¹€");
  });

  $("btnRechain").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    renumberPage(S.currentPageId);
    recomputeChainIndices(S.currentPageId);
    S.showLinesWithCatFilter = true;
    setChipToggle($("tgShowChainSameCat"), true);
    applyAllCatStylesOnPage(S.currentPageId);
    applyAllChainStylesOnPage(S.currentPageId); // âœ… FIX
    saveLocal();
    draw();
    toast("ì„  í‘œì‹œ");
  });

  $("btnResetMarkers").addEventListener("click", async (e)=>{
    requireAuth(); if(!isAuthed()) return;
    const ok = await openPopConfirm({
      anchor: $("btnResetMarkers"),
      title: "ë§ˆì»¤ ì´ˆê¸°í™”",
      message: "í˜„ì¬ í˜ì´ì§€ì˜ ë§ˆì»¤ë¥¼ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?",
      okText: "ì‚­ì œ",
      cancelText: "ì·¨ì†Œ",
      danger: true
    });
    if(!ok) return;

    const pid = S.currentPageId;
    S.markers = S.markers.filter(m=>m.pageId!==pid);
    selectedMarker = null;
    insertAfterMarkerId = null;
    saveLocal();
    syncSelectedPanel();
    renderKpi();
    draw();
    toast("ë§ˆì»¤ ì´ˆê¸°í™”");
  });

  // ---------- marker modal ----------
  let editingId = null;
  function openMarkerModal(markerId){
    requireAuth(); if(!isAuthed()) return;
    const m = S.markers.find(x=>x.id===markerId);
    if(!m) return;

    editingId = markerId;
    const sel = $("mfCat");
    sel.innerHTML = "";
    for(const c of S.categories){
      if(c.id==="ì „ì²´") continue;
      const o = document.createElement("option");
      o.value = c.id;
      o.textContent = c.name;
      sel.appendChild(o);
    }

    $("mfName").value = m.name || "";
    $("mfCat").value = m.cat || "ê¸°í…”";

    $("mfColor").value = m.colorOverride || "";
    $("mfUseCatColor").checked = !!m.useCatColor;

    $("mfYt").value = m.yt || "";
    $("mfYtTitle").value = m.ytTitle || "";
    $("mfMemo").value = m.memo || "";

    $("mfR").value = m.r ?? 10;
    $("mfFs").value = m.fs ?? 15;
    $("mfFw").value = String(m.fw ?? 900);
    $("mfLabelColor").value = m.labelColor || "#e7eef8";

    $("mfRVal").textContent = $("mfR").value;
    $("mfFsVal").textContent = $("mfFs").value;

    $("mfPos").textContent = `ì¢Œí‘œ(ë¹„ìœ¨): ${m.x.toFixed(6)}, ${m.y.toFixed(6)}`;

    updateColorChip();
    mMarker.classList.add("show");
    setTimeout(()=>$("mfName").focus(), 0);
  }

  function closeMarkerModal(){
    mMarker.classList.remove("show");
    editingId = null;
  }
  $("btnCloseMarker").addEventListener("click", closeMarkerModal);
  $("btnSaveMarker").addEventListener("click", saveMarkerModal);
  $("btnDeleteMarker").addEventListener("click", deleteMarkerModal);

  mMarker.addEventListener("keydown", (e)=>{
    if(e.key==="Enter"){
      if(e.target && e.target.tagName==="TEXTAREA") return;
      e.preventDefault();
      saveMarkerModal();
    }
    if(e.key==="Escape"){
      closeMarkerModal();
    }
  });

  function updateColorChip(){
    const m = getEditing();
    if(!m) return;
    const chip = $("mfColorChip");
    const col = $("mfUseCatColor").checked ? (getCat($("mfCat").value)?.color || "#7cc4ff") : ($("mfColor").value || markerColor(m));
    chip.style.setProperty("--c", col);
  }
  $("mfColor").addEventListener("input", updateColorChip);
  $("mfUseCatColor").addEventListener("change", updateColorChip);
  $("mfCat").addEventListener("change", updateColorChip);

  let ytTouched = false, memoTouched = false;
  $("mfYtTitle").addEventListener("input", ()=>{ ytTouched = true; syncSelectedPanelLive(); });
  $("mfMemo").addEventListener("input", ()=>{ memoTouched = true; syncSelectedPanelLive(); });

  $("mfName").addEventListener("input", ()=>{
    const v = $("mfName").value;
    if(!ytTouched) $("mfYtTitle").value = v;
    if(!memoTouched) $("mfMemo").value = v;
    syncSelectedPanelLive();
  });

  function syncSelectedPanelLive(){
    if(!editingId) return;
    if(selectedMarker && selectedMarker.id === editingId){
      $("selName").textContent = $("mfName").value || "(ì´ë¦„ ì—†ìŒ)";
      $("selYtTitle").value = $("mfYtTitle").value || "";
      $("selLink").value = $("mfYt").value || "";
    }
  }

  $("mfR").addEventListener("input", ()=>{
    $("mfRVal").textContent = $("mfR").value;
    const r = Number($("mfR").value);
    // âœ… (2) ë²”ìœ„ í™•ì¥ì— ë§ì¶° clamp ì¡°ì • (2~80)
    const fs = clamp(Math.round(r * 1.5), 4, 80);
    $("mfFs").value = fs;
    $("mfFsVal").textContent = fs;
  });
  $("mfFs").addEventListener("input", ()=>{ $("mfFsVal").textContent = $("mfFs").value; });

  $("mfLabelDefault").addEventListener("click", ()=>{ $("mfLabelColor").value = "#e7eef8"; });

  function getEditing(){
    if(!editingId) return null;
    return S.markers.find(x=>x.id===editingId) || null;
  }

  function saveMarkerModal(){
    requireAuth(); if(!isAuthed()) return;
    const m = getEditing();
    if(!m) return;

    const prevCat = m.cat;

    m.name = ($("mfName").value || "").trim();
    m.cat = $("mfCat").value || "ê¸°í…”";
    ensureCat(m.cat, "#ffffff");

    m.useCatColor = $("mfUseCatColor").checked;
    m.colorOverride = ($("mfColor").value || "").trim();

    m.yt = ($("mfYt").value || "").trim();
    m.ytTitle = ($("mfYtTitle").value || "").trim();
    m.memo = ($("mfMemo").value || "").trim();

    m.r = Number($("mfR").value);
    m.fs = Number($("mfFs").value);
    m.fw = Number($("mfFw").value);
    m.labelColor = ($("mfLabelColor").value || "#e7eef8").trim();

    renumberPage(m.pageId);
    recomputeChainIndices(m.pageId);

    // âœ… (4) ì¹´í…Œê³ ë¦¬ 1ë²ˆ ê¸°ì¤€ ìŠ¤íƒ€ì¼ ì „íŒŒ ê°•ì œ: ì €ì¥ ì¦‰ì‹œ ë™ê¸°í™”
    applyCatLeaderStyle(m.pageId, prevCat);
    applyCatLeaderStyle(m.pageId, m.cat);

    // âœ… FIX: ì²´ì¸(1ë²ˆ ë§ˆì»¤) ìŠ¤íƒ€ì¼ ë™ê¸°í™”(ê°œë³„ ë§ˆì»¤ ìŠ¤íƒ€ì¼ ê¸ˆì§€)
    applyAllChainStylesOnPage(m.pageId); // âœ… FIX

    // âœ… (9) ì €ì¥ ì‹œì—ë„ ì²´ì¸ ìë™ ì´ë¦„(ë¹ˆ ì´ë¦„ë§Œ) ì •ë¦¬
    applyAutoNamesForChainOnPage(m.pageId, ensureMarkerChain(m));

    saveLocal();
    selectMarker(m.id);
    renderCats();
    renderKpi();
    draw();
    toast("ì €ì¥ ì™„ë£Œ");
    closeMarkerModal();
  }

  async function deleteMarkerModal(){
    requireAuth(); if(!isAuthed()) return;
    const m = getEditing();
    if(!m) return;

    // âœ… (10) ë§ˆì»¤ ì‚­ì œ confirm ì œê±°: ì¦‰ì‹œ ì‚­ì œ
    const pid = m.pageId;
    const catId = m.cat;
    const cid = ensureMarkerChain(m);

    S.markers = S.markers.filter(x=>x.id!==m.id);
    renumberPage(pid);
    recomputeChainIndices(pid);

    applyCatLeaderStyle(pid, catId);
    applyAllChainStylesOnPage(pid); // âœ… FIX

    saveLocal();
    closeMarkerModal();
    selectedMarker = null;
    syncSelectedPanel();
    renderKpi();
    draw();
    toast("ì‚­ì œ ì™„ë£Œ");
  }

  $("btnNewChain").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    const m = getEditing();
    if(!m) return;

    // âœ… (7) ìƒˆ ì²´ì¸ ìƒì„±: ê¸°ì¡´ ì²´ì¸ê³¼ ì„  ì—°ê²° ê¸ˆì§€ + ì´ ë§ˆì»¤ê°€ ìƒˆ ì²´ì¸ì˜ 1ë²ˆ
    const pid = m.pageId;
    const newCid = "c_" + uid();
    m.chainId = newCid;
    ensureMarkerChain(m);
    setActiveChainIdForPage(pid, newCid);

    renumberPage(pid);
    recomputeChainIndices(pid);

    applyCatLeaderStyle(pid, m.cat);
    applyAllChainStylesOnPage(pid); // âœ… FIX

    insertAfterMarkerId = null;
    saveLocal();
    draw();
    toast("ìƒˆë¡œìš´ ë²ˆí˜¸ë¡œ ì‹œì‘");
  });

  $("btnInsertAfter").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    const m = getEditing();
    if(!m) return;
    insertAfterMarkerId = m.id;
    toast("ì¤‘ê°„ ì‚½ì… ëª¨ë“œ í™œì„±í™”");
  });

  cv.addEventListener("dblclick", (e)=>{
    requireAuth(); if(!isAuthed()) return;
    const rect = cv.getBoundingClientRect();
    const sx = e.clientX - rect.left;
    const sy = e.clientY - rect.top;
    const hit = pickCircleAt(sx, sy);
    if(hit){
      selectMarker(hit.id);
      ytTouched = false; memoTouched = false;
      openMarkerModal(hit.id);
    }
  });

  // ---------- category modal ----------
  let catSelectedRowId = null;

  $("btnEditCats").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    openCatsModal();
  });
  $("btnCloseCats").addEventListener("click", ()=>mCats.classList.remove("show"));

  function openCatsModal(){
    catSelectedRowId = null;
    setChipToggle(tgShowLinesWithCatFilter, !!S.showLinesWithCatFilter);
    renderCatRows();
    renderCatQuickPalette();
    mCats.classList.add("show");
  }

  function renderCatQuickPalette(){
    const wrap = $("catQuickPalette");
    wrap.innerHTML = "";
    for(const q of QUICK){
      const w = document.createElement("div");
      w.className = "swWrap";
      w.innerHTML = `<div class="sw" style="--c:${q.c}"></div><div class="swLabel">${q.name}</div>`;
      w.querySelector(".sw").addEventListener("click", ()=>{
        if(!catSelectedRowId){ toast("ì¹´í…Œê³ ë¦¬ í–‰ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”"); return; }
        const c = S.categories.find(x=>x.id===catSelectedRowId);
        if(!c) return;
        c.color = q.c;
        renderCatRows();
      });
      wrap.appendChild(w);
    }
  }

  function renderCatRows(){
    const rows = $("catRows");
    rows.innerHTML = "";

    const list = S.categories.filter(c=>c.id!=="ì „ì²´");
    for(const c of list){
      const row = document.createElement("div");
      row.style.display = "grid";
      row.style.gridTemplateColumns = "1fr 70px 90px";
      row.style.gap = "10px";
      row.style.alignItems = "center";
      row.style.marginBottom = "10px";

      row.innerHTML = `
        <input class="field" value="${c.name}" />
        <div class="colorChip" style="--c:${c.color}; cursor:pointer;"></div>
        <button class="pill danger" type="button">ì‚­ì œ</button>
      `;

      const inp = row.querySelector("input");
      const chip = row.querySelector(".colorChip");
      const del = row.querySelector("button");

      row.addEventListener("click", ()=>{
        catSelectedRowId = c.id;
        toast("ì¹´í…Œê³ ë¦¬ ì„ íƒ");
      });

      inp.addEventListener("input", ()=>{
        c.name = inp.value;
      });

      chip.addEventListener("click", async (e)=>{
        e.stopPropagation();
        catSelectedRowId = c.id;
        const next = await openPopInput({
          anchor: chip,
          title: "ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ",
          message: "ìƒ‰ìƒ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: #ff0000)",
          placeholder: "#rrggbb",
          value: c.color || "",
          okText: "ì €ì¥",
          cancelText: "ì·¨ì†Œ"
        });
        if(next === null) return;
        const v = (next||"").trim();
        if(v) c.color = v;

        renderCatRows();
        renderCats();
        applyAllChainStylesOnPage(S.currentPageId); // âœ… FIX: ë¦¬ë”(1ë²ˆ) ìƒ‰ ë³€ê²½ ì‹œ ì²´ì¸ ì „ì²´ ë™ê¸°í™”
        saveLocal();
        draw();
      });

      del.addEventListener("click", async (e)=>{
        e.stopPropagation();

        // âœ… (11) ì¹´í…Œê³ ë¦¬ ì‚­ì œ confirm ì œê±°: ì¦‰ì‹œ ì‚­ì œ
        const fallback = S.categories.find(x=>x.id==="ê¸°í…”") || S.categories[0];
        for(const m of S.markers){
          if(m.cat === c.id) m.cat = fallback.id;
        }
        S.categories = S.categories.filter(x=>x.id!==c.id);

        applyAllCatStylesOnPage(S.currentPageId);
        applyAllChainStylesOnPage(S.currentPageId); // âœ… FIX

        renderCatRows();
        renderCats();
        saveLocal();
        draw();
      });

      rows.appendChild(row);
    }
  }

  $("btnAddCat").addEventListener("click", async (e)=>{
    const name = await openPopInput({
      anchor: $("btnAddCat"),
      title: "ì¹´í…Œê³ ë¦¬ ì¶”ê°€",
      message: "ì¶”ê°€í•  ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.",
      placeholder: "ì˜ˆ: 11",
      value: "",
      okText: "ì¶”ê°€",
      cancelText: "ì·¨ì†Œ"
    });
    if(name === null) return;
    const id = (name||"").trim();
    if(!id) return;
    if(S.categories.some(c=>c.id===id)){ toast("ì´ë¯¸ ì¡´ì¬"); return; }
    S.categories.push({ id, name:id, color:"#ffffff", on:true });
    renderCatRows();
  });

  $("btnCatsDefault").addEventListener("click", async (e)=>{
    const ok = await openPopConfirm({
      anchor: $("btnCatsDefault"),
      title: "ê¸°ë³¸ê°’ìœ¼ë¡œ",
      message: "ê¸°ë³¸ ì¹´í…Œê³ ë¦¬ë¡œ ë˜ëŒë¦´ê¹Œìš”?",
      okText: "ë˜ëŒë¦¬ê¸°",
      cancelText: "ì·¨ì†Œ",
      danger: true
    });
    if(!ok) return;
    S.categories = structuredClone(defaultCats);
    renderCatRows();
  });

  $("btnSaveCats").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;

    const cleaned = [];
    const seen = new Set(["ì „ì²´"]);
    for(const c of S.categories){
      const name = (c.name||c.id||"").trim();
      if(!name) continue;
      const finalId = name;
      if(seen.has(finalId)) continue;
      seen.add(finalId);
      cleaned.push({ id:finalId, name, color:(c.color||"#ffffff"), on:!!c.on });
    }
    const all = { id:"ì „ì²´", name:"ì „ì²´", color:"#7cc4ff", on:true };
    S.categories = [all, ...cleaned];

    const valid = new Set(S.categories.map(x=>x.id));
    const fb = valid.has("ê¸°í…”") ? "ê¸°í…”" : (S.categories[1]?.id || "ì „ì²´");
    for(const m of S.markers){
      if(!valid.has(m.cat)) m.cat = fb;
    }

    applyAllCatStylesOnPage(S.currentPageId);
    applyAllChainStylesOnPage(S.currentPageId); // âœ… FIX: ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°ì—ì„œë„ ì²´ì¸ ë™ê¸°í™” ìœ ì§€

    saveLocal();
    renderCats();
    renderKpi();
    draw();
    mCats.classList.remove("show");
    toast("ì¹´í…Œê³ ë¦¬ ì €ì¥");
  });

  // ---------- marker edit: text quick colors ----------
  function renderTextColors(){
    textColors.innerHTML = "";
    const colors = [
      "#ff3b30","#ff9500","#ffd60a","#34c759","#0a84ff","#ffffff","#0b0b0f"
    ];
    for(const c of colors){
      const d = document.createElement("div");
      d.className = "tSw";
      d.style.setProperty("--c", c);
      d.addEventListener("click", ()=>{
        $("mfLabelColor").value = c;
      });
      textColors.appendChild(d);
    }
  }

  // ---------- helpers ----------
  function renderAll(){
    renderLogo();
    renderGamesTop();
    renderPages();
    renderCats();
    renderPalette();
    renderTextColors();
    syncSelectedPanel();
    renderKpi();
    resizeCanvas();
    if(!S.map.scale || S.map.scale<=0) fitToScreen();

    renumberPage(S.currentPageId);
    recomputeChainIndices(S.currentPageId);
    applyAllCatStylesOnPage(S.currentPageId);
    applyAllChainStylesOnPage(S.currentPageId); // âœ… FIX: ì²´ì¸(1ë²ˆ) ìŠ¤íƒ€ì¼ ë™ê¸°í™”

    draw();
  }

  // ---------- init ----------
  async function init(){
    requireAuth();
    const st = await loadStateRemoteFirst();
    S = mergeState(st);

    if(typeof S.showLinesWithCatFilter !== "boolean") S.showLinesWithCatFilter = true;

    if(!Array.isArray(S.games) || !S.games.length) S.games = ["ì•„ì´ì˜¨2"];
    if(!S.games.includes(S.game)) S.game = S.games[0];

    renderAll();
    loadMap();
    if(!S.map.scale || S.map.scale<=0){
      setTimeout(()=>{
        fitToScreen();
        saveLocal();
        draw();
      }, 0);
    }else{
      draw();
    }
  }

  init();

})();
</script>
</body>
</html>
