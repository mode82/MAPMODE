<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MAPMODE Â· ADMIN99</title>

  <style>
    :root{
      color-scheme: dark;

      --bg:#070b12;
      --panel:#0b1220cc;
      --card:#0e1626cc;

      --stroke:#1f2a3a;
      --stroke2:#27344a;

      --text:#e7eef8;
      --muted:#9fb0c6;

      --accent:#7cc4ff;
      --danger:#ff5d5d;
      --ok:#39d98a;
      --warn:#ffd60a;

      --r12:12px;
      --r14:14px;
      --r16:16px;
      --r18:18px;

      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --shadow2: 0 8px 24px rgba(0,0,0,.35);
      --blur: 14px;

      --topH:58px;
      --sideW:320px;
      --sideW2:360px;

      /* âœ… ìŠ¤ìƒ· ëŠë‚Œ ê¸°ë³¸ í°íŠ¸/êµµê¸° */
      --uiFont: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", Arial, sans-serif;

      /* âœ… (ìš”ì²­) ë§ˆì»¤ ê¸°ë³¸ê°’(4ë²ˆ ìŠ¤ìƒ· ëŠë‚Œìœ¼ë¡œ ë” ì‘ê²Œ) */
      --mR: 6;        /* ê¸°ë³¸ ì› ë°˜ì§€ë¦„(world px) */
      --mFs: 11;      /* ê¸°ë³¸ ë¼ë²¨ í°íŠ¸(world px) */
      --mNumScale: 1.25; /* ìˆ«ì í¬ê¸° = r * scale */
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      overflow:hidden;
      background:
        radial-gradient(1200px 700px at 50% -10%, rgba(124,196,255,.18), transparent 55%),
        radial-gradient(900px 650px at 88% 10%, rgba(57,217,138,.12), transparent 55%),
        radial-gradient(900px 650px at 12% 10%, rgba(255,214,10,.08), transparent 55%),
        linear-gradient(180deg, #0a0f18 0%, var(--bg) 100%);
      color:var(--text);

      font-family: var(--uiFont);
      font-weight: 800;
      letter-spacing: .1px;
    }

    /* ========== TOPBAR ========== */
    .topbar{
      position:fixed; inset:0 0 auto 0;
      height:var(--topH);
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 14px;
      z-index:90;
      background: linear-gradient(180deg, rgba(9,14,23,.88), rgba(9,14,23,.58));
      backdrop-filter: blur(var(--blur));
      border-bottom:1px solid rgba(39,52,74,.65);
    }
    .top-left, .top-right{ display:flex; align-items:center; gap:10px; min-width:0; }

    .slot{
      height:38px;
      display:flex; align-items:center;
      padding:0 10px;
      border-radius:999px;
      background: rgba(14,22,38,.55);
      border:1px solid rgba(39,52,74,.65);
      box-shadow: var(--shadow2);
      gap:8px;
      white-space:nowrap;
    }
    .slot.fixed{ width:170px; justify-content:center; }
    .slot.logo{
      justify-content:flex-start;
      border:none;
      background: transparent;
      box-shadow:none;
      padding:0;
      width:170px;
    }
    .logoBox{
      width:170px; height:38px;
      border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      background: transparent;
      border:none;
      cursor:pointer;
      user-select:none;
    }
    .logoBox img{ height:26px; width:auto; display:block; opacity:.98; }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.5px; }
    .brand .word{ font-size:20px; line-height:1; display:flex; align-items:center; }
    .brand .word .o{
      display:inline-block;
      width:12px; height:12px; border-radius:999px;
      margin:0 2px;
      background:#fff;
      box-shadow: 0 0 0 2px rgba(255,255,255,.12);
      transform: translateY(1px);
    }

    /* âœ… (ìš”ì²­) ê²Œì„ ì„ íƒ UI: ê¸€ì”¨ ë” í¬ê²Œ / + ì˜† ë²„íŠ¼ í¬ê¸° ë§ì¶¤ */
    .gamePill{
      height:36px;
      display:inline-flex; align-items:center; justify-content:center;
      gap:10px;
      padding:0 14px;
      border-radius:999px;
      background: rgba(10,15,24,.35);
      border:1px solid rgba(39,52,74,.65);
      color:var(--text);
      box-shadow: var(--shadow2);
      cursor:pointer;
      user-select:none;
      font-weight:900;
      font-size:15px;     /* âœ… ë” í¼ */
      line-height:1;
    }
    .gamePill:hover{ border-color: rgba(124,196,255,.55); }
    .gamePill .chev{
      width:0;height:0;
      border-left:5px solid transparent;
      border-right:5px solid transparent;
      border-top:7px solid rgba(231,238,248,.75);
      transform: translateY(2px);
    }

    .miniBtn{
      height:36px;             /* âœ… gamePillê³¼ ë§ì¶¤ */
      padding:0 12px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color: rgba(231,238,248,.92);
      cursor:pointer;
      font-weight:900;
      font-size:14px;
      display:flex; align-items:center; justify-content:center;
    }
    .miniBtn.icon{ width:36px; padding:0; }
    .miniBtn.edit{ border-color: rgba(124,196,255,.55); }

    .gameMenu{
      position:fixed;
      z-index:160;
      min-width: 220px;
      background: linear-gradient(180deg, rgba(14,22,38,.96), rgba(10,15,24,.92));
      border:1px solid rgba(39,52,74,.75);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:10px;
      display:none;
      backdrop-filter: blur(var(--blur));
    }
    .gameMenu.show{ display:block; }
    .gameItem{
      height:40px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.6);
      background: rgba(10,15,24,.35);
      display:flex; align-items:center; justify-content:space-between;
      padding:0 12px;
      cursor:pointer;
      user-select:none;
      font-weight:900;
      margin-bottom:8px;
    }
    .gameItem:last-child{ margin-bottom:0; }
    .gameItem.on{
      border-color: rgba(124,196,255,.65);
      background: rgba(124,196,255,.10);
    }
    .gameItem .tag{
      font-size:12px;
      color: rgba(159,176,198,.92);
      font-weight:900;
    }

    .pill{
      height:34px;
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px;
      padding:0 12px;
      border-radius:999px;
      background: rgba(14,22,38,.55);
      border:1px solid rgba(39,52,74,.65);
      color:var(--text);
      box-shadow: var(--shadow2);
      cursor:pointer;
      user-select:none;
      text-decoration:none;
      font-weight:900;
      font-size:13px;
    }
    .pill:hover{ border-color: rgba(124,196,255,.55); }
    .pill:active{ transform: translateY(1px); }
    .pill.small{ height:32px; padding:0 10px; font-size:13px; font-weight:900; }
    .pill.ghost{ background: rgba(14,22,38,.25); }
    .pill.danger{ border-color: rgba(255,93,93,.55); }
    .pill.ok{ border-color: rgba(57,217,138,.55); }

    /* âœ… (ìš”ì²­) ìƒë‹¨ ì•„ì´ì½˜/ë²„íŠ¼ì€ 4ìŠ¬ë¡¯ ì´í›„(ì˜¤ë¥¸ìª½)ì—ì„œ ì‹œì‘ */
    .top-right{ flex-wrap:nowrap; justify-content:flex-end; gap:10px; }
    .top-right .pill{ flex: 0 0 auto; }

    /* ========== LAYOUT ========== */
    .layout{
      position:fixed;
      inset:var(--topH) 0 0 0;
      display:grid;
      grid-template-columns: var(--sideW) 1fr var(--sideW2);
      height:calc(100% - var(--topH));
      min-height: 0;
    }
    .side{
      overflow:hidden;
      border-right:1px solid rgba(39,52,74,.55);
      background: rgba(8,12,20,.35);
      backdrop-filter: blur(var(--blur));
      min-height:0;
    }
    .side.right{ border-right:none; border-left:1px solid rgba(39,52,74,.55); }

    .sideInner{
      height:100%;
      padding:12px;
      overflow:auto;
    }

    .card{
      background: rgba(14,22,38,.50);
      border:1px solid rgba(39,52,74,.6);
      border-radius: var(--r16);
      padding:12px;
      box-shadow: var(--shadow2);
    }
    .card + .card{ margin-top:12px; }

    .sectionTitle{
      font-size:12px;
      color: rgba(231,238,248,.9);
      margin:4px 0 10px 0;
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
      font-weight:900;
    }
    .sectionTitle b{ font-weight:900; }
    .subtle{
      color: rgba(159,176,198,.92);
      font-size:12px;
      line-height:1.45;
      font-weight:800;
    }

    /* ========== LEFT: Pages ========== */
    .btnAddPage{
      width:100%;
      height:52px;
      border-radius:18px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(14,22,38,.35);
      color: rgba(231,238,248,.95);
      font-weight:900;
      cursor:pointer;
      box-shadow: var(--shadow2);
      font-size:14px;
    }
    .btnAddPage:hover{ border-color: rgba(124,196,255,.55); }

    .pageList{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .pageItem{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 10px;
      border-radius: var(--r16);
      border:1px solid rgba(39,52,74,.6);
      background: rgba(14,22,38,.35);
      cursor:pointer;
    }
    .pageItem.active{
      outline:2px solid rgba(57,217,138,.35);
      border-color: rgba(57,217,138,.55);
      background: rgba(14,22,38,.55);
    }
    .pageName{ font-weight:900; font-size:16px; }
    .pageActions{ display:flex; align-items:center; gap:8px; flex:0 0 auto; }
    .miniBtn.url{ border-color: rgba(57,217,138,.55); }
    .miniBtn.del{ border-color: rgba(255,93,93,.55); }

    /* ========== CENTER: Canvas ========== */
    .center{
      position:relative;
      overflow:hidden;
      background:
        radial-gradient(900px 700px at 50% 15%, rgba(124,196,255,.08), transparent 60%),
        radial-gradient(900px 700px at 50% 80%, rgba(57,217,138,.05), transparent 60%);
      min-height:0;
    }
    .canvasWrap{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:16px;
    }
    canvas{ background: transparent; touch-action:none; }

    .hintToast{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      top:14px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.6);
      background: rgba(14,22,38,.55);
      color: rgba(231,238,248,.9);
      box-shadow: var(--shadow2);
      font-size:12px;
      display:none;
      z-index:40;
      font-weight:900;
    }
    .hintToast.show{ display:block; }

    /* ========== RIGHT: Tools ========== */
    .chipRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .chip{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.6);
      background: rgba(10,15,24,.35);
      cursor:pointer;
      font-size:13px;
      user-select:none;
      font-weight:900;
    }
    .chip.on{ border-color: rgba(124,196,255,.6); background: rgba(124,196,255,.10); }
    .dotc{ width:10px; height:10px; border-radius:999px; box-shadow:0 0 0 2px rgba(255,255,255,.06); }

    .toggleRow{ display:flex; gap:10px; flex-direction:column; margin-top:10px; }
    .toggle{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.6);
      background: rgba(10,15,24,.35);
      cursor:pointer;
      font-size:13px;
      user-select:none;
      font-weight:900;
    }
    .toggle .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(231,238,248,.25);
      border:1px solid rgba(231,238,248,.25);
    }
    .toggle.on{ border-color: rgba(57,217,138,.55); }
    .toggle.on .dot{ background: rgba(57,217,138,.9); border-color: rgba(57,217,138,.9); }

    .hr{ height:1px; background: rgba(39,52,74,.55); margin:12px 0; }

    .btnFull{
      width:100%;
      height:52px;
      border-radius:18px;
      font-weight:900;
      font-size:15px;
      justify-content:center;
    }

    /* ë¹ ë¥¸ ìƒ‰ìƒí‘œ */
    .palette{
      display:flex; gap:12px; align-items:flex-start;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .sw{
      width:42px; height:42px;
      border-radius:14px;
      border:1px solid rgba(39,52,74,.65);
      box-shadow: var(--shadow2);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      position:relative;
      overflow:hidden;
      background: rgba(10,15,24,.35);
    }
    .sw::after{
      content:"";
      position:absolute; inset:6px;
      border-radius:10px;
      background: var(--c);
    }
    .swLabel{
      margin-top:6px;
      font-size:12px;
      text-align:center;
      color: rgba(231,238,248,.85);
      font-weight:900;
    }
    .swWrap{ display:flex; flex-direction:column; align-items:center; }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }

    .field{
      width:100%;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color: rgba(231,238,248,.95);
      outline:none;
      font-weight:900;
      font-size:14px;
      font-family: var(--uiFont);
    }
    textarea.field{ min-height:90px; resize:vertical; }

    .selectedBox .label{
      font-size:14px; font-weight:900; margin-bottom:8px;
    }
    .selectedBox .sub{
      font-size:12px; color: rgba(159,176,198,.92); font-weight:900;
      margin-top:10px;
    }

    /* âœ… select/option ìŠ¤íƒ€ì¼(ê°€ëŠ¥í•œ ë²”ìœ„ ë‚´) */
    select.field{
      appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(231,238,248,.8) 50%),
        linear-gradient(135deg, rgba(231,238,248,.8) 50%, transparent 50%),
        linear-gradient(to right, transparent, transparent);
      background-position:
        calc(100% - 18px) 50%,
        calc(100% - 12px) 50%,
        0 0;
      background-size:
        6px 6px,
        6px 6px,
        100% 100%;
      background-repeat:no-repeat;
      padding-right:38px;
    }
    option{
      background:#0e1626;
      color:#e7eef8;
      font-weight:900;
    }

    /* ========== MODAL ========== */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:stretch;
      justify-content:stretch;
      z-index:200;
    }
    .modalBack.show{ display:flex; }
    .modal{
      margin:auto;
      width:min(1050px, calc(100vw - 28px));
      height:min(860px, calc(100vh - 28px));
      background: linear-gradient(180deg, rgba(14,22,38,.96), rgba(10,15,24,.92));
      border:1px solid rgba(39,52,74,.75);
      border-radius:22px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex; flex-direction:column;
    }
    .modalHead{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(39,52,74,.55);
    }
    .modalHead .title{ font-size:18px; font-weight:900; }
    .modalBody{
      padding:16px;
      overflow:auto;
      flex:1 1 auto;
    }
    .modalClose{
      height:40px;
      padding:0 14px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color: rgba(231,238,248,.92);
      cursor:pointer;
      font-weight:900;
      font-family: var(--uiFont);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    .labelRow{ color: rgba(159,176,198,.92); font-size:13px; font-weight:900; margin:10px 0 8px; }
    .checkRow{ display:flex; align-items:center; gap:10px; justify-content:flex-end; }
    .checkRow input{ width:18px; height:18px; accent-color:#a86bff; }
    .colorChip{
      width:46px; height:46px;
      border-radius:16px;
      border:1px solid rgba(39,52,74,.65);
      box-shadow: var(--shadow2);
      background: rgba(10,15,24,.35);
      position:relative;
      overflow:hidden;
    }
    .colorChip::after{ content:""; position:absolute; inset:7px; border-radius:12px; background: var(--c); }

    .styleGrid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      margin-top:14px;
    }
    .styleCard{
      border-radius:18px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      padding:14px;
      min-height:160px;
    }
    .styleCard h4{ margin:0 0 10px; font-size:18px; font-weight:900; }
    .rangeRow{ display:flex; align-items:center; gap:12px; }
    .rangeRow input[type="range"]{ width:100%; }
    .numBox{
      width:68px;
      text-align:center;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      padding:8px 10px;
      font-weight:900;
    }
    .fwSelect{ width:100%; }

    .quickTextColors{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .tSw{
      width:34px; height:34px;
      border-radius:12px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      box-shadow: var(--shadow2);
      cursor:pointer;
      position:relative;
      overflow:hidden;
    }
    .tSw::after{ content:""; position:absolute; inset:7px; border-radius:9px; background: var(--c); }

    .modalFoot{
      padding:14px 16px;
      border-top:1px solid rgba(39,52,74,.55);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .btnBig{
      height:46px;
      padding:0 16px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color: rgba(231,238,248,.95);
      font-weight:900;
      cursor:pointer;
      font-family: var(--uiFont);
    }
    .btnBig.danger{ border-color: rgba(255,93,93,.65); }
    .btnBig.ok{ border-color: rgba(57,217,138,.65); }

    /* ========== LOGIN OVERLAY ========== */
    .lock{
      position:fixed; inset:0;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center; justify-content:center;
      z-index:300;
    }
    .lock.show{ display:flex; }
    .lockBox{
      width:min(420px, calc(100vw - 28px));
      background: linear-gradient(180deg, rgba(14,22,38,.96), rgba(10,15,24,.92));
      border:1px solid rgba(39,52,74,.75);
      border-radius:22px;
      box-shadow: var(--shadow);
      padding:18px;
    }
    .lockBox h3{ margin:0 0 10px; font-size:18px; font-weight:900; }
    .lockBox p{ margin:0 0 14px; color:rgba(159,176,198,.92); font-size:13px; font-weight:900; }
    .lockRow{ display:flex; gap:10px; }
    .lockRow input{
      flex:1;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color: rgba(231,238,248,.95);
      outline:none;
      font-weight:900;
      font-size:14px;
      font-family: var(--uiFont);
    }

    /* ========== MINI PROMPT (prompt ëŒ€ì²´) ========== */
    .pBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index:260;
      align-items:center; justify-content:center;
      backdrop-filter: blur(6px);
    }
    .pBack.show{ display:flex; }
    .pBox{
      width:min(560px, calc(100vw - 28px));
      border-radius:22px;
      border:1px solid rgba(39,52,74,.75);
      background: linear-gradient(180deg, rgba(14,22,38,.96), rgba(10,15,24,.92));
      box-shadow: var(--shadow);
      padding:16px;
    }
    .pTitle{
      font-size:16px;
      font-weight:900;
      margin:0 0 10px 0;
    }
    .pHint{
      margin:0 0 12px 0;
      color: rgba(159,176,198,.92);
      font-size:12px;
      font-weight:900;
      line-height:1.45;
    }
    .pRow{ display:flex; gap:10px; align-items:center; }
    .pRow .field{ flex:1; }
    .pBtns{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }

    /* rgb picker row */
    .rgbRow{
      display:grid;
      grid-template-columns: 48px 1fr 1fr 1fr;
      gap:10px;
      align-items:center;
      margin-top:10px;
    }
    .rgbRow .rgb{
      width:100%;
      padding:12px 10px;
      border-radius:16px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color: rgba(231,238,248,.95);
      outline:none;
      font-weight:900;
      font-size:14px;
      font-family: var(--uiFont);
      text-align:center;
    }
    .rgbRow input[type="color"]{
      width:48px;
      height:44px;
      border-radius:14px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      padding:0;
      cursor:pointer;
    }

    /* responsive */
    @media (max-width: 1200px){
      body{ overflow:auto; }
      .layout{
        width: calc(var(--sideW) + 1000px + var(--sideW2));
        min-width: calc(var(--sideW) + 1000px + var(--sideW2));
      }
      .center{ min-width: 1000px; }
    }
    @media (max-width: 560px){
      .slot.fixed{ width:160px; }
      .slot.logo{ width:160px; }
      .logoBox{ width:160px; }
    }
  </style>
</head>

<body>

  <!-- LOGIN LOCK -->
  <div class="lock" id="lock">
    <div class="lockBox">
      <h3>ê´€ë¦¬ì ì¸ì¦</h3>
      <p>ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë©´ <b>24ì‹œê°„</b> ì¸ì¦ì´ ìœ ì§€ë©ë‹ˆë‹¤.</p>
      <div class="lockRow">
        <input id="pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" />
        <button class="pill ok" id="btnLogin">ë¡œê·¸ì¸</button>
      </div>
      <div class="subtle" id="lockMsg" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- MINI PROMPT (ë¸Œë¼ìš°ì € prompt ì œê±° = 5ë²ˆ ìœ„ì¹˜ ê¸€ì”¨ ì œê±° íš¨ê³¼) -->
  <div class="pBack" id="pBack" aria-hidden="true">
    <div class="pBox">
      <div class="pTitle" id="pTitle">ì…ë ¥</div>
      <p class="pHint" id="pHint">ê°’ì„ ì…ë ¥í•˜ì„¸ìš”</p>
      <div class="pRow" id="pRow">
        <input class="field" id="pInput" />
      </div>
      <div class="pBtns">
        <button class="pill ghost" id="pCancel">ì·¨ì†Œ</button>
        <button class="pill ok" id="pOk">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- GAME MENU (custom) -->
  <div class="gameMenu" id="gameMenu"></div>

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="top-left">
      <!-- Slot 1: Logo (í´ë¦­í•´ì„œ URL ì…ë ¥) -->
      <div class="slot fixed logo">
        <div class="logoBox" id="logoBox" title="ë¡œê³  í´ë¦­ â†’ URL ì…ë ¥">
          <div class="brand"><div class="word">MAPM<span class="o"></span>DE</div></div>
        </div>
      </div>

      <!-- Slot 2: Game (ì¹©/ë“œë¡­ë‹¤ìš´ í˜•íƒœ) -->
      <div class="slot fixed" title="ê²Œì„ ì„ íƒ/ì¶”ê°€" style="gap:10px; justify-content:space-between;">
        <div class="gamePill" id="gamePill">
          <span id="gameLabel">ì•„ì´ì˜¨2</span>
          <span class="chev"></span>
        </div>
        <button class="miniBtn icon edit" id="btnAddGame" title="ê²Œì„ ì¶”ê°€">+</button>
      </div>

      <!-- Slot 3: Admin label -->
      <div class="slot fixed">
        <div style="font-weight:900; color:rgba(57,217,138,.95); font-size:15px;">ADMIN</div>
      </div>

      <!-- Slot 4: Breadcrumb (4ë²ˆì§¸ ì¹´í…Œê³ ë¦¬ ìŠ¬ë¡¯) -->
      <div class="slot fixed" style="justify-content:center; gap:8px;">
        <span style="opacity:.95; font-weight:900;">ê´€ë¦¬ì</span>
        <span style="opacity:.55;">/</span>
        <span id="pathGameTop" style="opacity:.9;">ì•„ì´ì˜¨2</span>
        <span style="opacity:.55;">/</span>
        <span id="pathPageTop" style="opacity:.9;">ì „ì²´ì§€ë„</span>
      </div>
    </div>

    <!-- âœ… ìƒë‹¨ ë²„íŠ¼ë“¤ì€ 4ìŠ¬ë¡¯ ì´í›„(ì˜¤ë¥¸ìª½) -->
    <div class="top-right">
      <label class="pill small ghost" style="cursor:pointer;">
        ì§€ë„ ì—…ë¡œë“œ
        <input id="fileMap" type="file" accept="image/*" style="display:none;" />
      </label>
      <button class="pill small ghost" id="btnExport">stateë‚´ë³´ë‚´ê¸°</button>
      <button class="pill small danger" id="btnResetAll">ì „ì²´ ì´ˆê¸°í™”</button>
    </div>
  </div>

  <div class="layout">
    <!-- LEFT -->
    <aside class="side left">
      <div class="sideInner">
        <div class="card">
          <div class="sectionTitle">
            <span>í˜ì´ì§€</span>
            <span class="subtle"><b id="pathGame">ì•„ì´ì˜¨2</b> / <b id="pathPage">ì „ì²´ì§€ë„</b></span>
          </div>

          <button class="btnAddPage" id="btnAddPage">+ í˜ì´ì§€ ì¶”ê°€</button>

          <div class="subtle" style="margin-top:10px;">
            â€¢ í˜ì´ì§€ ë²„íŠ¼ í´ë¦­ â†’ ê°™ì€ ê²Œì„ ì•ˆì—ì„œ ì§€ë„ í˜ì´ì§€ ì´ë™<br/>
            â€¢ í°/ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œë„ ì§€ë„ ë³´ì´ê²Œ í•˜ë ¤ë©´: ê´€ë¦¬ìì—ì„œ URL ë²„íŠ¼ìœ¼ë¡œ ì§€ë„ ì´ë¯¸ì§€ URL ì„¤ì •
          </div>

          <div class="pageList" id="pageList"></div>
        </div>
      </div>
    </aside>

    <!-- CENTER -->
    <main class="center">
      <div class="hintToast" id="toast"></div>
      <div class="canvasWrap">
        <canvas id="cv" width="1200" height="900"></canvas>
      </div>
    </main>

    <!-- RIGHT -->
    <aside class="side right">
      <div class="sideInner">

        <!-- ì¹´í…Œê³ ë¦¬ -->
        <div class="card">
          <div class="sectionTitle">
            <span>ì¹´í…Œê³ ë¦¬</span>
            <span class="subtle">í•„í„°</span>
          </div>

          <div class="chipRow" id="catChips"></div>

          <div class="toggleRow">
            <div class="toggle" id="tgShowChainSameCat">
              <div class="dot"></div>
              <div>ê°™ì€ ì¹´í…Œê³ ë¦¬ í•„í„° ì‹œ ì„ ë„ ê°™ì´ í‘œì‹œ/ìˆ¨ê¹€</div>
            </div>

            <div class="chipRow" style="gap:10px;">
              <div class="chip" data-quickcat="4"><div class="dotc" style="background:#fff;"></div>4</div>
              <div class="chip" data-quickcat="11"><div class="dotc" style="background:#fff;"></div>11</div>
              <div class="chip" data-quickcat="22"><div class="dotc" style="background:#fff;"></div>22</div>
              <div class="chip" data-quickcat="33"><div class="dotc" style="background:#fff;"></div>33</div>
              <div class="chip" data-quickcat="44"><div class="dotc" style="background:#fff;"></div>44</div>
              <div class="chip" data-quickcat="455"><div class="dotc" style="background:#fff;"></div>455</div>
            </div>

            <div class="subtle" id="kpi" style="margin-top:2px;">í‘œì‹œ ì¤‘ ë§ˆì»¤: 0 / í˜ì´ì§€ ì „ì²´: 0</div>

            <button class="pill btnFull ghost" id="btnEditCats">ì¹´í…Œê³ ë¦¬/ìƒ‰ìƒ í¸ì§‘</button>
          </div>
        </div>

        <!-- ê´€ë¦¬ì íˆ´ -->
        <div class="card">
          <div class="sectionTitle">
            <span>ê´€ë¦¬ì íˆ´</span>
            <span class="subtle">â€¢ ìƒ‰ìƒ íŒ”ë ˆíŠ¸(ì²´ì¸ 1ë²ˆ ê¸°ì¤€ ì „íŒŒ)<br/>â€¢ ì„ ì€ "ê°™ì€ ì¹´í…Œê³ ë¦¬ í•„í„°" ì‹œ ê°™ì´ í‘œì‹œ/ìˆ¨ê¹€</span>
          </div>

          <div class="subtle" style="margin-top:8px;">ë¹ ë¥¸ ìƒ‰ìƒ (ì› ìƒ‰ìƒ ì˜¤ë²„ë¼ì´ë“œ)</div>
          <div class="palette" id="palette"></div>

          <div class="row2">
            <button class="pill btnFull ghost" id="btnApplyQuick" disabled>ì„ íƒ ë§ˆì»¤ì— ì ìš©</button>
            <button class="pill btnFull ghost" id="btnUseCatColor" disabled>ì„ íƒ ë§ˆì»¤ ìƒ‰ìƒ(ì¹´í…Œê³ ë¦¬ë¡œ)</button>
          </div>

          <div class="hr"></div>

          <div class="row2">
            <button class="pill btnFull danger" id="btnClearLines">ëª¨ë“  ì„  ì œê±°</button>
            <button class="pill btnFull ghost" id="btnRechain">ì„  ë‹¤ì‹œ ì²´ì¸(ì „ì²´)</button>
          </div>

          <div class="hr"></div>

          <button class="pill btnFull danger" id="btnResetMarkers" style="border-color:rgba(255,93,93,.65);">ë§ˆì»¤ ì´ˆê¸°í™”</button>

          <div class="hr"></div>

          <div class="selectedBox" style="margin-top:6px;">
            <div class="label">ì„ íƒí•œ ë§ˆì»¤: <span id="selName">(ì´ë¦„ ì—†ìŒ)</span></div>
            <div class="sub">ìœ íŠœë¸Œ ë§í¬</div>
            <input class="field" id="selLink" placeholder="ìœ íŠœë¸Œ" />
            <div class="sub">ìœ íŠœë¸Œ í‘œì‹œëª…</div>
            <input class="field" id="selYtTitle" placeholder="ìœ íŠœë¸Œ í‘œì‹œëª…" />
            <div style="margin-top:10px;">
              <button class="pill btnFull ghost" id="btnOpenMarkerEdit" disabled>ë§ˆì»¤ í¸ì§‘ ì—´ê¸°</button>
            </div>
          </div>
        </div>

      </div>
    </aside>
  </div>

  <!-- MARKER EDIT MODAL -->
  <div class="modalBack" id="mMarker">
    <div class="modal">
      <div class="modalHead">
        <div>
          <div class="title">ë§ˆì»¤ í¸ì§‘</div>
          <div class="subtle" style="margin-top:6px;">ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ í¸ì§‘/ì‚­ì œ ê°€ëŠ¥í•©ë‹ˆë‹¤. (Enter = ì €ì¥)</div>
        </div>
        <button class="modalClose" id="btnCloseMarker">ë‹«ê¸°</button>
      </div>

      <div class="modalBody">
        <div class="grid2">
          <div>
            <div class="labelRow">ì´ë¦„(ë§ˆì»¤ ì´ë¦„)</div>
            <input class="field" id="mfName" placeholder="ì˜ˆ: ê¸°í…” ìœ„ì¹˜" />
          </div>
          <div>
            <div class="labelRow">ì¹´í…Œê³ ë¦¬</div>
            <select class="field" id="mfCat"></select>
          </div>
        </div>

        <div class="labelRow" style="margin-top:12px;">ë§ˆì»¤ ì› ìƒ‰ìƒ (RGB ì„ íƒ ê°€ëŠ¥)</div>
        <div style="display:flex; align-items:flex-start; gap:12px; justify-content:space-between; flex-wrap:wrap;">
          <div style="flex:1; min-width:260px;">
            <input class="field" id="mfColor" placeholder="ê°œë³„ ì˜¤ë²„ë¼ì´ë“œ ìƒ‰ìƒ (ì˜ˆ: #ff0000)" />
            <div class="rgbRow">
              <input type="color" id="mfColorPick" value="#2b8cff" title="ìƒ‰ ì„ íƒ" />
              <input class="rgb" id="mfR" inputmode="numeric" pattern="[0-9]*" placeholder="R" />
              <input class="rgb" id="mfG" inputmode="numeric" pattern="[0-9]*" placeholder="G" />
              <input class="rgb" id="mfB" inputmode="numeric" pattern="[0-9]*" placeholder="B" />
            </div>
            <div class="subtle" style="margin-top:10px;">* RGBë¥¼ ìˆ˜ì •í•˜ë©´ ìë™ìœ¼ë¡œ ìƒ‰ìƒ ì½”ë“œê°€ ë°˜ì˜ë©ë‹ˆë‹¤.</div>
          </div>

          <div style="display:flex; align-items:center; gap:10px; margin-left:auto;">
            <div class="colorChip" id="mfColorChip" style="--c:#2b8cff;"></div>
            <div class="checkRow">
              <input type="checkbox" id="mfUseCatColor" />
              <label for="mfUseCatColor" class="subtle" style="cursor:pointer;">ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì‚¬ìš©</label>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="grid2">
          <div>
            <div class="labelRow">ìœ íŠœë¸Œ ë§í¬(URL)</div>
            <input class="field" id="mfYt" placeholder="https://www.youtube.com/..." />
          </div>
          <div>
            <div class="labelRow">ìœ íŠœë¸Œ í‘œì‹œëª…(ìœ ì €ëª¨ë“œ ì œëª©)</div>
            <input class="field" id="mfYtTitle" placeholder="ì˜ˆ: ê¸°í…” 1ë²ˆìœ„ì¹˜" />
          </div>
        </div>

        <div class="labelRow" style="margin-top:12px;">ë©”ëª¨ (ê´€ë¦¬ì ë“±ë¡)</div>
        <textarea class="field" id="mfMemo" placeholder="ê´€ë¦¬ì ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ìœ ì € ëª¨ë“œì—ì„œëŠ” ì½ê¸° ì „ìš©ì…ë‹ˆë‹¤."></textarea>

        <div class="hr"></div>

        <div class="labelRow">ë§ˆì»¤ ìŠ¤íƒ€ì¼</div>
        <div class="styleGrid">
          <div class="styleCard">
            <h4>ì› í¬ê¸° <span class="subtle" style="float:right;">px</span></h4>
            <div class="rangeRow">
              <input type="range" id="mfRSize" min="3" max="40" step="1" />
              <div class="numBox" id="mfRVal">6</div>
            </div>
            <div class="subtle" style="margin-top:10px;">* ì› í¬ê¸° ë³€ê²½ ì‹œ ìˆ«ì/ë¼ë²¨ í¬ê¸°ê°€ ê°™ì€ ë¹„ìœ¨ë¡œ ìë™ ë³€ê²½ë©ë‹ˆë‹¤.</div>
          </div>

          <div class="styleCard">
            <h4>ë¼ë²¨ í¬ê¸° <span class="subtle" style="float:right;">px</span></h4>
            <div class="rangeRow">
              <input type="range" id="mfFs" min="8" max="40" step="1" />
              <div class="numBox" id="mfFsVal">11</div>
            </div>
            <div class="subtle" style="margin-top:10px;">* ê¸°ë³¸ì€ ìë™ ë™ê¸°í™”</div>
          </div>

          <div class="styleCard">
            <h4>êµµê¸°/ìƒ‰ìƒ <span class="subtle" style="float:right;">ë¼ë²¨</span></h4>
            <select class="field fwSelect" id="mfFw">
              <option value="900">900 (Black)</option>
              <option value="800">800 (ExtraBold)</option>
              <option value="700">700 (Bold)</option>
              <option value="600">600 (SemiBold)</option>
            </select>

            <div class="labelRow" style="margin-top:10px;">ê¸€ì”¨ ìƒ‰ìƒ (ë¼ë²¨)</div>
            <div style="display:flex; gap:10px; align-items:center;">
              <input class="field" style="flex:1;" id="mfLabelColor" placeholder="#e7eef8" />
              <button class="btnBig" id="mfLabelDefault" type="button">ê¸°ë³¸ê°’</button>
            </div>

            <div class="labelRow" style="margin-top:10px;">ë¹ ë¥¸ ê¸€ì”¨ìƒ‰</div>
            <div class="quickTextColors" id="textColors"></div>
          </div>
        </div>

        <div class="subtle" id="mfPos" style="margin-top:12px;">ì¢Œí‘œ(ë¹„ìœ¨): -</div>
        <div class="subtle" style="margin-top:8px;">
          â€¢ ìƒˆë¡œìš´ ë²ˆí˜¸ë¡œ ì‹œì‘: ì´ ë§ˆì»¤ë¶€í„° ìƒˆ ì²´ì¸(ìƒˆ 1ë²ˆ) ì‹œì‘<br/>
          â€¢ í•´ë‹¹ ë§ˆì»¤ë¥¼ ì´ì–´ì„œ ì‹œì‘: ì´ ë§ˆì»¤ ë’¤ë¡œ "ì¤‘ê°„ ì‚½ì…" ëª¨ë“œ í™œì„±í™”
        </div>
      </div>

      <div class="modalFoot">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btnBig" id="btnNewChain">ìƒˆë¡œìš´ ë²ˆí˜¸ë¡œ ì‹œì‘</button>
          <button class="btnBig" id="btnInsertAfter">í•´ë‹¹ ë§ˆì»¤ë¥¼ ì´ì–´ì„œ ì‹œì‘</button>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-left:auto;">
          <button class="btnBig danger" id="btnDeleteMarker">ì‚­ì œ</button>
          <button class="btnBig ok" id="btnSaveMarker">ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CATEGORY EDIT MODAL -->
  <div class="modalBack" id="mCats">
    <div class="modal">
      <div class="modalHead">
        <div class="title">ì¹´í…Œê³ ë¦¬/ìƒ‰ìƒ í¸ì§‘</div>
        <button class="modalClose" id="btnCloseCats">ë‹«ê¸°</button>
      </div>

      <div class="modalBody">
        <div class="subtle">ì €ì¥í•˜ë©´ í˜„ì¬ ê²Œì„ì˜ ì¹´í…Œê³ ë¦¬ ëª©ë¡ì´ ì™„ì „íˆ êµì²´ë©ë‹ˆë‹¤.</div>

        <div class="labelRow" style="margin-top:14px;">ë¹ ë¥¸ ìƒ‰ìƒ (ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ í–‰ì— ì ìš©)</div>
        <div class="palette" id="catQuickPalette" style="margin-top:10px;"></div>
        <div class="subtle" style="margin-top:8px;">ì¹´í…Œê³ ë¦¬ í–‰ì„ ë¨¼ì € í´ë¦­í•´ì„œ ì„ íƒí•˜ì„¸ìš”.</div>

        <div class="hr"></div>

        <div class="row2">
          <button class="pill btnFull ghost" id="btnAddCat">+ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</button>
          <button class="pill btnFull ghost" id="btnCatsDefault">ê¸°ë³¸ê°’ìœ¼ë¡œ</button>
        </div>

        <div class="hr"></div>

        <div id="catRows"></div>
      </div>

      <div class="modalFoot" style="justify-content:flex-end;">
        <button class="btnBig ok" id="btnSaveCats">ì €ì¥</button>
      </div>
    </div>
  </div>

<script>
(() => {
  /************************************************************
   * ADMIN99 ì €ì¥ ê·œì¹™
   ************************************************************/
  const LS_AUTH_KEY = "mapmode_admin_auth_v99";
  const LS_KEY = "mapmode_state_v99";
  const REMOTE_STATE_URL = new URL("./data/state.json", location.href).toString();
  const PASSWORD = "0000000001";
  const AUTH_MS = 24 * 60 * 60 * 1000;

  const defaultCats = [
    { id:"ì „ì²´", name:"ì „ì²´", color:"#7cc4ff", on:true },
    { id:"ë³´ìŠ¤", name:"ë³´ìŠ¤", color:"#ff5d5d", on:true },
    { id:"ê¸°í…”", name:"ê¸°í…”", color:"#ffd60a", on:true },
    { id:"íë¸Œ", name:"íë¸Œ", color:"#2b8cff", on:true },
  ];

  const defaultState = {
    version:99,
    game:"ì•„ì´ì˜¨2",
    logoUrl:"",
    games:["ì•„ì´ì˜¨2"],
    pages: [
      { id:"p_all", name:"ì „ì²´ì§€ë„", url:"" },
      { id:"p_2", name:"2ë²ˆë§ˆì„", url:"" },
      { id:"p_3", name:"3ë²ˆë§ˆì„", url:"" },
      { id:"p_4", name:"4ë²ˆë§ˆì„", url:"" },
      { id:"p_5", name:"5ë²ˆë§ˆì„", url:"" },
      { id:"p_6", name:"6ë²ˆë§ˆì„", url:"" },
      { id:"p_7", name:"7ë²ˆë§ˆì„", url:"" },
    ],
    currentPageId:"p_all",
    categories: structuredClone(defaultCats),
    showLinesWithCatFilter:true,
    map:{ imgDataUrl:"", naturalW:1, naturalH:1, scale:0, tx:0, ty:0 },
    markers:[],
    chains:[], // (ë¯¸ì‚¬ìš© ìœ ì§€)
  };

  const $ = (id)=>document.getElementById(id);
  const cv = $("cv");
  const ctx = cv.getContext("2d");

  const toastEl = $("toast");
  const lock = $("lock");
  const pw = $("pw");
  const btnLogin = $("btnLogin");
  const lockMsg = $("lockMsg");

  const pageList = $("pageList");
  const catChips = $("catChips");
  const palette = $("palette");
  const textColors = $("textColors");

  const mMarker = $("mMarker");
  const mCats = $("mCats");

  /* ====== prompt ëŒ€ì²´ ====== */
  const pBack = $("pBack");
  const pTitle = $("pTitle");
  const pHint  = $("pHint");
  const pInput = $("pInput");
  const pOk    = $("pOk");
  const pCancel= $("pCancel");
  const pRow   = $("pRow");
  let _promptResolve = null;

  function openPrompt({title="ì…ë ¥", hint="", value="", placeholder="", type="text"}){
    return new Promise((resolve)=>{
      _promptResolve = resolve;

      pTitle.textContent = title;
      pHint.textContent = hint || "";
      pInput.type = type;
      pInput.value = value ?? "";
      pInput.placeholder = placeholder ?? "";

      pRow.style.display = "flex";
      pRow.style.gap = "10px";

      pBack.classList.add("show");
      pBack.setAttribute("aria-hidden","false");
      setTimeout(()=>pInput.focus(), 0);
    });
  }
  function closePrompt(ret){
    pBack.classList.remove("show");
    pBack.setAttribute("aria-hidden","true");
    const r = _promptResolve;
    _promptResolve = null;
    if(r) r(ret);
  }
  pCancel.addEventListener("click", ()=>closePrompt(null));
  pOk.addEventListener("click", ()=>closePrompt(pInput.value));
  pBack.addEventListener("click", (e)=>{
    if(e.target === pBack) closePrompt(null);
  });
  pInput.addEventListener("keydown", (e)=>{
    if(e.key==="Enter"){ e.preventDefault(); closePrompt(pInput.value); }
    if(e.key==="Escape"){ closePrompt(null); }
  });

  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const safeParse = (json, fallback) => { try{ return JSON.parse(json); }catch(e){ return fallback; } };
  const uid = () => Math.random().toString(36).slice(2,10);

  function toast(msg, ms=1200){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>toastEl.classList.remove("show"), ms);
  }

  function isAuthed(){
    const t = Number(localStorage.getItem(LS_AUTH_KEY) || "0");
    return (Date.now() - t) < AUTH_MS;
  }
  function setAuthed(){
    localStorage.setItem(LS_AUTH_KEY, String(Date.now()));
  }

  function requireAuth(){
    if(isAuthed()){
      lock.classList.remove("show");
      return;
    }
    lock.classList.add("show");
    pw.value = "";
    lockMsg.textContent = "";
    setTimeout(()=>pw.focus(), 0);
  }

  btnLogin.addEventListener("click", ()=>{
    if(pw.value === PASSWORD){
      setAuthed();
      lock.classList.remove("show");
      toast("ì¸ì¦ ì™„ë£Œ");
    }else{
      lockMsg.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      toast("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
    }
  });
  pw.addEventListener("keydown", (e)=>{
    if(e.key==="Enter") btnLogin.click();
  });

  // ---------- state ----------
  let S = structuredClone(defaultState);

  // âœ… í˜„ì¬ í˜ì´ì§€ì˜ urlì„ ì§€ë„ ì†ŒìŠ¤ë¡œë„ ì‚¬ìš©
  let mapImg = new Image();
  mapImg.crossOrigin = "anonymous";
  let mapImgSrc = ""; // í˜„ì¬ ë¡œë”©ëœ src(ì¤‘ë³µ ë¡œë”© ë°©ì§€)

  function mergeState(st){
    const merged = structuredClone(defaultState);
    if(st && typeof st === "object") Object.assign(merged, st);
    merged.pages = Array.isArray(st?.pages) && st.pages.length ? st.pages : structuredClone(defaultState.pages);
    merged.categories = Array.isArray(st?.categories) && st.categories.length ? st.categories : structuredClone(defaultCats);
    merged.markers = Array.isArray(st?.markers) ? st.markers : [];
    merged.chains = Array.isArray(st?.chains) ? st.chains : [];
    merged.map = Object.assign(structuredClone(defaultState.map), st?.map||{});
    merged.games = Array.isArray(st?.games) && st.games.length ? st.games : ["ì•„ì´ì˜¨2"];
    if(!merged.pages.find(p=>p.id===merged.currentPageId)) merged.currentPageId = merged.pages[0].id;
    if(!merged.games.includes(merged.game)) merged.game = merged.games[0];
    return merged;
  }

  function saveLocal(){
    localStorage.setItem(LS_KEY, JSON.stringify(S));
  }

  async function loadStateRemoteFirst(){
    try{
      const r = await fetch(REMOTE_STATE_URL, { cache:"no-store" });
      if(r.ok){
        const st = await r.json();
        localStorage.setItem(LS_KEY, JSON.stringify(st));
        return st;
      }
    }catch(e){}
    const raw = localStorage.getItem(LS_KEY);
    return raw ? safeParse(raw, structuredClone(defaultState)) : structuredClone(defaultState);
  }

  // ---------- logo ----------
  const logoBox = $("logoBox");
  function renderLogo(){
    logoBox.innerHTML = "";
    if(S.logoUrl){
      const img = document.createElement("img");
      img.src = S.logoUrl;
      img.alt = "logo";
      img.onerror = () => {
        logoBox.innerHTML = `<div class="brand"><div class="word">MAPM<span class="o"></span>DE</div></div>`;
      };
      logoBox.appendChild(img);
    }else{
      logoBox.innerHTML = `<div class="brand"><div class="word">MAPM<span class="o"></span>DE</div></div>`;
    }
  }
  logoBox.addEventListener("click", async ()=>{
    requireAuth();
    if(!isAuthed()) return;

    const cur = S.logoUrl || "";
    const next = await openPrompt({
      title: "ë¡œê³  URL",
      hint: "ë¡œê³  ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”. ë¹„ìš°ë©´ ê¸°ë³¸ ë¡œê³ ê°€ í‘œì‹œë©ë‹ˆë‹¤.",
      value: cur,
      placeholder: "https://.../logo.png"
    });
    if(next === null) return;
    S.logoUrl = (next || "").trim();
    saveLocal();
    renderLogo();
    toast("ë¡œê³  ì„¤ì • ì €ì¥");
  });

  // ---------- game menu (custom chip dropdown) ----------
  const gamePill = $("gamePill");
  const gameLabel = $("gameLabel");
  const gameMenu = $("gameMenu");

  function renderGames(){
    gameLabel.textContent = S.game;
    $("pathGameTop").textContent = S.game;
    $("pathGame").textContent = S.game;

    gameMenu.innerHTML = "";
    for(const g of S.games){
      const row = document.createElement("div");
      row.className = "gameItem" + (g===S.game ? " on":"");
      row.innerHTML = `<div>${g}</div><div class="tag">${g===S.game ? "ì„ íƒë¨" : ""}</div>`;
      row.addEventListener("click", ()=>{
        requireAuth();
        if(!isAuthed()) return;
        S.game = g;
        saveLocal();
        renderGames();
        hideGameMenu();
        toast("ê²Œì„ ë³€ê²½");
      });
      gameMenu.appendChild(row);
    }
  }

  function showGameMenu(){
    const rect = gamePill.getBoundingClientRect();
    gameMenu.style.left = Math.round(rect.left) + "px";
    gameMenu.style.top  = Math.round(rect.bottom + 8) + "px";
    gameMenu.classList.add("show");
  }
  function hideGameMenu(){ gameMenu.classList.remove("show"); }
  gamePill.addEventListener("click", ()=>{
    if(gameMenu.classList.contains("show")) hideGameMenu();
    else showGameMenu();
  });
  window.addEventListener("click", (e)=>{
    if(e.target.closest("#gamePill")) return;
    if(e.target.closest("#gameMenu")) return;
    hideGameMenu();
  });

  const btnAddGame = $("btnAddGame");
  btnAddGame.addEventListener("click", async ()=>{
    requireAuth();
    if(!isAuthed()) return;

    const name = await openPrompt({
      title: "ê²Œì„ ì¶”ê°€",
      hint: "ì¶”ê°€í•  ê²Œì„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.",
      value: "",
      placeholder: "ì˜ˆ) ì•„ì´ì˜¨2"
    });
    if(!name) return;
    const g = name.trim();
    if(!g) return;
    if(S.games.includes(g)){
      toast("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²Œì„");
      return;
    }
    S.games.push(g);
    S.game = g;
    saveLocal();
    renderGames();
    toast("ê²Œì„ ì¶”ê°€");
  });

  // ---------- pages ----------
  function curPageObj(){
    return S.pages.find(p=>p.id===S.currentPageId) || S.pages[0];
  }

  function renderPages(){
    pageList.innerHTML = "";
    const cur = curPageObj();
    $("pathPage").textContent = cur ? cur.name : "ì „ì²´ì§€ë„";
    $("pathPageTop").textContent = cur ? cur.name : "ì „ì²´ì§€ë„";

    for(const p of S.pages){
      const item = document.createElement("div");
      item.className = "pageItem" + (p.id===S.currentPageId ? " active" : "");
      item.innerHTML = `
        <div class="pageName">${p.name}</div>
        <div class="pageActions">
          <button class="miniBtn url" title="ì§€ë„ ì´ë¯¸ì§€ URL ì„¤ì •">URL</button>
          <button class="miniBtn icon edit" title="ì´ë¦„ í¸ì§‘">âœ</button>
          <button class="miniBtn icon del" title="ì‚­ì œ">ğŸ—‘</button>
        </div>
      `;
      item.addEventListener("click", (e)=>{
        const btn = e.target.closest("button");
        if(btn) return;
        S.currentPageId = p.id;
        saveLocal();
        renderPages();
        renderKpi();
        loadMapForCurrentPage(true);
      });

      const [bUrl, bEdit, bDel] = item.querySelectorAll("button");

      bUrl.addEventListener("click", async (e)=>{
        e.stopPropagation();
        requireAuth();
        if(!isAuthed()) return;

        const next = await openPrompt({
          title:"í˜ì´ì§€ ì§€ë„ URL",
          hint:"ì´ í˜ì´ì§€ì˜ ì§€ë„ ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”.",
          value: p.url || "",
          placeholder:"https://.../map.png"
        });
        if(next === null) return;
        p.url = (next || "").trim();
        saveLocal();
        toast("í˜ì´ì§€ URL ì €ì¥");
        if(p.id === S.currentPageId){
          loadMapForCurrentPage(true);
        }
      });

      bEdit.addEventListener("click", async (e)=>{
        e.stopPropagation();
        requireAuth();
        if(!isAuthed()) return;

        const next = await openPrompt({
          title:"í˜ì´ì§€ ì´ë¦„ ìˆ˜ì •",
          hint:"í˜ì´ì§€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.",
          value: p.name,
          placeholder:"ì˜ˆ) ë„ë§ìë§ˆì„"
        });
        if(!next) return;
        p.name = next.trim();
        saveLocal();
        renderPages();
        toast("í˜ì´ì§€ ì´ë¦„ ìˆ˜ì •");
      });

      bDel.addEventListener("click", (e)=>{
        e.stopPropagation();
        requireAuth();
        if(!isAuthed()) return;
        if(S.pages.length <= 1){ toast("ìµœì†Œ 1ê°œ í˜ì´ì§€ëŠ” í•„ìš”í•©ë‹ˆë‹¤"); return; }
        if(!confirm(`"${p.name}" í˜ì´ì§€ë¥¼ ì‚­ì œí• ê¹Œìš”? (í•´ë‹¹ í˜ì´ì§€ ë§ˆì»¤ë„ ê°™ì´ ì‚­ì œë©ë‹ˆë‹¤)`)) return;

        const pid = p.id;
        S.markers = S.markers.filter(m=>m.pageId !== pid);
        S.pages = S.pages.filter(x=>x.id !== pid);
        if(S.currentPageId === pid) S.currentPageId = S.pages[0].id;

        saveLocal();
        renderPages();
        renderKpi();
        loadMapForCurrentPage(true);
        toast("í˜ì´ì§€ ì‚­ì œ");
      });

      pageList.appendChild(item);
    }
  }

  $("btnAddPage").addEventListener("click", async ()=>{
    requireAuth();
    if(!isAuthed()) return;

    const name = await openPrompt({
      title:"í˜ì´ì§€ ì¶”ê°€",
      hint:"ì¶”ê°€í•  í˜ì´ì§€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: ë„ë§ìë§ˆì„)",
      value:"",
      placeholder:"ë„ë§ìë§ˆì„"
    });
    if(!name) return;
    const p = { id:"p_"+uid(), name:name.trim(), url:"" };
    S.pages.push(p);
    S.currentPageId = p.id;
    saveLocal();
    renderPages();
    renderKpi();
    loadMapForCurrentPage(true);
    toast("í˜ì´ì§€ ì¶”ê°€");
  });

  // ---------- categories ----------
  function getCat(id){ return S.categories.find(c=>c.id===id); }
  function ensureCat(name, color){
    if(S.categories.some(c=>c.id===name)) return;
    S.categories.push({ id:name, name, color:color||"#ffffff", on:true });
  }
  function markerColor(m){
    if(!m) return "#7cc4ff";
    if(m.useCatColor){
      const c = getCat(m.cat);
      return (c && c.color) ? c.color : "#7cc4ff";
    }
    if(m.colorOverride && m.colorOverride.trim()) return m.colorOverride.trim();
    const c = getCat(m.cat);
    return (c && c.color) ? c.color : "#7cc4ff";
  }

  function renderCats(){
    catChips.innerHTML = "";
    for(const c of S.categories){
      const chip = document.createElement("div");
      chip.className = "chip" + (c.on ? " on" : "");
      chip.innerHTML = `<div class="dotc" style="background:${c.color};"></div><div>${c.name}</div>`;
      chip.addEventListener("click", ()=>{
        requireAuth();
        if(!isAuthed()) return;
        c.on = !c.on;
        if(!S.categories.some(x=>x.on)){
          c.on = true;
          toast("ìµœì†Œ 1ê°œ ì¹´í…Œê³ ë¦¬ëŠ” ì¼œì ¸ì•¼ í•©ë‹ˆë‹¤");
        }
        saveLocal();
        renderCats();
        renderKpi();
        draw();
      });
      catChips.appendChild(chip);
    }
  }

  function setToggle(el, on){
    el.classList.toggle("on", !!on);
    el.dataset.on = on ? "1" : "0";
  }
  const tgShowLinesWithCatFilter = $("tgShowChainSameCat");
  tgShowLinesWithCatFilter.addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    S.showLinesWithCatFilter = !S.showLinesWithCatFilter;
    setToggle(tgShowLinesWithCatFilter, S.showLinesWithCatFilter);
    saveLocal();
    draw();
  });

  document.querySelectorAll('[data-quickcat]').forEach(ch=>{
    ch.addEventListener("click", ()=>{
      requireAuth(); if(!isAuthed()) return;
      if(!selectedMarker){ toast("ë§ˆì»¤ë¥¼ ì„ íƒí•˜ì„¸ìš”"); return; }
      const name = ch.getAttribute("data-quickcat");
      ensureCat(name, "#ffffff");
      selectedMarker.cat = name;
      selectedMarker.useCatColor = true;

      // âœ… ê°™ì€ ì¹´í…Œê³ ë¦¬ëŠ” ê°™ì€ ìŠ¤íƒ€ì¼/ìƒ‰(1ë²ˆ ê¸°ì¤€)ì„ ë” ê°•í•˜ê²Œ ìœ ì§€
      applyCatStyleDefaultsFromFirst(selectedMarker);

      saveLocal();
      syncSelectedPanel();
      draw();
      toast("ì¹´í…Œê³ ë¦¬ ë³€ê²½");
    });
  });

  // ---------- map upload / url load ----------
  $("fileMap").addEventListener("change", async (e)=>{
    requireAuth();
    if(!isAuthed()) return;
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const dataUrl = await fileToDataURL(f);
    S.map.imgDataUrl = dataUrl;
    saveLocal();
    loadMapForCurrentPage(true);
    toast("ì§€ë„ ì—…ë¡œë“œ ì™„ë£Œ");
    e.target.value = "";
  });

  function fileToDataURL(file){
    return new Promise((res, rej)=>{
      const fr = new FileReader();
      fr.onload = ()=>res(fr.result);
      fr.onerror = rej;
      fr.readAsDataURL(file);
    });
  }

  function loadMapForCurrentPage(fit=true){
    const p = curPageObj();
    const url = (p && p.url) ? p.url.trim() : "";
    const dataUrl = (S.map.imgDataUrl || "").trim();

    let src = "";
    if(url) src = url;
    else if(dataUrl) src = dataUrl;

    if(!src){
      mapImg = new Image();
      mapImg.crossOrigin = "anonymous";
      mapImg.onload = ()=>{
        S.map.naturalW = mapImg.naturalWidth || 1;
        S.map.naturalH = mapImg.naturalHeight || 1;
        if(!S.map.scale || S.map.scale<=0 || fit) fitToScreen();
        draw();
      };
      mapImg.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(
        `<svg xmlns="http://www.w3.org/2000/svg" width="1400" height="1000">
          <defs>
            <radialGradient id="g" cx="50%" cy="40%" r="70%">
              <stop offset="0%" stop-color="#ffffff"/>
              <stop offset="100%" stop-color="#e8edf7"/>
            </radialGradient>
          </defs>
          <rect width="100%" height="100%" fill="url(#g)"/>
          <text x="50%" y="50%" text-anchor="middle" font-family="Arial" font-size="28" fill="#7a889e">ì§€ë„ ì—…ë¡œë“œ ë˜ëŠ” í˜ì´ì§€ URL ì„¤ì •</text>
        </svg>`
      );
      mapImgSrc = mapImg.src;
      draw();
      return;
    }

    if(src === mapImgSrc && mapImg && mapImg.complete){
      if(fit) fitToScreen();
      draw();
      return;
    }

    mapImg = new Image();
    mapImg.crossOrigin = "anonymous";
    mapImg.onload = ()=>{
      S.map.naturalW = mapImg.naturalWidth || 1;
      S.map.naturalH = mapImg.naturalHeight || 1;
      if(!S.map.scale || S.map.scale<=0 || fit) fitToScreen();
      saveLocal();
      draw();
    };
    mapImg.onerror = ()=>{
      toast("ì§€ë„ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨(URL í™•ì¸)");
      draw();
    };
    mapImg.src = src;
    mapImgSrc = src;
  }

  // ---------- export ----------
  $("btnExport").addEventListener("click", ()=>{
    requireAuth();
    if(!isAuthed()) return;
    const blob = new Blob([JSON.stringify(S, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "state99.json";
    a.click();
    URL.revokeObjectURL(a.href);
    toast("state ë‚´ë³´ë‚´ê¸° ì™„ë£Œ");
  });

  $("btnResetAll").addEventListener("click", ()=>{
    requireAuth();
    if(!isAuthed()) return;
    if(!confirm("ì „ì²´ ì´ˆê¸°í™”í• ê¹Œìš”? (í˜ì´ì§€/ë§ˆì»¤/ì§€ë„ í¬í•¨)")) return;
    S = structuredClone(defaultState);
    saveLocal();
    renderAll();
    loadMapForCurrentPage(true);
    toast("ì „ì²´ ì´ˆê¸°í™” ì™„ë£Œ");
  });

  // ---------- canvas sizing ----------
  function resizeCanvas(){
    const wrap = cv.parentElement;
    const w = wrap.clientWidth - 32;
    const h = wrap.clientHeight - 32;
    cv.width = Math.max(900, Math.floor(w));
    cv.height = Math.max(650, Math.floor(h));
  }
  window.addEventListener("resize", ()=>{ resizeCanvas(); draw(); });

  function fitToScreen(){
    const pad = 40;
    const iw = S.map.naturalW || (mapImg?.naturalWidth||1);
    const ih = S.map.naturalH || (mapImg?.naturalHeight||1);
    const cw = cv.width, ch = cv.height;
    const scale = Math.min((cw - pad)/iw, (ch - pad)/ih);
    S.map.scale = clamp(scale, 0.05, 10);
    S.map.tx = (cw - iw*S.map.scale)/2;
    S.map.ty = (ch - ih*S.map.scale)/2;
  }

  // ---------- marker data ----------
  function getVisibleMarkers(){
    const curPage = S.currentPageId;
    const onCats = new Set(S.categories.filter(c=>c.on).map(c=>c.id));
    const allOn = onCats.has("ì „ì²´");
    return (S.markers||[]).filter(m=>{
      if(m.pageId !== curPage) return false;
      if(allOn) return true;
      return onCats.has(m.cat);
    });
  }

  function renderKpi(){
    const curPage = S.currentPageId;
    const total = (S.markers||[]).filter(m=>m.pageId===curPage).length;
    const shown = getVisibleMarkers().length;
    $("kpi").textContent = `í‘œì‹œ ì¤‘ ë§ˆì»¤: ${shown} / í˜ì´ì§€ ì „ì²´: ${total}`;
  }

  // ---------- geometry helpers ----------
  function worldFromNorm(nx, ny){
    const iw = S.map.naturalW || (mapImg?.naturalWidth||1);
    const ih = S.map.naturalH || (mapImg?.naturalHeight||1);
    return { x:nx*iw, y:ny*ih };
  }
  function screenFromWorld(wx, wy){
    return { sx: wx*S.map.scale + S.map.tx, sy: wy*S.map.scale + S.map.ty };
  }
  function worldFromScreen(sx, sy){
    return { wx:(sx - S.map.tx)/S.map.scale, wy:(sy - S.map.ty)/S.map.scale };
  }
  function normFromWorld(wx, wy){
    const iw = S.map.naturalW || (mapImg?.naturalWidth||1);
    const ih = S.map.naturalH || (mapImg?.naturalHeight||1);
    return { nx: clamp(wx/iw, 0, 1), ny: clamp(wy/ih, 0, 1) };
  }

  // ---------- (ìš”ì²­) ê°™ì€ ì¹´í…Œê³ ë¦¬ëŠ” ê°™ì€ ìƒ‰/í¬ê¸°/í°íŠ¸(ê° 1ë²ˆ ê¸°ì¤€) ----------
  function findFirstMarkerStyleByCat(cat){
    const ms = (S.markers||[])
      .filter(m=>m.pageId===S.currentPageId && m.cat===cat && (m.chainIndex===1));
    if(!ms.length) return null;
    ms.sort((a,b)=>(a.createdAt||0)-(b.createdAt||0));
    const m = ms[0];
    return { r:m.r, fs:m.fs, fw:m.fw, labelColor:m.labelColor, useCatColor:m.useCatColor, colorOverride:m.colorOverride };
  }
  function applyCatStyleDefaultsFromFirst(m){
    const st = findFirstMarkerStyleByCat(m.cat);
    if(!st) return;
    m.r = st.r ?? m.r;
    m.fs = st.fs ?? m.fs;
    m.fw = st.fw ?? m.fw;
    m.labelColor = st.labelColor ?? m.labelColor;

    // ìƒ‰ì€ "ê°™ì€ ì¹´í…Œê³ ë¦¬ = ê°™ì€ ìƒ‰"ì´ë¯€ë¡œ ê¸°ë³¸ì€ ì¹´í…Œê³ ë¦¬ ìƒ‰ ì‚¬ìš© ìœ ì§€
    m.useCatColor = true;
    m.colorOverride = "";
  }

  // ---------- drawing ----------
  let circleHitboxes = []; // {id,sx,sy,rPx}
  function drawArrowHead(x2, y2, x1, y1, size){
    const ang = Math.atan2(y2 - y1, x2 - x1);
    const a1 = ang + Math.PI * 0.85;
    const a2 = ang - Math.PI * 0.85;
    ctx.beginPath();
    ctx.moveTo(x2, y2);
    ctx.lineTo(x2 + Math.cos(a1)*size, y2 + Math.sin(a1)*size);
    ctx.lineTo(x2 + Math.cos(a2)*size, y2 + Math.sin(a2)*size);
    ctx.closePath();
    ctx.fill();
    ctx.stroke();
  }

  function draw(){
    ctx.clearRect(0,0,cv.width,cv.height);
    circleHitboxes = [];

    ctx.save();
    ctx.fillStyle = "rgba(0,0,0,.22)";
    ctx.fillRect(0,0,cv.width,cv.height);
    ctx.restore();

    ctx.save();
    ctx.translate(S.map.tx, S.map.ty);
    ctx.scale(S.map.scale, S.map.scale);

    // map
    if(mapImg && mapImg.complete){
      const iw = S.map.naturalW || (mapImg.naturalWidth||1);
      const ih = S.map.naturalH || (mapImg.naturalHeight||1);
      ctx.drawImage(mapImg, 0,0, iw, ih);
    }

    const ms = getVisibleMarkers();

    // ì²´ì¸ ë¼ì¸ + í™”ì‚´í‘œ (í™•ëŒ€í•´ë„ ì‹ë³„ë˜ê²Œ)
    const showLines = !!S.showLinesWithCatFilter;
    if(showLines){
      const byChain = new Map();
      for(const m of ms){
        if(!m.chainId || !m.chainIndex) continue;
        if(!byChain.has(m.chainId)) byChain.set(m.chainId, []);
        byChain.get(m.chainId).push(m);
      }

      const lw = 2.2 / S.map.scale;
      ctx.lineWidth = lw;
      ctx.strokeStyle = "rgba(255,255,255,.88)";
      ctx.fillStyle = "rgba(255,255,255,.92)";
      ctx.globalAlpha = 0.98;

      for(const arr of byChain.values()){
        arr.sort((a,b)=>(a.chainIndex||0)-(b.chainIndex||0));
        if(arr.length<2) continue;

        ctx.beginPath();
        for(let i=0;i<arr.length;i++){
          const p = worldFromNorm(arr[i].x, arr[i].y);
          if(i===0) ctx.moveTo(p.x, p.y);
          else ctx.lineTo(p.x, p.y);
        }
        ctx.stroke();

        // âœ… í™”ì‚´í‘œ: í™”ë©´ í”½ì…€ ê¸°ì¤€ìœ¼ë¡œ ë” í¬ê²Œ + í…Œë‘ë¦¬(ê²€ì •)ë¡œ ì‹ë³„ì„± ê°•í™”
        const ah = 14 / S.map.scale; // screenâ‰ˆ14px
        ctx.lineWidth = 2.0 / S.map.scale;
        ctx.strokeStyle = "rgba(0,0,0,.35)";
        ctx.fillStyle = "rgba(255,255,255,.95)";
        for(let i=0;i<arr.length-1;i++){
          const a = worldFromNorm(arr[i].x, arr[i].y);
          const b = worldFromNorm(arr[i+1].x, arr[i+1].y);
          const dx = b.x - a.x, dy = b.y - a.y;
          const len = Math.hypot(dx,dy) || 1;
          const ux = dx/len, uy = dy/len;
          const bx = b.x - ux*(ah*1.55);
          const by = b.y - uy*(ah*1.55);
          drawArrowHead(bx, by, a.x, a.y, ah);
        }
      }
    }

    // markers
    for(const m of ms){
      const p = worldFromNorm(m.x, m.y);

      const r = (m.r ?? Number(getComputedStyle(document.documentElement).getPropertyValue("--mR")) || 6);
      const col = markerColor(m);

      // circle
      ctx.save();
      ctx.globalAlpha = 1;
      ctx.beginPath();
      ctx.arc(p.x, p.y, r, 0, Math.PI*2);
      ctx.fillStyle = col;
      ctx.fill();
      ctx.lineWidth = 1.6 / S.map.scale;
      ctx.strokeStyle = "rgba(0,0,0,.35)";
      ctx.stroke();
      ctx.restore();

      // number (âœ… ì› í¬ê¸°ì— ë¹„ë¡€)
      const num = (m.chainIndex != null) ? String(m.chainIndex) : "";
      if(num){
        ctx.save();
        ctx.globalAlpha = 0.98;
        ctx.fillStyle = "rgba(0,0,0,.78)";
        const numFs = Math.max(8, Math.round(r * (Number(getComputedStyle(document.documentElement).getPropertyValue("--mNumScale")) || 1.25)));
        ctx.font = `${m.fw ?? 900} ${numFs}px ui-sans-serif`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(num, p.x, p.y + 0.5);
        ctx.restore();
      }

      // label
      if(m.name){
        ctx.save();
        ctx.globalAlpha = 0.98;
        ctx.fillStyle = m.labelColor || "#e7eef8";
        const fs = (m.fs ?? Number(getComputedStyle(document.documentElement).getPropertyValue("--mFs")) || 11);
        ctx.font = `${m.fw ?? 900} ${fs}px ui-sans-serif`;
        ctx.textAlign = "left";
        ctx.textBaseline = "middle";
        const off = r + 7;
        ctx.fillText(m.name, p.x + off, p.y);
        ctx.restore();
      }

      // hitbox
      const sp = screenFromWorld(p.x, p.y);
      circleHitboxes.push({ id:m.id, sx:sp.sx, sy:sp.sy, rPx: r*S.map.scale });
    }

    ctx.restore();
  }

  function pickCircleAt(sx, sy){
    let best=null, bestD=Infinity;
    for(const c of circleHitboxes){
      const d = Math.hypot(c.sx - sx, c.sy - sy);
      if(d <= c.rPx*1.25 && d < bestD){
        best = c;
        bestD = d;
      }
    }
    return best;
  }

  // ---------- pan/zoom + marker drag ----------
  let isPanning=false, lastX=0,lastY=0;

  let isDraggingMarker = false;
  let draggingId = null;

  let dragOffWX = 0, dragOffWY = 0;

  function setMarkerPosByWorld(marker, wx, wy){
    const n = normFromWorld(wx, wy);
    marker.x = n.nx;
    marker.y = n.ny;
  }

  cv.addEventListener("pointerdown", (e)=>{
    requireAuth(); if(!isAuthed()) return;

    cv.setPointerCapture(e.pointerId);
    lastX=e.clientX; lastY=e.clientY;

    const rect = cv.getBoundingClientRect();
    const sx = e.clientX - rect.left;
    const sy = e.clientY - rect.top;

    const hit = pickCircleAt(sx, sy);
    if(hit && e.button === 0){
      const m = S.markers.find(x=>x.id===hit.id);
      if(m){
        isDraggingMarker = true;
        draggingId = m.id;
        selectMarker(m.id);

        const wm = worldFromNorm(m.x, m.y);
        const w = worldFromScreen(sx, sy);
        dragOffWX = wm.x - w.wx;
        dragOffWY = wm.y - w.wy;

        isPanning = false;
        return;
      }
    }

    if(e.button === 0){
      isPanning=true;
    }
  });

  cv.addEventListener("pointermove", (e)=>{
    requireAuth(); if(!isAuthed()) return;

    const rect = cv.getBoundingClientRect();
    const sx = e.clientX - rect.left;
    const sy = e.clientY - rect.top;

    if(isDraggingMarker && draggingId){
      const m = S.markers.find(x=>x.id===draggingId);
      if(!m) return;

      const w = worldFromScreen(sx, sy);
      const wx = w.wx + dragOffWX;
      const wy = w.wy + dragOffWY;
      setMarkerPosByWorld(m, wx, wy);

      draw();
      clearTimeout(draw._dragSaveT);
      draw._dragSaveT = setTimeout(()=>{ saveLocal(); }, 120);
      return;
    }

    if(!isPanning) return;
    const dx=e.clientX-lastX, dy=e.clientY-lastY;
    lastX=e.clientX; lastY=e.clientY;
    S.map.tx += dx;
    S.map.ty += dy;
    draw();
  });

  function endPointer(){
    if(isDraggingMarker){
      isDraggingMarker = false;
      draggingId = null;
      saveLocal();
      toast("ë§ˆì»¤ ì´ë™ ì €ì¥");
    }
    isPanning=false;
  }
  cv.addEventListener("pointerup", endPointer);
  cv.addEventListener("pointercancel", endPointer);

  cv.addEventListener("wheel", (e)=>{
    e.preventDefault();
    const rect = cv.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;

    const old = S.map.scale || 1;
    const zoom = Math.exp(-e.deltaY * 0.0012);
    const next = clamp(old * zoom, 0.05, 10);

    const wx = (mx - S.map.tx) / old;
    const wy = (my - S.map.ty) / old;

    S.map.scale = next;
    S.map.tx = mx - wx * next;
    S.map.ty = my - wy * next;

    draw();
  }, {passive:false});

  // ---------- marker create / select ----------
  let selectedMarker = null;
  let insertAfterMarkerId = null;

  let lastChainIdByPage = new Map();
  function getOrCreateDefaultChainId(pageId){
    if(lastChainIdByPage.has(pageId)) return lastChainIdByPage.get(pageId);
    const ms = (S.markers||[]).filter(m=>m.pageId===pageId && m.chainId && m.chainIndex);
    if(ms.length){
      ms.sort((a,b)=>(b.chainIndex||0)-(a.chainIndex||0));
      lastChainIdByPage.set(pageId, ms[0].chainId);
      return ms[0].chainId;
    }
    const cid = "c_"+uid();
    lastChainIdByPage.set(pageId, cid);
    return cid;
  }

  function nextChainIndex(pageId, chainId){
    const ms = (S.markers||[]).filter(m=>m.pageId===pageId && m.chainId===chainId && m.chainIndex);
    let max = 0;
    for(const m of ms) max = Math.max(max, m.chainIndex||0);
    return max + 1;
  }

  function defaultCatForNewMarker(){
    return (S.categories.find(c=>c.on && c.id!=="ì „ì²´")?.id) || "ê¸°í…”";
  }

  function newMarkerAt(normX, normY){
    const pid = S.currentPageId;
    const defaultCat = defaultCatForNewMarker();

    const m = {
      id:"m_"+uid(),
      pageId:pid,
      x:normX, y:normY,
      name:"",
      cat: defaultCat,
      colorOverride:"",
      useCatColor:true,
      yt:"",
      ytTitle:"",
      memo:"",
      r:Number(getComputedStyle(document.documentElement).getPropertyValue("--mR")) || 6,
      fs:Number(getComputedStyle(document.documentElement).getPropertyValue("--mFs")) || 11,
      fw:900,
      labelColor:"#e7eef8",
      chainId:null,
      chainIndex:null,
      createdAt: Date.now()
    };

    if(insertAfterMarkerId){
      const base = S.markers.find(x=>x.id===insertAfterMarkerId);
      if(base && base.chainId){
        m.chainId = base.chainId;
        m.chainIndex = (base.chainIndex||0) + 1;
        for(const mm of S.markers){
          if(mm.chainId===m.chainId && (mm.chainIndex||0) >= m.chainIndex){
            mm.chainIndex = (mm.chainIndex||0) + 1;
          }
        }
      }else{
        const cid = getOrCreateDefaultChainId(pid);
        m.chainId = cid;
        m.chainIndex = nextChainIndex(pid, cid);
      }
    }else{
      const cid = getOrCreateDefaultChainId(pid);
      m.chainId = cid;
      m.chainIndex = nextChainIndex(pid, cid);
    }

    // âœ… (ìš”ì²­) ìš°í´ë¦­ ìƒì„± ì‹œ í…ìŠ¤íŠ¸ ìë™ ìƒì„±: "në²ˆ + ì¹´í…Œê³ ë¦¬"
    m.name = `${m.chainIndex}ë²ˆ ${m.cat}`;

    // âœ… (ìš”ì²­) ê°™ì€ ì¹´í…Œê³ ë¦¬ëŠ” ê°™ì€ ìŠ¤íƒ€ì¼(ê° 1ë²ˆ ê¸°ì¤€)
    // 1ë²ˆì´ ì´ë¯¸ ìˆìœ¼ë©´ ê·¸ ìŠ¤íƒ€ì¼ì„ ë³µì‚¬
    applyCatStyleDefaultsFromFirst(m);

    // âœ… ì²´ì¸ 1ë²ˆì´ë©´ "ê·¸ ìì²´ê°€ ê¸°ì¤€"ì´ ë˜ë¯€ë¡œ ê¸°ë³¸ê°’ ìœ ì§€
    if(m.chainIndex === 1){
      m.useCatColor = true;
      m.colorOverride = "";
    }

    S.markers.push(m);

    // âœ… ê°™ì€ ì²´ì¸ì—ì„œ 1ë²ˆ ìŠ¤íƒ€ì¼ì„ í›„ìˆœìœ„ì—ë„ ê°•ì œ(ìš”ì²­)
    propagateStyleFromChainFirst(m.chainId);

    saveLocal();
    selectMarker(m.id);
    renderKpi();
    draw();
  }

  function propagateStyleFromChainFirst(chainId){
    if(!chainId) return;
    const list = (S.markers||[])
      .filter(x=>x.pageId===S.currentPageId && x.chainId===chainId && x.chainIndex!=null)
      .sort((a,b)=>(a.chainIndex||0)-(b.chainIndex||0));
    const first = list.find(x=>x.chainIndex===1);
    if(!first) return;

    for(const mm of list){
      if(mm===first) continue;
      // âœ… í¬ê¸°/í°íŠ¸/êµµê¸°/ë¼ë²¨ìƒ‰: 1ë²ˆ ê¸°ì¤€
      mm.r = first.r ?? mm.r;
      mm.fs = first.fs ?? mm.fs;
      mm.fw = first.fw ?? mm.fw;
      mm.labelColor = first.labelColor ?? mm.labelColor;

      // âœ… ê°™ì€ ì¹´í…Œê³ ë¦¬ëŠ” ê°™ì€ ìƒ‰(ì¹´í…Œê³ ë¦¬ìƒ‰ ì‚¬ìš©)
      mm.useCatColor = true;
      mm.colorOverride = "";
    }
  }

  function selectMarker(id){
    selectedMarker = S.markers.find(m=>m.id===id) || null;
    syncSelectedPanel();
  }

  function syncSelectedPanel(){
    $("selName").textContent = selectedMarker ? (selectedMarker.name || "(ì´ë¦„ ì—†ìŒ)") : "(ì´ë¦„ ì—†ìŒ)";
    $("selLink").value = selectedMarker ? (selectedMarker.yt || "") : "";
    $("selYtTitle").value = selectedMarker ? (selectedMarker.ytTitle || "") : "";
    $("btnOpenMarkerEdit").disabled = !selectedMarker;
    $("btnApplyQuick").disabled = !selectedMarker;
    $("btnUseCatColor").disabled = !selectedMarker;
  }

  cv.addEventListener("click", (e)=>{
    requireAuth(); if(!isAuthed()) return;
    if(isDraggingMarker) return;

    const rect = cv.getBoundingClientRect();
    const sx = e.clientX - rect.left;
    const sy = e.clientY - rect.top;
    const hit = pickCircleAt(sx, sy);
    if(hit){
      selectMarker(hit.id);
      toast("ë§ˆì»¤ ì„ íƒ");
      return;
    }
    selectedMarker = null;
    insertAfterMarkerId = null;
    syncSelectedPanel();
  });

  cv.addEventListener("contextmenu", (e)=>{
    e.preventDefault();
    requireAuth(); if(!isAuthed()) return;

    const rect = cv.getBoundingClientRect();
    const sx = e.clientX - rect.left;
    const sy = e.clientY - rect.top;

    const w = worldFromScreen(sx, sy);
    const n = normFromWorld(w.wx, w.wy);
    newMarkerAt(n.nx, n.ny);
    toast("ë§ˆì»¤ ì¶”ê°€");
  });

  $("selLink").addEventListener("input", ()=>{
    if(!selectedMarker) return;
    selectedMarker.yt = $("selLink").value.trim();
    saveLocal();
  });
  $("selYtTitle").addEventListener("input", ()=>{
    if(!selectedMarker) return;
    selectedMarker.ytTitle = $("selYtTitle").value;
    saveLocal();
  });

  $("btnOpenMarkerEdit").addEventListener("click", ()=>{
    if(!selectedMarker) return;
    openMarkerModal(selectedMarker.id);
  });

  // ---------- quick palette ----------
  const QUICK = [
    {name:"ë¹¨", c:"#ff3b30"},
    {name:"ì£¼", c:"#ff9500"},
    {name:"ë…¸", c:"#ffd60a"},
    {name:"ì´ˆ", c:"#34c759"},
    {name:"íŒŒ", c:"#0a84ff"},
    {name:"í°", c:"#ffffff"},
    {name:"ê²€", c:"#0b0b0f"},
  ];
  let pickedQuick = null;

  function renderPalette(){
    palette.innerHTML = "";
    for(const q of QUICK){
      const wrap = document.createElement("div");
      wrap.className = "swWrap";
      wrap.innerHTML = `
        <div class="sw" style="--c:${q.c}" title="${q.name}"></div>
        <div class="swLabel">${q.name}</div>
      `;
      wrap.querySelector(".sw").addEventListener("click", ()=>{
        pickedQuick = q.c;
        toast("ìƒ‰ìƒ ì„ íƒ");
      });
      palette.appendChild(wrap);
    }
  }

  $("btnApplyQuick").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    if(!selectedMarker){ toast("ë§ˆì»¤ë¥¼ ì„ íƒí•˜ì„¸ìš”"); return; }
    if(!pickedQuick){ toast("ë¹ ë¥¸ ìƒ‰ìƒì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”"); return; }
    selectedMarker.colorOverride = pickedQuick;
    selectedMarker.useCatColor = false;
    saveLocal();
    draw();
    toast("ìƒ‰ìƒ ì ìš©");
  });

  $("btnUseCatColor").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    if(!selectedMarker){ toast("ë§ˆì»¤ë¥¼ ì„ íƒí•˜ì„¸ìš”"); return; }
    selectedMarker.colorOverride = "";
    selectedMarker.useCatColor = true;
    saveLocal();
    draw();
    toast("ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì ìš©");
  });

  // chain tools
  $("btnClearLines").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    if(!confirm("ëª¨ë“  ì„ (ì²´ì¸)ì„ ì œê±°í• ê¹Œìš”?")) return;
    for(const m of S.markers){
      if(m.pageId===S.currentPageId){
        m.chainId = null;
        m.chainIndex = null;
      }
    }
    lastChainIdByPage.delete(S.currentPageId);
    insertAfterMarkerId = null;
    saveLocal();
    draw();
    toast("ëª¨ë“  ì„  ì œê±°");
  });

  $("btnRechain").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    const pageMs = S.markers.filter(m=>m.pageId===S.currentPageId);
    const chainId = "c_"+uid();
    let idx=1;
    for(const m of pageMs){
      m.chainId = chainId;
      m.chainIndex = idx++;
    }
    lastChainIdByPage.set(S.currentPageId, chainId);
    // âœ… ë‹¤ì‹œ ì²´ì¸ í›„ì—ë„ 1ë²ˆ ìŠ¤íƒ€ì¼ ê¸°ì¤€ìœ¼ë¡œ ì „íŒŒ
    propagateStyleFromChainFirst(chainId);
    saveLocal();
    draw();
    toast("ì„  ë‹¤ì‹œ ì²´ì¸(ì „ì²´)");
  });

  $("btnResetMarkers").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    if(!confirm("í˜„ì¬ í˜ì´ì§€ì˜ ë§ˆì»¤ë¥¼ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?")) return;
    const pid = S.currentPageId;
    S.markers = S.markers.filter(m=>m.pageId!==pid);
    lastChainIdByPage.delete(pid);
    selectedMarker = null;
    insertAfterMarkerId = null;
    saveLocal();
    syncSelectedPanel();
    renderKpi();
    draw();
    toast("ë§ˆì»¤ ì´ˆê¸°í™”");
  });

  // ---------- marker modal ----------
  let editingId = null;
  function openMarkerModal(markerId){
    requireAuth(); if(!isAuthed()) return;
    const m = S.markers.find(x=>x.id===markerId);
    if(!m) return;

    editingId = markerId;
    const sel = $("mfCat");
    sel.innerHTML = "";
    for(const c of S.categories){
      if(c.id==="ì „ì²´") continue;
      const o = document.createElement("option");
      o.value = c.id;
      o.textContent = c.name;
      sel.appendChild(o);
    }

    $("mfName").value = m.name || "";
    $("mfCat").value = m.cat || "ê¸°í…”";

    $("mfColor").value = m.colorOverride || "";
    $("mfUseCatColor").checked = !!m.useCatColor;

    $("mfYt").value = m.yt || "";
    $("mfYtTitle").value = m.ytTitle || "";
    $("mfMemo").value = m.memo || "";

    $("mfRSize").value = m.r ?? (Number(getComputedStyle(document.documentElement).getPropertyValue("--mR"))||6);
    $("mfFs").value = m.fs ?? (Number(getComputedStyle(document.documentElement).getPropertyValue("--mFs"))||11);
    $("mfFw").value = String(m.fw ?? 900);
    $("mfLabelColor").value = m.labelColor || "#e7eef8";

    $("mfRVal").textContent = $("mfRSize").value;
    $("mfFsVal").textContent = $("mfFs").value;

    $("mfPos").textContent = `ì¢Œí‘œ(ë¹„ìœ¨): ${m.x.toFixed(6)}, ${m.y.toFixed(6)}`;

    // color picker sync
    syncRgbFromHex(getEffectiveEditColor());
    updateColorChip();

    mMarker.classList.add("show");
    setTimeout(()=>$("mfName").focus(), 0);
  }

  function closeMarkerModal(){
    mMarker.classList.remove("show");
    editingId = null;
  }
  $("btnCloseMarker").addEventListener("click", closeMarkerModal);
  $("btnSaveMarker").addEventListener("click", saveMarkerModal);
  $("btnDeleteMarker").addEventListener("click", deleteMarkerModal);

  mMarker.addEventListener("keydown", (e)=>{
    if(e.key==="Enter"){
      if(e.target && e.target.tagName==="TEXTAREA") return;
      e.preventDefault();
      saveMarkerModal();
    }
    if(e.key==="Escape"){
      closeMarkerModal();
    }
  });

  function getEditing(){
    if(!editingId) return null;
    return S.markers.find(x=>x.id===editingId) || null;
  }

  function getEffectiveEditColor(){
    const m = getEditing();
    if(!m) return "#2b8cff";
    if($("mfUseCatColor").checked){
      return getCat($("mfCat").value)?.color || "#7cc4ff";
    }
    return ($("mfColor").value || m.colorOverride || markerColor(m) || "#2b8cff");
  }

  function updateColorChip(){
    const chip = $("mfColorChip");
    const col = getEffectiveEditColor();
    chip.style.setProperty("--c", col);
  }

  function hexToRgb(hex){
    const h = (hex||"").trim();
    const m = /^#?([0-9a-fA-F]{6})$/.exec(h);
    if(!m) return null;
    const n = parseInt(m[1], 16);
    return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 };
  }
  function rgbToHex(r,g,b){
    const rr = clamp(Number(r)||0, 0, 255).toString(16).padStart(2,"0");
    const gg = clamp(Number(g)||0, 0, 255).toString(16).padStart(2,"0");
    const bb = clamp(Number(b)||0, 0, 255).toString(16).padStart(2,"0");
    return "#"+rr+gg+bb;
  }

  function syncRgbFromHex(hex){
    const rgb = hexToRgb(hex) || {r:43,g:140,b:255};
    $("mfR").value = rgb.r;
    $("mfG").value = rgb.g;
    $("mfB").value = rgb.b;
    $("mfColorPick").value = rgbToHex(rgb.r, rgb.g, rgb.b);
  }

  function syncHexFromRgbInputs(){
    const r = clamp(parseInt($("mfR").value||"0",10),0,255);
    const g = clamp(parseInt($("mfG").value||"0",10),0,255);
    const b = clamp(parseInt($("mfB").value||"0",10),0,255);
    const hex = rgbToHex(r,g,b);
    $("mfColorPick").value = hex;
    $("mfColor").value = hex;
    updateColorChip();
  }

  $("mfColor").addEventListener("input", ()=>{
    // hex ì§ì ‘ ì…ë ¥ -> rgb ë™ê¸°í™”
    const v = $("mfColor").value.trim();
    const rgb = hexToRgb(v);
    if(rgb){
      $("mfColorPick").value = rgbToHex(rgb.r,rgb.g,rgb.b);
      $("mfR").value = rgb.r;
      $("mfG").value = rgb.g;
      $("mfB").value = rgb.b;
    }
    updateColorChip();
  });
  $("mfColorPick").addEventListener("input", ()=>{
    $("mfColor").value = $("mfColorPick").value;
    syncRgbFromHex($("mfColorPick").value);
    updateColorChip();
  });
  ["mfR","mfG","mfB"].forEach(id=>{
    $(id).addEventListener("input", syncHexFromRgbInputs);
  });
  $("mfUseCatColor").addEventListener("change", ()=>{
    // ì¹´í…Œê³ ë¦¬ìƒ‰ ì‚¬ìš©ì´ë©´ override ë¹„í™œì„±ì²˜ëŸ¼ ë³´ì´ê²Œ
    updateColorChip();
  });
  $("mfCat").addEventListener("change", ()=>{
    updateColorChip();
    // ì¹´í…Œê³ ë¦¬ ë³€ê²½ì‹œ "ê°™ì€ ì¹´í…Œê³ ë¦¬ ìŠ¤íƒ€ì¼" ë¯¸ë¦¬ ë°˜ì˜(í¸ì§‘ì°½ì—ì„œë„)
    const m = getEditing();
    if(m){
      // ì•„ì§ ì €ì¥ ì „ì´ì§€ë§Œ previewìš©
      const st = findFirstMarkerStyleByCat($("mfCat").value);
      if(st){
        $("mfRSize").value = st.r ?? $("mfRSize").value;
        $("mfFs").value = st.fs ?? $("mfFs").value;
        $("mfFw").value = String(st.fw ?? $("mfFw").value);
        $("mfLabelColor").value = (st.labelColor ?? $("mfLabelColor").value);
        $("mfRVal").textContent = $("mfRSize").value;
        $("mfFsVal").textContent = $("mfFs").value;
      }
    }
  });

  let ytTouched = false, memoTouched = false;
  $("mfYtTitle").addEventListener("input", ()=>{ ytTouched = true; syncSelectedPanelLive(); });
  $("mfMemo").addEventListener("input", ()=>{ memoTouched = true; syncSelectedPanelLive(); });

  $("mfName").addEventListener("input", ()=>{
    const v = $("mfName").value;
    if(!ytTouched) $("mfYtTitle").value = v;
    if(!memoTouched) $("mfMemo").value = v;
    syncSelectedPanelLive();
  });

  function syncSelectedPanelLive(){
    if(!editingId) return;
    if(selectedMarker && selectedMarker.id === editingId){
      $("selName").textContent = $("mfName").value || "(ì´ë¦„ ì—†ìŒ)";
      $("selYtTitle").value = $("mfYtTitle").value || "";
      $("selLink").value = $("mfYt").value || "";
    }
  }

  $("mfRSize").addEventListener("input", ()=>{
    $("mfRVal").textContent = $("mfRSize").value;
    const r = Number($("mfRSize").value);
    const fs = clamp(Math.round(r * 1.8), 8, 40); // âœ… ë¹„ìœ¨ ë” ì•ˆì •ì ìœ¼ë¡œ
    $("mfFs").value = fs;
    $("mfFsVal").textContent = fs;
  });
  $("mfFs").addEventListener("input", ()=>{ $("mfFsVal").textContent = $("mfFs").value; });

  $("mfLabelDefault").addEventListener("click", ()=>{ $("mfLabelColor").value = "#e7eef8"; });

  function saveMarkerModal(){
    requireAuth(); if(!isAuthed()) return;
    const m = getEditing();
    if(!m) return;

    m.name = ($("mfName").value || "").trim();
    m.cat = $("mfCat").value || "ê¸°í…”";
    ensureCat(m.cat, "#ffffff");

    m.useCatColor = $("mfUseCatColor").checked;
    m.colorOverride = ($("mfColor").value || "").trim();

    m.yt = ($("mfYt").value || "").trim();
    m.ytTitle = ($("mfYtTitle").value || "").trim();
    m.memo = ($("mfMemo").value || "").trim();

    m.r = Number($("mfRSize").value);
    m.fs = Number($("mfFs").value);
    m.fw = Number($("mfFw").value);
    m.labelColor = ($("mfLabelColor").value || "#e7eef8").trim();

    // âœ… ê°™ì€ ì¹´í…Œê³ ë¦¬ëŠ” ì¹´í…Œê³ ë¦¬ìƒ‰ ê³ ì •(ìš”ì²­)
    m.useCatColor = true;
    m.colorOverride = "";

    // âœ… ì²´ì¸ 1ë²ˆ ìŠ¤íƒ€ì¼ì„ ê°™ì€ ì²´ì¸ í›„ìˆœìœ„ì— ì „íŒŒ(ìš”ì²­)
    propagateStyleFromChainFirst(m.chainId);

    saveLocal();
    selectMarker(m.id);
    renderCats();
    renderKpi();
    draw();
    toast("ì €ì¥ ì™„ë£Œ");

    // âœ… (ìš”ì²­) ì €ì¥(ë˜ëŠ” Enter) ì‹œ í¸ì§‘ì°½ ë‹«ê¸°
    closeMarkerModal();
  }

  function deleteMarkerModal(){
    requireAuth(); if(!isAuthed()) return;
    const m = getEditing();
    if(!m) return;
    if(!confirm("ì´ ë§ˆì»¤ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;

    const cid = m.chainId;
    const cidx = m.chainIndex;
    S.markers = S.markers.filter(x=>x.id!==m.id);
    if(cid && cidx){
      for(const mm of S.markers){
        if(mm.chainId===cid && (mm.chainIndex||0) > cidx){
          mm.chainIndex = (mm.chainIndex||0) - 1;
        }
      }
    }
    saveLocal();
    closeMarkerModal();
    selectedMarker = null;
    syncSelectedPanel();
    renderKpi();
    draw();
    toast("ì‚­ì œ ì™„ë£Œ");
  }

  $("btnNewChain").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    const m = getEditing();
    if(!m) return;

    m.chainId = "c_"+uid();
    m.chainIndex = 1;
    lastChainIdByPage.set(m.pageId, m.chainId);
    insertAfterMarkerId = null;

    // âœ… ìƒˆ 1ë²ˆì´ë‹ˆê¹Œ ì¹´í…Œê³ ë¦¬ìƒ‰/ê¸°ë³¸ ìŠ¤íƒ€ì¼ ìœ ì§€
    m.useCatColor = true;
    m.colorOverride = "";

    saveLocal();
    draw();
    toast("ìƒˆ ì²´ì¸ ì‹œì‘");

    // âœ… (ìš”ì²­) ë²„íŠ¼ ëˆ„ë¥´ë©´ í¸ì§‘ì°½ ë‹«ê¸°
    closeMarkerModal();
  });

  $("btnInsertAfter").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    const m = getEditing();
    if(!m) return;
    insertAfterMarkerId = m.id;
    toast("ì¤‘ê°„ ì‚½ì… ëª¨ë“œ í™œì„±í™”");

    // âœ… (ìš”ì²­) ë²„íŠ¼ ëˆ„ë¥´ë©´ í¸ì§‘ì°½ ë‹«ê¸°
    closeMarkerModal();
  });

  cv.addEventListener("dblclick", (e)=>{
    requireAuth(); if(!isAuthed()) return;
    const rect = cv.getBoundingClientRect();
    const sx = e.clientX - rect.left;
    const sy = e.clientY - rect.top;
    const hit = pickCircleAt(sx, sy);
    if(hit){
      selectMarker(hit.id);
      ytTouched = false; memoTouched = false;
      openMarkerModal(hit.id);
    }
  });

  // ---------- category modal ----------
  let catSelectedRowId = null;

  $("btnEditCats").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    openCatsModal();
  });
  $("btnCloseCats").addEventListener("click", ()=>mCats.classList.remove("show"));

  function openCatsModal(){
    catSelectedRowId = null;
    renderCatRows();
    renderCatQuickPalette();
    mCats.classList.add("show");
  }

  function renderCatQuickPalette(){
    const wrap = $("catQuickPalette");
    wrap.innerHTML = "";
    for(const q of QUICK){
      const w = document.createElement("div");
      w.className = "swWrap";
      w.innerHTML = `<div class="sw" style="--c:${q.c}"></div><div class="swLabel">${q.name}</div>`;
      w.querySelector(".sw").addEventListener("click", ()=>{
        if(!catSelectedRowId){ toast("ì¹´í…Œê³ ë¦¬ í–‰ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”"); return; }
        const c = S.categories.find(x=>x.id===catSelectedRowId);
        if(!c) return;
        c.color = q.c;
        renderCatRows();
      });
      wrap.appendChild(w);
    }
  }

  function renderCatRows(){
    const rows = $("catRows");
    rows.innerHTML = "";

    const list = S.categories.filter(c=>c.id!=="ì „ì²´");
    for(const c of list){
      const row = document.createElement("div");
      row.style.display = "grid";
      row.style.gridTemplateColumns = "1fr 70px 90px";
      row.style.gap = "10px";
      row.style.alignItems = "center";
      row.style.marginBottom = "10px";

      row.innerHTML = `
        <input class="field" value="${c.name}" />
        <div class="colorChip" style="--c:${c.color};"></div>
        <button class="pill danger" type="button">ì‚­ì œ</button>
      `;

      const inp = row.querySelector("input");
      const chip = row.querySelector(".colorChip");
      const del = row.querySelector("button");

      row.addEventListener("click", ()=>{
        catSelectedRowId = c.id;
        toast("ì¹´í…Œê³ ë¦¬ ì„ íƒ");
      });

      inp.addEventListener("input", ()=>{
        c.name = inp.value;
      });

      chip.addEventListener("click", async ()=>{
        catSelectedRowId = c.id;
        const next = await openPrompt({
          title:"ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ",
          hint:"ìƒ‰ìƒ ì½”ë“œ(#rrggbb)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.",
          value: c.color,
          placeholder:"#ff0000"
        });
        if(next===null) return;
        c.color = (next||"").trim() || c.color;
        renderCatRows();
      });

      del.addEventListener("click", (e)=>{
        e.stopPropagation();
        if(!confirm(`"${c.name}" ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí• ê¹Œìš”?`)) return;
        const fallback = S.categories.find(x=>x.id==="ê¸°í…”") || S.categories[0];
        for(const m of S.markers){
          if(m.cat === c.id) m.cat = fallback.id;
        }
        S.categories = S.categories.filter(x=>x.id!==c.id);
        renderCatRows();
        renderCats();
        saveLocal();
        draw();
      });

      rows.appendChild(row);
    }
  }

  $("btnAddCat").addEventListener("click", async ()=>{
    const name = await openPrompt({
      title:"ì¹´í…Œê³ ë¦¬ ì¶”ê°€",
      hint:"ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.",
      value:"",
      placeholder:"ì˜ˆ) ë³´ìŠ¤"
    });
    if(!name) return;
    const id = name.trim();
    if(!id) return;
    if(S.categories.some(c=>c.id===id)){ toast("ì´ë¯¸ ì¡´ì¬"); return; }
    S.categories.push({ id, name:id, color:"#ffffff", on:true });
    renderCatRows();
  });

  $("btnCatsDefault").addEventListener("click", ()=>{
    if(!confirm("ê¸°ë³¸ ì¹´í…Œê³ ë¦¬ë¡œ ë˜ëŒë¦´ê¹Œìš”?")) return;
    S.categories = structuredClone(defaultCats);
    renderCatRows();
  });

  $("btnSaveCats").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    const cleaned = [];
    const seen = new Set(["ì „ì²´"]);
    for(const c of S.categories){
      const name = (c.name||c.id||"").trim();
      if(!name) continue;
      const finalId = name;
      if(seen.has(finalId)) continue;
      seen.add(finalId);
      cleaned.push({ id:finalId, name, color:(c.color||"#ffffff"), on:!!c.on });
    }
    const all = { id:"ì „ì²´", name:"ì „ì²´", color:"#7cc4ff", on:true };
    S.categories = [all, ...cleaned];

    const valid = new Set(S.categories.map(x=>x.id));
    const fb = valid.has("ê¸°í…”") ? "ê¸°í…”" : (S.categories[1]?.id || "ì „ì²´");
    for(const m of S.markers){
      if(!valid.has(m.cat)) m.cat = fb;
      // âœ… ê°™ì€ ì¹´í…Œê³ ë¦¬ ìƒ‰ ê³ ì • ìœ„í•´ useCatColor ê°•ì œ
      m.useCatColor = true;
      m.colorOverride = "";
    }

    saveLocal();
    renderCats();
    renderKpi();
    draw();
    mCats.classList.remove("show");
    toast("ì¹´í…Œê³ ë¦¬ ì €ì¥");
  });

  // ---------- marker edit: text quick colors ----------
  function renderTextColors(){
    textColors.innerHTML = "";
    const colors = [
      "#ff3b30","#ff9500","#ffd60a","#34c759","#0a84ff","#ffffff","#0b0b0f"
    ];
    for(const c of colors){
      const d = document.createElement("div");
      d.className = "tSw";
      d.style.setProperty("--c", c);
      d.addEventListener("click", ()=>{
        $("mfLabelColor").value = c;
      });
      textColors.appendChild(d);
    }
  }

  // ---------- helpers ----------
  function renderAll(){
    renderLogo();
    renderGames();
    renderPages();
    renderCats();
    renderPalette();
    renderTextColors();
    setToggle(tgShowLinesWithCatFilter, !!S.showLinesWithCatFilter);
    syncSelectedPanel();
    renderKpi();
    resizeCanvas();
    if(!S.map.scale || S.map.scale<=0) fitToScreen();
    draw();
  }

  // ---------- init ----------
  async function init(){
    requireAuth();
    const st = await loadStateRemoteFirst();
    S = mergeState(st);

    if(typeof S.showLinesWithCatFilter !== "boolean") S.showLinesWithCatFilter = true;

    lastChainIdByPage = new Map();

    renderAll();
    loadMapForCurrentPage(false);

    if(!S.map.scale || S.map.scale<=0){
      setTimeout(()=>{
        fitToScreen();
        saveLocal();
        draw();
      }, 0);
    }else{
      draw();
    }
  }

  init();

})();
</script>
</body>
</html>
