<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Mode - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #1a1a1a; color: #e5e7eb; overflow: hidden; }
        .canvas-container { cursor: grab; }
        .canvas-container:active { cursor: grabbing; }
        .marker { transition: opacity 0.2s; position: absolute; transform: translate(-50%, -50%); cursor: move; }
        .line-path { fill: none; stroke: #555; stroke-width: 2; }
        /* Chrome, Safari 등 브라우저 스크롤바 숨기기 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <header class="h-14 bg-[#2d2d2d] border-b border-gray-700 flex items-center px-4 justify-between z-50">
        <div class="flex items-center gap-6">
            <img src="../logo/MAPMODELOGO2.png" alt="Logo" class="h-10 object-contain">
            <nav class="flex gap-4 items-center">
                <button class="px-3 py-1 bg-blue-600 rounded text-sm font-bold">카테고리1</button>
                <button class="px-3 py-1 hover:bg-gray-700 rounded text-sm">카테고리2</button>
                <button class="px-3 py-1 hover:bg-gray-700 rounded text-sm">카테고리3</button>
                <button class="px-3 py-1 hover:bg-gray-700 rounded text-sm">카테고리4</button>
            </nav>
        </div>
        <div class="flex items-center gap-3">
            <button onclick="exportState()" class="text-xs bg-gray-700 px-3 py-1.5 rounded hover:bg-gray-600">state.json 내보내기</button>
            <button onclick="fullReset()" class="text-xs bg-red-900/40 text-red-400 px-3 py-1.5 rounded hover:bg-red-800/60">전체 초기화</button>
            <button id="loginBtn" class="text-xs border border-gray-600 px-3 py-1.5 rounded">관리자 로그아웃</button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-64 bg-[#1e1e1e] border-r border-gray-800 flex flex-col p-4 gap-4">
            <div class="flex justify-between items-center">
                <h3 class="text-sm font-bold text-gray-400">페이지 목록</h3>
                <button onclick="addPage()" class="text-blue-500 hover:bg-blue-500/10 p-1 rounded"><i data-lucide="plus-circle" size="18"></i></button>
            </div>
            <div id="pageList" class="space-y-2 overflow-y-auto">
                <div class="bg-[#2d2d2d] p-3 rounded-lg flex flex-col gap-2 border border-blue-500/50">
                    <input type="text" value="메인 지도" class="bg-transparent text-sm focus:outline-none">
                    <div class="flex justify-end gap-2">
                        <button class="text-[10px] text-gray-400">URL 등록</button>
                        <button class="text-[10px] text-red-400">삭제</button>
                    </div>
                </div>
            </div>
        </aside>

        <main id="viewport" class="relative flex-1 bg-[#121212] overflow-hidden canvas-container" oncontextmenu="return false;">
            <div id="mapCanvas" class="absolute top-0 left-0 origin-top-left" style="width: 3000px; height: 3000px;">
                <img src="../maps/aion2map.jpg" class="absolute inset-0 w-full h-full object-none pointer-events-none opacity-60">
                
                <svg id="svgLayer" class="absolute inset-0 w-full h-full pointer-events-none z-10">
                    <defs>
                        <marker id="arrow" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                          <path d="M 0 0 L 10 5 L 0 10 z" fill="#888" />
                        </marker>
                    </defs>
                </svg>
                
                <div id="markerLayer" class="absolute inset-0 z-20"></div>
            </div>
        </main>

        <aside class="w-72 bg-[#1e1e1e] border-l border-gray-800 flex flex-col p-4 gap-6 overflow-y-auto">
            <div>
                <h3 class="text-sm font-bold text-gray-400 mb-4">관리자 툴</h3>
                <div class="space-y-4">
                    <div>
                        <p class="text-[11px] text-gray-500 mb-2">빠른 색상표</p>
                        <div class="flex flex-wrap gap-2">
                            <div class="w-6 h-6 rounded-full bg-red-500 cursor-pointer"></div>
                            <div class="w-6 h-6 rounded-full bg-orange-500 cursor-pointer"></div>
                            <div class="w-6 h-6 rounded-full bg-yellow-500 cursor-pointer"></div>
                            <div class="w-6 h-6 rounded-full bg-green-500 cursor-pointer"></div>
                            <div class="w-6 h-6 rounded-full bg-blue-500 cursor-pointer"></div>
                            <div class="w-6 h-6 rounded-full bg-white cursor-pointer"></div>
                            <div class="w-6 h-6 rounded-full bg-black border border-gray-600 cursor-pointer"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-2">
                        <button class="w-full py-2 bg-[#2d2d2d] rounded text-xs">모든 선 표시/제거</button>
                        <button onclick="clearMarkers()" class="w-full py-2 bg-red-900/20 text-red-400 rounded text-xs hover:bg-red-900/40">마커 초기화</button>
                    </div>
                </div>
            </div>

            <div class="border-t border-gray-800 pt-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-sm font-bold text-gray-400">마커 카테고리</h3>
                    <button class="text-blue-500 text-xs">+ 추가</button>
                </div>
                <div class="space-y-2">
                    <div class="flex items-center gap-2 text-xs bg-[#2d2d2d] p-2 rounded">
                        <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                        <span class="flex-1">전체 마커</span>
                        <input type="checkbox" checked>
                    </div>
                </div>
            </div>
            
            <div class="bg-[#262626] p-4 rounded-lg border border-gray-700">
                <p class="text-xs font-bold text-blue-400 mb-2 underline">유튜브 링크 연결</p>
                <input type="text" placeholder="유튜브 이름" class="w-full bg-[#1a1a1a] p-2 rounded text-xs mb-2">
                <textarea placeholder="유튜브 설명" class="w-full bg-[#1a1a1a] p-2 rounded text-xs h-20"></textarea>
            </div>
        </aside>
    </div>

    <div id="editModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center">
        <div class="bg-[#2d2d2d] w-80 p-5 rounded-xl border border-gray-600 shadow-2xl">
            <h4 class="text-sm font-bold mb-4 flex items-center gap-2"><i data-lucide="edit-3" size="16"></i> 마커 편집</h4>
            <div class="space-y-3">
                <input id="editName" type="text" placeholder="마커 이름" class="w-full bg-[#1a1a1a] border border-gray-600 p-2 rounded text-sm outline-none">
                <input id="editYoutube" type="text" placeholder="유튜브 링크" class="w-full bg-[#1a1a1a] border border-gray-600 p-2 rounded text-sm outline-none">
                
                <div class="pt-2">
                    <p class="text-[10px] text-gray-400 mb-1">마커 크기 조절</p>
                    <input id="editSize" type="range" min="10" max="100" class="w-full h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                </div>

                <div class="grid grid-cols-2 gap-2 pt-4">
                    <button onclick="closeModal()" class="py-2 bg-gray-700 rounded text-xs">취소</button>
                    <button onclick="saveMarker()" class="py-2 bg-blue-600 rounded text-xs font-bold">저장 (Enter)</button>
                </div>
                <button onclick="deleteMarker()" class="w-full py-2 bg-red-900/40 text-red-400 rounded text-[10px] mt-2">이 마커 삭제</button>
            </div>
        </div>
    </div>

    <script>
        // --- 상태 관리 ---
        let state = {
            markers: [],
            connections: [],
            lastNum: 0,
            selectedIds: [],
            isDraggingCanvas: false,
            canvasPos: { x: 0, y: 0 },
            currentEditId: null
        };

        const canvas = document.getElementById('mapCanvas');
        const markerLayer = document.getElementById('markerLayer');
        const svgLayer = document.getElementById('svgLayer');

        // --- 초기화 ---
        lucide.createIcons();

        // --- 마커 생성 (우클릭) ---
        document.getElementById('viewport').oncontextmenu = (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            createMarker(x, y);
        };

        function createMarker(x, y) {
            state.lastNum++;
            const id = 'm-' + Date.now();
            const prevId = state.markers.length > 0 ? state.markers[state.markers.length - 1].id : null;

            const newMarker = {
                id,
                x,
                y,
                number: state.lastNum,
                name: 'Marker ' + state.lastNum,
                size: 40,
                color: '#fbbf24'
            };

            state.markers.push(newMarker);
            if (prevId) state.connections.push({ from: prevId, to: id });

            render();
        }

        // --- 렌더링 함수 ---
        function render() {
            markerLayer.innerHTML = '';
            svgLayer.innerHTML = `
                <defs>
                    <marker id="arrow" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                      <path d="M 0 0 L 10 5 L 0 10 z" fill="#888" />
                    </marker>
                </defs>`;

            // 선 그리기
            state.connections.forEach(conn => {
                const m1 = state.markers.find(m => m.id === conn.from);
                const m2 = state.markers.find(m => m.id === conn.to);
                if (m1 && m2) {
                    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    path.setAttribute("d", `M ${m1.x} ${m1.y} L ${m2.x} ${m2.y}`);
                    path.setAttribute("class", "line-path");
                    path.setAttribute("marker-end", "url(#arrow)");
                    svgLayer.appendChild(path);
                }
            });

            // 마커 그리기
            state.markers.forEach(m => {
                const div = document.createElement('div');
                div.className = 'marker group';
                div.style.left = `${m.x}px`;
                div.style.top = `${m.y}px`;
                div.style.opacity = state.selectedIds.includes(m.id) ? '0.3' : '1';

                div.innerHTML = `
                    <div class="flex flex-col items-center">
                        <div class="rounded-full flex items-center justify-center font-bold text-black shadow-xl border-2 border-black/20" 
                             style="width:${m.size}px; height:${m.size}px; background-color:${m.color}; font-size:${m.size*0.4}px">
                            ${m.number}
                        </div>
                        <div class="text-white text-[11px] mt-1 whitespace-nowrap drop-shadow-lg font-medium">${m.name}</div>
                    </div>
                `;

                // 이벤트 바인딩
                div.onclick = (e) => {
                    e.stopPropagation();
                    if (state.selectedIds.includes(m.id)) {
                        state.selectedIds = state.selectedIds.filter(id => id !== m.id);
                    } else {
                        state.selectedIds.push(m.id);
                    }
                    render();
                };

                div.ondblclick = (e) => {
                    e.stopPropagation();
                    openModal(m.id);
                };

                markerLayer.appendChild(div);
            });
        }

        // --- 캔버스 드래그 (좌클릭 드래그) ---
        let isMouseDown = false;
        let startPos = { x: 0, y: 0 };

        document.getElementById('viewport').onmousedown = (e) => {
            if (e.button === 0) {
                isMouseDown = true;
                startPos = { x: e.clientX - state.canvasPos.x, y: e.clientY - state.canvasPos.y };
            }
        };

        window.onmousemove = (e) => {
            if (isMouseDown) {
                state.canvasPos.x = e.clientX - startPos.x;
                state.canvasPos.y = e.clientY - startPos.y;
                canvas.style.transform = `translate(${state.canvasPos.x}px, ${state.canvasPos.y}px)`;
            }
        };

        window.onmouseup = () => isMouseDown = false;

        // --- 모달 로직 ---
        function openModal(id) {
            const m = state.markers.find(m => m.id === id);
            state.currentEditId = id;
            document.getElementById('editName').value = m.name;
            document.getElementById('editSize').value = m.size;
            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        function saveMarker() {
            const m = state.markers.find(m => m.id === state.currentEditId);
            m.name = document.getElementById('editName').value;
            m.size = document.getElementById('editSize').value;
            render();
            closeModal();
        }

        function deleteMarker() {
            state.markers = state.markers.filter(m => m.id !== state.currentEditId);
            state.connections = state.connections.filter(c => c.from !== state.currentEditId && c.to !== state.currentEditId);
            render();
            closeModal();
        }

        function clearMarkers() {
            if (confirm("모든 마커를 삭제하시겠습니까?")) {
                state.markers = [];
                state.connections = [];
                state.lastNum = 0;
                render();
            }
        }
    </script>
</body>
</html>
