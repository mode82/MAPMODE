<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MAPMODE Â· ADMIN99</title>

  <style>
    :root{
      color-scheme: dark;

      --bg:#070b12;
      --panel:#0b1220cc;
      --card:#0e1626cc;

      --stroke:#1f2a3a;
      --stroke2:#27344a;

      --text:#e7eef8;
      --muted:#9fb0c6;

      --accent:#7cc4ff;
      --danger:#ff5d5d;
      --ok:#39d98a;
      --warn:#ffd60a;

      --r14:14px;
      --r16:16px;
      --r18:18px;

      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --shadow2: 0 8px 24px rgba(0,0,0,.35);
      --blur: 14px;

      --topH:58px;
      --sideW:320px;
      --sideW2:360px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      overflow:hidden;
      background:
        radial-gradient(1200px 700px at 50% -10%, rgba(124,196,255,.18), transparent 55%),
        radial-gradient(900px 650px at 88% 10%, rgba(57,217,138,.12), transparent 55%),
        radial-gradient(900px 650px at 12% 10%, rgba(255,214,10,.08), transparent 55%),
        linear-gradient(180deg, #0a0f18 0%, var(--bg) 100%);
      color:var(--text);

      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", Arial, sans-serif;
      font-weight: 800;
      letter-spacing: .1px;
    }

    /* ========== TOPBAR ========== */
    .topbar{
      position:fixed; inset:0 0 auto 0;
      height:var(--topH);
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 14px;
      z-index:90;
      background: linear-gradient(180deg, rgba(9,14,23,.88), rgba(9,14,23,.58));
      backdrop-filter: blur(var(--blur));
      border-bottom:1px solid rgba(39,52,74,.65);
    }
    .top-left, .top-right{ display:flex; align-items:center; gap:10px; min-width:0; }

    .slot{
      height:38px;
      display:flex; align-items:center;
      padding:0 10px;
      border-radius:999px;
      background: rgba(14,22,38,.55);
      border:1px solid rgba(39,52,74,.65);
      box-shadow: var(--shadow2);
      gap:8px;
      white-space:nowrap;
    }
    .slot.fixed{ width:170px; justify-content:center; }
    .slot.logo{
      justify-content:flex-start;
      border:none;
      background: transparent;
      box-shadow:none;
      padding:0;
      width:170px;
    }
    .logoBox{
      width:170px; height:38px;
      border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      background: transparent;
      border:none;
      cursor:pointer;
      user-select:none;
    }
    .logoBox img{ height:26px; width:auto; display:block; opacity:.98; }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.5px; }
    .brand .word{ font-size:20px; line-height:1; display:flex; align-items:center; }
    .brand .word .o{
      display:inline-block;
      width:12px; height:12px; border-radius:999px;
      margin:0 2px;
      background:#fff;
      box-shadow: 0 0 0 2px rgba(255,255,255,.12);
      transform: translateY(1px);
    }

    .pill{
      height:34px;
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px;
      padding:0 12px;
      border-radius:999px;
      background: rgba(14,22,38,.55);
      border:1px solid rgba(39,52,74,.65);
      color:var(--text);
      box-shadow: var(--shadow2);
      cursor:pointer;
      user-select:none;
      text-decoration:none;
      font-weight:900;
    }
    .pill:hover{ border-color: rgba(124,196,255,.55); }
    .pill:active{ transform: translateY(1px); }
    .pill.small{ height:32px; padding:0 10px; font-size:13px; font-weight:900; }
    .pill.ghost{ background: rgba(14,22,38,.25); }
    .pill.danger{ border-color: rgba(255,93,93,.55); }
    .pill.ok{ border-color: rgba(57,217,138,.55); }

    .miniBtn{
      height:34px;
      padding:0 12px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color: rgba(231,238,248,.92);
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      display:flex; align-items:center; justify-content:center;
    }
    .miniBtn.icon{
      width:34px;
      padding:0;
    }
    .miniBtn.url{ border-color: rgba(57,217,138,.55); }
    .miniBtn.edit{ border-color: rgba(124,196,255,.55); }
    .miniBtn.del{ border-color: rgba(255,93,93,.55); }

    .top-right{ flex-wrap:wrap; justify-content:flex-end; }
    .top-right .pill{ flex: 0 0 auto; }

    /* Top Categories */
    .topCats{
      display:flex;
      align-items:center;
      gap:10px;
      height:38px;
    }
    .topCatPill{
      width:170px;
      height:38px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(14,22,38,.55);
      box-shadow: var(--shadow2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 10px;
      cursor:pointer;
      user-select:none;
      gap:10px;
    }
    .topCatPill.active{
      border-color: rgba(57,217,138,.65);
      box-shadow: 0 0 0 2px rgba(57,217,138,.18), var(--shadow2);
    }
    .topCatPill.disabled{
      opacity:.38;
      border-color: rgba(39,52,74,.25);
      background: rgba(14,22,38,.18);
      box-shadow:none;
    }
    .topCatLabel{
      font-weight:900;
      font-size:15px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width: 116px;
    }
    .topCatToggle{
      width:44px;
      height:24px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      position:relative;
      flex:0 0 auto;
      cursor:pointer;
    }
    .topCatToggle::after{
      content:"";
      position:absolute;
      width:18px; height:18px;
      border-radius:999px;
      top:2px; left:2px;
      background: rgba(231,238,248,.55);
      box-shadow: var(--shadow2);
      transition: transform .16s ease, background .16s ease;
    }
    .topCatToggle.on{
      border-color: rgba(57,217,138,.55);
      background: rgba(57,217,138,.12);
    }
    .topCatToggle.on::after{
      transform: translateX(20px);
      background: rgba(57,217,138,.92);
    }

    /* ========== LAYOUT ========== */
    .layout{
      position:fixed;
      inset:var(--topH) 0 0 0;
      display:grid;
      grid-template-columns: var(--sideW) 1fr var(--sideW2);
      height:calc(100% - var(--topH));
      min-height: 0;
    }
    .side{
      overflow:hidden;
      border-right:1px solid rgba(39,52,74,.55);
      background: rgba(8,12,20,.35);
      backdrop-filter: blur(var(--blur));
      min-height:0;
    }
    .side.right{ border-right:none; border-left:1px solid rgba(39,52,74,.55); }

    .sideInner{
      height:100%;
      padding:12px;
      overflow:auto;
    }

    .card{
      background: rgba(14,22,38,.50);
      border:1px solid rgba(39,52,74,.6);
      border-radius: var(--r16);
      padding:12px;
      box-shadow: var(--shadow2);
    }
    .card + .card{ margin-top:12px; }

    .sectionTitle{
      font-size:12px;
      color: rgba(231,238,248,.9);
      margin:4px 0 10px 0;
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
    }
    .sectionTitle b{ font-weight:900; }
    .subtle{
      color: rgba(159,176,198,.92);
      font-size:12px;
      line-height:1.45;
      font-weight:800;
    }

    /* ========== LEFT: Pages ========== */
    .btnAddPage{
      width:100%;
      height:52px;
      border-radius:18px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(14,22,38,.35);
      color: rgba(231,238,248,.95);
      font-weight:900;
      cursor:pointer;
      box-shadow: var(--shadow2);
    }
    .btnAddPage:hover{ border-color: rgba(124,196,255,.55); }

    .pageList{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .pageItem{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 10px;
      border-radius: var(--r16);
      border:1px solid rgba(39,52,74,.6);
      background: rgba(14,22,38,.35);
      cursor:pointer;
    }
    .pageItem.active{
      outline:2px solid rgba(57,217,138,.35);
      border-color: rgba(57,217,138,.55);
      background: rgba(14,22,38,.55);
    }
    .pageName{ font-weight:900; font-size:16px; }
    .pageActions{ display:flex; align-items:center; gap:8px; flex:0 0 auto; }

    /* ========== CENTER: Canvas ========== */
    .center{
      position:relative;
      overflow:hidden;
      background:
        radial-gradient(900px 700px at 50% 15%, rgba(124,196,255,.08), transparent 60%),
        radial-gradient(900px 700px at 50% 80%, rgba(57,217,138,.05), transparent 60%);
      min-height:0;
    }
    .canvasWrap{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:16px;
    }
    canvas{ background: transparent; touch-action:none; }

    .hintToast{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      top:14px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.6);
      background: rgba(14,22,38,.55);
      color: rgba(231,238,248,.9);
      box-shadow: var(--shadow2);
      font-size:12px;
      display:none;
      z-index:40;
    }
    .hintToast.show{ display:block; }

    /* ========== RIGHT: Tools ========== */
    .chipRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .chip{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.6);
      background: rgba(10,15,24,.35);
      cursor:pointer;
      font-size:13px;
      user-select:none;
      font-weight:900;
    }
    .chip.on{ border-color: rgba(124,196,255,.6); background: rgba(124,196,255,.10); }
    .chip.off{ opacity:.55; }
    .dotc{ width:10px; height:10px; border-radius:999px; box-shadow:0 0 0 2px rgba(255,255,255,.06); }

    .toggleRow{ display:flex; gap:10px; flex-direction:column; margin-top:10px; }
    .toggle{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.6);
      background: rgba(10,15,24,.35);
      cursor:pointer;
      font-size:13px;
      user-select:none;
      font-weight:900;
    }
    .toggle .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(231,238,248,.25);
      border:1px solid rgba(231,238,248,.25);
    }
    .toggle.on{ border-color: rgba(57,217,138,.55); }
    .toggle.on .dot{ background: rgba(57,217,138,.9); border-color: rgba(57,217,138,.9); }

    .hr{ height:1px; background: rgba(39,52,74,.55); margin:12px 0; }

    .btnFull{
      width:100%;
      height:52px;
      border-radius:18px;
      font-weight:900;
      font-size:15px;
      justify-content:center;
    }

    .palette{
      display:flex; gap:12px; align-items:flex-start;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .sw{
      width:42px; height:42px;
      border-radius:14px;
      border:1px solid rgba(39,52,74,.65);
      box-shadow: var(--shadow2);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      position:relative;
      overflow:hidden;
      background: rgba(10,15,24,.35);
    }
    .sw::after{
      content:"";
      position:absolute; inset:6px;
      border-radius:10px;
      background: var(--c);
    }
    .swLabel{
      margin-top:6px;
      font-size:12px;
      text-align:center;
      color: rgba(231,238,248,.85);
      font-weight:900;
    }
    .swWrap{ display:flex; flex-direction:column; align-items:center; }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }

    .field{
      width:100%;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color: rgba(231,238,248,.95);
      outline:none;
      font-weight:900;
      font-size:14px;
    }
    textarea.field{ min-height:90px; resize:vertical; }

    .selectedBox .label{
      font-size:14px; font-weight:900; margin-bottom:8px;
    }
    .selectedBox .sub{
      font-size:12px; color: rgba(159,176,198,.92); font-weight:900;
      margin-top:10px;
    }

    /* ========== MODAL ========== */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:stretch;
      justify-content:stretch;
      z-index:200;
    }
    .modalBack.show{ display:flex; }
    .modal{
      margin:auto;
      width:min(1050px, calc(100vw - 28px));
      height:min(860px, calc(100vh - 28px));
      background: linear-gradient(180deg, rgba(14,22,38,.96), rgba(10,15,24,.92));
      border:1px solid rgba(39,52,74,.75);
      border-radius:22px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex; flex-direction:column;
    }
    .modalHead{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(39,52,74,.55);
    }
    .modalHead .title{ font-size:18px; font-weight:900; }
    .modalBody{
      padding:16px;
      overflow:auto;
      flex:1 1 auto;
    }
    .modalClose{
      height:40px;
      padding:0 14px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color: rgba(231,238,248,.92);
      cursor:pointer;
      font-weight:900;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    .labelRow{ color: rgba(159,176,198,.92); font-size:13px; font-weight:900; margin:10px 0 8px; }
    .checkRow{ display:flex; align-items:center; gap:10px; justify-content:flex-end; }
    .checkRow input{ width:18px; height:18px; accent-color:#a86bff; }
    .colorChip{
      width:46px; height:46px;
      border-radius:16px;
      border:1px solid rgba(39,52,74,.65);
      box-shadow: var(--shadow2);
      background: rgba(10,15,24,.35);
      position:relative;
      overflow:hidden;
    }
    .colorChip::after{ content:""; position:absolute; inset:7px; border-radius:12px; background: var(--c); }

    .styleGrid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      margin-top:14px;
    }
    .styleCard{
      border-radius:18px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      padding:14px;
      min-height:160px;
    }
    .styleCard h4{ margin:0 0 10px; font-size:18px; font-weight:900; }
    .rangeRow{ display:flex; align-items:center; gap:12px; }
    .rangeRow input[type="range"]{ width:100%; }
    .numBox{
      width:68px;
      text-align:center;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      padding:8px 10px;
      font-weight:900;
    }
    .fwSelect{ width:100%; }

    .quickTextColors{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .tSw{
      width:34px; height:34px;
      border-radius:12px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      box-shadow: var(--shadow2);
      cursor:pointer;
      position:relative;
      overflow:hidden;
    }
    .tSw::after{ content:""; position:absolute; inset:7px; border-radius:9px; background: var(--c); }

    .modalFoot{
      padding:14px 16px;
      border-top:1px solid rgba(39,52,74,.55);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .btnBig{
      height:46px;
      padding:0 16px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color: rgba(231,238,248,.95);
      font-weight:900;
      cursor:pointer;
    }
    .btnBig.danger{ border-color: rgba(255,93,93,.65); }
    .btnBig.ok{ border-color: rgba(57,217,138,.65); }

    .markerFont{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-weight: 900;
      letter-spacing: 0;
    }

    /* ========== LOGIN OVERLAY ========== */
    .lock{
      position:fixed; inset:0;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center; justify-content:center;
      z-index:300;
    }
    .lock.show{ display:flex; }
    .lockBox{
      width:min(420px, calc(100vw - 28px));
      background: linear-gradient(180deg, rgba(14,22,38,.96), rgba(10,15,24,.92));
      border:1px solid rgba(39,52,74,.75);
      border-radius:22px;
      box-shadow: var(--shadow);
      padding:18px;
    }
    .lockBox h3{ margin:0 0 10px; font-size:18px; font-weight:900; }
    .lockBox p{ margin:0 0 14px; color:rgba(159,176,198,.92); font-size:13px; font-weight:900; }
    .lockRow{ display:flex; gap:10px; }
    .lockRow input{
      flex:1;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color: rgba(231,238,248,.95);
      outline:none;
      font-weight:900;
      font-size:14px;
    }

    @media (max-width: 1200px){
      body{ overflow:auto; }
      .layout{
        width: calc(var(--sideW) + 1000px + var(--sideW2));
        min-width: calc(var(--sideW) + 1000px + var(--sideW2));
      }
      .center{ min-width: 1000px; }
    }
    @media (max-width: 560px){
      .slot.fixed{ width:160px; }
      .slot.logo{ width:160px; }
      .logoBox{ width:160px; }
      .topCatPill{ width:160px; }
      .topCatLabel{ max-width: 106px; }
    }
  </style>
</head>

<body>

  <!-- LOGIN LOCK -->
  <div class="lock" id="lock">
    <div class="lockBox">
      <h3>ê´€ë¦¬ì ì¸ì¦</h3>
      <p>ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë©´ <b>24ì‹œê°„</b> ì¸ì¦ì´ ìœ ì§€ë©ë‹ˆë‹¤.</p>
      <div class="lockRow">
        <input id="pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" />
        <button class="pill ok" id="btnLogin">ë¡œê·¸ì¸</button>
      </div>
      <div class="subtle" id="lockMsg" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="top-left">
      <!-- Slot 1: Logo (í´ë¦­í•´ì„œ URL ì…ë ¥) -->
      <div class="slot fixed logo">
        <div class="logoBox" id="logoBox" title="ë¡œê³  í´ë¦­ â†’ URL ì…ë ¥">
          <div class="brand"><div class="word">MAPM<span class="o"></span>DE</div></div>
        </div>
      </div>

      <!-- Slot 2: Top Categories (4ê°œ ê³ ì •) -->
      <div class="topCats" id="topCats"></div>

      <!-- Slot 3: Admin label -->
      <div class="slot fixed">
        <div style="font-weight:900; color:rgba(57,217,138,.95);">ADMIN</div>
      </div>

      <!-- Slot 4: Controls -->
      <div class="slot fixed" style="justify-content:center; gap:8px;">
        <label class="pill small ghost" style="cursor:pointer;">
          ì§€ë„ ì—…ë¡œë“œ
          <input id="fileMap" type="file" accept="image/*" style="display:none;" />
        </label>
        <button class="pill small ghost" id="btnExport">state ë‚´ë³´ë‚´ê¸°</button>
        <button class="pill small danger" id="btnResetAll">ì „ì²´ ì´ˆê¸°í™”</button>
      </div>
    </div>

    <div class="top-right">
      <span class="pill small ghost" title="í˜„ì¬ ì¹´í…Œê³ ë¦¬/í˜ì´ì§€">
        ê´€ë¦¬ì
        <span style="opacity:.7;">/</span>
        <span id="pathTopCat">ì¹´í…Œê³ ë¦¬1</span>
        <span style="opacity:.7;">/</span>
        <span id="pathPageTop">ì „ì²´ì§€ë„</span>
      </span>
    </div>
  </div>

  <div class="layout">
    <!-- LEFT -->
    <aside class="side left">
      <div class="sideInner">
        <div class="card">
          <div class="sectionTitle">
            <span>í˜ì´ì§€</span>
            <span class="subtle"><b id="pathCat">ì¹´í…Œê³ ë¦¬1</b> / <b id="pathPage">ì „ì²´ì§€ë„</b></span>
          </div>

          <button class="btnAddPage" id="btnAddPage">+ í˜ì´ì§€ ì¶”ê°€</button>

          <div class="subtle" style="margin-top:10px;">
            â€¢ í˜ì´ì§€ ë²„íŠ¼ í´ë¦­ â†’ ê°™ì€ ì¹´í…Œê³ ë¦¬ ì•ˆì—ì„œ ì§€ë„ í˜ì´ì§€ ì´ë™<br/>
            â€¢ ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œë„ ì§€ë„ ë³´ì´ê²Œ í•˜ë ¤ë©´: í˜ì´ì§€ URL ë²„íŠ¼ìœ¼ë¡œ ì§€ë„ ì´ë¯¸ì§€ URL ì„¤ì •
          </div>

          <div class="pageList" id="pageList"></div>
        </div>
      </div>
    </aside>

    <!-- CENTER -->
    <main class="center">
      <div class="hintToast" id="toast"></div>
      <div class="canvasWrap">
        <canvas id="cv" width="1200" height="900"></canvas>
      </div>
    </main>

    <!-- RIGHT -->
    <aside class="side right">
      <div class="sideInner">

        <!-- ì¹´í…Œê³ ë¦¬ -->
        <div class="card">
          <div class="sectionTitle">
            <span>ì¹´í…Œê³ ë¦¬</span>
            <span class="subtle">í•„í„°</span>
          </div>

          <div class="chipRow" id="catChips"></div>

          <div class="toggleRow">
            <div class="toggle" id="tgShowChainSameCat">
              <div class="dot"></div>
              <div>ê°™ì€ ì¹´í…Œê³ ë¦¬ í•„í„° ì‹œ ì„ ë„ ê°™ì´ í‘œì‹œ/ìˆ¨ê¹€</div>
            </div>

            <div class="subtle" id="kpi" style="margin-top:2px;">í‘œì‹œ ì¤‘ ë§ˆì»¤: 0 / í˜ì´ì§€ ì „ì²´: 0</div>

            <button class="pill btnFull ghost" id="btnEditCats">ì¹´í…Œê³ ë¦¬/ìƒ‰ìƒ í¸ì§‘</button>
          </div>
        </div>

        <!-- ê´€ë¦¬ì íˆ´ -->
        <div class="card">
          <div class="sectionTitle">
            <span>ê´€ë¦¬ì íˆ´</span>
            <span class="subtle">â€¢ ìƒ‰ìƒ íŒ”ë ˆíŠ¸(ì²´ì¸ 1ë²ˆ ê¸°ì¤€ ì „íŒŒ)<br/>â€¢ ì„ ì€ "ê°™ì€ ì¹´í…Œê³ ë¦¬ í•„í„°" ì‹œ ê°™ì´ í‘œì‹œ/ìˆ¨ê¹€</span>
          </div>

          <div class="subtle" style="margin-top:8px;">ë¹ ë¥¸ ìƒ‰ìƒ (ì› ìƒ‰ìƒ ì˜¤ë²„ë¼ì´ë“œ)</div>
          <div class="palette" id="palette"></div>

          <div class="row2">
            <button class="pill btnFull ghost" id="btnApplyQuick" disabled>ì„ íƒ ë§ˆì»¤ì— ì ìš©</button>
            <button class="pill btnFull ghost" id="btnUseCatColor" disabled>ì„ íƒ ë§ˆì»¤ ìƒ‰ìƒ(ì¹´í…Œê³ ë¦¬ë¡œ)</button>
          </div>

          <div class="hr"></div>

          <div class="row2">
            <button class="pill btnFull danger" id="btnClearLines">ëª¨ë“  ì„  ì œê±°</button>
            <button class="pill btnFull ghost" id="btnRechain">ì„  ë‹¤ì‹œ ì²´ì¸(ì „ì²´)</button>
          </div>

          <div class="hr"></div>

          <button class="pill btnFull danger" id="btnResetMarkers" style="border-color:rgba(255,93,93,.65);">ë§ˆì»¤ ì´ˆê¸°í™”</button>

          <div class="hr"></div>

          <div class="selectedBox" style="margin-top:6px;">
            <div class="label">ì„ íƒí•œ ë§ˆì»¤: <span id="selName">(ì´ë¦„ ì—†ìŒ)</span></div>
            <div class="sub">ìœ íŠœë¸Œ ë§í¬</div>
            <input class="field" id="selLink" placeholder="ìœ íŠœë¸Œ" />
            <div class="sub">ìœ íŠœë¸Œ í‘œì‹œëª…</div>
            <input class="field" id="selYtTitle" placeholder="ìœ íŠœë¸Œ í‘œì‹œëª…" />
            <div style="margin-top:10px;">
              <button class="pill btnFull ghost" id="btnOpenMarkerEdit" disabled>ë§ˆì»¤ í¸ì§‘ ì—´ê¸°</button>
            </div>
          </div>
        </div>

      </div>
    </aside>
  </div>

  <!-- MARKER EDIT MODAL -->
  <div class="modalBack" id="mMarker">
    <div class="modal">
      <div class="modalHead">
        <div>
          <div class="title">ë§ˆì»¤ í¸ì§‘</div>
          <div class="subtle" style="margin-top:6px;">ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ í¸ì§‘/ì‚­ì œ ê°€ëŠ¥í•©ë‹ˆë‹¤. (Enter = ì €ì¥)</div>
        </div>
        <button class="modalClose" id="btnCloseMarker">ë‹«ê¸°</button>
      </div>

      <div class="modalBody">
        <div class="grid2">
          <div>
            <div class="labelRow">ì´ë¦„(ë§ˆì»¤ ì´ë¦„)</div>
            <input class="field" id="mfName" placeholder="ì˜ˆ: ê¸°í…” ìœ„ì¹˜" />
          </div>
          <div>
            <div class="labelRow">ì¹´í…Œê³ ë¦¬</div>
            <select class="field" id="mfCat"></select>
          </div>
        </div>

        <div class="labelRow" style="margin-top:12px;">ë§ˆì»¤ ì› ìƒ‰ìƒ</div>
        <div style="display:flex; align-items:center; gap:12px; justify-content:space-between;">
          <input class="field" id="mfColor" placeholder="ê°œë³„ ì˜¤ë²„ë¼ì´ë“œ ìƒ‰ìƒ (ì˜ˆ: #ff0000)" />
          <div style="display:flex; align-items:center; gap:10px;">
            <div class="colorChip" id="mfColorChip" style="--c:#2b8cff;"></div>
            <div class="checkRow">
              <input type="checkbox" id="mfUseCatColor" />
              <label for="mfUseCatColor" class="subtle" style="cursor:pointer;">ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì‚¬ìš©</label>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="grid2">
          <div>
            <div class="labelRow">ìœ íŠœë¸Œ ë§í¬(URL)</div>
            <input class="field" id="mfYt" placeholder="https://www.youtube.com/..." />
          </div>
          <div>
            <div class="labelRow">ìœ íŠœë¸Œ í‘œì‹œëª…(ìœ ì €ëª¨ë“œ ì œëª©)</div>
            <input class="field" id="mfYtTitle" placeholder="ì˜ˆ: ê¸°í…” 1ë²ˆìœ„ì¹˜" />
          </div>
        </div>

        <div class="labelRow" style="margin-top:12px;">ë©”ëª¨ (ê´€ë¦¬ì ë“±ë¡)</div>
        <textarea class="field" id="mfMemo" placeholder="ê´€ë¦¬ì ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ìœ ì € ëª¨ë“œì—ì„œëŠ” ì½ê¸° ì „ìš©ì…ë‹ˆë‹¤."></textarea>

        <div class="hr"></div>

        <div class="labelRow">ë§ˆì»¤ ìŠ¤íƒ€ì¼</div>
        <div class="styleGrid">
          <div class="styleCard">
            <h4>ì› í¬ê¸° <span class="subtle" style="float:right;">px</span></h4>
            <div class="rangeRow">
              <input type="range" id="mfR" min="4" max="40" step="1" />
              <div class="numBox" id="mfRVal">10</div>
            </div>
            <div class="subtle" style="margin-top:10px;">* ì› í¬ê¸° ë³€ê²½ ì‹œ ê¸€ì”¨ í¬ê¸°ê°€ ê°™ì€ ë¹„ìœ¨ë¡œ ìë™ ë³€ê²½ë©ë‹ˆë‹¤.</div>
          </div>

          <div class="styleCard">
            <h4>ê¸€ì”¨ í¬ê¸° <span class="subtle" style="float:right;">ë¼ë²¨</span></h4>
            <div class="rangeRow">
              <input type="range" id="mfFs" min="8" max="40" step="1" />
              <div class="numBox" id="mfFsVal">15</div>
            </div>
            <div class="subtle" style="margin-top:10px;">* í˜„ì¬ëŠ” ìë™ ë™ê¸°í™” ìš°ì„ </div>
          </div>

          <div class="styleCard">
            <h4>êµµê¸°/ìƒ‰ìƒ <span class="subtle" style="float:right;">ë¼ë²¨</span></h4>
            <select class="field fwSelect" id="mfFw">
              <option value="900">900 (Black)</option>
              <option value="800">800 (ExtraBold)</option>
              <option value="700">700 (Bold)</option>
              <option value="600">600 (SemiBold)</option>
            </select>

            <div class="labelRow" style="margin-top:10px;">ê¸€ì”¨ ìƒ‰ìƒ (ë¼ë²¨)</div>
            <div style="display:flex; gap:10px; align-items:center;">
              <input class="field" style="flex:1;" id="mfLabelColor" placeholder="#e7eef8" />
              <button class="btnBig" id="mfLabelDefault" type="button">ê¸°ë³¸ê°’</button>
            </div>

            <div class="labelRow" style="margin-top:10px;">ë¹ ë¥¸ ê¸€ì”¨ìƒ‰</div>
            <div class="quickTextColors" id="textColors"></div>
          </div>
        </div>

        <div class="subtle" id="mfPos" style="margin-top:12px;">ì¢Œí‘œ(ë¹„ìœ¨): -</div>
        <div class="subtle" style="margin-top:8px;">
          â€¢ ìƒˆë¡œìš´ ë²ˆí˜¸ë¡œ ì‹œì‘: ì´ ë§ˆì»¤ë¶€í„° ìƒˆ ì²´ì¸(ìƒˆ 1ë²ˆ) ì‹œì‘<br/>
          â€¢ í•´ë‹¹ ë§ˆì»¤ë¥¼ ì´ì–´ì„œ ì‹œì‘: ì´ ë§ˆì»¤ ë’¤ë¡œ "ì¤‘ê°„ ì‚½ì…" ëª¨ë“œ í™œì„±í™”
        </div>
      </div>

      <div class="modalFoot">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btnBig" id="btnNewChain">ìƒˆë¡œìš´ ë²ˆí˜¸ë¡œ ì‹œì‘</button>
          <button class="btnBig" id="btnInsertAfter">í•´ë‹¹ ë§ˆì»¤ë¥¼ ì´ì–´ì„œ ì‹œì‘</button>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-left:auto;">
          <button class="btnBig danger" id="btnDeleteMarker">ì‚­ì œ</button>
          <button class="btnBig ok" id="btnSaveMarker">ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CATEGORY EDIT MODAL -->
  <div class="modalBack" id="mCats">
    <div class="modal">
      <div class="modalHead">
        <div class="title">ì¹´í…Œê³ ë¦¬/ìƒ‰ìƒ í¸ì§‘</div>
        <button class="modalClose" id="btnCloseCats">ë‹«ê¸°</button>
      </div>

      <div class="modalBody">
        <div class="subtle">ì €ì¥í•˜ë©´ í˜„ì¬ ì¹´í…Œê³ ë¦¬ì˜ ì¹´í…Œê³ ë¦¬ ëª©ë¡ì´ ì™„ì „íˆ êµì²´ë©ë‹ˆë‹¤.</div>

        <div class="labelRow" style="margin-top:14px;">ë¹ ë¥¸ ìƒ‰ìƒ (ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ í–‰ì— ì ìš©)</div>
        <div class="palette" id="catQuickPalette" style="margin-top:10px;"></div>
        <div class="subtle" style="margin-top:8px;">ì¹´í…Œê³ ë¦¬ í–‰ì„ ë¨¼ì € í´ë¦­í•´ì„œ ì„ íƒí•˜ì„¸ìš”.</div>

        <div class="hr"></div>

        <div class="row2">
          <button class="pill btnFull ghost" id="btnAddCat">+ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</button>
          <button class="pill btnFull ghost" id="btnCatsDefault">ê¸°ë³¸ê°’ìœ¼ë¡œ</button>
        </div>

        <div class="hr"></div>

        <div id="catRows"></div>
      </div>

      <div class="modalFoot" style="justify-content:flex-end;">
        <button class="btnBig ok" id="btnSaveCats">ì €ì¥</button>
      </div>
    </div>
  </div>

<script>
(() => {
  /************************************************************
   * ADMIN99 ì €ì¥ ê·œì¹™
   ************************************************************/
  const LS_AUTH_KEY = "mapmode_admin_auth_v99";
  const LS_KEY = "mapmode_state_v99";
  const REMOTE_STATE_URL = new URL("./data/state.json", location.href).toString();
  const PASSWORD = "0000000001";
  const AUTH_MS = 24 * 60 * 60 * 1000;

  const defaultCats = [
    { id:"ì „ì²´", name:"ì „ì²´", color:"#7cc4ff", on:true },
    { id:"ë³´ìŠ¤", name:"ë³´ìŠ¤", color:"#ff5d5d", on:true },
    { id:"ê¸°í…”", name:"ê¸°í…”", color:"#ffd60a", on:true },
    { id:"íë¸Œ", name:"íë¸Œ", color:"#2b8cff", on:true },
  ];

  const makeDefaultCatState = () => ({
    pages: [
      { id:"p_all", name:"ì „ì²´ì§€ë„", url:"" },
      { id:"p_2", name:"2ë²ˆë§ˆì„", url:"" },
      { id:"p_3", name:"3ë²ˆë§ˆì„", url:"" },
      { id:"p_4", name:"4ë²ˆë§ˆì„", url:"" },
      { id:"p_5", name:"5ë²ˆë§ˆì„", url:"" },
      { id:"p_6", name:"6ë²ˆë§ˆì„", url:"" },
      { id:"p_7", name:"7ë²ˆë§ˆì„", url:"" },
    ],
    currentPageId:"p_all",
    categories: structuredClone(defaultCats),
    showLinesWithCatFilter:true,
    map:{ imgDataUrl:"", naturalW:1, naturalH:1, scale:0, tx:0, ty:0 },
    markers:[],
    chains:[], // (legacy placeholder)
    curves:{}  // key "aId|bId" => { cx, cy }  (world coords)
  });

  const defaultState = {
    version:99,
    logoUrl:"",
    topCats: [
      { id:"cat1", label:"ì¹´í…Œê³ ë¦¬1", enabled:true },
      { id:"cat2", label:"ì¹´í…Œê³ ë¦¬2", enabled:true },
      { id:"cat3", label:"ì¹´í…Œê³ ë¦¬3", enabled:true },
      { id:"cat4", label:"ì¹´í…Œê³ ë¦¬4", enabled:true },
    ],
    activeTopCatId:"cat1",
    cats: {
      cat1: makeDefaultCatState(),
      cat2: makeDefaultCatState(),
      cat3: makeDefaultCatState(),
      cat4: makeDefaultCatState(),
    }
  };

  const $ = (id)=>document.getElementById(id);
  const cv = $("cv");
  const ctx = cv.getContext("2d");

  const toastEl = $("toast");
  const lock = $("lock");
  const pw = $("pw");
  const btnLogin = $("btnLogin");
  const lockMsg = $("lockMsg");

  const pageList = $("pageList");
  const catChips = $("catChips");
  const palette = $("palette");
  const textColors = $("textColors");

  const mMarker = $("mMarker");
  const mCats = $("mCats");

  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const safeParse = (json, fallback) => { try{ return JSON.parse(json); }catch(e){ return fallback; } };
  const uid = () => Math.random().toString(36).slice(2,10);

  function toast(msg, ms=1200){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>toastEl.classList.remove("show"), ms);
  }

  function isAuthed(){
    const t = Number(localStorage.getItem(LS_AUTH_KEY) || "0");
    return (Date.now() - t) < AUTH_MS;
  }
  function setAuthed(){
    localStorage.setItem(LS_AUTH_KEY, String(Date.now()));
  }

  function requireAuth(){
    if(isAuthed()){
      lock.classList.remove("show");
      return;
    }
    lock.classList.add("show");
    pw.value = "";
    lockMsg.textContent = "";
    setTimeout(()=>pw.focus(), 0);
  }

  btnLogin.addEventListener("click", ()=>{
    if(pw.value === PASSWORD){
      setAuthed();
      lock.classList.remove("show");
      toast("ì¸ì¦ ì™„ë£Œ");
    }else{
      lockMsg.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      toast("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
    }
  });
  pw.addEventListener("keydown", (e)=>{
    if(e.key==="Enter") btnLogin.click();
  });

  // ---------- state ----------
  let S = structuredClone(defaultState);
  let mapImg = new Image();
  mapImg.crossOrigin = "anonymous";

  function currentTopCat(){
    const id = S.activeTopCatId || "cat1";
    const tc = (S.topCats||[]).find(x=>x.id===id) || (S.topCats?.[0] || {id:"cat1", label:"ì¹´í…Œê³ ë¦¬1", enabled:true});
    return tc;
  }
  function currentCatState(){
    const id = S.activeTopCatId || "cat1";
    if(!S.cats) S.cats = {};
    if(!S.cats[id]) S.cats[id] = makeDefaultCatState();
    return S.cats[id];
  }

  function ensureCatSlotIntegrity(){
    if(!Array.isArray(S.topCats) || !S.topCats.length){
      S.topCats = structuredClone(defaultState.topCats);
    }
    const needed = ["cat1","cat2","cat3","cat4"];
    for(const id of needed){
      if(!S.topCats.some(x=>x.id===id)){
        const base = defaultState.topCats.find(x=>x.id===id);
        S.topCats.push(structuredClone(base));
      }
      if(!S.cats) S.cats = {};
      if(!S.cats[id]) S.cats[id] = makeDefaultCatState();
    }
    // keep exactly 4 in order
    S.topCats = needed.map(id=>{
      const found = S.topCats.find(x=>x.id===id);
      return {
        id,
        label: (found?.label ?? defaultState.topCats.find(x=>x.id===id).label),
        enabled: (typeof found?.enabled==="boolean") ? found.enabled : true
      };
    });
    if(!needed.includes(S.activeTopCatId)) S.activeTopCatId = "cat1";
  }

  function migrateLegacyStateToCat1(st){
    // If prior schema existed (game/pages/markers/categories/map), fold into cats.cat1
    const legacyHas = st && typeof st==="object" && (
      Array.isArray(st.pages) || Array.isArray(st.markers) || Array.isArray(st.categories) || st.map
    );
    if(!legacyHas) return st;

    const merged = structuredClone(defaultState);
    merged.logoUrl = (typeof st.logoUrl==="string") ? st.logoUrl : "";
    merged.topCats = structuredClone(defaultState.topCats);
    merged.activeTopCatId = "cat1";
    merged.cats = structuredClone(defaultState.cats);

    const c1 = merged.cats.cat1;
    if(Array.isArray(st.pages) && st.pages.length) c1.pages = st.pages;
    if(typeof st.currentPageId==="string") c1.currentPageId = st.currentPageId;
    if(Array.isArray(st.categories) && st.categories.length) c1.categories = st.categories;
    if(typeof st.showLinesWithCatFilter==="boolean") c1.showLinesWithCatFilter = st.showLinesWithCatFilter;
    if(st.map && typeof st.map==="object") c1.map = Object.assign(structuredClone(c1.map), st.map);
    if(Array.isArray(st.markers)) c1.markers = st.markers;
    if(Array.isArray(st.chains)) c1.chains = st.chains;
    if(st.curves && typeof st.curves==="object") c1.curves = st.curves;

    return merged;
  }

  function mergeState(st){
    // Accept new schema, else migrate legacy schema
    let base = st;
    if(st && typeof st==="object"){
      const isNew = st.topCats && st.cats;
      base = isNew ? st : migrateLegacyStateToCat1(st);
    }else{
      base = structuredClone(defaultState);
    }

    const merged = structuredClone(defaultState);
    if(base && typeof base==="object"){
      merged.version = 99;
      merged.logoUrl = typeof base.logoUrl==="string" ? base.logoUrl : "";
      merged.topCats = Array.isArray(base.topCats) ? base.topCats : structuredClone(defaultState.topCats);
      merged.activeTopCatId = typeof base.activeTopCatId==="string" ? base.activeTopCatId : "cat1";
      merged.cats = (base.cats && typeof base.cats==="object") ? base.cats : structuredClone(defaultState.cats);
    }
    ensureCatSlotIntegrity();

    // normalize each cat state
    for(const tc of merged.topCats){
      const cs = merged.cats[tc.id] || makeDefaultCatState();
      const norm = makeDefaultCatState();
      norm.pages = Array.isArray(cs.pages) && cs.pages.length ? cs.pages : norm.pages;
      norm.currentPageId = (typeof cs.currentPageId==="string" && norm.pages.some(p=>p.id===cs.currentPageId)) ? cs.currentPageId : norm.pages[0].id;
      norm.categories = Array.isArray(cs.categories) && cs.categories.length ? cs.categories : structuredClone(defaultCats);
      norm.showLinesWithCatFilter = (typeof cs.showLinesWithCatFilter==="boolean") ? cs.showLinesWithCatFilter : true;
      norm.map = Object.assign(structuredClone(norm.map), (cs.map && typeof cs.map==="object") ? cs.map : {});
      norm.markers = Array.isArray(cs.markers) ? cs.markers : [];
      norm.chains = Array.isArray(cs.chains) ? cs.chains : [];
      norm.curves = (cs.curves && typeof cs.curves==="object") ? cs.curves : {};
      merged.cats[tc.id] = norm;
    }
    S = merged;
    return merged;
  }

  function saveLocal(){
    localStorage.setItem(LS_KEY, JSON.stringify(S));
  }

  async function loadStateRemoteFirst(){
    try{
      const r = await fetch(REMOTE_STATE_URL, { cache:"no-store" });
      if(r.ok){
        const st = await r.json();
        localStorage.setItem(LS_KEY, JSON.stringify(st));
        return st;
      }
    }catch(e){}
    const raw = localStorage.getItem(LS_KEY);
    return raw ? safeParse(raw, structuredClone(defaultState)) : structuredClone(defaultState);
  }

  // ---------- logo ----------
  const logoBox = $("logoBox");
  function renderLogo(){
    logoBox.innerHTML = "";
    if(S.logoUrl){
      const img = document.createElement("img");
      img.src = S.logoUrl;
      img.alt = "logo";
      img.onerror = () => {
        logoBox.innerHTML = `<div class="brand"><div class="word">MAPM<span class="o"></span>DE</div></div>`;
      };
      logoBox.appendChild(img);
    }else{
      logoBox.innerHTML = `<div class="brand"><div class="word">MAPM<span class="o"></span>DE</div></div>`;
    }
  }
  logoBox.addEventListener("click", ()=>{
    requireAuth();
    if(!isAuthed()) return;

    const cur = S.logoUrl || "";
    const next = prompt("ë¡œê³  ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš” (ë¹„ìš°ë©´ ê¸°ë³¸ ë¡œê³ )", cur);
    if(next === null) return;
    S.logoUrl = (next || "").trim();
    saveLocal();
    renderLogo();
    toast("ë¡œê³  ì„¤ì • ì €ì¥");
  });

  // ---------- top categories ----------
  const topCatsEl = $("topCats");
  function renderTopCats(){
    topCatsEl.innerHTML = "";
    ensureCatSlotIntegrity();
    for(const tc of S.topCats){
      const pill = document.createElement("div");
      const isActive = (tc.id === S.activeTopCatId);
      pill.className = "topCatPill" + (isActive ? " active" : "") + (!tc.enabled ? " disabled" : "");
      pill.innerHTML = `
        <div class="topCatLabel">${tc.id==="cat1" ? "ì•„ì´ì˜¨2" : tc.label}</div>
        <div class="topCatToggle ${tc.enabled ? "on" : ""}" title="í™œì„±/ë¹„í™œì„±"></div>
      `;

      const toggle = pill.querySelector(".topCatToggle");

      toggle.addEventListener("click", (e)=>{
        e.stopPropagation();
        requireAuth(); if(!isAuthed()) return;
        tc.enabled = !tc.enabled;
        saveLocal();
        renderTopCats();
        toast(tc.enabled ? "ì¹´í…Œê³ ë¦¬ í™œì„±í™”" : "ì¹´í…Œê³ ë¦¬ ë¹„í™œì„±í™”");
      });

      pill.addEventListener("click", ()=>{
        requireAuth(); if(!isAuthed()) return;
        S.activeTopCatId = tc.id;
        saveLocal();
        selectedMarker = null;
        insertAfterMarkerId = null;
        syncSelectedPanel();
        renderAll();
        loadMap();
        toast("ì¹´í…Œê³ ë¦¬ ì „í™˜");
      });

      topCatsEl.appendChild(pill);
    }

    $("pathTopCat").textContent = (S.activeTopCatId==="cat1") ? "ì•„ì´ì˜¨2" : currentTopCat().label;
    $("pathCat").textContent = (S.activeTopCatId==="cat1") ? "ì•„ì´ì˜¨2" : currentTopCat().label;
  }

  // ---------- pages ----------
  function renderPages(){
    const C = currentCatState();
    pageList.innerHTML = "";
    const cur = C.pages.find(p=>p.id===C.currentPageId) || C.pages[0];
    $("pathPage").textContent = cur ? cur.name : "ì „ì²´ì§€ë„";
    $("pathPageTop").textContent = cur ? cur.name : "ì „ì²´ì§€ë„";

    for(const p of C.pages){
      const item = document.createElement("div");
      item.className = "pageItem" + (p.id===C.currentPageId ? " active" : "");
      item.innerHTML = `
        <div class="pageName">${p.name}</div>
        <div class="pageActions">
          <button class="miniBtn url" title="ì§€ë„ ì´ë¯¸ì§€ URL ì„¤ì •">URL</button>
          <button class="miniBtn icon edit" title="ì´ë¦„ í¸ì§‘">âœ</button>
          <button class="miniBtn icon del" title="ì‚­ì œ">ğŸ—‘</button>
        </div>
      `;
      item.addEventListener("click", (e)=>{
        const btn = e.target.closest("button");
        if(btn) return;
        C.currentPageId = p.id;
        saveLocal();
        renderPages();
        renderKpi();
        loadMap();
      });

      const [bUrl, bEdit, bDel] = item.querySelectorAll("button");

      bUrl.addEventListener("click", (e)=>{
        e.stopPropagation();
        requireAuth();
        if(!isAuthed()) return;
        const next = prompt("ì´ í˜ì´ì§€ ì§€ë„ ì´ë¯¸ì§€ URL(ë˜ëŠ” Raw/GitHub Pages URL)ì„ ì…ë ¥í•˜ì„¸ìš”", p.url || "");
        if(next === null) return;
        p.url = (next || "").trim();
        saveLocal();
        toast("í˜ì´ì§€ URL ì €ì¥");
        if(p.id === C.currentPageId) loadMap();
      });

      bEdit.addEventListener("click", (e)=>{
        e.stopPropagation();
        requireAuth();
        if(!isAuthed()) return;
        const next = prompt("í˜ì´ì§€ ì´ë¦„ì„ ìˆ˜ì •í•˜ì„¸ìš”", p.name);
        if(!next) return;
        p.name = next.trim();
        saveLocal();
        renderPages();
        toast("í˜ì´ì§€ ì´ë¦„ ìˆ˜ì •");
      });

      bDel.addEventListener("click", (e)=>{
        e.stopPropagation();
        requireAuth();
        if(!isAuthed()) return;
        if(C.pages.length <= 1){ toast("ìµœì†Œ 1ê°œ í˜ì´ì§€ëŠ” í•„ìš”í•©ë‹ˆë‹¤"); return; }
        if(!confirm(`"${p.name}" í˜ì´ì§€ë¥¼ ì‚­ì œí• ê¹Œìš”? (í•´ë‹¹ í˜ì´ì§€ ë§ˆì»¤ë„ ê°™ì´ ì‚­ì œë©ë‹ˆë‹¤)`)) return;

        const pid = p.id;
        C.markers = C.markers.filter(m=>m.pageId !== pid);
        C.pages = C.pages.filter(x=>x.id !== pid);
        if(C.currentPageId === pid) C.currentPageId = C.pages[0].id;

        // curves cleanup
        const validIds = new Set(C.markers.map(m=>m.id));
        const newCurves = {};
        for(const k of Object.keys(C.curves||{})){
          const [a,b] = k.split("|");
          if(validIds.has(a) && validIds.has(b)) newCurves[k]=C.curves[k];
        }
        C.curves = newCurves;

        saveLocal();
        renderPages();
        renderKpi();
        loadMap();
        toast("í˜ì´ì§€ ì‚­ì œ");
      });

      pageList.appendChild(item);
    }
  }

  $("btnAddPage").addEventListener("click", ()=>{
    requireAuth();
    if(!isAuthed()) return;
    const C = currentCatState();
    const name = prompt("ì¶”ê°€í•  í˜ì´ì§€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 8ë²ˆë§ˆì„)");
    if(!name) return;
    const p = { id:"p_"+uid(), name:name.trim(), url:"" };
    C.pages.push(p);
    C.currentPageId = p.id;
    saveLocal();
    renderPages();
    renderKpi();
    loadMap();
    toast("í˜ì´ì§€ ì¶”ê°€");
  });

  // ---------- categories (filter chips) ----------
  function getCat(id){
    const C = currentCatState();
    return C.categories.find(c=>c.id===id);
  }
  function markerColor(m){
    if(!m) return "#7cc4ff";
    if(m.useCatColor){
      const c = getCat(m.cat);
      return (c && c.color) ? c.color : "#7cc4ff";
    }
    if(m.colorOverride && m.colorOverride.trim()) return m.colorOverride.trim();
    const c = getCat(m.cat);
    return (c && c.color) ? c.color : "#7cc4ff";
  }

  function ensureCat(name, color){
    const C = currentCatState();
    if(C.categories.some(c=>c.id===name)) return;
    C.categories.push({ id:name, name, color:color||"#ffffff", on:true });
    renderCats();
  }

  function setToggle(el, on){
    el.classList.toggle("on", !!on);
    el.dataset.on = on ? "1" : "0";
  }

  function renderCats(){
    const C = currentCatState();
    catChips.innerHTML = "";

    for(const c of C.categories){
      const chip = document.createElement("div");
      chip.className = "chip" + (c.on ? " on" : " off");
      chip.innerHTML = `<div class="dotc" style="background:${c.color};"></div><div>${c.name}</div>`;

      chip.addEventListener("click", ()=>{
        requireAuth();
        if(!isAuthed()) return;

        if(c.id === "ì „ì²´"){
          // ì „ì²´ í´ë¦­: ëª¨ë“  ë§ˆì»¤ ON/OFF (ì¹´í…Œê³ ë¦¬ í† ê¸€ ì „ì²´ ë°˜ì˜)
          const anyOn = C.categories.some(x=>x.id!=="ì „ì²´" && x.on);
          const toOn = !anyOn;
          for(const x of C.categories){
            if(x.id==="ì „ì²´"){ x.on = true; continue; }
            x.on = toOn;
          }
          saveLocal();
          renderCats();
          renderKpi();
          draw();
          toast(toOn ? "ì „ì²´ ON" : "ì „ì²´ OFF");
          return;
        }

        c.on = !c.on;
        saveLocal();
        renderCats();
        renderKpi();
        draw();
      });

      catChips.appendChild(chip);
    }
  }

  const tgShowLinesWithCatFilter = $("tgShowChainSameCat");
  tgShowLinesWithCatFilter.addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    const C = currentCatState();
    C.showLinesWithCatFilter = !C.showLinesWithCatFilter;
    setToggle(tgShowLinesWithCatFilter, C.showLinesWithCatFilter);
    saveLocal();
    draw();
  });

  // ---------- map upload ----------
  $("fileMap").addEventListener("change", async (e)=>{
    requireAuth();
    if(!isAuthed()) return;
    const C = currentCatState();
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const dataUrl = await fileToDataURL(f);
    C.map.imgDataUrl = dataUrl;
    saveLocal();
    loadMap();
    toast("ì§€ë„ ì—…ë¡œë“œ ì™„ë£Œ");
    e.target.value = "";
  });

  function fileToDataURL(file){
    return new Promise((res, rej)=>{
      const fr = new FileReader();
      fr.onload = ()=>res(fr.result);
      fr.onerror = rej;
      fr.readAsDataURL(file);
    });
  }

  function loadMap(){
    const C = currentCatState();
    const curPage = C.pages.find(p => p.id === C.currentPageId);
    const pageUrl = (curPage?.url || "").trim();

    if(pageUrl){
      mapImg = new Image();
      mapImg.crossOrigin = "anonymous";
      mapImg.onload = ()=>{
        C.map.naturalW = mapImg.naturalWidth || 1;
        C.map.naturalH = mapImg.naturalHeight || 1;
        fitToScreen();
        saveLocal();
        draw();
        renderKpi();
      };
      mapImg.onerror = ()=>{
        toast("ì§€ë„ URL ë¡œë“œ ì‹¤íŒ¨");
        draw();
      };
      mapImg.src = pageUrl;
      return;
    }

    if(C.map.imgDataUrl){
      mapImg = new Image();
      mapImg.crossOrigin = "anonymous";
      mapImg.onload = ()=>{
        C.map.naturalW = mapImg.naturalWidth || 1;
        C.map.naturalH = mapImg.naturalHeight || 1;
        if(!C.map.scale || C.map.scale<=0) fitToScreen();
        draw();
      };
      mapImg.src = C.map.imgDataUrl;
      return;
    }

    mapImg = new Image();
    mapImg.onload = ()=>draw();
    mapImg.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(
      `<svg xmlns="http://www.w3.org/2000/svg" width="1400" height="1000">
        <defs>
          <radialGradient id="g" cx="50%" cy="40%" r="70%">
            <stop offset="0%" stop-color="#ffffff"/>
            <stop offset="100%" stop-color="#e8edf7"/>
          </radialGradient>
        </defs>
        <rect width="100%" height="100%" fill="url(#g)"/>
        <text x="50%" y="50%" text-anchor="middle" font-family="Arial" font-size="28" fill="#7a889e">í˜ì´ì§€ URL ë˜ëŠ” ì§€ë„ ì—…ë¡œë“œê°€ í•„ìš”</text>
      </svg>`
    );
  }

  // ---------- export ----------
  $("btnExport").addEventListener("click", ()=>{
    requireAuth();
    if(!isAuthed()) return;

    const blob = new Blob([JSON.stringify(S, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "state.json";
    a.click();
    URL.revokeObjectURL(a.href);
    toast("state.json ë‹¤ìš´ë¡œë“œ");
  });

  $("btnResetAll").addEventListener("click", ()=>{
    requireAuth();
    if(!isAuthed()) return;
    if(!confirm("ì „ì²´ ì´ˆê¸°í™”í• ê¹Œìš”? (ì¹´í…Œê³ ë¦¬/í˜ì´ì§€/ë§ˆì»¤/ì§€ë„ í¬í•¨)")) return;
    S = structuredClone(defaultState);
    saveLocal();
    selectedMarker = null;
    insertAfterMarkerId = null;
    renderAll();
    loadMap();
    toast("ì „ì²´ ì´ˆê¸°í™” ì™„ë£Œ");
  });

  // ---------- canvas sizing ----------
  function resizeCanvas(){
    const wrap = cv.parentElement;
    const w = wrap.clientWidth - 32;
    const h = wrap.clientHeight - 32;
    cv.width = Math.max(900, Math.floor(w));
    cv.height = Math.max(650, Math.floor(h));
  }
  window.addEventListener("resize", ()=>{ resizeCanvas(); draw(); });

  function fitToScreen(){
    const C = currentCatState();
    const pad = 40;
    const iw = C.map.naturalW || (mapImg.naturalWidth||1);
    const ih = C.map.naturalH || (mapImg.naturalHeight||1);
    const cw = cv.width, ch = cv.height;
    const scale = Math.min((cw - pad)/iw, (ch - pad)/ih);
    C.map.scale = clamp(scale, 0.05, 10);
    C.map.tx = (cw - iw*C.map.scale)/2;
    C.map.ty = (ch - ih*C.map.scale)/2;
  }

  // ---------- marker data ----------
  function getVisibleMarkers(){
    const C = currentCatState();
    const curPage = C.currentPageId;
    const onCats = new Set(C.categories.filter(c=>c.on).map(c=>c.id));
    const allOn = onCats.has("ì „ì²´");
    const anyNonAllOn = C.categories.some(c=>c.id!=="ì „ì²´" && c.on);

    return (C.markers||[]).filter(m=>{
      if(m.pageId !== curPage) return false;
      if(allOn) return true;
      if(!anyNonAllOn) return false; // ì „ì²´ OFF ìƒíƒœ
      return onCats.has(m.cat);
    });
  }

  function renderKpi(){
    const C = currentCatState();
    const curPage = C.currentPageId;
    const total = (C.markers||[]).filter(m=>m.pageId===curPage).length;
    const shown = getVisibleMarkers().length;
    $("kpi").textContent = `í‘œì‹œ ì¤‘ ë§ˆì»¤: ${shown} / í˜ì´ì§€ ì „ì²´: ${total}`;
  }

  // ---------- drawing helpers ----------
  function worldFromNorm(nx, ny){
    const C = currentCatState();
    const iw = C.map.naturalW || (mapImg.naturalWidth||1);
    const ih = C.map.naturalH || (mapImg.naturalHeight||1);
    return { x:nx*iw, y:ny*ih };
  }
  function normFromWorld(wx, wy){
    const C = currentCatState();
    const iw = C.map.naturalW || (mapImg.naturalWidth||1);
    const ih = C.map.naturalH || (mapImg.naturalHeight||1);
    return { nx: iw ? wx/iw : 0, ny: ih ? wy/ih : 0 };
  }
  function screenFromWorld(wx, wy){
    const C = currentCatState();
    return { sx: wx*C.map.scale + C.map.tx, sy: wy*C.map.scale + C.map.ty };
  }
  function worldFromScreen(sx, sy){
    const C = currentCatState();
    return { wx: (sx - C.map.tx)/C.map.scale, wy: (sy - C.map.ty)/C.map.scale };
  }

  function drawArrowAt(p, v, sizeWorld){
    // p: {x,y} in world coords; v: direction vector in world coords (normalized)
    const C = currentCatState();
    const s = sizeWorld;
    const nx = v.x, ny = v.y;
    const px = -ny, py = nx;
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
    ctx.lineTo(p.x - nx*s + px*(s*0.55), p.y - ny*s + py*(s*0.55));
    ctx.lineTo(p.x - nx*s - px*(s*0.55), p.y - ny*s - py*(s*0.55));
    ctx.closePath();
    ctx.fill();
  }

  function quadPoint(a, c, b, t){
    const u = 1-t;
    return {
      x: u*u*a.x + 2*u*t*c.x + t*t*b.x,
      y: u*u*a.y + 2*u*t*c.y + t*t*b.y
    };
  }
  function quadDeriv(a, c, b, t){
    return {
      x: 2*(1-t)*(c.x-a.x) + 2*t*(b.x-c.x),
      y: 2*(1-t)*(c.y-a.y) + 2*t*(b.y-c.y)
    };
  }
  function normVec(v){
    const d = Math.hypot(v.x, v.y) || 1;
    return { x:v.x/d, y:v.y/d };
  }

  function segmentKey(aId,bId){ return `${aId}|${bId}`; }

  let circleHitboxes = []; // {id,sx,sy,rPx}
  let segHitboxes = [];    // {key,aId,bId, distFn(sx,sy)->d, midW:{x,y}, aW, bW}

  function draw(){
    const C = currentCatState();
    ctx.clearRect(0,0,cv.width,cv.height);
    circleHitboxes = [];
    segHitboxes = [];

    ctx.save();
    ctx.fillStyle = "rgba(0,0,0,.22)";
    ctx.fillRect(0,0,cv.width,cv.height);
    ctx.restore();

    ctx.save();
    ctx.translate(C.map.tx, C.map.ty);
    ctx.scale(C.map.scale, C.map.scale);

    // map
    if(mapImg && mapImg.complete){
      const iw = C.map.naturalW || (mapImg.naturalWidth||1);
      const ih = C.map.naturalH || (mapImg.naturalHeight||1);
      ctx.drawImage(mapImg, 0,0, iw, ih);
    }

    const ms = getVisibleMarkers();

    // chain lines + arrows + curve support
    const showLines = !!C.showLinesWithCatFilter;
    if(showLines){
      const byChain = new Map();
      for(const m of ms){
        if(!m.chainId || !m.chainIndex) continue;
        if(!byChain.has(m.chainId)) byChain.set(m.chainId, []);
        byChain.get(m.chainId).push(m);
      }

      ctx.lineWidth = 2 / C.map.scale;
      ctx.strokeStyle = "rgba(255,255,255,.78)";
      ctx.fillStyle = "rgba(255,255,255,.86)";
      ctx.globalAlpha = 0.9;

      for(const arr of byChain.values()){
        arr.sort((a,b)=>(a.chainIndex||0)-(b.chainIndex||0));
        if(arr.length<2) continue;

        for(let i=0;i<arr.length-1;i++){
          const A = arr[i], B = arr[i+1];
          const aW = worldFromNorm(A.x, A.y);
          const bW = worldFromNorm(B.x, B.y);
          const key = segmentKey(A.id,B.id);

          const cc = (C.curves && C.curves[key]) ? C.curves[key] : null;
          const hasCurve = !!cc && typeof cc.cx==="number" && typeof cc.cy==="number";
          const cW = hasCurve ? { x: cc.cx, y: cc.cy } : { x: (aW.x+bW.x)/2, y: (aW.y+bW.y)/2 };

          ctx.beginPath();
          if(hasCurve){
            ctx.moveTo(aW.x, aW.y);
            ctx.quadraticCurveTo(cW.x, cW.y, bW.x, bW.y);
          }else{
            ctx.moveTo(aW.x, aW.y);
            ctx.lineTo(bW.x, bW.y);
          }
          ctx.stroke();

          // arrow at t=0.5 (straight or curve)
          const t = 0.5;
          const mid = hasCurve ? quadPoint(aW, cW, bW, t) : { x:(aW.x+bW.x)/2, y:(aW.y+bW.y)/2 };
          const dv = hasCurve ? quadDeriv(aW, cW, bW, t) : { x:(bW.x-aW.x), y:(bW.y-aW.y) };
          const dir = normVec(dv);

          ctx.save();
          ctx.globalAlpha = 0.95;
          const arrowSize = 10 / C.map.scale; // world-size so looks consistent
          drawArrowAt(mid, dir, arrowSize);
          ctx.restore();

          // segment hitbox (screen distance approximation)
          const distFn = (sx,sy)=>{
            const local = worldFromScreen(sx,sy);
            const px = local.wx, py = local.wy;
            // sample along curve/line
            const samples = 18;
            let best = Infinity;
            let prev = aW;
            for(let k=1;k<=samples;k++){
              const tt = k/samples;
              const cur = hasCurve ? quadPoint(aW,cW,bW,tt) : { x:aW.x + (bW.x-aW.x)*tt, y:aW.y + (bW.y-aW.y)*tt };
              // distance from point to segment prev-cur
              const vx = cur.x - prev.x, vy = cur.y - prev.y;
              const wx = px - prev.x, wy = py - prev.y;
              const vv = vx*vx + vy*vy || 1e-9;
              const tproj = clamp((wx*vx + wy*vy)/vv, 0, 1);
              const cxp = prev.x + vx*tproj;
              const cyp = prev.y + vy*tproj;
              const d = Math.hypot(px-cxp, py-cyp);
              if(d<best) best=d;
              prev = cur;
            }
            return best;
          };

          segHitboxes.push({
            key, aId:A.id, bId:B.id,
            aW, bW,
            midW: mid,
            hasCurve,
            distFn
          });
        }
      }
    }

    // markers
    for(const m of ms){
      const p = worldFromNorm(m.x, m.y);
      const r = (m.r ?? 10);
      const col = markerColor(m);

      ctx.save();
      ctx.globalAlpha = 1;
      ctx.beginPath();
      ctx.arc(p.x, p.y, r, 0, Math.PI*2);
      ctx.fillStyle = col;
      ctx.fill();
      ctx.lineWidth = 2 / C.map.scale;
      ctx.strokeStyle = "rgba(0,0,0,.35)";
      ctx.stroke();
      ctx.restore();

      // number
      const num = (m.chainIndex != null) ? String(m.chainIndex) : "";
      if(num){
        ctx.save();
        ctx.globalAlpha = 0.98;
        ctx.fillStyle = "rgba(0,0,0,.75)";
        ctx.font = `${m.fw ?? 900} ${Math.max(10, Math.round((m.fs ?? 15) * 0.95))}px ui-sans-serif`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(num, p.x, p.y + 0.5);
        ctx.restore();
      }

      // label: offset reduced by 50% vs old (r + 8 -> r + 4)
      if(m.name){
        ctx.save();
        ctx.globalAlpha = 0.98;
        ctx.fillStyle = m.labelColor || "#e7eef8";
        ctx.font = `${m.fw ?? 900} ${m.fs ?? 15}px ui-sans-serif`;
        ctx.textAlign = "left";
        ctx.textBaseline = "middle";
        const off = r + 4;
        ctx.fillText(m.name, p.x + off, p.y);
        ctx.restore();
      }

      const sp = screenFromWorld(p.x, p.y);
      circleHitboxes.push({ id:m.id, sx:sp.sx, sy:sp.sy, rPx: r*C.map.scale });
    }

    ctx.restore();
  }

  function pickCircleAt(sx, sy){
    let best=null, bestD=Infinity;
    for(const c of circleHitboxes){
      const d = Math.hypot(c.sx - sx, c.sy - sy);
      if(d <= c.rPx*1.25 && d < bestD){
        best = c;
        bestD = d;
      }
    }
    return best;
  }

  function pickSegmentAt(sx,sy){
    const C = currentCatState();
    const tol = 10 / C.map.scale; // in world
    let best=null, bestD=Infinity;
    for(const s of segHitboxes){
      const d = s.distFn(sx,sy);
      if(d <= tol && d < bestD){
        best = s;
        bestD = d;
      }
    }
    return best;
  }

  // ---------- pan/zoom + curve-drag ----------
  let isPanning=false, lastX=0,lastY=0;
  let isDraggingCurve=false;
  let draggingSegKey=null;

  cv.addEventListener("pointerdown", (e)=>{
    requireAuth(); if(!isAuthed()) return;
    cv.setPointerCapture(e.pointerId);
    lastX=e.clientX; lastY=e.clientY;

    const rect = cv.getBoundingClientRect();
    const sx = e.clientX - rect.left;
    const sy = e.clientY - rect.top;

    // if near line segment -> start curve drag
    const seg = pickSegmentAt(sx,sy);
    if(seg){
      isDraggingCurve = true;
      draggingSegKey = seg.key;
      toast("ì„  ë“œë˜ê·¸: ê³¡ì„  ì¡°ì •");
      return;
    }

    isPanning=true;
  });

  cv.addEventListener("pointermove", (e)=>{
    const C = currentCatState();
    if(isDraggingCurve && draggingSegKey){
      const rect = cv.getBoundingClientRect();
      const sx = e.clientX - rect.left;
      const sy = e.clientY - rect.top;
      const w = worldFromScreen(sx,sy);
      if(!C.curves) C.curves = {};
      // set control point world coords
      C.curves[draggingSegKey] = { cx: w.wx, cy: w.wy };
      saveLocal();
      draw();
      return;
    }

    if(!isPanning) return;
    const dx=e.clientX-lastX, dy=e.clientY-lastY;
    lastX=e.clientX; lastY=e.clientY;
    C.map.tx += dx;
    C.map.ty += dy;
    draw();
  });

  cv.addEventListener("pointerup", ()=>{
    isPanning=false;
    isDraggingCurve=false;
    draggingSegKey=null;
  });
  cv.addEventListener("pointercancel", ()=>{
    isPanning=false;
    isDraggingCurve=false;
    draggingSegKey=null;
  });

  cv.addEventListener("wheel", (e)=>{
    e.preventDefault();
    const C = currentCatState();
    const rect = cv.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;

    const old = C.map.scale || 1;
    const zoom = Math.exp(-e.deltaY * 0.0012);
    const next = clamp(old * zoom, 0.05, 10);

    const wx = (mx - C.map.tx) / old;
    const wy = (my - C.map.ty) / old;

    C.map.scale = next;
    C.map.tx = mx - wx * next;
    C.map.ty = my - wy * next;

    draw();
  }, {passive:false});

  // ---------- marker create / select ----------
  let selectedMarker = null;
  let insertAfterMarkerId = null;

  function newMarkerAt(normX, normY){
    const C = currentCatState();
    const m = {
      id:"m_"+uid(),
      pageId:C.currentPageId,
      x:normX, y:normY,
      name:"",
      cat: (C.categories.find(c=>c.on && c.id!=="ì „ì²´")?.id) || "ê¸°í…”",
      colorOverride:"",
      useCatColor:true,
      yt:"",
      ytTitle:"",
      memo:"",
      r:10,
      fs:15,
      fw:900,
      labelColor:"#e7eef8",
      chainId:null,
      chainIndex:null,
    };

    if(insertAfterMarkerId){
      const base = C.markers.find(x=>x.id===insertAfterMarkerId);
      if(base && base.chainId){
        m.chainId = base.chainId;
        m.chainIndex = (base.chainIndex||0) + 1;
        for(const mm of C.markers){
          if(mm.chainId===m.chainId && (mm.chainIndex||0) >= m.chainIndex){
            mm.chainIndex = (mm.chainIndex||0) + 1;
          }
        }
      }
    }else{
      m.chainId = "c_"+uid();
      m.chainIndex = 1;
    }

    C.markers.push(m);
    saveLocal();
    selectMarker(m.id);
    renderKpi();
    draw();
  }

  function selectMarker(id){
    const C = currentCatState();
    selectedMarker = C.markers.find(m=>m.id===id) || null;
    syncSelectedPanel();
  }

  function syncSelectedPanel(){
    $("selName").textContent = selectedMarker ? (selectedMarker.name || "(ì´ë¦„ ì—†ìŒ)") : "(ì´ë¦„ ì—†ìŒ)";
    $("selLink").value = selectedMarker ? (selectedMarker.yt || "") : "";
    $("selYtTitle").value = selectedMarker ? (selectedMarker.ytTitle || "") : "";
    $("btnOpenMarkerEdit").disabled = !selectedMarker;
    $("btnApplyQuick").disabled = !selectedMarker;
    $("btnUseCatColor").disabled = !selectedMarker;
  }

  cv.addEventListener("click", (e)=>{
    requireAuth(); if(!isAuthed()) return;
    if(isDraggingCurve) return;

    const rect = cv.getBoundingClientRect();
    const sx = e.clientX - rect.left;
    const sy = e.clientY - rect.top;

    const hit = pickCircleAt(sx, sy);
    if(hit){
      selectMarker(hit.id);
      toast("ë§ˆì»¤ ì„ íƒ");
      return;
    }
    selectedMarker = null;
    insertAfterMarkerId = null;
    syncSelectedPanel();
  });

  cv.addEventListener("contextmenu", (e)=>{
    e.preventDefault();
    requireAuth(); if(!isAuthed()) return;

    const C = currentCatState();
    const rect = cv.getBoundingClientRect();
    const sx = e.clientX - rect.left;
    const sy = e.clientY - rect.top;

    const wx = (sx - C.map.tx) / C.map.scale;
    const wy = (sy - C.map.ty) / C.map.scale;

    const iw = C.map.naturalW || (mapImg.naturalWidth||1);
    const ih = C.map.naturalH || (mapImg.naturalHeight||1);

    const nx = clamp(wx / iw, 0, 1);
    const ny = clamp(wy / ih, 0, 1);

    newMarkerAt(nx, ny);
    toast("ë§ˆì»¤ ì¶”ê°€");
  });

  $("selLink").addEventListener("input", ()=>{
    if(!selectedMarker) return;
    selectedMarker.yt = $("selLink").value.trim();
    saveLocal();
  });
  $("selYtTitle").addEventListener("input", ()=>{
    if(!selectedMarker) return;
    selectedMarker.ytTitle = $("selYtTitle").value;
    saveLocal();
  });

  $("btnOpenMarkerEdit").addEventListener("click", ()=>{
    if(!selectedMarker) return;
    openMarkerModal(selectedMarker.id);
  });

  // ---------- quick palette ----------
  const QUICK = [
    {name:"ë¹¨", c:"#ff3b30"},
    {name:"ì£¼", c:"#ff9500"},
    {name:"ë…¸", c:"#ffd60a"},
    {name:"ì´ˆ", c:"#34c759"},
    {name:"íŒŒ", c:"#0a84ff"},
    {name:"í°", c:"#ffffff"},
    {name:"ê²€", c:"#0b0b0f"},
  ];
  let pickedQuick = null;

  function renderPalette(){
    palette.innerHTML = "";
    for(const q of QUICK){
      const wrap = document.createElement("div");
      wrap.className = "swWrap";
      wrap.innerHTML = `
        <div class="sw" style="--c:${q.c}" title="${q.name}"></div>
        <div class="swLabel">${q.name}</div>
      `;
      wrap.querySelector(".sw").addEventListener("click", ()=>{
        pickedQuick = q.c;
        toast("ìƒ‰ìƒ ì„ íƒ");
      });
      palette.appendChild(wrap);
    }
  }

  function propagateChainFromOne(m){
    const C = currentCatState();
    if(!m || !m.chainId || m.chainIndex !== 1) return;
    const cid = m.chainId;
    const base = m;
    for(const mm of C.markers){
      if(mm.chainId !== cid) continue;
      // size + label style sync
      mm.r = base.r;
      mm.fs = base.fs;
      mm.fw = base.fw;
      mm.labelColor = base.labelColor;
      // color sync per requirement
      mm.useCatColor = base.useCatColor;
      mm.colorOverride = base.useCatColor ? "" : (base.colorOverride || "");
    }
  }

  $("btnApplyQuick").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    if(!selectedMarker){ toast("ë§ˆì»¤ë¥¼ ì„ íƒí•˜ì„¸ìš”"); return; }
    if(!pickedQuick){ toast("ë¹ ë¥¸ ìƒ‰ìƒì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”"); return; }
    selectedMarker.colorOverride = pickedQuick;
    selectedMarker.useCatColor = false;
    propagateChainFromOne(selectedMarker);
    saveLocal();
    draw();
    toast("ìƒ‰ìƒ ì ìš©");
  });

  $("btnUseCatColor").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    if(!selectedMarker){ toast("ë§ˆì»¤ë¥¼ ì„ íƒí•˜ì„¸ìš”"); return; }
    selectedMarker.colorOverride = "";
    selectedMarker.useCatColor = true;
    propagateChainFromOne(selectedMarker);
    saveLocal();
    draw();
    toast("ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì ìš©");
  });

  // chain tools
  $("btnClearLines").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    const C = currentCatState();
    if(!confirm("ëª¨ë“  ì„ (ì²´ì¸)ì„ ì œê±°í• ê¹Œìš”?")) return;
    for(const m of C.markers){
      if(m.pageId===C.currentPageId){
        m.chainId = null;
        m.chainIndex = null;
      }
    }
    // remove curves on current page
    C.curves = {};
    insertAfterMarkerId = null;
    saveLocal();
    draw();
    toast("ëª¨ë“  ì„  ì œê±°");
  });

  $("btnRechain").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    const C = currentCatState();
    const pageMs = C.markers.filter(m=>m.pageId===C.currentPageId);
    const chainId = "c_"+uid();
    let idx=1;
    for(const m of pageMs){
      m.chainId = chainId;
      m.chainIndex = idx++;
    }
    C.curves = {};
    saveLocal();
    draw();
    toast("ì„  ë‹¤ì‹œ ì²´ì¸(ì „ì²´)");
  });

  $("btnResetMarkers").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    const C = currentCatState();
    if(!confirm("í˜„ì¬ í˜ì´ì§€ì˜ ë§ˆì»¤ë¥¼ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?")) return;
    const pid = C.currentPageId;
    C.markers = C.markers.filter(m=>m.pageId!==pid);
    C.curves = {};
    selectedMarker = null;
    insertAfterMarkerId = null;
    saveLocal();
    syncSelectedPanel();
    renderKpi();
    draw();
    toast("ë§ˆì»¤ ì´ˆê¸°í™”");
  });

  // ---------- marker modal ----------
  let editingId = null;
  let ytTouched = false, memoTouched = false;

  function openMarkerModal(markerId){
    requireAuth(); if(!isAuthed()) return;
    const C = currentCatState();
    const m = C.markers.find(x=>x.id===markerId);
    if(!m) return;

    editingId = markerId;
    ytTouched = false;
    memoTouched = false;

    const sel = $("mfCat");
    sel.innerHTML = "";
    for(const c of C.categories){
      if(c.id==="ì „ì²´") continue;
      const o = document.createElement("option");
      o.value = c.id;
      o.textContent = c.name;
      sel.appendChild(o);
    }

    $("mfName").value = m.name || "";
    $("mfCat").value = m.cat || "ê¸°í…”";

    $("mfColor").value = m.colorOverride || "";
    $("mfUseCatColor").checked = !!m.useCatColor;

    $("mfYt").value = m.yt || "";
    $("mfYtTitle").value = m.ytTitle || "";
    $("mfMemo").value = m.memo || "";

    $("mfR").value = m.r ?? 10;
    $("mfFs").value = m.fs ?? 15;
    $("mfFw").value = String(m.fw ?? 900);
    $("mfLabelColor").value = m.labelColor || "#e7eef8";

    $("mfRVal").textContent = $("mfR").value;
    $("mfFsVal").textContent = $("mfFs").value;

    $("mfPos").textContent = `ì¢Œí‘œ(ë¹„ìœ¨): ${m.x.toFixed(6)}, ${m.y.toFixed(6)}`;

    updateColorChip();
    mMarker.classList.add("show");
  }

  function closeMarkerModal(){
    mMarker.classList.remove("show");
    editingId = null;
  }
  $("btnCloseMarker").addEventListener("click", closeMarkerModal);
  $("btnSaveMarker").addEventListener("click", saveMarkerModal);
  $("btnDeleteMarker").addEventListener("click", deleteMarkerModal);

  mMarker.addEventListener("keydown", (e)=>{
    if(e.key==="Enter"){
      if(e.target && e.target.tagName==="TEXTAREA") return;
      e.preventDefault();
      saveMarkerModal();
    }
    if(e.key==="Escape"){
      closeMarkerModal();
    }
  });

  function getEditing(){
    if(!editingId) return null;
    const C = currentCatState();
    return C.markers.find(x=>x.id===editingId) || null;
  }

  function updateColorChip(){
    const m = getEditing();
    if(!m) return;
    const chip = $("mfColorChip");
    const col = $("mfUseCatColor").checked ? (getCat($("mfCat").value)?.color || "#7cc4ff") : ($("mfColor").value || markerColor(m));
    chip.style.setProperty("--c", col);
  }
  $("mfColor").addEventListener("input", updateColorChip);
  $("mfUseCatColor").addEventListener("change", updateColorChip);
  $("mfCat").addEventListener("change", updateColorChip);

  $("mfYtTitle").addEventListener("input", ()=>{ ytTouched = true; syncSelectedPanelLive(); });
  $("mfMemo").addEventListener("input", ()=>{ memoTouched = true; syncSelectedPanelLive(); });

  $("mfName").addEventListener("input", ()=>{
    const v = $("mfName").value;
    if(!ytTouched) $("mfYtTitle").value = v;
    if(!memoTouched) $("mfMemo").value = v;
    syncSelectedPanelLive();
  });

  function syncSelectedPanelLive(){
    if(!editingId) return;
    if(selectedMarker && selectedMarker.id === editingId){
      $("selName").textContent = $("mfName").value || "(ì´ë¦„ ì—†ìŒ)";
      $("selYtTitle").value = $("mfYtTitle").value || "";
      $("selLink").value = $("mfYt").value || "";
    }
  }

  $("mfR").addEventListener("input", ()=>{
    $("mfRVal").textContent = $("mfR").value;
    const r = Number($("mfR").value);
    const fs = clamp(Math.round(r * 1.5), 8, 40);
    $("mfFs").value = fs;
    $("mfFsVal").textContent = fs;
  });
  $("mfFs").addEventListener("input", ()=>{ $("mfFsVal").textContent = $("mfFs").value; });

  $("mfLabelDefault").addEventListener("click", ()=>{ $("mfLabelColor").value = "#e7eef8"; });

  function saveMarkerModal(){
    requireAuth(); if(!isAuthed()) return;
    const C = currentCatState();
    const m = getEditing();
    if(!m) return;

    m.name = ($("mfName").value || "").trim();
    m.cat = $("mfCat").value || "ê¸°í…”";
    ensureCat(m.cat, "#ffffff");

    m.useCatColor = $("mfUseCatColor").checked;
    m.colorOverride = ($("mfColor").value || "").trim();

    m.yt = ($("mfYt").value || "").trim();
    m.ytTitle = ($("mfYtTitle").value || "").trim();
    m.memo = ($("mfMemo").value || "").trim();

    m.r = Number($("mfR").value);
    m.fs = Number($("mfFs").value);
    m.fw = Number($("mfFw").value);
    m.labelColor = ($("mfLabelColor").value || "#e7eef8").trim();

    // chain rule: if this is 1ë²ˆ, sync to all in chain
    propagateChainFromOne(m);

    saveLocal();
    selectMarker(m.id);
    renderCats();
    renderKpi();
    draw();
    toast("ì €ì¥ ì™„ë£Œ");
  }

  function deleteMarkerModal(){
    requireAuth(); if(!isAuthed()) return;
    const C = currentCatState();
    const m = getEditing();
    if(!m) return;
    if(!confirm("ì´ ë§ˆì»¤ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;

    const cid = m.chainId;
    const cidx = m.chainIndex;
    C.markers = C.markers.filter(x=>x.id!==m.id);

    if(cid && cidx){
      for(const mm of C.markers){
        if(mm.chainId===cid && (mm.chainIndex||0) > cidx){
          mm.chainIndex = (mm.chainIndex||0) - 1;
        }
      }
    }

    // curves cleanup
    const valid = new Set(C.markers.map(mm=>mm.id));
    const newCurves = {};
    for(const k of Object.keys(C.curves||{})){
      const [a,b] = k.split("|");
      if(valid.has(a) && valid.has(b)) newCurves[k]=C.curves[k];
    }
    C.curves = newCurves;

    saveLocal();
    closeMarkerModal();
    selectedMarker = null;
    syncSelectedPanel();
    renderKpi();
    draw();
    toast("ì‚­ì œ ì™„ë£Œ");
  }

  $("btnNewChain").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    const m = getEditing();
    if(!m) return;
    m.chainId = "c_"+uid();
    m.chainIndex = 1;
    insertAfterMarkerId = null;
    propagateChainFromOne(m);
    saveLocal();
    draw();
    toast("ìƒˆ ì²´ì¸ ì‹œì‘");
  });

  $("btnInsertAfter").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    const m = getEditing();
    if(!m) return;
    insertAfterMarkerId = m.id;
    toast("ì¤‘ê°„ ì‚½ì… ëª¨ë“œ í™œì„±í™”");
  });

  cv.addEventListener("dblclick", (e)=>{
    requireAuth(); if(!isAuthed()) return;
    const rect = cv.getBoundingClientRect();
    const sx = e.clientX - rect.left;
    const sy = e.clientY - rect.top;
    const hit = pickCircleAt(sx, sy);
    if(hit){
      selectMarker(hit.id);
      openMarkerModal(hit.id);
    }
  });

  // ---------- category modal ----------
  let catSelectedRowId = null;

  $("btnEditCats").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    openCatsModal();
  });
  $("btnCloseCats").addEventListener("click", ()=>mCats.classList.remove("show"));

  function openCatsModal(){
    catSelectedRowId = null;
    renderCatRows();
    renderCatQuickPalette();
    mCats.classList.add("show");
  }

  function renderCatQuickPalette(){
    const wrap = $("catQuickPalette");
    wrap.innerHTML = "";
    for(const q of QUICK){
      const w = document.createElement("div");
      w.className = "swWrap";
      w.innerHTML = `<div class="sw" style="--c:${q.c}"></div><div class="swLabel">${q.name}</div>`;
      w.querySelector(".sw").addEventListener("click", ()=>{
        if(!catSelectedRowId){ toast("ì¹´í…Œê³ ë¦¬ í–‰ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”"); return; }
        const C = currentCatState();
        const c = C.categories.find(x=>x.id===catSelectedRowId);
        if(!c) return;
        c.color = q.c;
        renderCatRows();
      });
      wrap.appendChild(w);
    }
  }

  function renderCatRows(){
    const C = currentCatState();
    const rows = $("catRows");
    rows.innerHTML = "";

    const list = C.categories.filter(c=>c.id!=="ì „ì²´");
    for(const c of list){
      const row = document.createElement("div");
      row.style.display = "grid";
      row.style.gridTemplateColumns = "1fr 70px 90px";
      row.style.gap = "10px";
      row.style.alignItems = "center";
      row.style.marginBottom = "10px";

      row.innerHTML = `
        <input class="field" value="${c.name}" />
        <div class="colorChip" style="--c:${c.color};"></div>
        <button class="pill danger" type="button">ì‚­ì œ</button>
      `;

      const inp = row.querySelector("input");
      const chip = row.querySelector(".colorChip");
      const del = row.querySelector("button");

      row.addEventListener("click", ()=>{
        catSelectedRowId = c.id;
        toast("ì¹´í…Œê³ ë¦¬ ì„ íƒ");
      });

      inp.addEventListener("input", ()=>{
        c.name = inp.value;
      });

      chip.addEventListener("click", ()=>{
        catSelectedRowId = c.id;
        const next = prompt("ìƒ‰ìƒ ì½”ë“œ ì…ë ¥ (#rrggbb)", c.color);
        if(next===null) return;
        c.color = (next||"").trim() || c.color;
        renderCatRows();
      });

      del.addEventListener("click", (e)=>{
        e.stopPropagation();
        if(!confirm(`"${c.name}" ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí• ê¹Œìš”?`)) return;
        const fallback = C.categories.find(x=>x.id==="ê¸°í…”") || C.categories[0];
        for(const m of C.markers){
          if(m.cat === c.id) m.cat = fallback.id;
        }
        C.categories = C.categories.filter(x=>x.id!==c.id);
        renderCatRows();
        renderCats();
        saveLocal();
        draw();
      });

      rows.appendChild(row);
    }
  }

  $("btnAddCat").addEventListener("click", ()=>{
    const C = currentCatState();
    const name = prompt("ì¹´í…Œê³ ë¦¬ ì´ë¦„");
    if(!name) return;
    const id = name.trim();
    if(!id) return;
    if(C.categories.some(c=>c.id===id)){ toast("ì´ë¯¸ ì¡´ì¬"); return; }
    C.categories.push({ id, name:id, color:"#ffffff", on:true });
    renderCatRows();
  });

  $("btnCatsDefault").addEventListener("click", ()=>{
    const C = currentCatState();
    if(!confirm("ê¸°ë³¸ ì¹´í…Œê³ ë¦¬ë¡œ ë˜ëŒë¦´ê¹Œìš”?")) return;
    C.categories = structuredClone(defaultCats);
    renderCatRows();
  });

  $("btnSaveCats").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    const C = currentCatState();

    const cleaned = [];
    const seen = new Set(["ì „ì²´"]);
    for(const c of C.categories){
      const name = (c.name||c.id||"").trim();
      if(!name) continue;
      const finalId = name;
      if(seen.has(finalId)) continue;
      seen.add(finalId);
      cleaned.push({ id:finalId, name, color:(c.color||"#ffffff"), on:!!c.on });
    }
    const all = { id:"ì „ì²´", name:"ì „ì²´", color:"#7cc4ff", on:true };
    C.categories = [all, ...cleaned];

    const valid = new Set(C.categories.map(x=>x.id));
    const fb = valid.has("ê¸°í…”") ? "ê¸°í…”" : (C.categories[1]?.id || "ì „ì²´");
    for(const m of C.markers){
      if(!valid.has(m.cat)) m.cat = fb;
    }

    saveLocal();
    renderCats();
    renderKpi();
    draw();
    mCats.classList.remove("show");
    toast("ì¹´í…Œê³ ë¦¬ ì €ì¥");
  });

  // ---------- marker edit: text quick colors ----------
  function renderTextColors(){
    textColors.innerHTML = "";
    const colors = [
      "#ff3b30","#ff9500","#ffd60a","#34c759","#0a84ff","#ffffff","#0b0b0f"
    ];
    for(const c of colors){
      const d = document.createElement("div");
      d.className = "tSw";
      d.style.setProperty("--c", c);
      d.addEventListener("click", ()=>{
        $("mfLabelColor").value = c;
      });
      textColors.appendChild(d);
    }
  }

  // ---------- helpers ----------
  function renderAll(){
    ensureCatSlotIntegrity();
    renderLogo();
    renderTopCats();
    renderPages();
    renderCats();
    renderPalette();
    renderTextColors();

    const C = currentCatState();
    setToggle(tgShowLinesWithCatFilter, !!C.showLinesWithCatFilter);

    syncSelectedPanel();
    renderKpi();
    resizeCanvas();
    if(!C.map.scale || C.map.scale<=0) fitToScreen();
    draw();
  }

  // ---------- init ----------
  async function init(){
    requireAuth();
    const st = await loadStateRemoteFirst();
    mergeState(st);

    ensureCatSlotIntegrity();
    renderAll();
    loadMap();

    const C = currentCatState();
    if(!C.map.scale || C.map.scale<=0){
      setTimeout(()=>{
        fitToScreen();
        saveLocal();
        draw();
      }, 0);
    }else{
      draw();
    }
  }

  init();

})();
</script>
</body>
</html>
