<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MAPMODE Â· ADMIN99</title>

  <style>
    :root{
      color-scheme: dark;

      --bg:#070b12;
      --panel:#0b1220cc;
      --card:#0e1626cc;

      --stroke:#1f2a3a;
      --stroke2:#27344a;

      --text:#e7eef8;
      --muted:#9fb0c6;

      --accent:#7cc4ff;
      --danger:#ff5d5d;
      --ok:#39d98a;
      --warn:#ffd60a;

      --r14:14px;
      --r16:16px;
      --r18:18px;

      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --shadow2: 0 8px 24px rgba(0,0,0,.35);
      --blur: 14px;

      --topH:58px;
      --sideW:320px;
      --sideW2:360px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      overflow:hidden;
      background:
        radial-gradient(1200px 700px at 50% -10%, rgba(124,196,255,.18), transparent 55%),
        radial-gradient(900px 650px at 88% 10%, rgba(57,217,138,.12), transparent 55%),
        radial-gradient(900px 650px at 12% 10%, rgba(255,214,10,.08), transparent 55%),
        linear-gradient(180deg, #0a0f18 0%, var(--bg) 100%);
      color:var(--text);

      /* UI ê¸€ì”¨ êµµê³  ë˜ë ·(ë§ˆì»¤ ê´€ë ¨ì€ ë³„ë„) */
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", Arial, sans-serif;
      font-weight: 800;
      letter-spacing: .1px;
    }

    /* ========== TOPBAR ========== */
    .topbar{
      position:fixed; inset:0 0 auto 0;
      height:var(--topH);
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 14px;
      z-index:90;
      background: linear-gradient(180deg, rgba(9,14,23,.88), rgba(9,14,23,.58));
      backdrop-filter: blur(var(--blur));
      border-bottom:1px solid rgba(39,52,74,.65);
      gap:12px;
    }
    .top-left, .top-right{
      display:flex; align-items:center; gap:10px; min-width:0; flex-wrap:wrap;
    }

    .slot{
      height:38px;
      display:flex; align-items:center;
      padding:0 10px;
      border-radius:999px;
      background: rgba(14,22,38,.55);
      border:1px solid rgba(39,52,74,.65);
      box-shadow: var(--shadow2);
      gap:8px;
      white-space:nowrap;
    }
    .slot.fixed{ width:170px; justify-content:center; }
    .slot.logo{
      justify-content:flex-start;
      border:none;
      background: transparent;
      box-shadow:none;
      padding:0;
      width:170px;
    }
    .logoBox{
      width:170px; height:38px;
      border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      background: transparent;
      border:none;
      cursor:pointer;
      user-select:none;
    }
    .logoBox img{ height:26px; width:auto; display:block; opacity:.98; }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.5px; }
    .brand .word{ font-size:20px; line-height:1; display:flex; align-items:center; }
    .brand .word .o{
      display:inline-block;
      width:12px; height:12px; border-radius:999px;
      margin:0 2px;
      background:#fff;
      box-shadow: 0 0 0 2px rgba(255,255,255,.12);
      transform: translateY(1px);
    }

    .catTabs{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .catPill{
      height:38px;
      display:flex; align-items:center; gap:8px;
      padding:0 10px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(14,22,38,.55);
      box-shadow: var(--shadow2);
      cursor:pointer;
      user-select:none;
      max-width: 210px;
    }
    .catPill.active{
      border-color: rgba(57,217,138,.65);
      box-shadow: 0 0 0 2px rgba(57,217,138,.15), var(--shadow2);
    }
    .catPill .name{
      font-weight:900;
      max-width: 140px;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space:nowrap;
    }
    .catPill .mini{
      height:28px;
      min-width:28px;
      padding:0 10px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color: rgba(231,238,248,.92);
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      display:inline-flex; align-items:center; justify-content:center;
    }
    .catPill .mini:active{ transform: translateY(1px); }
    .catPill .mini.danger{ border-color: rgba(255,93,93,.55); }
    .catPill .mini.ok{ border-color: rgba(57,217,138,.55); }

    .select{
      appearance:none;
      border:none;
      background:transparent;
      color:var(--text);
      font-weight:900;
      padding-right:18px;
      outline:none;
      cursor:pointer;
      max-width: 160px;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .chev{
      width:0; height:0;
      border-left:5px solid transparent;
      border-right:5px solid transparent;
      border-top:6px solid rgba(231,238,248,.7);
      margin-left:-8px;
      pointer-events:none;
    }

    .pill{
      height:34px;
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px;
      padding:0 12px;
      border-radius:999px;
      background: rgba(14,22,38,.55);
      border:1px solid rgba(39,52,74,.65);
      color:var(--text);
      box-shadow: var(--shadow2);
      cursor:pointer;
      user-select:none;
      text-decoration:none;
      font-weight:900;
    }
    .pill:hover{ border-color: rgba(124,196,255,.55); }
    .pill:active{ transform: translateY(1px); }
    .pill.small{ height:32px; padding:0 10px; font-size:13px; font-weight:900; }
    .pill.ghost{ background: rgba(14,22,38,.25); }
    .pill.danger{ border-color: rgba(255,93,93,.55); }
    .pill.ok{ border-color: rgba(57,217,138,.55); }

    /* ========== LAYOUT ========== */
    .layout{
      position:fixed;
      inset:var(--topH) 0 0 0;
      display:grid;
      grid-template-columns: var(--sideW) 1fr var(--sideW2);
      height:calc(100% - var(--topH));
      min-height: 0;
    }
    .side{
      overflow:hidden;
      border-right:1px solid rgba(39,52,74,.55);
      background: rgba(8,12,20,.35);
      backdrop-filter: blur(var(--blur));
      min-height:0;
    }
    .side.right{ border-right:none; border-left:1px solid rgba(39,52,74,.55); }

    .sideInner{
      height:100%;
      padding:12px;
      overflow:auto;
    }

    .card{
      background: rgba(14,22,38,.50);
      border:1px solid rgba(39,52,74,.6);
      border-radius: var(--r16);
      padding:12px;
      box-shadow: var(--shadow2);
    }
    .card + .card{ margin-top:12px; }

    .sectionTitle{
      font-size:12px;
      color: rgba(231,238,248,.9);
      margin:4px 0 10px 0;
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
    }
    .sectionTitle b{ font-weight:900; }
    .subtle{
      color: rgba(159,176,198,.92);
      font-size:12px;
      line-height:1.45;
      font-weight:800;
    }

    /* ========== LEFT: Pages ========== */
    .btnAddPage{
      width:100%;
      height:52px;
      border-radius:18px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(14,22,38,.35);
      color: rgba(231,238,248,.95);
      font-weight:900;
      cursor:pointer;
      box-shadow: var(--shadow2);
    }
    .btnAddPage:hover{ border-color: rgba(124,196,255,.55); }

    .pageList{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .pageItem{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 10px;
      border-radius: var(--r16);
      border:1px solid rgba(39,52,74,.6);
      background: rgba(14,22,38,.35);
      cursor:pointer;
    }
    .pageItem.active{
      outline:2px solid rgba(57,217,138,.35);
      border-color: rgba(57,217,138,.55);
      background: rgba(14,22,38,.55);
    }
    .pageName{ font-weight:900; font-size:16px; }
    .pageActions{ display:flex; align-items:center; gap:8px; flex:0 0 auto; }
    .miniBtn{
      height:34px;
      padding:0 12px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color: rgba(231,238,248,.92);
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      display:flex; align-items:center; justify-content:center;
    }
    .miniBtn.icon{
      width:34px;
      padding:0;
    }
    .miniBtn.url{ border-color: rgba(57,217,138,.55); }
    .miniBtn.edit{ border-color: rgba(124,196,255,.55); }
    .miniBtn.del{ border-color: rgba(255,93,93,.55); }

    /* ========== CENTER: Canvas ========== */
    .center{
      position:relative;
      overflow:hidden;
      background:
        radial-gradient(900px 700px at 50% 15%, rgba(124,196,255,.08), transparent 60%),
        radial-gradient(900px 700px at 50% 80%, rgba(57,217,138,.05), transparent 60%);
      min-height:0;
    }
    .canvasWrap{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:16px;
    }
    canvas{ background: transparent; touch-action:none; }

    .hintToast{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      top:14px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.6);
      background: rgba(14,22,38,.55);
      color: rgba(231,238,248,.9);
      box-shadow: var(--shadow2);
      font-size:12px;
      display:none;
      z-index:40;
    }
    .hintToast.show{ display:block; }

    /* ========== RIGHT: Tools ========== */
    .chipRow{ display:flex; gap:10px; flex-wrap:wrap; }
    .chip{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.6);
      background: rgba(10,15,24,.35);
      cursor:pointer;
      font-size:13px;
      user-select:none;
      font-weight:900;
    }
    .chip.on{ border-color: rgba(124,196,255,.6); background: rgba(124,196,255,.10); }
    .dotc{ width:10px; height:10px; border-radius:999px; box-shadow:0 0 0 2px rgba(255,255,255,.06); }

    .toggleRow{ display:flex; gap:10px; flex-direction:column; margin-top:10px; }
    .toggle{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.6);
      background: rgba(10,15,24,.35);
      cursor:pointer;
      font-size:13px;
      user-select:none;
      font-weight:900;
    }
    .toggle .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(231,238,248,.25);
      border:1px solid rgba(231,238,248,.25);
    }
    .toggle.on{ border-color: rgba(57,217,138,.55); }
    .toggle.on .dot{ background: rgba(57,217,138,.9); border-color: rgba(57,217,138,.9); }

    .hr{ height:1px; background: rgba(39,52,74,.55); margin:12px 0; }

    .btnFull{
      width:100%;
      height:52px;
      border-radius:18px;
      font-weight:900;
      font-size:15px;
      justify-content:center;
    }

    .palette{
      display:flex; gap:12px; align-items:flex-start;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .sw{
      width:42px; height:42px;
      border-radius:14px;
      border:1px solid rgba(39,52,74,.65);
      box-shadow: var(--shadow2);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      position:relative;
      overflow:hidden;
      background: rgba(10,15,24,.35);
    }
    .sw::after{
      content:"";
      position:absolute; inset:6px;
      border-radius:10px;
      background: var(--c);
    }
    .swLabel{
      margin-top:6px;
      font-size:12px;
      text-align:center;
      color: rgba(231,238,248,.85);
      font-weight:900;
    }
    .swWrap{ display:flex; flex-direction:column; align-items:center; }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }

    .field{
      width:100%;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color: rgba(231,238,248,.95);
      outline:none;
      font-weight:900;
      font-size:14px;
    }
    textarea.field{ min-height:90px; resize:vertical; }

    .selectedBox .label{
      font-size:14px; font-weight:900; margin-bottom:8px;
    }
    .selectedBox .sub{
      font-size:12px; color: rgba(159,176,198,.92); font-weight:900;
      margin-top:10px;
    }

    /* ========== MODAL ========== */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:stretch;
      justify-content:stretch;
      z-index:200;
    }
    .modalBack.show{ display:flex; }
    .modal{
      margin:auto;
      width:min(1050px, calc(100vw - 28px));
      height:min(860px, calc(100vh - 28px));
      background: linear-gradient(180deg, rgba(14,22,38,.96), rgba(10,15,24,.92));
      border:1px solid rgba(39,52,74,.75);
      border-radius:22px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex; flex-direction:column;
    }
    .modalHead{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(39,52,74,.55);
    }
    .modalHead .title{ font-size:18px; font-weight:900; }
    .modalBody{
      padding:16px;
      overflow:auto;
      flex:1 1 auto;
    }
    .modalClose{
      height:40px;
      padding:0 14px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color: rgba(231,238,248,.92);
      cursor:pointer;
      font-weight:900;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    .labelRow{ color: rgba(159,176,198,.92); font-size:13px; font-weight:900; margin:10px 0 8px; }
    .checkRow{ display:flex; align-items:center; gap:10px; justify-content:flex-end; }
    .checkRow input{ width:18px; height:18px; accent-color:#a86bff; }
    .colorChip{
      width:46px; height:46px;
      border-radius:16px;
      border:1px solid rgba(39,52,74,.65);
      box-shadow: var(--shadow2);
      background: rgba(10,15,24,.35);
      position:relative;
      overflow:hidden;
    }
    .colorChip::after{ content:""; position:absolute; inset:7px; border-radius:12px; background: var(--c); }

    .styleGrid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      margin-top:14px;
    }
    .styleCard{
      border-radius:18px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      padding:14px;
      min-height:160px;
    }
    .styleCard h4{ margin:0 0 10px; font-size:18px; font-weight:900; }
    .rangeRow{ display:flex; align-items:center; gap:12px; }
    .rangeRow input[type="range"]{ width:100%; }
    .numBox{
      width:68px;
      text-align:center;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      padding:8px 10px;
      font-weight:900;
    }
    .fwSelect{ width:100%; }

    .quickTextColors{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .tSw{
      width:34px; height:34px;
      border-radius:12px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      box-shadow: var(--shadow2);
      cursor:pointer;
      position:relative;
      overflow:hidden;
    }
    .tSw::after{ content:""; position:absolute; inset:7px; border-radius:9px; background: var(--c); }

    .modalFoot{
      padding:14px 16px;
      border-top:1px solid rgba(39,52,74,.55);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .btnBig{
      height:46px;
      padding:0 16px;
      border-radius:999px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color: rgba(231,238,248,.95);
      font-weight:900;
      cursor:pointer;
    }
    .btnBig.danger{ border-color: rgba(255,93,93,.65); }
    .btnBig.ok{ border-color: rgba(57,217,138,.65); }

    /* marker font (ë§ˆì»¤ ê´€ë ¨) */
    .markerFont{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-weight: 900;
      letter-spacing: 0;
    }

    /* ========== LOGIN OVERLAY ========== */
    .lock{
      position:fixed; inset:0;
      background: rgba(0,0,0,.65);
      backdrop-filter: blur(8px);
      display:none;
      align-items:center; justify-content:center;
      z-index:300;
    }
    .lock.show{ display:flex; }
    .lockBox{
      width:min(420px, calc(100vw - 28px));
      background: linear-gradient(180deg, rgba(14,22,38,.96), rgba(10,15,24,.92));
      border:1px solid rgba(39,52,74,.75);
      border-radius:22px;
      box-shadow: var(--shadow);
      padding:18px;
    }
    .lockBox h3{ margin:0 0 10px; font-size:18px; font-weight:900; }
    .lockBox p{ margin:0 0 14px; color:rgba(159,176,198,.92); font-size:13px; font-weight:900; }
    .lockRow{ display:flex; gap:10px; }
    .lockRow input{
      flex:1;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(39,52,74,.65);
      background: rgba(10,15,24,.35);
      color: rgba(231,238,248,.95);
      outline:none;
      font-weight:900;
      font-size:14px;
    }

    /* responsive */
    @media (max-width: 1200px){
      body{ overflow:auto; }
      .layout{
        width: calc(var(--sideW) + 1000px + var(--sideW2));
        min-width: calc(var(--sideW) + 1000px + var(--sideW2));
      }
      .center{ min-width: 1000px; }
    }
    @media (max-width: 560px){
      .slot.fixed{ width:160px; }
      .slot.logo{ width:160px; }
      .logoBox{ width:160px; }
      .select{ max-width:140px; }
      .catPill{ max-width: 180px; }
      .catPill .name{ max-width: 110px; }
    }
  </style>
</head>

<body>

  <!-- LOGIN LOCK -->
  <div class="lock" id="lock">
    <div class="lockBox">
      <h3>ê´€ë¦¬ì ì¸ì¦</h3>
      <p>ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ë©´ <b>24ì‹œê°„</b> ì¸ì¦ì´ ìœ ì§€ë©ë‹ˆë‹¤.</p>
      <div class="lockRow">
        <input id="pw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" />
        <button class="pill ok" id="btnLogin">ë¡œê·¸ì¸</button>
      </div>
      <div class="subtle" id="lockMsg" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="top-left">
      <!-- Logo -->
      <div class="slot logo">
        <div class="logoBox" id="logoBox" title="ë¡œê³  í´ë¦­ â†’ URL ì…ë ¥">
          <div class="brand"><div class="word">MAPM<span class="o"></span>DE</div></div>
        </div>
      </div>

      <!-- 4 Category Slots (í™œì„±í™”ëœ ê²ƒë§Œ ë Œë”) -->
      <div class="catTabs" id="catTabs"></div>

      <!-- Buttons (ì¹´í…Œê³ ë¦¬ 4ê°œ ì˜ì—­ ì´í›„ë¶€í„° ë…¸ì¶œ) -->
      <div class="slot fixed" style="justify-content:center; gap:8px;">
        <div style="font-weight:900; color:rgba(57,217,138,.95);">ADMIN</div>
      </div>

      <div class="slot fixed" style="justify-content:center; gap:8px;">
        <label class="pill small ghost" style="cursor:pointer;">
          ì§€ë„ ì—…ë¡œë“œ
          <input id="fileMap" type="file" accept="image/*" style="display:none;" />
        </label>
        <button class="pill small ghost" id="btnExport">state ë‚´ë³´ë‚´ê¸°</button>
        <button class="pill small danger" id="btnResetAll">ì „ì²´ ì´ˆê¸°í™”</button>
      </div>
    </div>

    <div class="top-right">
      <span class="pill small ghost" title="í˜„ì¬ ê²½ë¡œ">
        <span id="pathCatTop">ì¹´í…Œê³ ë¦¬1</span>
        <span style="opacity:.7;">/</span>
        <span id="pathGameTop">ì•„ì´ì˜¨2</span>
      </span>
    </div>
  </div>

  <div class="layout">
    <!-- LEFT -->
    <aside class="side left">
      <div class="sideInner">
        <div class="card">
          <div class="sectionTitle">
            <span>í˜ì´ì§€</span>
            <span class="subtle"><b id="pathCat">ì¹´í…Œê³ ë¦¬1</b> / <b id="pathGame">ì•„ì´ì˜¨2</b> / <b id="pathPage">ì „ì²´ì§€ë„</b></span>
          </div>

          <button class="btnAddPage" id="btnAddPage">+ í˜ì´ì§€ ì¶”ê°€</button>

          <div class="subtle" style="margin-top:10px;">
            â€¢ í˜ì´ì§€ ë²„íŠ¼ í´ë¦­ â†’ ê°™ì€ ì¹´í…Œê³ ë¦¬/ê²Œì„ ì•ˆì—ì„œ ì§€ë„ í˜ì´ì§€ ì´ë™<br/>
            â€¢ URL ë²„íŠ¼ìœ¼ë¡œ ì§€ë„ ì´ë¯¸ì§€ URL ì„¤ì •
          </div>

          <div class="pageList" id="pageList"></div>
        </div>
      </div>
    </aside>

    <!-- CENTER -->
    <main class="center">
      <div class="hintToast" id="toast"></div>
      <div class="canvasWrap">
        <canvas id="cv" width="1200" height="900"></canvas>
      </div>
    </main>

    <!-- RIGHT -->
    <aside class="side right">
      <div class="sideInner">

        <!-- ì¹´í…Œê³ ë¦¬(í•„í„°) -->
        <div class="card">
          <div class="sectionTitle">
            <span>ì¹´í…Œê³ ë¦¬</span>
            <span class="subtle">í•„í„°</span>
          </div>

          <div class="chipRow" id="catChips"></div>

          <div class="toggleRow">
            <div class="toggle" id="tgShowChainSameCat">
              <div class="dot"></div>
              <div>ê°™ì€ ì¹´í…Œê³ ë¦¬ í•„í„° ì‹œ ì„ ë„ ê°™ì´ í‘œì‹œ/ìˆ¨ê¹€</div>
            </div>

            <div class="subtle" id="kpi" style="margin-top:2px;">í‘œì‹œ ì¤‘ ë§ˆì»¤: 0 / í˜ì´ì§€ ì „ì²´: 0</div>

            <button class="pill btnFull ghost" id="btnEditCats">ì¹´í…Œê³ ë¦¬/ìƒ‰ìƒ í¸ì§‘</button>
          </div>
        </div>

        <!-- ê´€ë¦¬ì íˆ´ -->
        <div class="card">
          <div class="sectionTitle">
            <span>ê´€ë¦¬ì íˆ´</span>
            <span class="subtle">â€¢ ì¹´í…Œê³ ë¦¬ ìŠ¤íƒ€ì¼ì€ 1ë²ˆ(ì²´ì¸Index=1) ë³€ê²½ ì‹œ ì „íŒŒ</span>
          </div>

          <div class="subtle" style="margin-top:8px;">ë¹ ë¥¸ ìƒ‰ìƒ (ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ë³€ê²½)</div>
          <div class="palette" id="palette"></div>

          <div class="row2">
            <button class="pill btnFull ghost" id="btnApplyQuickCat" disabled>ì„ íƒ ë§ˆì»¤ ì¹´í…Œê³ ë¦¬ì— ì ìš©</button>
            <button class="pill btnFull ghost" id="btnOpenMarkerEdit" disabled>ë§ˆì»¤ í¸ì§‘ ì—´ê¸°</button>
          </div>

          <div class="hr"></div>

          <div class="row2">
            <button class="pill btnFull danger" id="btnClearCurves">í˜„ì¬ í˜ì´ì§€ ê³¡ì„  ì´ˆê¸°í™”</button>
            <button class="pill btnFull ghost" id="btnRechain">ì„  ë‹¤ì‹œ ì²´ì¸(ì „ì²´)</button>
          </div>

          <div class="hr"></div>

          <button class="pill btnFull danger" id="btnResetMarkers" style="border-color:rgba(255,93,93,.65);">ë§ˆì»¤ ì´ˆê¸°í™”</button>

          <div class="hr"></div>

          <div class="selectedBox" style="margin-top:6px;">
            <div class="label">ì„ íƒí•œ ë§ˆì»¤: <span id="selName">(ì´ë¦„ ì—†ìŒ)</span></div>
            <div class="sub">ìœ íŠœë¸Œ ë§í¬</div>
            <input class="field" id="selLink" placeholder="ìœ íŠœë¸Œ" />
            <div class="sub">ìœ íŠœë¸Œ í‘œì‹œëª…</div>
            <input class="field" id="selYtTitle" placeholder="ìœ íŠœë¸Œ í‘œì‹œëª…" />
          </div>

          <div class="subtle" style="margin-top:10px;">
            â€¢ ë§ˆì»¤ ë“œë˜ê·¸: í´ë¦­ ìœ ì§€ í›„ ì´ë™<br/>
            â€¢ ê³¡ì„  í¸ì§‘: ì„ ì„ ë“œë˜ê·¸í•˜ë©´ ê³¡ì„ (Quadratic)ìœ¼ë¡œ ì €ì¥, í™”ì‚´í‘œëŠ” ì¤‘ì•™ ìœ ì§€
          </div>
        </div>

      </div>
    </aside>
  </div>

  <!-- MARKER EDIT MODAL -->
  <div class="modalBack" id="mMarker">
    <div class="modal">
      <div class="modalHead">
        <div>
          <div class="title">ë§ˆì»¤ í¸ì§‘</div>
          <div class="subtle" style="margin-top:6px;">ê´€ë¦¬ì ëª¨ë“œì—ì„œë§Œ í¸ì§‘/ì‚­ì œ ê°€ëŠ¥í•©ë‹ˆë‹¤. (Enter = ì €ì¥)</div>
        </div>
        <button class="modalClose" id="btnCloseMarker">ë‹«ê¸°</button>
      </div>

      <div class="modalBody">
        <div class="grid2">
          <div>
            <div class="labelRow">ì´ë¦„(ë§ˆì»¤ ì´ë¦„)</div>
            <input class="field" id="mfName" placeholder="ì˜ˆ: ê¸°í…” ìœ„ì¹˜" />
          </div>
          <div>
            <div class="labelRow">ì¹´í…Œê³ ë¦¬</div>
            <select class="field" id="mfCat"></select>
          </div>
        </div>

        <div class="labelRow" style="margin-top:12px;">ìœ íŠœë¸Œ ë§í¬(URL)</div>
        <input class="field" id="mfYt" placeholder="https://www.youtube.com/..." />

        <div class="labelRow" style="margin-top:12px;">ìœ íŠœë¸Œ í‘œì‹œëª…(ìœ ì €ëª¨ë“œ ì œëª©)</div>
        <input class="field" id="mfYtTitle" placeholder="ì˜ˆ: ê¸°í…” 1ë²ˆìœ„ì¹˜" />

        <div class="labelRow" style="margin-top:12px;">ë©”ëª¨ (ê´€ë¦¬ì ë“±ë¡)</div>
        <textarea class="field" id="mfMemo" placeholder="ê´€ë¦¬ì ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ìœ ì € ëª¨ë“œì—ì„œëŠ” ì½ê¸° ì „ìš©ì…ë‹ˆë‹¤."></textarea>

        <div class="hr"></div>

        <div class="labelRow">ì¹´í…Œê³ ë¦¬ ìŠ¤íƒ€ì¼(ë™ì¼ ì¹´í…Œê³ ë¦¬ ì „ë¶€ ë™ì¼)</div>
        <div class="styleGrid">
          <div class="styleCard">
            <h4>ì› í¬ê¸° <span class="subtle" style="float:right;">px</span></h4>
            <div class="rangeRow">
              <input type="range" id="mfR" min="5" max="40" step="1" />
              <div class="numBox" id="mfRVal">10</div>
            </div>
            <div class="subtle" style="margin-top:10px;">* ìµœì†Œ í¬ê¸°: ê¸°ë³¸ì˜ 50%</div>
          </div>

          <div class="styleCard">
            <h4>ë¼ë²¨ í¬ê¸° <span class="subtle" style="float:right;">px</span></h4>
            <div class="rangeRow">
              <input type="range" id="mfLabelFs" min="8" max="46" step="1" />
              <div class="numBox" id="mfLabelFsVal">15</div>
            </div>
            <div class="subtle" style="margin-top:10px;">* ë¼ë²¨ë„ í™•ëŒ€/ì¶•ì†Œì— ê°™ì´ ë°˜ì‘</div>
          </div>

          <div class="styleCard">
            <h4>êµµê¸°/ìƒ‰ìƒ <span class="subtle" style="float:right;">ë¼ë²¨</span></h4>
            <select class="field fwSelect" id="mfFw">
              <option value="900">900 (Black)</option>
              <option value="800">800 (ExtraBold)</option>
              <option value="700">700 (Bold)</option>
              <option value="600">600 (SemiBold)</option>
            </select>

            <div class="labelRow" style="margin-top:10px;">ë¼ë²¨ ìƒ‰ìƒ</div>
            <div style="display:flex; gap:10px; align-items:center;">
              <input class="field" style="flex:1;" id="mfLabelColor" placeholder="#e7eef8" />
              <button class="btnBig" id="mfLabelDefault" type="button">ê¸°ë³¸ê°’</button>
            </div>

            <div class="labelRow" style="margin-top:10px;">ë¹ ë¥¸ ë¼ë²¨ìƒ‰</div>
            <div class="quickTextColors" id="textColors"></div>
          </div>
        </div>

        <div class="subtle" id="mfPos" style="margin-top:12px;">ì¢Œí‘œ(ë¹„ìœ¨): -</div>
        <div class="subtle" style="margin-top:8px;">
          â€¢ ìƒˆë¡œìš´ ë²ˆí˜¸ë¡œ ì‹œì‘: ì´ ë§ˆì»¤ë¶€í„° ìƒˆ ì²´ì¸(ìƒˆ 1ë²ˆ) ì‹œì‘<br/>
          â€¢ í•´ë‹¹ ë§ˆì»¤ë¥¼ ì´ì–´ì„œ ì‹œì‘: ì´ ë§ˆì»¤ ë’¤ë¡œ "ì¤‘ê°„ ì‚½ì…" ëª¨ë“œ í™œì„±í™”
        </div>
      </div>

      <div class="modalFoot">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btnBig" id="btnNewChain">ìƒˆë¡œìš´ ë²ˆí˜¸ë¡œ ì‹œì‘</button>
          <button class="btnBig" id="btnInsertAfter">í•´ë‹¹ ë§ˆì»¤ë¥¼ ì´ì–´ì„œ ì‹œì‘</button>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-left:auto;">
          <button class="btnBig danger" id="btnDeleteMarker">ì‚­ì œ</button>
          <button class="btnBig ok" id="btnSaveMarker">ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CATEGORY EDIT MODAL -->
  <div class="modalBack" id="mCats">
    <div class="modal">
      <div class="modalHead">
        <div class="title">ì¹´í…Œê³ ë¦¬/ìƒ‰ìƒ í¸ì§‘</div>
        <button class="modalClose" id="btnCloseCats">ë‹«ê¸°</button>
      </div>

      <div class="modalBody">
        <div class="subtle">ì €ì¥í•˜ë©´ í˜„ì¬ ì¹´í…Œê³ ë¦¬/ê²Œì„ì˜ ì¹´í…Œê³ ë¦¬ ëª©ë¡ì´ êµì²´ë©ë‹ˆë‹¤.</div>

        <div class="labelRow" style="margin-top:14px;">ë¹ ë¥¸ ìƒ‰ìƒ (ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ í–‰ì— ì ìš©)</div>
        <div class="palette" id="catQuickPalette" style="margin-top:10px;"></div>
        <div class="subtle" style="margin-top:8px;">ì¹´í…Œê³ ë¦¬ í–‰ì„ ë¨¼ì € í´ë¦­í•´ì„œ ì„ íƒí•˜ì„¸ìš”.</div>

        <div class="hr"></div>

        <div class="row2">
          <button class="pill btnFull ghost" id="btnAddCat">+ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</button>
          <button class="pill btnFull ghost" id="btnCatsDefault">ê¸°ë³¸ê°’ìœ¼ë¡œ</button>
        </div>

        <div class="hr"></div>

        <div id="catRows"></div>
      </div>

      <div class="modalFoot" style="justify-content:flex-end;">
        <button class="btnBig ok" id="btnSaveCats">ì €ì¥</button>
      </div>
    </div>
  </div>

<script>
(() => {
  /************************************************************
   * ADMIN99 ì €ì¥ ê·œì¹™
   ************************************************************/
  const LS_AUTH_KEY = "mapmode_admin_auth_v99";
  const LS_KEY = "mapmode_state_v99";
  const REMOTE_STATE_URL = new URL("./data/state.json", location.href).toString();
  const PASSWORD = "0000000001";
  const AUTH_MS = 24 * 60 * 60 * 1000;

  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  const safeParse = (json, fallback) => { try{ return JSON.parse(json); }catch(e){ return fallback; } };
  const uid = () => Math.random().toString(36).slice(2,10);
  const deepClone = (x)=>JSON.parse(JSON.stringify(x));

  const defaultFilterCats = [
    { id:"ì „ì²´", name:"ì „ì²´", color:"#7cc4ff", on:true, style:{ r:10, labelFs:15, fw:900, labelColor:"#e7eef8" } },
    { id:"ë³´ìŠ¤", name:"ë³´ìŠ¤", color:"#ff5d5d", on:true, style:{ r:10, labelFs:15, fw:900, labelColor:"#e7eef8" } },
    { id:"ê¸°í…”", name:"ê¸°í…”", color:"#ffd60a", on:true, style:{ r:10, labelFs:15, fw:900, labelColor:"#e7eef8" } },
    { id:"íë¸Œ", name:"íë¸Œ", color:"#2b8cff", on:true, style:{ r:10, labelFs:15, fw:900, labelColor:"#e7eef8" } },
  ];

  const defaultPages = [
    { id:"p_all", name:"ì „ì²´ì§€ë„", url:"" },
    { id:"p_2", name:"2ë²ˆë§ˆì„", url:"" },
    { id:"p_3", name:"3ë²ˆë§ˆì„", url:"" },
    { id:"p_4", name:"4ë²ˆë§ˆì„", url:"" },
    { id:"p_5", name:"5ë²ˆë§ˆì„", url:"" },
    { id:"p_6", name:"6ë²ˆë§ˆì„", url:"" },
    { id:"p_7", name:"7ë²ˆë§ˆì„", url:"" },
  ];

  const makeDefaultCtx = (gameName="ì•„ì´ì˜¨2") => ({
    game: gameName,
    games: [gameName],
    currentGame: gameName,
    dataByGame: {
      [gameName]: {
        pages: deepClone(defaultPages),
        currentPageId: "p_all",
        categories: deepClone(defaultFilterCats),
        showLinesWithCatFilter: true,
        map: { imgDataUrl:"", naturalW:1, naturalH:1, scale:0, tx:0, ty:0 },
        markers: [],
        // curves: per page, per segment key, cp normalized
        curves: {}, // { [pageId]: { [segKey]: { cpxN, cpyN } } }
      }
    }
  });

  const defaultState = {
    version:99,
    logoUrl:"",
    ui:{
      activeCatIndex:0
    },
    topCats:[
      { id:"cat1", name:"ì¹´í…Œê³ ë¦¬1", enabled:true,  ctx: makeDefaultCtx("ì•„ì´ì˜¨2") },
      { id:"cat2", name:"ì¹´í…Œê³ ë¦¬2", enabled:false, ctx: makeDefaultCtx("ì•„ì´ì˜¨2") },
      { id:"cat3", name:"ì¹´í…Œê³ ë¦¬3", enabled:false, ctx: makeDefaultCtx("ì•„ì´ì˜¨2") },
      { id:"cat4", name:"ì¹´í…Œê³ ë¦¬4", enabled:false, ctx: makeDefaultCtx("ì•„ì´ì˜¨2") },
    ]
  };

  const $ = (id)=>document.getElementById(id);
  const cv = $("cv");
  const ctx2d = cv.getContext("2d");

  const toastEl = $("toast");
  const lock = $("lock");
  const pw = $("pw");
  const btnLogin = $("btnLogin");
  const lockMsg = $("lockMsg");

  const pageList = $("pageList");
  const catChips = $("catChips");
  const palette = $("palette");
  const textColors = $("textColors");

  const mMarker = $("mMarker");
  const mCats = $("mCats");
  const catTabsEl = $("catTabs");

  const QUICK = [
    {name:"ë¹¨", c:"#ff3b30"},
    {name:"ì£¼", c:"#ff9500"},
    {name:"ë…¸", c:"#ffd60a"},
    {name:"ì´ˆ", c:"#34c759"},
    {name:"íŒŒ", c:"#0a84ff"},
    {name:"í°", c:"#ffffff"},
    {name:"ê²€", c:"#0b0b0f"},
  ];

  function toast(msg, ms=1200){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>toastEl.classList.remove("show"), ms);
  }

  function isAuthed(){
    const t = Number(localStorage.getItem(LS_AUTH_KEY) || "0");
    return (Date.now() - t) < AUTH_MS;
  }
  function setAuthed(){ localStorage.setItem(LS_AUTH_KEY, String(Date.now())); }

  function requireAuth(){
    if(isAuthed()){
      lock.classList.remove("show");
      return;
    }
    lock.classList.add("show");
    pw.value = "";
    lockMsg.textContent = "";
    setTimeout(()=>pw.focus(), 0);
  }

  btnLogin.addEventListener("click", ()=>{
    if(pw.value === PASSWORD){
      setAuthed();
      lock.classList.remove("show");
      toast("ì¸ì¦ ì™„ë£Œ");
    }else{
      lockMsg.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      toast("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
    }
  });
  pw.addEventListener("keydown", (e)=>{ if(e.key==="Enter") btnLogin.click(); });

  // ---------- state ----------
  let S = deepClone(defaultState);

  function normalizeState(st){
    const base = deepClone(defaultState);
    if(!st || typeof st !== "object") return base;

    // migration: old flat -> cat1 game
    const looksOld = !!st.pages && !!st.markers && !!st.categories;
    if(looksOld){
      const cat1 = base.topCats[0];
      cat1.enabled = true;
      cat1.ctx.games = Array.isArray(st.games)&&st.games.length ? st.games : ["ì•„ì´ì˜¨2"];
      cat1.ctx.currentGame = st.game && cat1.ctx.games.includes(st.game) ? st.game : cat1.ctx.games[0];
      cat1.ctx.dataByGame = {};
      for(const g of cat1.ctx.games){
        cat1.ctx.dataByGame[g] = {
          pages: deepClone(Array.isArray(st.pages)&&st.pages.length ? st.pages : defaultPages),
          currentPageId: st.currentPageId || "p_all",
          categories: deepClone(Array.isArray(st.categories)&&st.categories.length ? st.categories : defaultFilterCats),
          showLinesWithCatFilter: typeof st.showLinesWithCatFilter==="boolean" ? st.showLinesWithCatFilter : true,
          map: Object.assign({ imgDataUrl:"", naturalW:1, naturalH:1, scale:0, tx:0, ty:0 }, st.map||{}),
          markers: deepClone(Array.isArray(st.markers) ? st.markers : []),
          curves: deepClone(st.curves || {}),
        };
      }
      base.logoUrl = st.logoUrl || "";
      base.ui.activeCatIndex = 0;
      return base;
    }

    // new structure merge
    base.version = st.version || 99;
    base.logoUrl = st.logoUrl || "";
    base.ui = Object.assign(base.ui, st.ui||{});

    if(Array.isArray(st.topCats) && st.topCats.length===4){
      base.topCats = st.topCats.map((tc, i)=>{
        const t = deepClone(defaultState.topCats[i]);
        if(tc && typeof tc==="object"){
          t.id = tc.id || t.id;
          t.name = tc.name || t.name;
          t.enabled = !!tc.enabled;
          const ctx = tc.ctx || {};
          // ctx normalize
          t.ctx.games = Array.isArray(ctx.games)&&ctx.games.length ? ctx.games : t.ctx.games;
          t.ctx.currentGame = ctx.currentGame && t.ctx.games.includes(ctx.currentGame) ? ctx.currentGame : t.ctx.games[0];
          t.ctx.dataByGame = typeof ctx.dataByGame==="object" && ctx.dataByGame ? ctx.dataByGame : t.ctx.dataByGame;

          // ensure each game has data
          for(const g of t.ctx.games){
            if(!t.ctx.dataByGame[g]) t.ctx.dataByGame[g] = {};
            const d = t.ctx.dataByGame[g];
            d.pages = Array.isArray(d.pages)&&d.pages.length ? d.pages : deepClone(defaultPages);
            d.currentPageId = d.currentPageId && d.pages.some(p=>p.id===d.currentPageId) ? d.currentPageId : d.pages[0].id;
            d.categories = Array.isArray(d.categories)&&d.categories.length ? d.categories : deepClone(defaultFilterCats);
            d.showLinesWithCatFilter = typeof d.showLinesWithCatFilter==="boolean" ? d.showLinesWithCatFilter : true;
            d.map = Object.assign({ imgDataUrl:"", naturalW:1, naturalH:1, scale:0, tx:0, ty:0 }, d.map||{});
            d.markers = Array.isArray(d.markers) ? d.markers : [];
            d.curves = typeof d.curves==="object" && d.curves ? d.curves : {};
          }
        }
        return t;
      });
    }

    base.ui.activeCatIndex = clamp(Number(base.ui.activeCatIndex||0), 0, 3);
    return base;
  }

  function saveLocal(){
    localStorage.setItem(LS_KEY, JSON.stringify(S));
  }

  async function loadStateRemoteFirst(){
    try{
      const r = await fetch(REMOTE_STATE_URL, { cache:"no-store" });
      if(r.ok){
        const st = await r.json();
        localStorage.setItem(LS_KEY, JSON.stringify(st));
        return st;
      }
    }catch(e){}
    const raw = localStorage.getItem(LS_KEY);
    return raw ? safeParse(raw, deepClone(defaultState)) : deepClone(defaultState);
  }

  // ---------- context helpers ----------
  function activeCat(){
    return S.topCats[clamp(S.ui.activeCatIndex,0,3)];
  }
  function activeCtx(){
    const c = activeCat();
    const g = c.ctx.currentGame;
    return c.ctx.dataByGame[g];
  }
  function setActiveCat(index){
    S.ui.activeCatIndex = clamp(index,0,3);
    saveLocal();
    renderAll();
    loadMap();
  }
  function setActiveGame(game){
    const c = activeCat();
    if(!c.ctx.games.includes(game)) return;
    c.ctx.currentGame = game;
    saveLocal();
    renderAll();
    loadMap();
  }

  // ---------- logo ----------
  const logoBox = $("logoBox");
  function renderLogo(){
    logoBox.innerHTML = "";
    if(S.logoUrl){
      const img = document.createElement("img");
      img.src = S.logoUrl;
      img.alt = "logo";
      img.onerror = () => {
        logoBox.innerHTML = `<div class="brand"><div class="word">MAPM<span class="o"></span>DE</div></div>`;
      };
      logoBox.appendChild(img);
    }else{
      logoBox.innerHTML = `<div class="brand"><div class="word">MAPM<span class="o"></span>DE</div></div>`;
    }
  }
  logoBox.addEventListener("click", ()=>{
    requireAuth();
    if(!isAuthed()) return;
    const cur = S.logoUrl || "";
    const next = prompt("ë¡œê³  ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš” (ë¹„ìš°ë©´ ê¸°ë³¸ ë¡œê³ )", cur);
    if(next === null) return;
    S.logoUrl = (next || "").trim();
    saveLocal();
    renderLogo();
    toast("ë¡œê³  ì„¤ì • ì €ì¥");
  });

  // ---------- top cats render ----------
  function renderCatTabs(){
    catTabsEl.innerHTML = "";
    S.topCats.forEach((tc, idx)=>{
      if(!tc.enabled) return; // ë¹„í™œì„± ì¹´í…Œê³ ë¦¬ëŠ” UI ìì²´ ìˆ¨ê¹€(í…Œë‘ë¦¬ë„ ì•ˆ ë³´ì´ê²Œ)
      const pill = document.createElement("div");
      pill.className = "catPill" + (idx===S.ui.activeCatIndex ? " active":"");
      const curGame = tc.ctx.currentGame || tc.ctx.games[0] || "ê²Œì„";
      pill.innerHTML = `
        <div class="name">${curGame}</div>
        <select class="select" style="max-width:160px;">
          ${tc.ctx.games.map(g=>`<option value="${escapeHtml(g)}">${escapeHtml(g)}</option>`).join("")}
        </select>
        <div class="chev"></div>
        <button class="mini ok" title="ê²Œì„ ì¶”ê°€">+</button>
        <button class="mini danger" title="ê²Œì„ ì‚­ì œ">-</button>
      `;
      const sel = pill.querySelector("select");
      sel.value = curGame;

      pill.addEventListener("click", (e)=>{
        if(e.target.closest("select") || e.target.closest("button")) return;
        setActiveCat(idx);
      });

      sel.addEventListener("click", (e)=>e.stopPropagation());
      sel.addEventListener("change", (e)=>{
        e.stopPropagation();
        requireAuth(); if(!isAuthed()){ sel.value = tc.ctx.currentGame; return; }
        if(idx!==S.ui.activeCatIndex) setActiveCat(idx);
        setActiveGame(sel.value);
      });

      const btnAdd = pill.querySelectorAll("button")[0];
      const btnDel = pill.querySelectorAll("button")[1];

      btnAdd.addEventListener("click", (e)=>{
        e.stopPropagation();
        requireAuth(); if(!isAuthed()) return;
        if(idx!==S.ui.activeCatIndex) setActiveCat(idx);
        const name = prompt("ì¶”ê°€í•  ê²Œì„ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”");
        if(!name) return;
        const g = name.trim();
        if(!g) return;
        if(tc.ctx.games.includes(g)){ toast("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²Œì„"); return; }
        tc.ctx.games.push(g);
        if(!tc.ctx.dataByGame[g]){
          tc.ctx.dataByGame[g] = {
            pages: deepClone(defaultPages),
            currentPageId:"p_all",
            categories: deepClone(defaultFilterCats),
            showLinesWithCatFilter:true,
            map:{ imgDataUrl:"", naturalW:1, naturalH:1, scale:0, tx:0, ty:0 },
            markers:[],
            curves:{}
          };
        }
        tc.ctx.currentGame = g;
        saveLocal();
        renderAll();
        loadMap();
        toast("ê²Œì„ ì¶”ê°€");
      });

      btnDel.addEventListener("click", (e)=>{
        e.stopPropagation();
        requireAuth(); if(!isAuthed()) return;
        if(idx!==S.ui.activeCatIndex) setActiveCat(idx);
        if(tc.ctx.games.length<=1){ toast("ìµœì†Œ 1ê°œ ê²Œì„ì€ í•„ìš”í•©ë‹ˆë‹¤"); return; }
        const g = tc.ctx.currentGame;
        if(!confirm(`"${g}" ê²Œì„ì„ ì‚­ì œí• ê¹Œìš”? (í•´ë‹¹ ê²Œì„ì˜ í˜ì´ì§€/ë§ˆì»¤ í¬í•¨)`)) return;
        tc.ctx.games = tc.ctx.games.filter(x=>x!==g);
        delete tc.ctx.dataByGame[g];
        tc.ctx.currentGame = tc.ctx.games[0];
        saveLocal();
        renderAll();
        loadMap();
        toast("ê²Œì„ ì‚­ì œ");
      });

      catTabsEl.appendChild(pill);
    });

    // ê´€ë¦¬ìš©: ë¹„í™œì„± ì¹´í…Œê³ ë¦¬ í† ê¸€(ë‹¨ì¶•: ìš°ì¸¡ ìƒë‹¨ pill í´ë¦­ ì‹œ prompt)
    catTabsEl.addEventListener("contextmenu", (e)=>{
      e.preventDefault();
      requireAuth(); if(!isAuthed()) return;
      const cmd = prompt(
        "ì¹´í…Œê³ ë¦¬ ê´€ë¦¬:\n" +
        "1) ì¹´í…Œê³ ë¦¬2 í™œì„±í™”\n" +
        "2) ì¹´í…Œê³ ë¦¬3 í™œì„±í™”\n" +
        "3) ì¹´í…Œê³ ë¦¬4 í™œì„±í™”\n" +
        "4) ì¹´í…Œê³ ë¦¬2 ë¹„í™œì„±í™”\n" +
        "5) ì¹´í…Œê³ ë¦¬3 ë¹„í™œì„±í™”\n" +
        "6) ì¹´í…Œê³ ë¦¬4 ë¹„í™œì„±í™”\n\n" +
        "ìˆ«ì ì…ë ¥"
      );
      if(cmd===null) return;
      const n = Number(cmd);
      const map = {
        1:[1,true],2:[2,true],3:[3,true],
        4:[1,false],5:[2,false],6:[3,false],
      };
      if(!map[n]) return;
      const [i,on] = map[n];
      S.topCats[i].enabled = on;
      if(!S.topCats[S.ui.activeCatIndex].enabled){
        S.ui.activeCatIndex = 0;
      }
      saveLocal();
      renderAll();
      loadMap();
    });
  }

  function renderPath(){
    const c = activeCat();
    $("pathCatTop").textContent = c.name;
    $("pathGameTop").textContent = c.ctx.currentGame;
    $("pathCat").textContent = c.name;
    $("pathGame").textContent = c.ctx.currentGame;
  }

  // ---------- pages ----------
  function renderPages(){
    const D = activeCtx();
    pageList.innerHTML = "";
    const cur = D.pages.find(p=>p.id===D.currentPageId) || D.pages[0];
    $("pathPage").textContent = cur ? cur.name : "ì „ì²´ì§€ë„";

    for(const p of D.pages){
      const item = document.createElement("div");
      item.className = "pageItem" + (p.id===D.currentPageId ? " active" : "");
      item.innerHTML = `
        <div class="pageName">${escapeHtml(p.name)}</div>
        <div class="pageActions">
          <button class="miniBtn url" title="ì§€ë„ ì´ë¯¸ì§€ URL ì„¤ì •">URL</button>
          <button class="miniBtn icon edit" title="ì´ë¦„ í¸ì§‘">âœ</button>
          <button class="miniBtn icon del" title="ì‚­ì œ">ğŸ—‘</button>
        </div>
      `;
      item.addEventListener("click", (e)=>{
        const btn = e.target.closest("button");
        if(btn) return;
        D.currentPageId = p.id;
        saveLocal();
        renderPages();
        renderKpi();
        loadMap();
      });

      const [bUrl, bEdit, bDel] = item.querySelectorAll("button");

      bUrl.addEventListener("click", (e)=>{
        e.stopPropagation();
        requireAuth(); if(!isAuthed()) return;
        const next = prompt("ì´ í˜ì´ì§€ ì§€ë„ ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”", p.url || "");
        if(next === null) return;
        p.url = (next || "").trim();
        saveLocal();
        toast("í˜ì´ì§€ URL ì €ì¥");
        if(p.id === D.currentPageId) loadMap();
      });

      bEdit.addEventListener("click", (e)=>{
        e.stopPropagation();
        requireAuth(); if(!isAuthed()) return;
        const next = prompt("í˜ì´ì§€ ì´ë¦„ì„ ìˆ˜ì •í•˜ì„¸ìš”", p.name);
        if(!next) return;
        p.name = next.trim();
        saveLocal();
        renderPages();
        toast("í˜ì´ì§€ ì´ë¦„ ìˆ˜ì •");
      });

      bDel.addEventListener("click", (e)=>{
        e.stopPropagation();
        requireAuth(); if(!isAuthed()) return;
        if(D.pages.length <= 1){ toast("ìµœì†Œ 1ê°œ í˜ì´ì§€ëŠ” í•„ìš”í•©ë‹ˆë‹¤"); return; }
        if(!confirm(`"${p.name}" í˜ì´ì§€ë¥¼ ì‚­ì œí• ê¹Œìš”? (í•´ë‹¹ í˜ì´ì§€ ë§ˆì»¤/ê³¡ì„ ë„ ê°™ì´ ì‚­ì œë©ë‹ˆë‹¤)`)) return;

        const pid = p.id;
        D.markers = D.markers.filter(m=>m.pageId !== pid);
        if(D.curves && D.curves[pid]) delete D.curves[pid];
        D.pages = D.pages.filter(x=>x.id !== pid);
        if(D.currentPageId === pid) D.currentPageId = D.pages[0].id;

        saveLocal();
        renderPages();
        renderKpi();
        loadMap();
        toast("í˜ì´ì§€ ì‚­ì œ");
      });

      pageList.appendChild(item);
    }
  }

  $("btnAddPage").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    const D = activeCtx();
    const name = prompt("ì¶”ê°€í•  í˜ì´ì§€ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 8ë²ˆë§ˆì„)");
    if(!name) return;
    const p = { id:"p_"+uid(), name:name.trim(), url:"" };
    D.pages.push(p);
    D.currentPageId = p.id;
    saveLocal();
    renderPages();
    renderKpi();
    loadMap();
    toast("í˜ì´ì§€ ì¶”ê°€");
  });

  // ---------- categories (filter + style) ----------
  function getCat(id){
    const D = activeCtx();
    return D.categories.find(c=>c.id===id);
  }
  function ensureCat(name, color){
    const D = activeCtx();
    if(D.categories.some(c=>c.id===name)) return;
    D.categories.push({ id:name, name, color:color||"#ffffff", on:true, style:{ r:10, labelFs:15, fw:900, labelColor:"#e7eef8" } });
  }
  function markerCat(m){
    const D = activeCtx();
    if(!m.cat) m.cat = (D.categories.find(x=>x.id!=="ì „ì²´")?.id)||"ê¸°í…”";
    return m.cat;
  }
  function catColor(catId){
    const c = getCat(catId);
    return (c && c.color) ? c.color : "#7cc4ff";
  }
  function catStyle(catId){
    const c = getCat(catId);
    return (c && c.style) ? c.style : { r:10, labelFs:15, fw:900, labelColor:"#e7eef8" };
  }

  function renderCats(){
    const D = activeCtx();
    catChips.innerHTML = "";
    for(const c of D.categories){
      const chip = document.createElement("div");
      chip.className = "chip" + (c.on ? " on" : "");
      chip.innerHTML = `<div class="dotc" style="background:${c.color};"></div><div>${escapeHtml(c.name)}</div>`;
      chip.addEventListener("click", ()=>{
        requireAuth();
        if(!isAuthed()) return;

        // "ì „ì²´" ë™ì‘: ì „ì²´ on/off í† ê¸€
        if(c.id==="ì „ì²´"){
          const anyOff = D.categories.some(x=>x.id!=="ì „ì²´" && !x.on);
          D.categories.forEach(x=>{
            if(x.id==="ì „ì²´") x.on = true;
            else x.on = anyOff; // í•˜ë‚˜ë¼ë„ êº¼ì ¸ ìˆìœ¼ë©´ ì „ë¶€ ì¼œê¸°, ì•„ë‹ˆë©´ ì „ë¶€ ë„ê¸°
          });
          if(!D.categories.some(x=>x.id!=="ì „ì²´" && x.on)){
            // ëª¨ë‘ êº¼ì¡Œìœ¼ë©´(ì „ì²´ ì œì™¸) -> ì „ì²´ë§Œ í‘œì‹œ ì˜ë¯¸ë¡œ ë™ì‘í•˜ë˜, UIìƒ ìµœì†Œ 1ê°œëŠ” ì¼œì•¼í•˜ë¯€ë¡œ 'ì „ì²´'ì™¸ 1ê°œ ì¼œê¸° ë°©ì§€ ëŒ€ì‹  ì „ì²´ ì˜ë¯¸ ìœ ì§€
            // ì—¬ê¸°ì„œëŠ” "ì „ì²´ë§Œ" ìƒíƒœ í—ˆìš©: í•„í„° ê³„ì‚°ì—ì„œ ì „ì²´ onì´ë©´ ì „ë¶€ í‘œì‹œ
          }
        }else{
          c.on = !c.on;
          // ìµœì†Œ 1ê°œëŠ” ì¼œì ¸ì•¼ í•¨(ì „ì²´ í¬í•¨)
          if(!D.categories.some(x=>x.on)){
            c.on = true;
            toast("ìµœì†Œ 1ê°œ ì¹´í…Œê³ ë¦¬ëŠ” ì¼œì ¸ì•¼ í•©ë‹ˆë‹¤");
          }
          // ì „ì²´ëŠ” í•­ìƒ on ìœ ì§€(ì „ì²´ ë²„íŠ¼ì€ ì˜ë¯¸ìƒ í•­ìƒ ì¡´ì¬)
          const all = D.categories.find(x=>x.id==="ì „ì²´");
          if(all) all.on = true;
        }

        saveLocal();
        renderCats();
        renderKpi();
        draw();
      });
      catChips.appendChild(chip);
    }
  }

  function setToggle(el, on){
    el.classList.toggle("on", !!on);
    el.dataset.on = on ? "1" : "0";
  }
  const tgShowLinesWithCatFilter = $("tgShowChainSameCat");
  tgShowLinesWithCatFilter.addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    const D = activeCtx();
    D.showLinesWithCatFilter = !D.showLinesWithCatFilter;
    setToggle(tgShowLinesWithCatFilter, D.showLinesWithCatFilter);
    saveLocal();
    draw();
  });

  // ---------- map ----------
  let mapImg = new Image();
  mapImg.crossOrigin = "anonymous";

  function resizeCanvas(){
    const wrap = cv.parentElement;
    const w = wrap.clientWidth - 32;
    const h = wrap.clientHeight - 32;
    cv.width = Math.max(900, Math.floor(w));
    cv.height = Math.max(650, Math.floor(h));
  }
  window.addEventListener("resize", ()=>{ resizeCanvas(); draw(); });

  function fitToScreen(){
    const D = activeCtx();
    const pad = 40;
    const iw = D.map.naturalW || (mapImg.naturalWidth||1);
    const ih = D.map.naturalH || (mapImg.naturalHeight||1);
    const cw = cv.width, ch = cv.height;
    const scale = Math.min((cw - pad)/iw, (ch - pad)/ih);
    D.map.scale = clamp(scale, 0.05, 10);
    D.map.tx = (cw - iw*D.map.scale)/2;
    D.map.ty = (ch - ih*D.map.scale)/2;
  }

  function loadMap(){
    const D = activeCtx();
    const curPage = D.pages.find(p => p.id === D.currentPageId);
    const pageUrl = (curPage?.url || "").trim();

    if(pageUrl){
      mapImg = new Image();
      mapImg.crossOrigin = "anonymous";
      mapImg.onload = ()=>{
        D.map.naturalW = mapImg.naturalWidth || 1;
        D.map.naturalH = mapImg.naturalHeight || 1;
        fitToScreen();
        saveLocal();
        draw();
        renderKpi();
      };
      mapImg.onerror = ()=>{ toast("ì§€ë„ URL ë¡œë“œ ì‹¤íŒ¨"); draw(); };
      mapImg.src = pageUrl;
      return;
    }

    if(D.map.imgDataUrl){
      mapImg = new Image();
      mapImg.crossOrigin = "anonymous";
      mapImg.onload = ()=>{
        D.map.naturalW = mapImg.naturalWidth || 1;
        D.map.naturalH = mapImg.naturalHeight || 1;
        if(!D.map.scale || D.map.scale<=0) fitToScreen();
        draw();
      };
      mapImg.src = D.map.imgDataUrl;
      return;
    }

    mapImg = new Image();
    mapImg.onload = ()=>draw();
    mapImg.src = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(
      `<svg xmlns="http://www.w3.org/2000/svg" width="1400" height="1000">
        <defs>
          <radialGradient id="g" cx="50%" cy="40%" r="70%">
            <stop offset="0%" stop-color="#ffffff"/>
            <stop offset="100%" stop-color="#e8edf7"/>
          </radialGradient>
        </defs>
        <rect width="100%" height="100%" fill="url(#g)"/>
        <text x="50%" y="50%" text-anchor="middle" font-family="Arial" font-size="28" fill="#7a889e">í˜ì´ì§€ URL ë˜ëŠ” ì§€ë„ ì—…ë¡œë“œê°€ í•„ìš”</text>
      </svg>`
    );
  }

  $("fileMap").addEventListener("change", async (e)=>{
    requireAuth();
    if(!isAuthed()) return;
    const D = activeCtx();
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const dataUrl = await fileToDataURL(f);
    D.map.imgDataUrl = dataUrl;
    saveLocal();
    loadMap();
    toast("ì§€ë„ ì—…ë¡œë“œ ì™„ë£Œ");
    e.target.value = "";
  });

  function fileToDataURL(file){
    return new Promise((res, rej)=>{
      const fr = new FileReader();
      fr.onload = ()=>res(fr.result);
      fr.onerror = rej;
      fr.readAsDataURL(file);
    });
  }

  // ---------- export / reset ----------
  $("btnExport").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    const blob = new Blob([JSON.stringify(S, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "state.json";
    a.click();
    URL.revokeObjectURL(a.href);
    toast("state.json ë‹¤ìš´ë¡œë“œ");
  });

  $("btnResetAll").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    if(!confirm("ì „ì²´ ì´ˆê¸°í™”í• ê¹Œìš”? (ì¹´í…Œê³ ë¦¬/ê²Œì„/í˜ì´ì§€/ë§ˆì»¤/ì§€ë„ í¬í•¨)")) return;
    S = deepClone(defaultState);
    saveLocal();
    renderAll();
    loadMap();
    toast("ì „ì²´ ì´ˆê¸°í™” ì™„ë£Œ");
  });

  // ---------- markers / curves ----------
  let selectedMarker = null;
  let insertAfterMarkerId = null;

  function getVisibleMarkers(){
    const D = activeCtx();
    const curPage = D.currentPageId;
    const onCats = new Set(D.categories.filter(c=>c.on).map(c=>c.id));
    const allOn = onCats.has("ì „ì²´");
    return (D.markers||[]).filter(m=>{
      if(m.pageId !== curPage) return false;
      const cat = markerCat(m);
      if(allOn) return true;
      return onCats.has(cat);
    });
  }

  function renderKpi(){
    const D = activeCtx();
    const curPage = D.currentPageId;
    const total = (D.markers||[]).filter(m=>m.pageId===curPage).length;
    const shown = getVisibleMarkers().length;
    $("kpi").textContent = `í‘œì‹œ ì¤‘ ë§ˆì»¤: ${shown} / í˜ì´ì§€ ì „ì²´: ${total}`;
  }

  function worldFromNorm(nx, ny){
    const D = activeCtx();
    const iw = D.map.naturalW || (mapImg.naturalWidth||1);
    const ih = D.map.naturalH || (mapImg.naturalHeight||1);
    return { x:nx*iw, y:ny*ih };
  }
  function normFromWorld(wx, wy){
    const D = activeCtx();
    const iw = D.map.naturalW || (mapImg.naturalWidth||1);
    const ih = D.map.naturalH || (mapImg.naturalHeight||1);
    return { nx: wx/iw, ny: wy/ih };
  }
  function screenFromWorld(wx, wy){
    const D = activeCtx();
    return { sx: wx*D.map.scale + D.map.tx, sy: wy*D.map.scale + D.map.ty };
  }
  function worldFromScreen(sx, sy){
    const D = activeCtx();
    return { wx: (sx - D.map.tx)/D.map.scale, wy: (sy - D.map.ty)/D.map.scale };
  }

  function chainKey(m){
    // chainId ê¸°ì¤€ìœ¼ë¡œ ë¬¶ê³ , chainIndex ìˆœì„œ
    return String(m.chainId || "");
  }

  // marker create
  function newMarkerAt(normX, normY){
    const D = activeCtx();
    const m = {
      id:"m_"+uid(),
      pageId:D.currentPageId,
      x:normX, y:normY,
      name:"",
      cat: (D.categories.find(c=>c.id!=="ì „ì²´" && c.on)?.id) || (D.categories.find(c=>c.id!=="ì „ì²´")?.id)||"ê¸°í…”",
      yt:"",
      ytTitle:"",
      memo:"",
      chainId:null,
      chainIndex:null,
    };

    // chain logic
    if(insertAfterMarkerId){
      const base = D.markers.find(x=>x.id===insertAfterMarkerId);
      if(base && base.chainId){
        m.chainId = base.chainId;
        m.chainIndex = (base.chainIndex||0) + 1;
        for(const mm of D.markers){
          if(mm.chainId===m.chainId && (mm.chainIndex||0) >= m.chainIndex){
            mm.chainIndex = (mm.chainIndex||0) + 1;
          }
        }
      }
    }else{
      m.chainId = "c_"+uid();
      m.chainIndex = 1;
    }

    D.markers.push(m);
    saveLocal();
    selectMarker(m.id);
    renderKpi();
    draw();
  }

  function selectMarker(id){
    const D = activeCtx();
    selectedMarker = D.markers.find(m=>m.id===id) || null;
    syncSelectedPanel();
  }

  function syncSelectedPanel(){
    $("selName").textContent = selectedMarker ? (selectedMarker.name || "(ì´ë¦„ ì—†ìŒ)") : "(ì´ë¦„ ì—†ìŒ)";
    $("selLink").value = selectedMarker ? (selectedMarker.yt || "") : "";
    $("selYtTitle").value = selectedMarker ? (selectedMarker.ytTitle || "") : "";
    $("btnOpenMarkerEdit").disabled = !selectedMarker;
    $("btnApplyQuickCat").disabled = !selectedMarker;
  }

  $("selLink").addEventListener("input", ()=>{
    const D = activeCtx();
    if(!selectedMarker) return;
    const m = D.markers.find(x=>x.id===selectedMarker.id);
    if(!m) return;
    m.yt = $("selLink").value.trim();
    saveLocal();
  });
  $("selYtTitle").addEventListener("input", ()=>{
    const D = activeCtx();
    if(!selectedMarker) return;
    const m = D.markers.find(x=>x.id===selectedMarker.id);
    if(!m) return;
    m.ytTitle = $("selYtTitle").value;
    saveLocal();
  });

  // ---------- curves storage ----------
  function segKey(aId, bId){
    return aId + "->" + bId;
  }
  function getCurvesForPage(pageId){
    const D = activeCtx();
    if(!D.curves) D.curves = {};
    if(!D.curves[pageId]) D.curves[pageId] = {};
    return D.curves[pageId];
  }

  function getControlPointForSegment(pageId, a, b){
    const curves = getCurvesForPage(pageId);
    const key = segKey(a.id, b.id);
    const v = curves[key];
    if(!v) return null;
    const wp = worldFromNorm(v.cpxN, v.cpyN);
    return { x: wp.x, y: wp.y };
  }

  function setControlPointForSegment(pageId, a, b, wx, wy){
    const curves = getCurvesForPage(pageId);
    const key = segKey(a.id, b.id);
    const n = normFromWorld(wx, wy);
    curves[key] = { cpxN: clamp(n.nx,0,1), cpyN: clamp(n.ny,0,1) };
  }

  function clearCurvesForPage(pageId){
    const D = activeCtx();
    if(D.curves && D.curves[pageId]) D.curves[pageId] = {};
  }

  // ---------- drawing ----------
  let circleHitboxes = []; // {id,sx,sy,rPx}
  let segHitboxes = [];    // {aId,bId,pageId,distPx, nearest:...}

  function drawArrowAtQuadratic(p0, p1, cp, t){
    // compute point and tangent at t
    const x = (1-t)*(1-t)*p0.x + 2*(1-t)*t*cp.x + t*t*p1.x;
    const y = (1-t)*(1-t)*p0.y + 2*(1-t)*t*cp.y + t*t*p1.y;
    const dx = 2*(1-t)*(cp.x - p0.x) + 2*t*(p1.x - cp.x);
    const dy = 2*(1-t)*(cp.y - p0.y) + 2*t*(p1.y - cp.y);
    const len = Math.hypot(dx,dy) || 1;
    const ux = dx/len, uy = dy/len;

    // arrow size in world units
    const D = activeCtx();
    const s = 14 / D.map.scale; // constant pixels
    const w = 8 / D.map.scale;

    const tip = { x, y };
    const left = { x: x - ux*s + (-uy)*w, y: y - uy*s + (ux)*w };
    const right= { x: x - ux*s + (uy)*w,  y: y - uy*s + (-ux)*w };

    ctx2d.beginPath();
    ctx2d.moveTo(tip.x, tip.y);
    ctx2d.lineTo(left.x, left.y);
    ctx2d.lineTo(right.x, right.y);
    ctx2d.closePath();
    ctx2d.fill();
  }

  function draw(){
    const D = activeCtx();
    ctx2d.clearRect(0,0,cv.width,cv.height);
    circleHitboxes = [];
    segHitboxes = [];

    ctx2d.save();
    ctx2d.fillStyle = "rgba(0,0,0,.22)";
    ctx2d.fillRect(0,0,cv.width,cv.height);
    ctx2d.restore();

    ctx2d.save();
    ctx2d.translate(D.map.tx, D.map.ty);
    ctx2d.scale(D.map.scale, D.map.scale);

    // map
    if(mapImg && mapImg.complete){
      const iw = D.map.naturalW || (mapImg.naturalWidth||1);
      const ih = D.map.naturalH || (mapImg.naturalHeight||1);
      ctx2d.drawImage(mapImg, 0,0, iw, ih);
    }

    const ms = getVisibleMarkers();

    // build chains for current page
    const byChain = new Map();
    for(const m of ms){
      if(!m.chainId || !m.chainIndex) continue;
      const k = chainKey(m);
      if(!byChain.has(k)) byChain.set(k, []);
      byChain.get(k).push(m);
    }
    for(const arr of byChain.values()){
      arr.sort((a,b)=>(a.chainIndex||0)-(b.chainIndex||0));
    }

    // lines/curves
    if(!!D.showLinesWithCatFilter){
      ctx2d.save();
      ctx2d.lineWidth = 2 / D.map.scale;
      ctx2d.strokeStyle = "rgba(255,255,255,.78)";
      ctx2d.globalAlpha = 0.9;

      const pageId = D.currentPageId;

      for(const arr of byChain.values()){
        for(let i=0;i<arr.length-1;i++){
          const a = arr[i], b = arr[i+1];
          const p0 = worldFromNorm(a.x, a.y);
          const p1 = worldFromNorm(b.x, b.y);
          const cp = getControlPointForSegment(pageId, a, b) || { x:(p0.x+p1.x)/2, y:(p0.y+p1.y)/2 };

          ctx2d.beginPath();
          ctx2d.moveTo(p0.x, p0.y);
          ctx2d.quadraticCurveTo(cp.x, cp.y, p1.x, p1.y);
          ctx2d.stroke();

          // arrow at center
          ctx2d.fillStyle = "rgba(255,255,255,.85)";
          drawArrowAtQuadratic(p0, p1, cp, 0.5);

          // prepare screen-space hitbox for dragging curve
          const sp0 = screenFromWorld(p0.x, p0.y);
          const sp1 = screenFromWorld(p1.x, p1.y);
          const scp = screenFromWorld(cp.x, cp.y);
          segHitboxes.push({
            pageId,
            aId:a.id, bId:b.id,
            sp0, sp1, scp
          });
        }
      }
      ctx2d.restore();
    }

    // markers
    for(const m of ms){
      const catId = markerCat(m);
      const color = catColor(catId);
      const st = catStyle(catId);

      const p = worldFromNorm(m.x, m.y);

      // marker radius min = 5 (ê¸°ë³¸ì˜ 50% ê¸°ì¤€)
      const r = clamp(Number(st.r||10), 5, 200);

      // circle
      ctx2d.save();
      ctx2d.globalAlpha = 1;
      ctx2d.beginPath();
      ctx2d.arc(p.x, p.y, r, 0, Math.PI*2);
      ctx2d.fillStyle = color;
      ctx2d.fill();
      ctx2d.lineWidth = 2 / D.map.scale;
      ctx2d.strokeStyle = "rgba(0,0,0,.35)";
      ctx2d.stroke();
      ctx2d.restore();

      // number always inside circle with ratio
      const num = (m.chainIndex != null) ? String(m.chainIndex) : "";
      if(num){
        const numFs = clamp(Math.round(r * 1.15), 8, 80);
        ctx2d.save();
        ctx2d.globalAlpha = 0.98;
        ctx2d.fillStyle = "rgba(0,0,0,.75)";
        ctx2d.font = `${st.fw ?? 900} ${numFs}px ui-sans-serif`;
        ctx2d.textAlign = "center";
        ctx2d.textBaseline = "middle";
        ctx2d.fillText(num, p.x, p.y + 0.5);
        ctx2d.restore();
      }

      // label distance 50% ì¤„ì´ê¸° (ê¸°ì¡´ r+8 -> r+4)
      if(m.name){
        ctx2d.save();
        ctx2d.globalAlpha = 0.98;
        ctx2d.fillStyle = st.labelColor || "#e7eef8";
        const lf = clamp(Number(st.labelFs||15), 8, 120);
        ctx2d.font = `${st.fw ?? 900} ${lf}px ui-sans-serif`;
        ctx2d.textAlign = "left";
        ctx2d.textBaseline = "middle";
        const off = r + 4; // 50% ê°ì†Œ ëŠë‚Œ
        ctx2d.fillText(m.name, p.x + off, p.y);
        ctx2d.restore();
      }

      // hitbox
      const sp = screenFromWorld(p.x, p.y);
      circleHitboxes.push({ id:m.id, sx:sp.sx, sy:sp.sy, rPx: r*D.map.scale });
    }

    ctx2d.restore();
  }

  function pickCircleAt(sx, sy){
    let best=null, bestD=Infinity;
    for(const c of circleHitboxes){
      const d = Math.hypot(c.sx - sx, c.sy - sy);
      if(d <= c.rPx*1.25 && d < bestD){
        best = c;
        bestD = d;
      }
    }
    return best;
  }

  // nearest point distance to quadratic curve approximation (samples)
  function pickSegmentAt(sx, sy){
    const D = activeCtx();
    const threshold = 14; // px
    let best = null;
    let bestD = Infinity;

    for(const seg of segHitboxes){
      // sample along curve in screen space
      const p0 = seg.sp0, p1 = seg.sp1, cp = seg.scp;
      const steps = 18;
      let prev = null;
      for(let i=0;i<=steps;i++){
        const t = i/steps;
        const x = (1-t)*(1-t)*p0.sx + 2*(1-t)*t*cp.sx + t*t*p1.sx;
        const y = (1-t)*(1-t)*p0.sy + 2*(1-t)*t*cp.sy + t*t*p1.sy;
        if(prev){
          const d = distPointToSegment({x:sx,y:sy}, prev, {x,y});
          if(d < bestD){
            bestD = d;
            best = seg;
          }
        }
        prev = {x,y};
      }
    }

    if(best && bestD <= threshold){
      return { seg: best, dist: bestD };
    }
    return null;
  }

  function distPointToSegment(p, a, b){
    const vx = b.x - a.x, vy = b.y - a.y;
    const wx = p.x - a.x, wy = p.y - a.y;
    const c1 = vx*wx + vy*wy;
    if(c1 <= 0) return Math.hypot(p.x - a.x, p.y - a.y);
    const c2 = vx*vx + vy*vy;
    if(c2 <= c1) return Math.hypot(p.x - b.x, p.y - b.y);
    const t = c1 / c2;
    const px = a.x + t*vx, py = a.y + t*vy;
    return Math.hypot(p.x - px, p.y - py);
  }

  // ---------- interactions: marker drag / curve drag / pan ----------
  let drag = {
    mode: null, // "pan" | "marker" | "curve"
    pointerId: null,
    startSx:0, startSy:0,
    lastSx:0, lastSy:0,
    markerId:null,
    seg:null,
    moved:false,
  };

  function beginDrag(mode, pointerId, sx, sy){
    drag.mode = mode;
    drag.pointerId = pointerId;
    drag.startSx = drag.lastSx = sx;
    drag.startSy = drag.lastSy = sy;
    drag.moved = false;
  }

  cv.addEventListener("pointerdown", (e)=>{
    requireAuth(); if(!isAuthed()) return;
    cv.setPointerCapture(e.pointerId);

    const rect = cv.getBoundingClientRect();
    const sx = e.clientX - rect.left;
    const sy = e.clientY - rect.top;

    const hitM = pickCircleAt(sx, sy);
    if(hitM){
      beginDrag("marker", e.pointerId, sx, sy);
      drag.markerId = hitM.id;
      selectMarker(hitM.id);
      return;
    }

    // marker ìš°ì„  ì´í›„ ì„  ì„ íƒ
    const hitSeg = pickSegmentAt(sx, sy);
    if(hitSeg){
      beginDrag("curve", e.pointerId, sx, sy);
      drag.seg = hitSeg.seg;
      return;
    }

    // else pan
    beginDrag("pan", e.pointerId, sx, sy);
  });

  cv.addEventListener("pointermove", (e)=>{
    if(drag.pointerId !== e.pointerId || !drag.mode) return;
    const D = activeCtx();
    const rect = cv.getBoundingClientRect();
    const sx = e.clientX - rect.left;
    const sy = e.clientY - rect.top;

    const dx = sx - drag.lastSx;
    const dy = sy - drag.lastSy;
    drag.lastSx = sx;
    drag.lastSy = sy;

    const movedNow = Math.hypot(sx - drag.startSx, sy - drag.startSy) > 3;
    if(movedNow) drag.moved = true;

    if(drag.mode==="pan"){
      D.map.tx += dx;
      D.map.ty += dy;
      draw();
      return;
    }

    if(drag.mode==="marker"){
      const m = D.markers.find(x=>x.id===drag.markerId);
      if(!m) return;
      const w = worldFromScreen(sx, sy);
      const n = normFromWorld(w.wx, w.wy);
      m.x = clamp(n.nx, 0, 1);
      m.y = clamp(n.ny, 0, 1);
      saveLocal();
      draw();
      return;
    }

    if(drag.mode==="curve"){
      if(!drag.seg) return;
      const aId = drag.seg.aId, bId = drag.seg.bId;
      const a = D.markers.find(x=>x.id===aId);
      const b = D.markers.find(x=>x.id===bId);
      if(!a || !b) return;
      const w = worldFromScreen(sx, sy);
      setControlPointForSegment(D.currentPageId, a, b, w.wx, w.wy);
      saveLocal();
      draw();
      return;
    }
  });

  cv.addEventListener("pointerup", (e)=>{
    if(drag.pointerId !== e.pointerId) return;

    // click behavior when not moved
    if(!drag.moved){
      const rect = cv.getBoundingClientRect();
      const sx = e.clientX - rect.left;
      const sy = e.clientY - rect.top;
      const hit = pickCircleAt(sx, sy);
      if(hit){
        selectMarker(hit.id);
      }else{
        selectedMarker = null;
        insertAfterMarkerId = null;
        syncSelectedPanel();
      }
    }

    drag.mode = null;
    drag.pointerId = null;
    drag.markerId = null;
    drag.seg = null;
  });

  cv.addEventListener("pointercancel", ()=>{
    drag.mode = null;
    drag.pointerId = null;
    drag.markerId = null;
    drag.seg = null;
  });

  // wheel zoom
  cv.addEventListener("wheel", (e)=>{
    e.preventDefault();
    const D = activeCtx();
    const rect = cv.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;

    const old = D.map.scale || 1;
    const zoom = Math.exp(-e.deltaY * 0.0012);
    const next = clamp(old * zoom, 0.05, 10);

    const wx = (mx - D.map.tx) / old;
    const wy = (my - D.map.ty) / old;

    D.map.scale = next;
    D.map.tx = mx - wx * next;
    D.map.ty = my - wy * next;

    saveLocal();
    draw();
  }, {passive:false});

  // right click add marker
  cv.addEventListener("contextmenu", (e)=>{
    e.preventDefault();
    requireAuth(); if(!isAuthed()) return;
    const D = activeCtx();
    const rect = cv.getBoundingClientRect();
    const sx = e.clientX - rect.left;
    const sy = e.clientY - rect.top;

    const w = worldFromScreen(sx, sy);
    const n = normFromWorld(w.wx, w.wy);
    newMarkerAt(clamp(n.nx,0,1), clamp(n.ny,0,1));
    toast("ë§ˆì»¤ ì¶”ê°€");
  });

  // dblclick open marker edit
  cv.addEventListener("dblclick", (e)=>{
    requireAuth(); if(!isAuthed()) return;
    const rect = cv.getBoundingClientRect();
    const sx = e.clientX - rect.left;
    const sy = e.clientY - rect.top;
    const hit = pickCircleAt(sx, sy);
    if(hit){
      selectMarker(hit.id);
      ytTouched = false; memoTouched = false;
      openMarkerModal(hit.id);
    }
  });

  // ---------- right tools ----------
  $("btnResetMarkers").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    const D = activeCtx();
    if(!confirm("í˜„ì¬ í˜ì´ì§€ì˜ ë§ˆì»¤ë¥¼ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?")) return;
    const pid = D.currentPageId;
    D.markers = D.markers.filter(m=>m.pageId!==pid);
    clearCurvesForPage(pid);
    selectedMarker = null;
    insertAfterMarkerId = null;
    saveLocal();
    syncSelectedPanel();
    renderKpi();
    draw();
    toast("ë§ˆì»¤ ì´ˆê¸°í™”");
  });

  $("btnRechain").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    const D = activeCtx();
    const pageMs = D.markers.filter(m=>m.pageId===D.currentPageId);
    const chainId = "c_"+uid();
    let idx=1;
    for(const m of pageMs){
      m.chainId = chainId;
      m.chainIndex = idx++;
    }
    saveLocal();
    draw();
    toast("ì„  ë‹¤ì‹œ ì²´ì¸(ì „ì²´)");
  });

  $("btnClearCurves").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    const D = activeCtx();
    if(!confirm("í˜„ì¬ í˜ì´ì§€ ê³¡ì„ ì„ ì´ˆê¸°í™”í• ê¹Œìš”?")) return;
    clearCurvesForPage(D.currentPageId);
    saveLocal();
    draw();
    toast("ê³¡ì„  ì´ˆê¸°í™”");
  });

  // quick palette apply to selected marker's category color
  let pickedQuick = null;
  function renderPalette(){
    palette.innerHTML = "";
    for(const q of QUICK){
      const wrap = document.createElement("div");
      wrap.className = "swWrap";
      wrap.innerHTML = `
        <div class="sw" style="--c:${q.c}" title="${q.name}"></div>
        <div class="swLabel">${q.name}</div>
      `;
      wrap.querySelector(".sw").addEventListener("click", ()=>{
        pickedQuick = q.c;
        toast("ìƒ‰ìƒ ì„ íƒ");
      });
      palette.appendChild(wrap);
    }
  }

  $("btnApplyQuickCat").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    const D = activeCtx();
    if(!selectedMarker){ toast("ë§ˆì»¤ë¥¼ ì„ íƒí•˜ì„¸ìš”"); return; }
    if(!pickedQuick){ toast("ë¹ ë¥¸ ìƒ‰ìƒì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”"); return; }
    const m = D.markers.find(x=>x.id===selectedMarker.id);
    if(!m) return;
    const catId = markerCat(m);
    const c = getCat(catId);
    if(!c){ toast("ì¹´í…Œê³ ë¦¬ ì—†ìŒ"); return; }
    c.color = pickedQuick;
    saveLocal();
    renderCats();
    draw();
    toast("ì¹´í…Œê³ ë¦¬ ìƒ‰ìƒ ì ìš©");
  });

  $("btnOpenMarkerEdit").addEventListener("click", ()=>{
    if(!selectedMarker) return;
    ytTouched = false; memoTouched = false;
    openMarkerModal(selectedMarker.id);
  });

  // ---------- marker modal ----------
  let editingId = null;
  let ytTouched = false, memoTouched = false;

  function openMarkerModal(markerId){
    requireAuth(); if(!isAuthed()) return;
    const D = activeCtx();
    const m = D.markers.find(x=>x.id===markerId);
    if(!m) return;

    editingId = markerId;

    // categories select (exclude ì „ì²´)
    const sel = $("mfCat");
    sel.innerHTML = "";
    for(const c of D.categories){
      if(c.id==="ì „ì²´") continue;
      const o = document.createElement("option");
      o.value = c.id;
      o.textContent = c.name;
      sel.appendChild(o);
    }

    $("mfName").value = m.name || "";
    $("mfCat").value = m.cat || (D.categories.find(c=>c.id!=="ì „ì²´")?.id)||"ê¸°í…”";

    $("mfYt").value = m.yt || "";
    $("mfYtTitle").value = m.ytTitle || "";
    $("mfMemo").value = m.memo || "";

    const st = catStyle($("mfCat").value);
    $("mfR").value = st.r ?? 10;
    $("mfLabelFs").value = st.labelFs ?? 15;
    $("mfFw").value = String(st.fw ?? 900);
    $("mfLabelColor").value = st.labelColor || "#e7eef8";

    $("mfRVal").textContent = $("mfR").value;
    $("mfLabelFsVal").textContent = $("mfLabelFs").value;

    $("mfPos").textContent = `ì¢Œí‘œ(ë¹„ìœ¨): ${m.x.toFixed(6)}, ${m.y.toFixed(6)}`;

    mMarker.classList.add("show");
  }

  function closeMarkerModal(){
    mMarker.classList.remove("show");
    editingId = null;
  }
  $("btnCloseMarker").addEventListener("click", closeMarkerModal);

  mMarker.addEventListener("keydown", (e)=>{
    if(e.key==="Enter"){
      if(e.target && e.target.tagName==="TEXTAREA") return;
      e.preventDefault();
      saveMarkerModal();
    }
    if(e.key==="Escape"){
      closeMarkerModal();
    }
  });

  function getEditing(){
    if(!editingId) return null;
    const D = activeCtx();
    return D.markers.find(x=>x.id===editingId) || null;
  }

  function saveMarkerModal(){
    requireAuth(); if(!isAuthed()) return;
    const D = activeCtx();
    const m = getEditing();
    if(!m) return;

    m.name = ($("mfName").value || "").trim();
    m.cat = $("mfCat").value || "ê¸°í…”";
    ensureCat(m.cat, "#ffffff");
    m.yt = ($("mfYt").value || "").trim();
    m.ytTitle = ($("mfYtTitle").value || "").trim();
    m.memo = ($("mfMemo").value || "").trim();

    // category style update rules:
    // "ë§ˆì»¤ì˜ 1ë²ˆ(ì²´ì¸Index=1) ë³€ê²½ ì‹œ ë™ì¼ ì¹´í…Œê³ ë¦¬ ì „ë¶€ ë³€ê²½"
    // ì—¬ê¸°ì„œëŠ” ê´€ë¦¬ì í¸ì§‘ì—ì„œ ìŠ¤íƒ€ì¼ì„ ë°”ê¾¸ë©´ ì¹´í…Œê³ ë¦¬ ìŠ¤íƒ€ì¼ë¡œ ì €ì¥,
    // ê·¸ë¦¬ê³  í•´ë‹¹ ì¹´í…Œê³ ë¦¬ ëª¨ë“  ë§ˆì»¤ê°€ ë™ì¼í•˜ê²Œ ì ìš©ë¨(ìë™)
    const catId = m.cat;
    const c = getCat(catId);
    if(c){
      c.style = c.style || {};
      c.style.r = clamp(Number($("mfR").value||10), 5, 200);
      c.style.labelFs = clamp(Number($("mfLabelFs").value||15), 8, 200);
      c.style.fw = Number($("mfFw").value||900);
      c.style.labelColor = ($("mfLabelColor").value||"#e7eef8").trim() || "#e7eef8";

      // 1ë²ˆ ìŠ¤íƒ€ì¼ ì „íŒŒ ì¡°ê±´(ì²´ì¸Index=1) - ìš”êµ¬ì‚¬í•­ ì¤€ìˆ˜
      // ì²´ì¸Index=1ì´ ì•„ë‹ˆë©´ ìŠ¤íƒ€ì¼ ì €ì¥ì€ í•˜ë˜, "1ë²ˆ ê¸°ì¤€ ì „íŒŒ"ë¥¼ ë” ì—„ê²©íˆ ì›í•˜ë©´ ì•„ë˜ë¥¼ ì¡°ê±´í™” ê°€ëŠ¥.
      // ì—¬ê¸°ì„œëŠ” ìŠ¤íƒ€ì¼ì´ ì¹´í…Œê³ ë¦¬ ë‹¨ìœ„ì´ë¯€ë¡œ ê²°ê³¼ì ìœ¼ë¡œ ì „íŒŒë¨.
    }

    saveLocal();
    selectMarker(m.id);
    renderCats();
    renderKpi();
    draw();
    toast("ì €ì¥ ì™„ë£Œ");
  }

  function deleteMarkerModal(){
    requireAuth(); if(!isAuthed()) return;
    const D = activeCtx();
    const m = getEditing();
    if(!m) return;
    if(!confirm("ì´ ë§ˆì»¤ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;

    const cid = m.chainId;
    const cidx = m.chainIndex;
    D.markers = D.markers.filter(x=>x.id!==m.id);
    if(cid && cidx){
      for(const mm of D.markers){
        if(mm.chainId===cid && (mm.chainIndex||0) > cidx){
          mm.chainIndex = (mm.chainIndex||0) - 1;
        }
      }
    }
    saveLocal();
    closeMarkerModal();
    selectedMarker = null;
    syncSelectedPanel();
    renderKpi();
    draw();
    toast("ì‚­ì œ ì™„ë£Œ");
  }

  $("btnSaveMarker").addEventListener("click", saveMarkerModal);
  $("btnDeleteMarker").addEventListener("click", deleteMarkerModal);

  $("btnNewChain").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    const m = getEditing();
    if(!m) return;
    m.chainId = "c_"+uid();
    m.chainIndex = 1;
    insertAfterMarkerId = null;
    saveLocal();
    draw();
    toast("ìƒˆ ì²´ì¸ ì‹œì‘");
  });

  $("btnInsertAfter").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    const m = getEditing();
    if(!m) return;
    insertAfterMarkerId = m.id;
    toast("ì¤‘ê°„ ì‚½ì… ëª¨ë“œ í™œì„±í™”");
  });

  // 8ë²ˆ: ì´ë¦„ ì…ë ¥ ì‹œ í‘œì‹œëª…/ë©”ëª¨ ìë™
  $("mfYtTitle").addEventListener("input", ()=>{ ytTouched = true; syncSelectedPanelLive(); });
  $("mfMemo").addEventListener("input", ()=>{ memoTouched = true; syncSelectedPanelLive(); });
  $("mfName").addEventListener("input", ()=>{
    const v = $("mfName").value;
    if(!ytTouched) $("mfYtTitle").value = v;
    if(!memoTouched) $("mfMemo").value = v;
    syncSelectedPanelLive();
  });

  function syncSelectedPanelLive(){
    if(!editingId) return;
    const D = activeCtx();
    if(selectedMarker && selectedMarker.id === editingId){
      $("selName").textContent = $("mfName").value || "(ì´ë¦„ ì—†ìŒ)";
      $("selYtTitle").value = $("mfYtTitle").value || "";
      $("selLink").value = $("mfYt").value || "";
      const mm = D.markers.find(x=>x.id===editingId);
      if(mm){
        mm.yt = $("mfYt").value || "";
        mm.ytTitle = $("mfYtTitle").value || "";
        mm.memo = $("mfMemo").value || "";
      }
    }
  }

  $("mfR").addEventListener("input", ()=>{
    $("mfRVal").textContent = $("mfR").value;
  });
  $("mfLabelFs").addEventListener("input", ()=>{
    $("mfLabelFsVal").textContent = $("mfLabelFs").value;
  });

  $("mfLabelDefault").addEventListener("click", ()=>{ $("mfLabelColor").value = "#e7eef8"; });

  // ---------- category modal ----------
  let catSelectedRowId = null;

  $("btnEditCats").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    openCatsModal();
  });
  $("btnCloseCats").addEventListener("click", ()=>mCats.classList.remove("show"));

  function openCatsModal(){
    catSelectedRowId = null;
    renderCatRows();
    renderCatQuickPalette();
    mCats.classList.add("show");
  }

  function renderCatQuickPalette(){
    const wrap = $("catQuickPalette");
    wrap.innerHTML = "";
    for(const q of QUICK){
      const w = document.createElement("div");
      w.className = "swWrap";
      w.innerHTML = `<div class="sw" style="--c:${q.c}"></div><div class="swLabel">${q.name}</div>`;
      w.querySelector(".sw").addEventListener("click", ()=>{
        if(!catSelectedRowId){ toast("ì¹´í…Œê³ ë¦¬ í–‰ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”"); return; }
        const D = activeCtx();
        const c = D.categories.find(x=>x.id===catSelectedRowId);
        if(!c) return;
        c.color = q.c;
        renderCatRows();
      });
      wrap.appendChild(w);
    }
  }

  function renderCatRows(){
    const D = activeCtx();
    const rows = $("catRows");
    rows.innerHTML = "";

    const list = D.categories.filter(c=>c.id!=="ì „ì²´");
    for(const c of list){
      const row = document.createElement("div");
      row.style.display = "grid";
      row.style.gridTemplateColumns = "1fr 70px 90px";
      row.style.gap = "10px";
      row.style.alignItems = "center";
      row.style.marginBottom = "10px";

      row.innerHTML = `
        <input class="field" value="${escapeHtml(c.name)}" />
        <div class="colorChip" style="--c:${c.color};"></div>
        <button class="pill danger" type="button">ì‚­ì œ</button>
      `;

      const inp = row.querySelector("input");
      const chip = row.querySelector(".colorChip");
      const del = row.querySelector("button");

      row.addEventListener("click", ()=>{
        catSelectedRowId = c.id;
        toast("ì¹´í…Œê³ ë¦¬ ì„ íƒ");
      });

      inp.addEventListener("input", ()=>{
        c.name = inp.value;
      });

      chip.addEventListener("click", ()=>{
        catSelectedRowId = c.id;
        const next = prompt("ìƒ‰ìƒ ì½”ë“œ ì…ë ¥ (#rrggbb)", c.color);
        if(next===null) return;
        c.color = (next||"").trim() || c.color;
        renderCatRows();
      });

      del.addEventListener("click", (e)=>{
        e.stopPropagation();
        if(!confirm(`"${c.name}" ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí• ê¹Œìš”?`)) return;
        // markers with this cat -> move to "ê¸°í…”"(fallback)
        const fb = D.categories.find(x=>x.id==="ê¸°í…”") || D.categories[0];
        for(const m of D.markers){
          if(m.cat === c.id) m.cat = fb.id;
        }
        D.categories = D.categories.filter(x=>x.id!==c.id);
        renderCatRows();
        renderCats();
        saveLocal();
        draw();
      });

      rows.appendChild(row);
    }
  }

  $("btnAddCat").addEventListener("click", ()=>{
    const D = activeCtx();
    const name = prompt("ì¹´í…Œê³ ë¦¬ ì´ë¦„");
    if(!name) return;
    const id = name.trim();
    if(!id) return;
    if(D.categories.some(c=>c.id===id)){ toast("ì´ë¯¸ ì¡´ì¬"); return; }
    D.categories.push({ id, name:id, color:"#ffffff", on:true, style:{ r:10, labelFs:15, fw:900, labelColor:"#e7eef8" } });
    renderCatRows();
  });

  $("btnCatsDefault").addEventListener("click", ()=>{
    const D = activeCtx();
    if(!confirm("ê¸°ë³¸ ì¹´í…Œê³ ë¦¬ë¡œ ë˜ëŒë¦´ê¹Œìš”?")) return;
    D.categories = deepClone(defaultFilterCats);
    renderCatRows();
  });

  $("btnSaveCats").addEventListener("click", ()=>{
    requireAuth(); if(!isAuthed()) return;
    const D = activeCtx();

    // ensure unique by name as id
    const cleaned = [];
    const seen = new Set(["ì „ì²´"]);
    for(const c of D.categories){
      if(c.id==="ì „ì²´") continue;
      const name = (c.name||c.id||"").trim();
      if(!name) continue;
      const finalId = name;
      if(seen.has(finalId)) continue;
      seen.add(finalId);
      cleaned.push({
        id:finalId,
        name,
        color:(c.color||"#ffffff"),
        on: !!c.on,
        style: c.style || { r:10, labelFs:15, fw:900, labelColor:"#e7eef8" }
      });
    }
    const all = { id:"ì „ì²´", name:"ì „ì²´", color:"#7cc4ff", on:true, style:{ r:10, labelFs:15, fw:900, labelColor:"#e7eef8" } };
    D.categories = [all, ...cleaned];

    // remap markers cat if invalid
    const valid = new Set(D.categories.map(x=>x.id));
    const fb = valid.has("ê¸°í…”") ? "ê¸°í…”" : (D.categories[1]?.id || "ì „ì²´");
    for(const m of D.markers){
      if(!valid.has(m.cat)) m.cat = fb;
    }

    saveLocal();
    renderCats();
    renderKpi();
    draw();
    mCats.classList.remove("show");
    toast("ì¹´í…Œê³ ë¦¬ ì €ì¥");
  });

  // ---------- text quick colors ----------
  function renderTextColors(){
    textColors.innerHTML = "";
    const colors = ["#ff3b30","#ff9500","#ffd60a","#34c759","#0a84ff","#ffffff","#0b0b0f"];
    for(const c of colors){
      const d = document.createElement("div");
      d.className = "tSw";
      d.style.setProperty("--c", c);
      d.addEventListener("click", ()=>{ $("mfLabelColor").value = c; });
      textColors.appendChild(d);
    }
  }

  // ---------- utils ----------
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ---------- init/render ----------
  function renderAll(){
    renderLogo();
    renderCatTabs();
    renderPath();
    renderPages();
    renderCats();
    renderPalette();
    renderTextColors();

    const D = activeCtx();
    setToggle(tgShowLinesWithCatFilter, !!D.showLinesWithCatFilter);

    syncSelectedPanel();
    renderKpi();
    resizeCanvas();
    if(!D.map.scale || D.map.scale<=0) fitToScreen();
    draw();
  }

  async function init(){
    requireAuth();
    const st = await loadStateRemoteFirst();
    S = normalizeState(st);

    // ensure at least one topCat enabled
    if(!S.topCats.some(x=>x.enabled)) S.topCats[0].enabled = true;
    if(!S.topCats[S.ui.activeCatIndex].enabled){
      S.ui.activeCatIndex = S.topCats.findIndex(x=>x.enabled);
      if(S.ui.activeCatIndex<0) S.ui.activeCatIndex = 0;
    }

    renderAll();
    loadMap();

    const D = activeCtx();
    if(!D.map.scale || D.map.scale<=0){
      setTimeout(()=>{
        fitToScreen();
        saveLocal();
        draw();
      }, 0);
    }else{
      draw();
    }
  }

  init();

})();
</script>
</body>
</html>
